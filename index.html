<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tinny Fashion Store - Complete Business Manager</title>
   <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3crect width='100' height='100' rx='15' fill='%236B46C1'/%3e%3cpath fill='white' d='M20 30h60l-10 50H30zM50 20c-8 0-15 7-15 15v5h30v-5c0-8-7-15-15-15zM30 40c0 5 5 10 10 10h20c5 0 10-5 10-10'/%3e%3c/svg%3e">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <style>
        :root {
            --background-body: #F0F2F5;
            --surface-dark: #1A202C;
            --surface-dark-alt: #2D3748;
            
            --text-on-dark-primary: #E2E8F0;
            --text-on-dark-secondary: #A0AEC0;
            --text-on-dark-placeholder: #718096;

            --text-primary-on-light: #2D3748;
            --text-secondary-on-light: #4A5568;

            --accent-teal: #00A99D;
            --accent-teal-darker: #007A70;
            --accent-yellow: #F59E0B; /* Used for warnings, highlights */
            --accent-pink: #EC4899; /* For some dashboard trends or highlights */
            
            --success-green: #38A169;
            --danger-red: #E53E3E;
            --info-blue: #3182CE;

            --border-dark-primary: #4A5568;
            --border-dark-focus: var(--accent-teal);

            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 14px;

            --shadow-subtle: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03);
            --shadow-medium: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
            --shadow-strong: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
        }

        * {
            box-sizing: border-box;
        }

        html { height: 100%; scroll-behavior: smooth; }
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background-color: var(--background-body);
            color: var(--text-primary-on-light);
            margin: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #login-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; width: 100%; text-align: center; padding: 2rem;
            background: linear-gradient(135deg, var(--accent-teal) 0%, var(--accent-yellow) 100%);
        }
        .login-box {
            background: var(--surface-dark-alt); color: var(--text-on-dark-primary);
            padding: 2.5rem 3rem; border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-strong); max-width: 480px; width: 100%;
        }
        .login-box .store-logo { font-size: 2.5rem; font-weight: 700; color: var(--accent-yellow); margin-bottom: 0.5rem; }
        .login-box .store-logo span { display: inline-block; padding: 0.1em 0.4em; background-color: var(--accent-yellow); color: var(--surface-dark); border-radius: var(--border-radius-sm); margin-right: 0.1em; }
        .login-box h1 { color: var(--text-on-dark-primary); margin-bottom: 0.5rem; font-size: 1.8rem; font-weight: 700; }
        .login-box p { color: var(--text-on-dark-secondary); margin-bottom: 1.5rem; font-size: 0.95rem; }
        #signin-btn { background-color: #4285F4; color: white; border: none; padding: 14px 28px; font-size: 1rem; font-weight: 500; border-radius: var(--border-radius-md); cursor: pointer; display: inline-flex; align-items: center; gap: 1rem; transition: background-color 0.3s, box-shadow 0.3s; box-shadow: var(--shadow-subtle); }
        #signin-btn:hover:not([disabled]) { background-color: #357ae8; box-shadow: var(--shadow-medium); }
        #signin-btn[disabled] { background-color: #718096; color: var(--text-on-dark-secondary); cursor: not-allowed; }
        #signin-btn svg { width: 24px; height: 24px; background: white; border-radius: 50%; padding: 2px; }
        #auth-status { margin-top: 1.5rem; font-size: 0.9rem; }

        #app-container { display: none; padding: 25px; }
        #app-container.visible { display: block; }

        header {
            background-color: var(--surface-dark); color: var(--text-on-dark-primary);
            padding: 15px 25px; border-radius: var(--border-radius-lg);
            margin-bottom: 35px; box-shadow: var(--shadow-medium);
            display: flex; justify-content: space-between; align-items: center;
        }
        header .header-title-group h1 { margin: 0; font-weight: 700; font-size: 1.6rem; color: var(--accent-yellow); }
        .user-profile { display: flex; align-items: center; gap: 12px; }
        .user-profile span { font-weight: 500; font-size: 0.9rem; color: var(--text-on-dark-primary); }
        #signout-btn { font-size: 0.85rem; color: var(--accent-yellow); cursor: pointer; background: transparent; border: 1px solid var(--accent-yellow); border-radius: var(--border-radius-md); padding: 7px 12px; font-weight: 500; transition: background-color 0.2s, color 0.2s; }
        #signout-btn:hover { background-color: var(--accent-yellow); color: var(--surface-dark); }
        .low-stock-alert { 
            display: none; /* Permanently hidden */
        }

        .tab-nav {
            display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 30px;
            background-color: var(--surface-dark-alt); padding: 5px; border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-subtle);
        }
        .tab-button {
            padding: 10px 20px; cursor: pointer; border: none; background-color: transparent;
            font-size: 0.95rem; font-weight: 500; color: var(--text-on-dark-secondary);
            border-radius: var(--border-radius-md); transition: color 0.3s ease, background-color 0.2s ease;
            margin: 0 3px;
        }
        .tab-button:hover { color: var(--text-on-dark-primary); background-color: rgba(255,255,255,0.05); }
        .tab-button.active { color: var(--surface-dark); background-color: var(--accent-teal); font-weight: 600; box-shadow: var(--shadow-medium); }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeInContent 0.4s ease-out; }
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        main { max-width: 1200px; margin: 0 auto; }
        .main-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .operations-layout, .credit-layout { display: grid; grid-template-columns: 1fr; gap: 30px; }
        .action-forms-section { margin-top: 30px; } 


        .card {
            background-color: var(--surface-dark); color: var(--text-on-dark-primary);
            border-radius: var(--border-radius-lg); padding: 25px 30px;
            box-shadow: var(--shadow-medium); margin-bottom: 30px;
        }
        .card h2 {
            color: var(--accent-teal); font-weight: 600; font-size: 1.25rem; margin-top: 0;
            border-bottom: 1px solid var(--border-dark-primary); padding-bottom: 15px; margin-bottom: 25px;
        }
        .card .form-grid, .card form .item-entry { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .card .cosmetic-form-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .card .cosmetic-credit-form-grid { display: grid; grid-template-columns: 1.5fr 1fr 2fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .card .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        .card input[type="text"], .card input[type="number"], .card input[type="file"], .card input[type="date"], .card select {
            width: 100%; padding: 12px 15px; border: 1px solid var(--border-dark-primary);
            border-radius: var(--border-radius-md); font-size: 0.95rem; 
            font-family: 'Roboto', sans-serif; background-color: var(--surface-dark-alt);
            color: var(--text-on-dark-primary);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .card input[type="text"]:focus, .card input[type="number"]:focus, .card input[type="date"]:focus, .card select:focus {
            border-color: var(--border-dark-focus); box-shadow: 0 0 0 3px rgba(0, 169, 157, 0.25); outline: none;
        }
        .card input[type="file"] { background-color: var(--surface-dark-alt); border-color: var(--accent-teal); color: var(--accent-teal); cursor: pointer; }
        .card input::placeholder { color: var(--text-on-dark-placeholder); opacity: 1; }
        #settings .card input[type="file"] { margin-top: 15px; }
        .card .controls-grid label, .card .form-row label, #holiday-management-section label { display: block; font-size: 0.9rem; color: var(--text-on-dark-secondary); margin-bottom: 6px; font-weight: 500; }
        
        #add-sale-item-btn, #add-purchase-item-btn, #add-credit-inventory-item-btn {
            background-color: transparent; color: var(--accent-teal); border: 2px dashed var(--accent-teal);
            font-weight: 500; text-transform: none; padding: 10px 15px; margin-top: 10px; margin-bottom: 20px;
            width: 100%; border-radius: var(--border-radius-md); transition: background-color 0.2s, color 0.2s;
        }
        #add-sale-item-btn:hover, #add-purchase-item-btn:hover, #add-credit-inventory-item-btn:hover { background-color: rgba(0, 169, 157, 0.1); }

        .btn {
            width: 100%; padding: 12px 20px; border-radius: var(--border-radius-md); border: none; font-size: 0.95rem;
            font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            box-shadow: var(--shadow-subtle);
        }
        .btn:hover:not([disabled]) { box-shadow: var(--shadow-medium); transform: translateY(-1px); }
        .btn:active:not([disabled]) { box-shadow: var(--shadow-subtle); transform: translateY(0px); }
        .btn[disabled] { background-color: var(--text-on-dark-placeholder); color: var(--surface-dark-alt); cursor: not-allowed; opacity: 0.8; box-shadow: none; }
        .btn-primary { background-color: var(--accent-teal); color: var(--surface-dark); }
        .btn-primary:hover:not([disabled]) { background-color: var(--accent-teal-darker); }
        .btn-secondary { background-color: var(--surface-dark-alt); color: var(--text-on-dark-primary); border: 1px solid var(--border-dark-primary); }
        .btn-secondary:hover:not([disabled]) { background-color: #4A5568; }
        .btn-success { background-color: var(--success-green); color: white; }
        .btn-success:hover:not([disabled]) { background-color: #2F855A; }
        .btn-danger { background-color: var(--danger-red); color: white; }
        .btn-danger:hover:not([disabled]) { background-color: #C53030; }
        .btn-small { padding: 8px 14px; font-size: 0.8rem; letter-spacing: 0.2px; width: auto;}
        .sales-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }

        .table-container { max-height: 450px; overflow-y: auto; border: 1px solid var(--border-dark-primary); border-radius: var(--border-radius-md); margin-top: 20px; background-color: var(--surface-dark); }
        .styled-table { width: 100%; border-collapse: collapse; }
        .styled-table th, .styled-table td { border-bottom: 1px solid var(--border-dark-primary); padding: 14px 16px; text-align: left; font-size: 0.9rem; vertical-align: middle; color: var(--text-on-dark-secondary); }
        .styled-table th { background-color: var(--surface-dark-alt); color: var(--accent-teal); font-weight: 600; position: sticky; top: 0; text-transform: capitalize; z-index: 1; }
        .styled-table tr:hover td { background-color: var(--surface-dark-alt); color: var(--text-on-dark-primary); }
        .styled-table td ul { margin: 0; padding-left: 18px; list-style-type: disc; }
        .styled-table td li { padding: 3px 0; }
        .profit-col { font-weight: 600; color: var(--success-green); }
        .credit-label { font-size: 0.75rem; font-weight: 600; color: var(--surface-dark); background-color: var(--info-blue); padding: 3px 8px; border-radius: var(--border-radius-sm); display: inline-block; margin-top: 6px; }
        .sales-history-actions { display: flex; gap: 8px; }
        tr.is-low-stock td { background-color: rgba(245, 158, 11, 0.1) !important; border-left: 3px solid var(--accent-yellow); color: var(--accent-yellow) !important; }
        .low-stock-badge { display: inline-block; margin-left: 8px; padding: 3px 7px; font-size: 0.7rem; font-weight: 600; color: var(--surface-dark); background-color: var(--accent-yellow); border-radius: 10px; text-transform: uppercase; vertical-align: middle; }
        .inventory-actions { display: flex; gap: 6px; }
        .edit-input { padding: 6px 8px; font-size: 0.9rem; max-width: 90px; }
        tr.edit-mode .display-value { display: none; }
        tr:not(.edit-mode) .edit-field { display: none; }
        tr.edit-mode .edit-btn, tr.edit-mode .delete-btn { display: none; }
        tr:not(.edit-mode) .save-btn, tr:not(.edit-mode) .cancel-btn { display: none; }

        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .metric-card { text-align: left; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .metric-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-strong); }
        .metric-card h3 { margin: 0 0 12px; color: var(--text-on-dark-secondary); font-size: 0.85rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-card p { font-size: 2rem; margin: 0; color: var(--accent-yellow); font-weight: 700; }
        .metric-card #total-profit, .metric-card #total-revenue { color: var(--accent-teal);}
        
        /* Styles for categorized low stock in Analytics Tab */
        #low-stock-items { background-color: var(--surface-dark-alt); padding-bottom: 15px; }
        #low-stock-items.metric-card h3 { color: var(--accent-yellow); } 
        .categorized-low-stock-container .low-stock-category-group { margin-bottom: 15px; }
        .categorized-low-stock-container .low-stock-category-group:last-child { margin-bottom: 0; }
        
        .low-stock-category-title { 
            color: var(--accent-teal); 
            font-size: 1rem; 
            font-weight: 600;
            margin-top: 15px;
            margin-bottom: 8px;
            padding: 8px 5px; /* Added padding for better click area */
            border-bottom: 1px solid var(--border-dark-primary);
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            transition: background-color 0.2s;
        }
        .low-stock-category-title:hover {
            background-color: rgba(0, 169, 157, 0.1); /* Teal accent on hover */
        }
        .low-stock-category-title.expanded .category-toggle-indicator {
            transform: rotate(90deg);
        }
        .categorized-low-stock-container .low-stock-category-group:first-child .low-stock-category-title { margin-top: 0; }

        .low-stock-items-in-category {
            list-style-type: none;
            padding-left: 15px; /* Indent items under category */
            margin-top: 5px;
            background-color: var(--surface-dark); /* Match card background */
            border-radius: 0 0 var(--border-radius-sm) var(--border-radius-sm); /* Rounded corners if visible */
        }
        .low-stock-items-in-category li {
            padding: 10px 5px;
            border-bottom: 1px dashed var(--border-dark-primary); 
            font-size: 0.9rem;
            color: var(--text-on-dark-secondary);
        }
        .low-stock-items-in-category li:last-child { border-bottom: none; }
        .low-stock-items-in-category li .low-stock-qty { color: var(--accent-yellow); font-weight: 600; }
        #low-stock-items p[style*="text-align:center"] { /* For the "No low stock items" text */
            font-size: 0.95rem; 
            color: var(--text-on-dark-secondary);
            text-align: center;
            padding: 20px 0; /* Add padding */
        }


        #toast { position: fixed; bottom: -120px; right: 25px; padding: 14px 25px; border-radius: var(--border-radius-md); color: var(--surface-dark); font-weight: 600; font-size: 0.95rem; box-shadow: var(--shadow-strong); transition: bottom 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.4s ease; z-index: 9999; opacity: 0; }
        #toast.show { bottom: 25px; opacity: 1; }
        #toast.success { background-color: var(--success-green); color: white; }
        #toast.error { background-color: var(--danger-red); color: white; }
        #toast.info { background-color: var(--info-blue); color: white; }

        .creditor-item { background-color: var(--surface-dark); padding: 0; border: 1px solid var(--border-dark-primary); border-radius: var(--border-radius-md); margin-bottom: 15px; box-shadow: var(--shadow-subtle); overflow: hidden; }
        .creditor-header { display: flex; justify-content: space-between; align-items: center; font-weight: 500; font-size: 1.05rem; cursor: pointer; padding: 15px 20px; transition: background-color 0.2s; border-bottom: 1px solid transparent; color: var(--text-on-dark-primary); }
        .creditor-header:hover { background-color: var(--surface-dark-alt); }
        .creditor-header .creditor-balance { color: var(--accent-yellow); font-weight: 600; }
        .creditor-header::after { content: '▼'; font-size: 0.8em; color: var(--text-on-dark-secondary); transition: transform 0.3s ease; margin-left: auto; padding-left: 10px; }
        .creditor-header.is-open::after { transform: rotate(180deg); color: var(--accent-teal); }
        .creditor-item.is-expanded .creditor-header { border-bottom-color: var(--border-dark-primary); }
        .creditor-details { display: none; padding: 20px; background-color: var(--surface-dark-alt); }
        .creditor-details.visible { display: block; animation: fadeInAccordion 0.4s ease; }
        @keyframes fadeInAccordion { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }
        .creditor-details table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .creditor-details th, .creditor-details td { text-align: left; padding: 10px; border-bottom: 1px solid var(--border-dark-primary); font-size: 0.9rem; color: var(--text-on-dark-secondary); }
        .creditor-details th { font-size: 0.85rem; color: var(--accent-teal); background-color: var(--surface-dark); }
        .payment-form { display: flex; gap: 10px; margin-top: 15px; align-items: center; }
        .payment-form input { max-width: 180px; }
        .payment-form label { font-size: 0.9rem; color: var(--text-on-dark-secondary); white-space: nowrap; }

        /* Dashboard Specific Styles ("Operations" Tab) */
        .dashboard-overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .overview-card {
            background-color: var(--surface-dark);
            color: var(--text-on-dark-primary);
            padding: 20px 25px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-medium);
            position: relative;
        }
        .overview-card h4 {
            margin: 0 0 8px 0;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-on-dark-secondary);
            text-transform: uppercase;
        }
        .overview-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--accent-teal);
            margin: 0 0 10px 0;
            line-height: 1.1;
        }
        #overview-low-stock .overview-value, #overview-inventory-value .overview-value {
            color: var(--accent-yellow);
        }
        .overview-trend {
            font-size: 0.85rem;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: var(--border-radius-sm);
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .overview-trend.positive { background-color: rgba(56, 161, 105, 0.2); color: var(--success-green); }
        .overview-trend.warning { background-color: rgba(245, 158, 11, 0.2); color: var(--accent-yellow); }
        .overview-trend.neutral { background-color: rgba(113, 128, 150, 0.2); color: var(--text-on-dark-secondary); }

        .dashboard-main-area {
            display: grid;
            grid-template-columns: 2fr 1fr; 
            gap: 30px;
            margin-bottom: 30px;
        }
        .dashboard-chart-container.card { 
             min-height: 350px; 
             display: flex; flex-direction: column; justify-content: space-between;
        }
         .dashboard-chart-container.card h2 { font-size: 1.1rem; }
        .quick-stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            padding-top: 15px; border-top: 1px solid var(--border-dark-primary);
            font-size: 0.9rem;
        }
        .quick-stats-grid span { color: var(--text-on-dark-secondary); }
        .quick-stats-grid strong { color: var(--accent-teal); }


        .dashboard-low-stock-list.card { 
            padding-bottom: 15px;
        }
        .dashboard-low-stock-list .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dashboard-low-stock-list .list-header h2 {
            border-bottom: none; margin-bottom: 0; padding-bottom: 0; font-size: 1.1rem;
        }
        
        #dashboard-low-stock-items-ul {
            list-style-type: none;
            padding: 0;
            margin-top: 15px;
            max-height: 350px; 
            overflow-y: auto;
        }
         /* Style for the main li acting as a category container */
        #dashboard-low-stock-items-ul li.dashboard-category-item {
            display: block; 
            border-bottom: none; 
            padding: 0; 
            margin-bottom: 5px; /* Space between category groups */
            background-color: var(--surface-dark); /* Base for category item */
            border-radius: var(--border-radius-sm);
            overflow: hidden; /* Ensures child rounded corners are visible */
        }
         #dashboard-low-stock-items-ul li.dashboard-category-item:last-child {
            margin-bottom: 0;
        }

        .dashboard-category-header {
            padding: 10px 8px;
            background-color: var(--surface-dark-alt);
            /* border-bottom: 1px solid var(--border-dark-primary); Removed for cleaner look when expanded */
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        .dashboard-category-header:hover {
            background-color: #4A5568; 
        }
        .dashboard-category-header h5 {
            margin: 0;
            color: var(--accent-pink);
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            flex-grow: 1; 
        }
        .dashboard-category-header.expanded .category-toggle-indicator {
            transform: rotate(90deg);
        }
        .category-toggle-indicator { 
            font-size: 1em; /* Made slightly larger */
            color: var(--text-on-dark-secondary);
            transition: transform 0.2s ease-out;
            padding: 0 5px; 
        }

        #dashboard-low-stock-items-ul .dashboard-items-in-category { /* UL for items */
            list-style-type: none;
            padding: 0;
            margin: 0;
            background-color: var(--surface-dark); 
        }
        #dashboard-low-stock-items-ul .dashboard-items-in-category li { /* Actual item LI */
            display: flex;
            align-items: center;
            padding: 12px 10px; 
            border-bottom: 1px solid var(--border-dark-primary);
        }
        #dashboard-low-stock-items-ul .dashboard-items-in-category li:last-child {
            border-bottom: none;
        }
        #dashboard-low-stock-items-ul .dashboard-items-in-category li:hover {
            background-color: var(--surface-dark-alt);
        }
         /* For the "No low stock items." message when it's the only content of the main UL */
        #dashboard-low-stock-items-ul > li > p[style*="text-align:center"] {
            padding: 20px; 
            color: var(--text-on-dark-secondary);
        }


        .item-icon-placeholder {
            width: 40px; height: 40px;
            background-color: var(--accent-pink); 
            border-radius: var(--border-radius-sm);
            margin-right: 15px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; color: var(--surface-dark); font-weight: bold;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .item-icon-placeholder::before { content: "🛍️"; }

        .item-details { flex-grow: 1; }
        .item-details .item-name {
            display: block;
            font-weight: 500;
            color: var(--text-on-dark-primary);
            font-size: 0.95rem;
        }
        .item-details .item-sub-detail {
            display: block;
            font-size: 0.8rem;
            color: var(--text-on-dark-secondary);
        }
        .item-details .item-sub-detail .low-stock-qty { color: var(--accent-yellow); font-weight: bold; }
        .item-stock-level {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent-yellow);
            margin-left: 10px;
            white-space: nowrap; /* Prevent "X left" from wrapping */
        }
        
        /* Holiday Management Styles */
        #holiday-management-section { margin-top: 20px; }
        #holiday-management-section .holiday-input-group { display: flex; align-items: flex-end; gap: 10px; margin-bottom: 15px; }
        #holiday-management-section .holiday-input-group input[type="date"] { flex-grow: 1; }
        #holiday-list { list-style-type: none; padding-left: 0; margin-top: 10px; max-height: 200px; overflow-y: auto;}
        #holiday-list li {
            background-color: var(--surface-dark-alt);
            padding: 10px 15px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
            color: var(--text-on-dark-secondary);
        }
         #holiday-list li .holiday-date-text { color: var(--text-on-dark-primary); }

        /* Responsive adjustments */
        @media (max-width: 400px) {
            #login-screen { padding: 1rem; }
            .login-box { padding: 2rem 1.5rem; }
            .login-box .store-logo { font-size: 2rem; }
            .login-box h1 { font-size: 1.5rem; }
            .login-box p { font-size: 0.85rem; margin-bottom: 1rem; }
            .login-box p:nth-of-type(2) { margin-bottom: 1.5rem; }
            #signin-btn { padding: 12px 20px; font-size: 0.9rem; gap: 0.5rem; }
            #signin-btn svg { width: 20px; height: 20px; }
        }
        @media (max-width: 992px) { .dashboard-main-area { grid-template-columns: 1fr; } }
        @media (max-width: 900px) {
            .main-columns, .card .cosmetic-form-grid, .card .cosmetic-credit-form-grid { grid-template-columns: 1fr; }
            header { flex-direction: column; align-items: center; text-align: center; gap: 10px; }
            .dashboard-overview-grid { grid-template-columns: 1fr; } 
        }
        @media (max-width: 800px) {
            #app-container { padding: 15px; }
            .analytics-grid, .sales-actions, .card .form-row { grid-template-columns: 1fr; }
            .tab-nav { padding: 5px 0; }
            .tab-button { padding: 10px 12px; font-size: 0.9rem; margin: 2px; }
            .card .form-grid, .card .cosmetic-credit-form-grid { grid-template-columns: 1fr; }
            .card .controls-grid { grid-template-columns: 1fr; }
            .controls-grid .btn { margin-top: 10px; }
            header .header-title-group h1 { font-size: 1.4rem; }
            .card h2 { font-size: 1.15rem; }
            .overview-value { font-size: 1.8rem; }
            #sales-trend-controls { flex-direction: column; align-items: stretch;}
            #sales-trend-custom-range-inputs { flex-direction: column; }
            #holiday-management-section .holiday-input-group { flex-direction: column; align-items: stretch; }
            #holiday-management-section .holiday-input-group button { width: 100%; margin-top: 5px; }

            #sales-trend-controls {
    flex-direction: column; /* Stack controls vertically */
    align-items: stretch; /* Make items stretch to full width of the container */
}

#sales-trend-controls label,
#sales-trend-controls select,
#sales-trend-controls .btn {
    width: 100%; /* Make label, select, and button full width */
    max-width: none; /* Override any max-width set inline or elsewhere */
    margin-bottom: 10px; /* Add some space between stacked items */
}

#sales-trend-controls .btn {
    margin-left: 0; /* Remove auto margin for the button */
}

#sales-trend-custom-range-inputs {
    flex-direction: column; /* Stack date inputs vertically */
    width: 100%; /* Make the container full width */
    gap: 5px; /* Reduce gap for tighter stacking */
}

#sales-trend-custom-range-inputs input[type="date"] {
    width: 100%; /* Make date inputs full width */
    margin-bottom: 5px; /* Space between date inputs */
}

#sales-trend-custom-range-inputs span {
    display: none; /* Hide the hyphen when stacked, or style differently if preferred */
}

        }

    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <div class="store-logo"><span>T</span>inny Fashion</div>
            <h1>Welcome Back!</h1>
            <p>Manage your fashion store with ease.</p>
            <p style="color: var(--text-on-dark-secondary); margin-bottom: 2rem; font-size: 0.9rem;">Sign in with Google to access your dashboard.</p>
            <button id="signin-btn" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 35.841 44 30.138 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                Sign in with Google
            </button>
            <p id="auth-status" style="margin-top: 1.5rem; font-size: 0.9rem;">Initializing...</p>
        </div>
    </div>

    <div id="app-container">
        <header>
            <div id="low-stock-alert-container" class="low-stock-alert">
                Low Stock: <span id="low-stock-counter">0</span>
            </div>
            <div class="header-title-group">
                <h1>Tinny Fashion Store</h1>
            </div>
            <div id="user-profile-container" class="user-profile" style="display: none;">
                <div>
                    <span id="user-name"></span>
                    <button id="signout-btn">Sign Out</button>
                </div>
            </div>
        </header>

        <nav class="tab-nav">
            <button class="tab-button active" data-tab="operations">Operations</button>
            <button class="tab-button" data-tab="credit">Credit</button>
            <button class="tab-button" data-tab="analytics">Analytics</button>
            <button class="tab-button" data-tab="profit">Profit</button>
            <button class="tab-button" data-tab="transactions">Transactions</button>
            <button class="tab-button" data-tab="settings">Settings</button>
        </nav>

        <main>
            <!-- Operations Tab -->
            <div id="operations" class="tab-content active">
                <section class="dashboard-overview-grid">
                    <div class="overview-card" id="overview-current-stock">
                        <h4>Current Stock</h4>
                        <p class="overview-value" id="dashboard-total-units">0</p>
                        <span class="overview-trend positive">+0.0%</span> 
                    </div>
                    <div class="overview-card" id="overview-low-stock">
                        <h4>Low in Stock</h4>
                        <p class="overview-value" id="dashboard-low-stock-count">0</p>
                        <span class="overview-trend warning">Alert</span>
                    </div>
                    <div class="overview-card" id="overview-inventory-value">
                        <h4>Inventory Value</h4>
                        <p class="overview-value" id="dashboard-inventory-value">₹0.00</p>
                        <span class="overview-trend neutral">Total Cost</span>
                    </div>
                </section>

                <section class="dashboard-main-area">
                    <div class="dashboard-chart-container card">
                        <h2>Sales Trend</h2>
                         <div id="sales-trend-controls" style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                            <label for="sales-trend-mode" style="margin-bottom: 0; color: var(--text-on-dark-secondary);">View:</label>
                            <select id="sales-trend-mode" style="padding: 8px 10px; font-size: 0.9rem; max-width: 150px;">
                                <option value="last7days" selected>Last 7 Days</option>
                                <option value="currentMonth">Current Month</option>
                                <option value="customRange">Custom Range</option>
                            </select>
                            <div id="sales-trend-custom-range-inputs" style="display:none; gap: 10px; align-items: center;">
                                <input type="date" id="sales-trend-start-date" style="padding: 8px 10px; font-size: 0.9rem;">
                                <span style="color: var(--text-on-dark-secondary);">-</span>
                                <input type="date" id="sales-trend-end-date" style="padding: 8px 10px; font-size: 0.9rem;">
                            </div>
                            <button id="refresh-sales-trend-btn" class="btn btn-secondary btn-small" style="margin-left:auto;">Refresh</button>
                        </div>
                        <div style="flex-grow: 1; position: relative; min-height: 250px; padding-bottom: 15px;">
                            <canvas id="salesTrendChart"></canvas>
                        </div>
                        <div class="quick-stats-grid">
                            <div><span>Total Revenue (All Time):</span> <strong id="dashboard-total-revenue">₹0.00</strong></div>
                            <div><span>Total Profit (All Time):</span> <strong id="dashboard-total-profit">₹0.00</strong></div>
                        </div>
                    </div>

                    <div class="dashboard-low-stock-list card">
                        <div class="list-header">
                            <h2>Products Low in Stock</h2>
                            <button class="btn btn-primary btn-small" id="dashboard-download-low-stock-btn">Download</button>
                        </div>
                        <ul id="dashboard-low-stock-items-ul">
                            <li><p style="text-align:center; color: var(--text-on-dark-secondary);">No low stock items.</p></li>
                        </ul>
                    </div>
                </section>

                <div class="main-columns action-forms-section">
                    <section class="card">
                        <h2>Make a Sale (From Inventory)</h2>
                        <form id="sales-form">
                            <div id="sales-items-container"></div>
                            <datalist id="inventory-datalist"></datalist>
                            <button type="button" id="add-sale-item-btn" class="btn">+ Add Item</button>
                            <div class="sales-actions">
                                <button type="button" id="record-sale-btn" class="btn btn-secondary">Record Sale</button>
                                <button type="button" id="record-invoice-btn" class="btn btn-primary">Record & Print</button>
                            </div>
                        </form>
                    </section>
                    <section class="card">
                        <h2>Add New Stock (Purchase)</h2>
                        <form id="purchase-form">
                            <div id="purchase-items-container"></div>
                            <button type="button" id="add-purchase-item-btn" class="btn">+ Add Item</button>
                            <button type="submit" class="btn btn-primary">Add to Stock</button>
                        </form>
                    </section>
                </div>
                <div class="operations-layout action-forms-section">
                    <section class="card">
                        <h2>Cosmetic & Non-Inventory Sale</h2>
                        <form id="cosmetic-sale-form">
                            <div class="cosmetic-form-grid">
                                <input type="text" id="cosmetic-particulars" placeholder="Item Particulars" required>
                                <input type="number" id="cosmetic-quantity" placeholder="Quantity" min="1" required>
                                <input type="number" id="cosmetic-cost-rate" placeholder="Cost Rate (per item)" min="0" step="0.01" required>
                                <input type="number" id="cosmetic-sell-rate" placeholder="Selling Rate (per item)" min="0" step="0.01" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Record Profit</button>
                        </form>
                    </section>
                </div>
            </div>

            <!-- Credit Tab -->
            <div id="credit" class="tab-content">
                <div class="credit-layout">
                    <section class="card">
                        <h2>Credit Sale (From Inventory)</h2>
                        <form id="credit-inventory-sale-form">
                            <div class="form-row">
                                <div>
                                    <label for="credit-inventory-party-name">Party Name</label>
                                    <input type="text" id="credit-inventory-party-name" placeholder="Enter party's name" required>
                                </div>
                                <div>
                                    <label for="credit-inventory-date">Transaction Date</label>
                                    <input type="date" id="credit-inventory-date" required>
                                </div>
                            </div>
                            <div id="credit-inventory-items-container"></div>
                            <button type="button" id="add-credit-inventory-item-btn" class="btn">+ Add More Items</button>
                            <button type="submit" class="btn btn-primary">Record Credit Sale</button>
                        </form>
                    </section>

                    <section class="card">
                        <h2>Cosmetics Sales on Credit</h2>
                        <p>Record credit sales for items not tracked in inventory, like cosmetics.</p>
                        <form id="credit-cosmetic-sale-form">
                            <div class="cosmetic-credit-form-grid">
                            <div><label>Party Name</label><input type="text" id="credit-cosmetic-party-name" placeholder="Party's Name" required></div>
                            <div><label>Date</label><input type="date" id="credit-cosmetic-date" required></div>
                            <div><label>Item Name</label><input type="text" id="credit-cosmetic-item-name" placeholder="e.g., Lipstick" required></div>
                            <div><label>Quantity</label><input type="number" id="credit-cosmetic-qty" placeholder="Qty" min="1" required></div>
                            <div><label>Cost Rate</label><input type="number" id="credit-cosmetic-cost-rate" placeholder="Cost per item" min="0" step="0.01" required></div>
                            <div><label>Sell Rate</label><input type="number" id="credit-cosmetic-sell-rate" placeholder="Sell per item" min="0" step="0.01" required></div>
                            </div>
                            <button type="submit" class="btn btn-primary">Record Cosmetic Credit Sale</button>
                        </form>
                    </section>
                    
                    <section class="card" id="creditor-list-section">
                        <h2>Creditor List</h2>
                        <p>List of parties with outstanding credit balances. Click on a name to see details and record payments.</p>
                        <div id="creditor-list-container">
                        </div>
                    </section>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                <section class="card">
                    <h2>Shop Performance At a Glance</h2>
                    <div class="analytics-grid">
                        <div class="metric-card"><h3>Total Profit</h3><p id="total-profit">₹0.00</p></div>
                        <div class="metric-card"><h3>Total Revenue</h3><p id="total-revenue">₹0.00</p></div>
                        <div class="metric-card"><h3>Average Margin</h3><p id="avg-margin">0%</p></div>
                        <div class="metric-card"><h3>Inventory Value</h3><p id="total-inventory-cost">₹0.00</p></div>
                        <div class="metric-card"><h3>Units in Stock</h3><p id="total-units">0</p></div>
                    </div>
                </section>
                
                <section class="card">
                    <h2>Sales & Profit by Date Range</h2>
                    <div class="controls-grid" style="margin-bottom: 20px;">
                        <div>
                            <label for="analytics-start-date">Start Date</label>
                            <input type="date" id="analytics-start-date">
                        </div>
                        <div>
                            <label for="analytics-end-date">End Date</label>
                            <input type="date" id="analytics-end-date">
                        </div>
                        <button class="btn btn-primary" id="analytics-filter-btn">Filter</button>
                    </div>
                     <div class="analytics-grid" id="filtered-sales-profit-container">
                        <div class="metric-card">
                            <h3 id="filtered-sales-heading">Total Sales</h3>
                            <p id="filtered-sales-total">₹0.00</p>
                        </div>
                        <div class="metric-card">
                            <h3 id="filtered-profit-heading">Total Profit</h3>
                            <p id="filtered-profit-total">₹0.00</p>
                        </div>
                    </div>
                </section>

                <section class="card">
                    <h2>Low Stock Items
                        <button class="btn btn-success btn-small" id="download-low-stock-btn" style="float: right; margin-top: -5px;">Download List</button>
                    </h2>
                    <div id="low-stock-items" class="metric-card">
                         <p style="text-align:center; color: var(--text-on-dark-secondary);">No low stock items.</p>
                    </div>
                </section>
            </div>

            <!-- Profit Tab -->
            <div id="profit" class="tab-content">
                <section class="card">
                    <h2>Item-wise Profit Details</h2>
                    <div class="table-container">
                        <table class="styled-table" id="profit-details-table">
                            <thead>
                                <tr>
                                    <th>Date (DD/MM/YYYY)</th>
                                    <th>Particulars</th>
                                    <th>Qty</th>
                                    <th>Total Sell Price</th>
                                    <th>Cost Rate (per item)</th>
                                    <th>Profit</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" style="text-align:center;">No sales recorded yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- Transactions Tab -->
            <div id="transactions" class="tab-content">
                <section class="card">
                    <h2>Controls</h2>
                    <div class="controls-grid">
                        <div>
                            <label for="start-date">Start Date</label>
                            <input type="date" id="start-date">
                        </div>
                        <div>
                            <label for="end-date">End Date</label>
                            <input type="date" id="end-date">
                        </div>
                        <div>
                            <label for="transaction-sort-order">Sort By</label>
                            <select id="transaction-sort-order">
                                <option value="newest-first">Newest First</option>
                                <option value="oldest-first">Oldest First</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" id="filter-btn">Filter</button>
                        <button class="btn btn-secondary" id="reset-filter-btn">Reset</button>
                        <button class="btn btn-success" id="export-excel-btn">Export to Excel</button>
                    </div>
                </section>
                <section class="card"><h2>Sales History</h2><div class="table-container">
                    <table class="styled-table" id="sales-history-table">
                        <thead><tr><th>Date (DD/MM/YYYY)</th><th>Items</th><th>Total</th><th>Action</th></tr></thead>
                        <tbody><tr><td colspan="4" style="text-align:center;">No sales recorded yet.</td></tr></tbody>
                    </table>
                </div></section>
                <section class="card"><h2>Purchase History</h2><div class="table-container">
                    <table class="styled-table" id="purchase-history-table">
                        <thead><tr><th>Date (DD/MM/YYYY)</th><th>Items</th><th>Total</th></tr></thead>
                        <tbody><tr><td colspan="3" style="text-align:center;">No purchases recorded yet.</td></tr></tbody>
                    </table>
                </div></section>
            </div>
        
            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <section class="card">
                    <h2>Data Management</h2>
                    <p>Load your existing inventory from an Excel file. The file must contain 'particulars', 'quantity', and 'rate' columns. This will overwrite your current inventory.</p>
                    <input type="file" id="excel-file" accept=".xlsx, .xls">

                    <div style="margin-top: 2.5rem; border-top: 1px solid var(--border-dark-primary); padding-top: 1.5rem;">
                         <button class="btn btn-success" id="manual-save-btn">Sync to Google Drive</button>
                         <p style="color: var(--text-on-dark-secondary); font-size: 0.9rem; margin-top: 10px;">Manually save all current data to your Google Drive. The app also saves automatically after you make changes.</p>
                    </div>
                </section>
                <section class="card" id="holiday-management-section">
                    <h2>Holiday Management</h2>
                    <p>Mark specific dates as holidays. This information is saved with your data.</p>
                    <div class="holiday-input-group">
                        <div>
                            <label for="holiday-date">Select Holiday Date:</label>
                            <input type="date" id="holiday-date">
                        </div>
                        <button id="add-holiday-btn" class="btn btn-primary btn-small" style="width:auto; align-self: flex-end;">Add Holiday</button>
                    </div>
                    <h3>Marked Holidays:</h3>
                    <ul id="holiday-list">
                        <!-- Holidays will be listed here -->
                        <li style="text-align:center; color: var(--text-on-dark-secondary); background: none;">No holidays marked yet.</li>
                    </ul>
                </section>
            </div>

            <section class="card"><h2>Current Inventory</h2><div class="table-container">
                <table class="styled-table" id="inventory-table">
                    <thead><tr><th>Particulars</th><th>Quantity</th><th>Cost Rate</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div></section>
        </main>
    </div>

    <div id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
    window.onload = () => {
        const { jsPDF } = window.jspdf;

        const app = {
            CLIENT_ID: '460969544827-ip0gvjsjv79m5sibkmgbngmqpl8n5u16.apps.googleusercontent.com',
            API_KEY: 'AIzaSyDYfJX4cryYxGSgPe1319kHf_u6bb071lg', 
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            APP_FOLDER_NAME: 'TinnyFashionStore_Data',
            DATA_FILE_NAME: 'fashion_store_data.json',
            tokenClient: null, driveFileId: null, isSaving: false, saveTimeout: null,
            state: { inventory: [], transactions: [], holidays: [] }, // Added holidays to state
            ui: {},
            salesChartInstance: null, 

            init() { 
                this.cacheDOMElements();
                gapi.load('client', this.initializeGapiClient.bind(this));
                this.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: this.CLIENT_ID,
                    scope: this.SCOPES,
                    callback: this.handleAuthResponse.bind(this),
                });
                this.ui.signinBtn.addEventListener('click', () => this.tokenClient.requestAccessToken({prompt: 'consent'}));
                this.ui.signoutBtn.addEventListener('click', this.signOut.bind(this));
            },
            async initializeGapiClient() { 
                await gapi.client.init({
                    apiKey: this.API_KEY,
                    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                });
                this.ui.signinBtn.disabled = false;
                this.ui.authStatus.textContent = 'Ready. Please sign in.';
            },
            async handleAuthResponse(response) { 
                if (response.error) {
                    this.showToast(`Error: ${response.error}`, 'error');
                    return;
                }
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').classList.add('visible');
                await this.updateUserProfile();
                await this.loadData();
                this.startAppLogic();
            },
            signOut() { 
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token, () => {
                        gapi.client.setToken('');
                        this.driveFileId = null;
                        document.getElementById('login-screen').style.display = 'flex';
                        document.getElementById('app-container').classList.remove('visible');
                        this.showToast('Signed out successfully.');
                    });
                }
            },
            async updateUserProfile() { 
                try {
                    const res = await gapi.client.request({ path: 'https://www.googleapis.com/oauth2/v3/userinfo' });
                    document.getElementById('user-name').textContent = res.result.name;
                    document.getElementById('user-profile-container').style.display = 'flex';
                } catch (e) { console.error("Could not fetch user profile", e); }
            },
            startAppLogic() { 
                this.addEventListeners();
                this.addFormItem(this.ui.salesItemsContainer, true);
                this.addFormItem(this.ui.purchaseItemsContainer, false);
                this.addFormItem(this.ui.credit.inventoryItemsContainer, true);
                
                this.ui.credit.inventoryDateInput.value = this.getTodayDateString();
                this.ui.credit.cosmeticDateInput.value = this.getTodayDateString();
                
                this.renderAll();
                if (typeof Chart !== 'undefined' && this.ui.operations.salesTrendChart) {
                    this.renderSalesTrendChart(); // Initial render with default (last 7 days)
                } else if (this.ui.operations.salesTrendChart) {
                    console.warn("Chart.js is not loaded, but chart canvas exists. Sales trend chart will not be rendered.");
                }
            },
            async _findOrCreateAppFolder() { 
                if (this.appFolderId) return this.appFolderId;
                try {
                    let res = await gapi.client.drive.files.list({ q: `name='${this.APP_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`, spaces: 'drive', fields: 'files(id)' });
                    if (res.result.files && res.result.files.length > 0) {
                        this.appFolderId = res.result.files[0].id;
                    } else {
                        let folder = { 'name': this.APP_FOLDER_NAME, 'mimeType': 'application/vnd.google-apps.folder' };
                        res = await gapi.client.drive.files.create({ resource: folder, fields: 'id' });
                        this.appFolderId = res.result.id;
                    }
                    return this.appFolderId;
                } catch (e) { console.error('Error finding/creating app folder:', e); this.showToast('Could not access Drive folder.', 'error'); }
            },
            async loadData() { 
                this.showToast("Loading data from Google Drive...", "info");
                try {
                    const response = await gapi.client.drive.files.list({ q: `name='${this.DATA_FILE_NAME}' and trashed=false`, spaces: 'drive', fields: 'files(id)' });
                    if (response.result.files && response.result.files.length > 0) {
                        this.driveFileId = response.result.files[0].id;
                        const fileContentResponse = await gapi.client.drive.files.get({ fileId: this.driveFileId, alt: 'media' });
                        const loadedState = JSON.parse(fileContentResponse.body);
                        
                        if (loadedState.transactions) {
                           loadedState.transactions.forEach(t => {
                               t.date = new Date(t.date);
                               if (t.saleType === 'Credit' && t.paidAmount === undefined) {
                                   t.paidAmount = 0;
                               }
                               if(t.items && !Array.isArray(t.items)) {
                                   t.items = [t.items]; // Ensure items is always an array
                               }
                           });
                        }

                        const defaultState = { inventory: [], transactions: [], holidays: [] };
                        this.state = { ...defaultState, ...loadedState };
                        this.state.holidays = loadedState.holidays || []; // Ensure holidays array exists

                        this.showToast("Data loaded successfully.", "success");
                    } else {
                        this.showToast("No data file found. Starting fresh.", "info");
                        this.state.holidays = []; // Initialize holidays for fresh start
                        await this._findOrCreateAppFolder(); // Ensure folder exists for new data
                    }
                } catch (e) {
                    console.error("Error loading data:", e);
                    this.showToast("Failed to load data. Starting fresh.", "error");
                    this.state = { inventory: [], transactions: [], holidays: [] }; 
                }
            },
            triggerAutoSave() { 
                clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => this.saveData(), 2000);
            },
            async saveData() { 
                if (this.isSaving) return;
                this.isSaving = true;

                const originalBtnText = this.ui.manualSaveBtn.textContent;
                this.ui.manualSaveBtn.disabled = true;
                this.ui.manualSaveBtn.textContent = 'Saving...';
                
                this.showToast("Saving data...", "info");

                try {
                    if (!this.appFolderId) await this._findOrCreateAppFolder();
                    const dataToSave = JSON.stringify(this.state, null, 2);
                    const boundary = '-------314159265358979323846';
                    const delimiter = "\r\n--" + boundary + "\r\n";
                    const close_delim = "\r\n--" + boundary + "--";
                    let request;
                    if (this.driveFileId) {
                        const multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify({}) + delimiter + 'Content-Type: application/json\r\n\r\n' + dataToSave + close_delim;
                        request = gapi.client.request({'path': `https://www.googleapis.com/upload/drive/v3/files/${this.driveFileId}`,'method': 'PATCH','params': { 'uploadType': 'multipart' },'headers': {'Content-Type': 'multipart/related; boundary="' + boundary + '"'},'body': multipartRequestBody});
                    } else {
                        const metadata = {'name': this.DATA_FILE_NAME, 'parents': [this.appFolderId], 'mimeType': 'application/json'};
                        const multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) + delimiter + 'Content-Type: application/json\r\n\r\n' + dataToSave + close_delim;
                        request = gapi.client.request({'path': 'https://www.googleapis.com/upload/drive/v3/files', 'method': 'POST', 'params': {'uploadType': 'multipart'}, 'headers': {'Content-Type': 'multipart/related; boundary="' + boundary + '"'},'body': multipartRequestBody});
                    }
                    const response = await request;
                    if (!this.driveFileId) { this.driveFileId = response.result.id; }
                    this.showToast("Data saved successfully!", "success");
                } catch (e) { 
                    console.error("Error saving data:", e); 
                    this.showToast("Failed to save data.", "error");
                } finally {
                    this.isSaving = false;
                    this.ui.manualSaveBtn.disabled = false;
                    this.ui.manualSaveBtn.textContent = originalBtnText;
                }
            },

            hexToRgba(hex, alpha = 1) {
                if (!hex || typeof hex !== 'string' || hex.charAt(0) !== '#') {
                    return `rgba(0, 169, 157, ${alpha})`; 
                }
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                if (isNaN(r) || isNaN(g) || isNaN(b)) {
                    return `rgba(0, 169, 157, ${alpha})`; 
                }
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            },

            cacheDOMElements() {
                this.ui = {
                    signinBtn: document.getElementById('signin-btn'),
                    signoutBtn: document.getElementById('signout-btn'),
                    authStatus: document.getElementById('auth-status'),
                    excelFile: document.getElementById('excel-file'),
                    inventoryTableBody: document.querySelector('#inventory-table tbody'),
                    inventoryDatalist: document.getElementById('inventory-datalist'),
                    salesForm: document.getElementById('sales-form'),
                    addSaleItemBtn: document.getElementById('add-sale-item-btn'),
                    salesItemsContainer: document.getElementById('sales-items-container'),
                    purchaseForm: document.getElementById('purchase-form'),
                    addPurchaseItemBtn: document.getElementById('add-purchase-item-btn'),
                    purchaseItemsContainer: document.getElementById('purchase-items-container'),
                    recordSaleBtn: document.getElementById('record-sale-btn'),
                    recordInvoiceBtn: document.getElementById('record-invoice-btn'),
                    cosmeticSaleForm: document.getElementById('cosmetic-sale-form'),
                    tabButtons: document.querySelectorAll('.tab-button'),
                    tabContents: document.querySelectorAll('.tab-content'),
                    manualSaveBtn: document.getElementById('manual-save-btn'),
                    analytics: { 
                        totalProfit: document.getElementById('total-profit'),
                        totalRevenue: document.getElementById('total-revenue'),
                        avgMargin: document.getElementById('avg-margin'),
                        inventoryCost: document.getElementById('total-inventory-cost'),
                        totalUnits: document.getElementById('total-units'),
                        lowStockItems: document.getElementById('low-stock-items'),
                        downloadLowStockBtn: document.getElementById('download-low-stock-btn'),
                        startDateInput: document.getElementById('analytics-start-date'),
                        endDateInput: document.getElementById('analytics-end-date'),
                        filterBtn: document.getElementById('analytics-filter-btn'),
                        filteredSalesTotal: document.getElementById('filtered-sales-total'),
                        filteredProfitTotal: document.getElementById('filtered-profit-total'),
                        filteredSalesHeading: document.getElementById('filtered-sales-heading'),
                        filteredProfitHeading: document.getElementById('filtered-profit-heading'),
                    },
                    transactions: { 
                        salesHistoryBody: document.querySelector('#sales-history-table tbody'),
                        purchaseHistoryBody: document.querySelector('#purchase-history-table tbody'),
                        transactionsTab: document.getElementById('transactions'),
                        startDateInput: document.getElementById('start-date'),
                        endDateInput: document.getElementById('end-date'),
                        filterBtn: document.getElementById('filter-btn'),
                        resetFilterBtn: document.getElementById('reset-filter-btn'),
                        exportExcelBtn: document.getElementById('export-excel-btn'),
                        transactionSortOrder: document.getElementById('transaction-sort-order'),
                    },
                    profit: { 
                        profitDetailsBody: document.querySelector('#profit-details-table tbody'),
                    },
                    credit: { 
                        inventorySaleForm: document.getElementById('credit-inventory-sale-form'),
                        inventoryItemsContainer: document.getElementById('credit-inventory-items-container'),
                        addInventoryItemBtn: document.getElementById('add-credit-inventory-item-btn'),
                        inventoryDateInput: document.getElementById('credit-inventory-date'),
                        cosmeticSaleForm: document.getElementById('credit-cosmetic-sale-form'),
                        cosmeticDateInput: document.getElementById('credit-cosmetic-date'),
                        creditorListContainer: document.getElementById('creditor-list-container'),
                    },
                    operations: {
                        dashboardTotalUnits: document.getElementById('dashboard-total-units'),
                        dashboardLowStockCount: document.getElementById('dashboard-low-stock-count'),
                        dashboardInventoryValue: document.getElementById('dashboard-inventory-value'),
                        dashboardTotalRevenue: document.getElementById('dashboard-total-revenue'),
                        dashboardTotalProfit: document.getElementById('dashboard-total-profit'),
                        dashboardLowStockItemsUl: document.getElementById('dashboard-low-stock-items-ul'),
                        dashboardDownloadLowStockBtn: document.getElementById('dashboard-download-low-stock-btn'),
                        salesTrendChart: document.getElementById('salesTrendChart'), 
                        salesTrendModeSelect: document.getElementById('sales-trend-mode'),
                        salesTrendCustomRangeInputs: document.getElementById('sales-trend-custom-range-inputs'),
                        salesTrendStartDateInput: document.getElementById('sales-trend-start-date'),
                        salesTrendEndDateInput: document.getElementById('sales-trend-end-date'),
                        refreshSalesTrendBtn: document.getElementById('refresh-sales-trend-btn'),
                    },
                    settings: {
                        holidayDateInput: document.getElementById('holiday-date'),
                        addHolidayBtn: document.getElementById('add-holiday-btn'),
                        holidayList: document.getElementById('holiday-list'),
                    }
                };
            },
            
            getTodayDateString(date = new Date()) { return date.toISOString().slice(0, 10); },
            formatDateDDMMYYYY(date) { 
                if (!(date instanceof Date) || isNaN(date)) return 'N/A';
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            },
            parseItemNameFromDatalist(value) { 
                if (typeof value !== 'string') return '';
                const match = value.match(/^(.*) \(\d+ left\)$/);
                return match ? match[1].trim() : value.trim();
            },

            getCategoryFromParticulars(particulars) {
                const pTrimmed = particulars.trim();
                if (!pTrimmed) return "Uncategorized";

                const words = pTrimmed.split(/\s+/);
                let categoryParts = [];

                for (const word of words) {
                    if (/\d/.test(word)) { // If the word contains any digit
                        break;
                    }
                    categoryParts.push(word);
                }

                if (categoryParts.length > 0) {
                    return categoryParts.join(" ").trim();
                } else {
                    if (words.length > 0) {
                        const firstWord = words[0];
                        const textualPrefixMatch = firstWord.match(/^([a-zA-Z_]+)/); 
                        if (textualPrefixMatch && textualPrefixMatch[1]) {
                            return textualPrefixMatch[1];
                        }
                    }
                    return "Other Items"; // Fallback category
                }
            },
            
            _getFirstDayOfMonth(date) {
                return new Date(date.getFullYear(), date.getMonth(), 1);
            },
            _getLastDayOfMonth(date) {
                return new Date(date.getFullYear(), date.getMonth() + 1, 0);
            },
            _getDaysInMonth(year, month) { // month is 0-indexed
                return new Date(year, month + 1, 0).getDate();
            },


            renderAll() {
                this.renderInventory();
                this.renderAnalytics(); 
                this.renderFilteredSalesAndProfit();
                this.renderTransactions();
                this.renderProfit();
                this.renderCreditorList(); 
                this.renderHolidays();
                if (typeof Chart !== 'undefined' && this.ui.operations.salesTrendChart && document.getElementById('operations').classList.contains('active')) {
                     this.renderSalesTrendChart(); 
                }
            },

            renderInventory() { 
                this.state.inventory.sort((a, b) => a.particulars.localeCompare(b.particulars));
                this.ui.inventoryTableBody.innerHTML = this.state.inventory.length
                    ? this.state.inventory.map(item => {
                        const isLowStock = item.quantity > 0 && item.quantity <= 3; // Low stock threshold
                        const rowClass = isLowStock ? 'is-low-stock' : '';
                        const badgeHTML = isLowStock ? ` <span class="low-stock-badge">Low</span>` : '';

                        return `<tr data-particulars="${item.particulars}" class="${rowClass}">
                            <td><span class="display-value">${item.particulars}</span><div class="edit-field"><input type="text" class="edit-input" value="${item.particulars}" readonly></div></td>
                            <td><span class="display-value">${item.quantity}${badgeHTML}</span><div class="edit-field"><input type="number" class="edit-input edit-quantity" value="${item.quantity}" min="0"></div></td>
                            <td><span class="display-value">${item.rate.toFixed(2)}</span><div class="edit-field"><input type="number" class="edit-input edit-rate" value="${item.rate.toFixed(2)}" min="0" step="0.01"></div></td>
                            <td><div class="inventory-actions">
                                    <button class="btn btn-small btn-secondary edit-btn" data-particulars="${item.particulars}">Edit</button>
                                    <button class="btn btn-small btn-success save-btn" data-particulars="${item.particulars}">Save</button>
                                    <button class="btn btn-small btn-secondary cancel-btn">Cancel</button>
                                    <button class="btn btn-small btn-danger delete-btn" data-particulars="${item.particulars}">Delete</button>
                                </div></td></tr>`;
                    }).join('')
                    : `<tr><td colspan="4" style="text-align:center;">No inventory data. Add stock or load an Excel file.</td></tr>`;
                
                this.ui.inventoryDatalist.innerHTML = this.state.inventory
                    .map(item => `<option value="${item.particulars} (${item.quantity} left)"></option>`)
                    .join('');
            },

            renderAnalytics() { 
                const { cost, units, lowStockItemsArr } = this.state.inventory.reduce((acc, item) => {
                    acc.cost += item.quantity * item.rate;
                    acc.units += item.quantity;
                    if (item.quantity > 0 && item.quantity <= 3) acc.lowStockItemsArr.push(item);
                    return acc;
                }, { cost: 0, units: 0, lowStockItemsArr: [] });

                lowStockItemsArr.sort((a, b) => a.particulars.localeCompare(b.particulars));

                const categorizedLowStock = {};
                if (lowStockItemsArr.length > 0) {
                    lowStockItemsArr.forEach(item => {
                        const category = this.getCategoryFromParticulars(item.particulars);
                        if (!categorizedLowStock[category]) {
                            categorizedLowStock[category] = [];
                        }
                        categorizedLowStock[category].push(item);
                    });
                }
                const sortedCategories = Object.keys(categorizedLowStock).sort((a, b) => a.localeCompare(b));
                
                // For Analytics Tab (#low-stock-items)
                let analyticsLowStockHtml = '';
                if (sortedCategories.length > 0) {
                    analyticsLowStockHtml = '<div class="categorized-low-stock-container">';
                    sortedCategories.forEach((category, index) => {
                        analyticsLowStockHtml += `<div class="low-stock-category-group">`;
                        analyticsLowStockHtml += `<h4 class="low-stock-category-title" data-category-index="analytics-${index}">
                                                    <span class="category-name-text">${category.toUpperCase()}</span>
                                                    <span class="category-toggle-indicator">►</span>
                                                  </h4>`;
                        analyticsLowStockHtml += `<ul class="low-stock-items-in-category" id="analytics-items-${index}" style="display: none;">`;
                        categorizedLowStock[category].forEach(item => {
                            analyticsLowStockHtml += `<li>${item.particulars} - <span class="low-stock-qty">${item.quantity} left</span></li>`;
                        });
                        analyticsLowStockHtml += `</ul></div>`;
                    });
                    analyticsLowStockHtml += '</div>';
                } else {
                    analyticsLowStockHtml = '<p style="text-align:center; color: var(--text-on-dark-secondary); padding: 20px 0;">No low stock items.</p>';
                }
                this.ui.analytics.lowStockItems.innerHTML = analyticsLowStockHtml;
                
                // For Operations Tab Dashboard (#dashboard-low-stock-items-ul)
                let dashboardLowStockHtml = '';
                if (sortedCategories.length > 0) {
                    sortedCategories.forEach((category, index) => {
                        dashboardLowStockHtml += `<li class="dashboard-category-item">`;
                        dashboardLowStockHtml += `  <div class="dashboard-category-header" data-category-index="dashboard-${index}">
                                                        <h5>${category.toUpperCase()}</h5>
                                                        <span class="category-toggle-indicator">►</span>
                                                    </div>`;
                        dashboardLowStockHtml += `  <ul class="dashboard-items-in-category" id="dashboard-items-${index}" style="display: none;">`;
                        categorizedLowStock[category].forEach(item => {
                            dashboardLowStockHtml += `    <li>
                                                            <div class="item-icon-placeholder"></div>
                                                            <div class="item-details">
                                                                <span class="item-name">${item.particulars}</span>
                                                                <span class="item-sub-detail">Cost: ₹${item.rate.toFixed(2)} / Qty: <span class="low-stock-qty">${item.quantity}</span></span>
                                                            </div>
                                                            <span class="item-stock-level">${item.quantity} left</span>
                                                        </li>`;
                        });
                        dashboardLowStockHtml += `  </ul>`;
                        dashboardLowStockHtml += `</li>`;
                    });
                } else {
                    dashboardLowStockHtml = '<li><p style="text-align:center; color: var(--text-on-dark-secondary);">No low stock items.</p></li>';
                }
                if (this.ui.operations.dashboardLowStockItemsUl) {
                    this.ui.operations.dashboardLowStockItemsUl.innerHTML = dashboardLowStockHtml;
                }

                const sales = this.state.transactions.filter(t => t.type === 'Sale');
                const totalRevenue = sales.reduce((sum, t) => sum + t.total, 0);
                const totalProfit = sales.flatMap(t => t.items).reduce((sum, i) => sum + (i.sellingRate - i.costRate) * i.quantity, 0);
                const avgMargin = totalRevenue > 0 ? ((totalProfit / totalRevenue) * 100) : 0;
                
                this.ui.analytics.totalProfit.textContent = `₹${totalProfit.toFixed(2)}`;
                this.ui.analytics.totalRevenue.textContent = `₹${totalRevenue.toFixed(2)}`;
                this.ui.analytics.avgMargin.textContent = `${avgMargin.toFixed(1)}%`;
                this.ui.analytics.inventoryCost.textContent = `₹${cost.toFixed(2)}`;
                this.ui.analytics.totalUnits.textContent = units;
                
                const lowStockCount = lowStockItemsArr.length;
                this.ui.analytics.downloadLowStockBtn.disabled = lowStockCount === 0;
                
                if (this.ui.operations.dashboardTotalUnits) { 
                    this.ui.operations.dashboardTotalUnits.textContent = units;
                    this.ui.operations.dashboardLowStockCount.textContent = lowStockCount;
                    this.ui.operations.dashboardInventoryValue.textContent = `₹${cost.toFixed(2)}`;
                    this.ui.operations.dashboardTotalRevenue.textContent = `₹${totalRevenue.toFixed(2)}`;
                    this.ui.operations.dashboardTotalProfit.textContent = `₹${totalProfit.toFixed(2)}`;
                    if(this.ui.operations.dashboardDownloadLowStockBtn) {
                        this.ui.operations.dashboardDownloadLowStockBtn.disabled = lowStockCount === 0;
                    }
                }
            },
            
            _prepareSalesDataForMode(mode, customStartDate, customEndDate) {
                let startDate, endDate;
                let labels = [];
                const salesDataAggregated = {};
                let titleSuffix = "";

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (mode === 'last7days') {
                    titleSuffix = "Last 7 Days";
                    endDate = new Date(today);
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 6);

                    for (let i = 0; i < 7; i++) {
                        const date = new Date(startDate);
                        date.setDate(startDate.getDate() + i);
                        const dateString = date.toISOString().split('T')[0];
                        labels.push(this.formatDateDDMMYYYY(date).substring(0, 5)); // DD/MM
                        salesDataAggregated[dateString] = 0;
                    }
                } else if (mode === 'currentMonth') {
                    titleSuffix = "Current Month";
                    startDate = this._getFirstDayOfMonth(today);
                    endDate = this._getLastDayOfMonth(today);
                    const daysInMonth = endDate.getDate();

                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(today.getFullYear(), today.getMonth(), day);
                        const dateString = date.toISOString().split('T')[0];
                        labels.push(String(day)); // Day number
                        salesDataAggregated[dateString] = 0;
                    }
                } else if (mode === 'customRange') {
                    if (!customStartDate || !customEndDate) {
                        this.showToast("Please select both start and end dates for custom range.", "error");
                        return this._prepareSalesDataForMode('last7days'); // Fallback to default
                    }
                    startDate = new Date(customStartDate);
                    startDate.setHours(0,0,0,0);
                    endDate = new Date(customEndDate);
                    endDate.setHours(23,59,59,999);

                    if (startDate > endDate) {
                        this.showToast("Start date cannot be after end date.", "error");
                        return this._prepareSalesDataForMode('last7days'); // Fallback
                    }
                    titleSuffix = `Custom: ${this.formatDateDDMMYYYY(startDate)} - ${this.formatDateDDMMYYYY(endDate)}`;

                    let currentDate = new Date(startDate);
                    while(currentDate <= endDate) {
                        const dateString = currentDate.toISOString().split('T')[0];
                        labels.push(this.formatDateDDMMYYYY(currentDate).substring(0,5));
                        salesDataAggregated[dateString] = 0;
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                     if (labels.length === 0 && startDate.getTime() === endDate.setHours(0,0,0,0)) { // Handle single day range
                        const dateString = startDate.toISOString().split('T')[0];
                        labels.push(this.formatDateDDMMYYYY(startDate).substring(0,5));
                        salesDataAggregated[dateString] = 0;
                    }
                }

                this.state.transactions.forEach(transaction => {
                    if (transaction.type === 'Sale') {
                        const transactionDate = new Date(transaction.date);
                        transactionDate.setHours(0, 0, 0, 0);
                        if (transactionDate >= startDate && transactionDate <= endDate) {
                            const transactionDateString = transactionDate.toISOString().split('T')[0];
                            if (salesDataAggregated.hasOwnProperty(transactionDateString)) {
                                salesDataAggregated[transactionDateString] += transaction.total;
                            }
                        }
                    }
                });
                
                const dataPoints = Object.values(salesDataAggregated);
                return { labels, dataPoints, titleSuffix, salesDataAggregated };
            },

            renderSalesTrendChart() {
                if (typeof Chart === 'undefined') {
                    console.warn("Chart.js is not defined. Cannot render sales trend chart.");
                    if(this.ui.operations.salesTrendChart) {
                        this.ui.operations.salesTrendChart.parentElement.innerHTML = '<p style="text-align:center; color: var(--text-on-dark-secondary); padding-top: 20px;">Chart library not loaded.</p>';
                    }
                    return;
                }
                if (!this.ui.operations.salesTrendChart) {
                    console.warn("Sales trend chart canvas not found."); return;
                }
                const ctx = this.ui.operations.salesTrendChart.getContext('2d');
                if (!ctx) { console.error("Failed to get 2D context for sales trend chart."); return; }

                const style = getComputedStyle(document.documentElement);
                const textOnDarkSecondary = style.getPropertyValue('--text-on-dark-secondary').trim();
                const borderDarkPrimary = style.getPropertyValue('--border-dark-primary').trim();
                const accentTeal = style.getPropertyValue('--accent-teal').trim();

                const mode = this.ui.operations.salesTrendModeSelect.value;
                const customStartDate = this.ui.operations.salesTrendStartDateInput.value;
                const customEndDate = this.ui.operations.salesTrendEndDateInput.value;

                const { labels, dataPoints, titleSuffix } = this._prepareSalesDataForMode(mode, customStartDate, customEndDate);

                if (this.salesChartInstance) {
                    this.salesChartInstance.destroy();
                }

                this.salesChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Daily Sales',
                            data: dataPoints,
                            borderColor: accentTeal,
                            backgroundColor: this.hexToRgba(accentTeal, 0.2),
                            tension: 0.3,
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                grid: { color: borderDarkPrimary, borderColor: borderDarkPrimary },
                                ticks: { color: textOnDarkSecondary }
                            },
                            y: {
                                beginAtZero: true,
                                grid: { color: borderDarkPrimary, borderColor: borderDarkPrimary },
                                ticks: {
                                    color: textOnDarkSecondary,
                                    callback: function(value) { return '₹' + value.toLocaleString('en-IN'); }
                                }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: textOnDarkSecondary } },
                            title: { // Dynamic title
                                display: true,
                                text: 'Sales Trend (' + titleSuffix + ')',
                                color: textOnDarkSecondary,
                                font: { size: 16 }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed.y !== null) {
                                            label += new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            },

            renderFilteredSalesAndProfit() { 
                const startDateStr = this.ui.analytics.startDateInput.value;
                const endDateStr = this.ui.analytics.endDateInput.value;
                const startDate = startDateStr ? new Date(startDateStr) : null;
                if(startDate) startDate.setHours(0, 0, 0, 0);
                const endDate = endDateStr ? new Date(endDateStr) : null;
                if(endDate) endDate.setHours(23, 59, 59, 999);

                const isFiltered = startDate || endDate;

                const sales = this.state.transactions.filter(t => 
                    t.type === 'Sale' &&
                    (!startDate || t.date >= startDate) && 
                    (!endDate || t.date <= endDate)
                );
                
                const totalSales = sales.reduce((sum, t) => sum + t.total, 0);
                const totalProfit = sales.flatMap(t => t.items).reduce((sum, i) => sum + (i.sellingRate - i.costRate) * i.quantity, 0);
                
                this.ui.analytics.filteredSalesTotal.textContent = `₹${totalSales.toFixed(2)}`;
                this.ui.analytics.filteredProfitTotal.textContent = `₹${totalProfit.toFixed(2)}`;

                this.ui.analytics.filteredSalesHeading.textContent = isFiltered ? "Filtered Sales" : "All-Time Sales";
                this.ui.analytics.filteredProfitHeading.textContent = isFiltered ? "Filtered Profit" : "All-Time Profit";
            },
            renderTransactions() { 
                const startDateStr = this.ui.transactions.startDateInput.value;
                const endDateStr = this.ui.transactions.endDateInput.value;
                const startDate = startDateStr ? new Date(startDateStr) : null;
                if(startDate) startDate.setHours(0,0,0,0);
                const endDate = endDateStr ? new Date(endDateStr) : null;
                if(endDate) endDate.setHours(23,59,59,999);
                const sortOrder = this.ui.transactions.transactionSortOrder.value;
                
                const sortFunction = (a, b) => sortOrder === 'oldest-first' ? a.date - b.date : b.date - a.date;

                const filteredSales = this.state.transactions
                    .filter(t => t.type === 'Sale' && (!startDate || t.date >= startDate) && (!endDate || t.date <= endDate))
                    .sort(sortFunction);
                
                const filteredPurchases = this.state.transactions
                    .filter(t => t.type === 'Purchase' && (!startDate || t.date >= startDate) && (!endDate || t.date <= endDate))
                    .sort(sortFunction);

                this.ui.transactions.salesHistoryBody.innerHTML = filteredSales.length ? filteredSales.map(t => {
                    const creditLabel = t.saleType === 'Credit' ? `<span class="credit-label">CREDIT TO: ${t.partyName} (Paid: ₹${(t.paidAmount || 0).toFixed(2)})</span>` : '';
                    const itemsHtml = t.items.map(i => {
                        const returnButton = `<button class="btn btn-danger btn-small return-item-btn" data-transaction-id="${t.id}" data-item-particulars="${i.particulars}">Return</button>`;
                        return `<li><span>${i.quantity} x ${i.particulars} @ ₹${i.sellingRate.toFixed(2)}</span> ${returnButton}</li>`;
                    }).join('');

                    return `
                    <tr><td>${this.formatDateDDMMYYYY(t.date)}</td>
                        <td><ul>${itemsHtml}</ul>${creditLabel}</td>
                        <td>₹${t.total.toFixed(2)}</td>
                        <td><div class="sales-history-actions">
                            <button class="btn btn-secondary btn-small download-invoice-btn" data-id="${t.id}">Invoice</button>
                            <button class="btn btn-danger btn-small delete-sale-btn" data-id="${t.id}">Delete</button>
                        </div></td></tr>`}).join('') : `<tr><td colspan="4" style="text-align:center;">No sales match the selected criteria.</td></tr>`;

                this.ui.transactions.purchaseHistoryBody.innerHTML = filteredPurchases.length ? filteredPurchases.map(t => `
                    <tr><td>${this.formatDateDDMMYYYY(t.date)}</td>
                        <td><ul>${t.items.map(i => `<li>${i.quantity} x ${i.particulars} @ ₹${i.rate.toFixed(2)}</li>`).join('')}</ul></td>
                        <td>₹${t.total.toFixed(2)}</td></tr>`).join('') : `<tr><td colspan="3" style="text-align:center;">No purchases match the selected criteria.</td></tr>`;
            },
            renderProfit() { 
                const allItemsSold = this.state.transactions
                    .filter(t => t.type === 'Sale')
                    .flatMap(t => t.items.map(item => ({ ...item, date: t.date })));
                
                if (!allItemsSold.length) {
                    this.ui.profit.profitDetailsBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No sales recorded yet.</td></tr>`;
                    return;
                }

                allItemsSold.sort((a,b) => b.date - a.date);
                
                const tableRows = allItemsSold.map(item => {
                    const totalSellingPrice = item.sellingRate * item.quantity;
                    const profit = totalSellingPrice - (item.costRate * item.quantity);
                    
                    return `<tr>
                                <td>${this.formatDateDDMMYYYY(item.date)}</td>
                                <td>${item.particulars}</td>
                                <td>${item.quantity}</td>
                                <td>${totalSellingPrice.toFixed(2)}</td>
                                <td>${item.costRate.toFixed(2)}</td>
                                <td class="profit-col">₹${profit.toFixed(2)}</td>
                            </tr>`;
                }).join('');

                this.ui.profit.profitDetailsBody.innerHTML = tableRows;
            },
            renderCreditorList() { 
                const creditSales = this.state.transactions.filter(t => t.saleType === 'Credit');
                const creditors = creditSales.reduce((acc, t) => {
                    if (!t.partyName) return acc;
                    if (!acc[t.partyName]) {
                        acc[t.partyName] = { totalOwed: 0, totalPaid: 0, transactions: [] };
                    }
                    acc[t.partyName].totalOwed += t.total;
                    acc[t.partyName].totalPaid += (t.paidAmount || 0);
                    acc[t.partyName].transactions.push(t);
                    return acc;
                }, {});

                this.ui.credit.creditorListContainer.innerHTML = '';
                const creditorsWithBalance = Object.entries(creditors).filter(([name, data]) => (data.totalOwed - data.totalPaid) > 0.01);
                
                if (creditorsWithBalance.length === 0) {
                    this.ui.credit.creditorListContainer.innerHTML = '<p style="text-align:center; color: var(--text-on-dark-secondary);">No outstanding credit balances.</p>';
                    return;
                }
                
                creditorsWithBalance.sort((a,b) => a[0].localeCompare(b[0]));

                for (const [name, data] of creditorsWithBalance) {
                    const remainingBalance = data.totalOwed - data.totalPaid;
                    const transactionRows = data.transactions.map(tx => {
                        const balanceOnTx = tx.total - (tx.paidAmount || 0);
                        if (balanceOnTx <= 0.01) return '';
                        const itemsList = tx.items.map(i => `${i.quantity}x ${i.particulars.replace('(Cosmetic)', '')}`).join(', ');
                        return `<tr>
                                <td>${this.formatDateDDMMYYYY(tx.date)}</td>
                                <td>${itemsList}</td>
                                <td>₹${tx.total.toFixed(2)}</td>
                                <td>₹${balanceOnTx.toFixed(2)}</td>
                            </tr>`;
                    }).join('');

                    const creditorElementHTML = `
                        <div class="creditor-item" data-creditor-name="${name}">
                            <div class="creditor-header">
                                <span class="creditor-name">${name}</span>
                                <span class="creditor-balance">Balance: ₹${remainingBalance.toFixed(2)}</span>
                            </div>
                            <div class="creditor-details">
                                <table><thead><tr><th>Date</th><th>Items</th><th>Total Sale</th><th>Balance</th></tr></thead><tbody>${transactionRows}</tbody></table>
                                <div class="payment-form">
                                    <label for="payment-${name.replace(/\s+/g, '-')}" style="white-space: nowrap;">Record Payment:</label>
                                    <input type="number" id="payment-${name.replace(/\s+/g, '-')}" class="payment-amount-input" placeholder="Enter amount" min="0.01" max="${remainingBalance.toFixed(2)}" step="0.01">
                                    <button class="btn btn-success btn-small record-payment-btn" data-creditor-name="${name}">Pay</button>
                                </div>
                            </div>
                        </div>`;
                    this.ui.credit.creditorListContainer.insertAdjacentHTML('beforeend', creditorElementHTML);
                }
            },
             renderHolidays() {
                const holidayListEl = this.ui.settings.holidayList;
                holidayListEl.innerHTML = ''; // Clear existing list

                if (this.state.holidays.length === 0) {
                    holidayListEl.innerHTML = '<li style="text-align:center; color: var(--text-on-dark-secondary); background: none;">No holidays marked yet.</li>';
                    return;
                }
                
                // Sort holidays for consistent display
                const sortedHolidays = [...this.state.holidays].sort();

                sortedHolidays.forEach(holidayDateStr => {
                    const listItem = document.createElement('li');
                    const dateObj = new Date(holidayDateStr + 'T00:00:00'); // Ensure parsing as local date
                    
                    const dateTextSpan = document.createElement('span');
                    dateTextSpan.className = 'holiday-date-text';
                    dateTextSpan.textContent = this.formatDateDDMMYYYY(dateObj);
                    
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'btn btn-danger btn-small delete-holiday-btn';
                    deleteButton.textContent = 'Remove';
                    deleteButton.dataset.date = holidayDateStr;
                    
                    listItem.appendChild(dateTextSpan);
                    listItem.appendChild(deleteButton);
                    holidayListEl.appendChild(listItem);
                });
            },
            createFormItemHTML(isSale) { 
                return isSale
                ? `<div class="form-grid item-entry"><input type="text" class="particulars" placeholder="Item Particulars" list="inventory-datalist" required><input type="number" class="quantity" placeholder="Quantity" min="1" required><input type="number" class="rate" placeholder="Selling Rate" min="0" step="0.01" required></div>`
                : `<div class="form-grid item-entry"><input type="text" class="particulars" placeholder="Item Particulars" required><input type="number" class="quantity" placeholder="Quantity" min="1" required><input type="number" class="rate" placeholder="Cost Rate" min="0" step="0.01" required></div>`; },
            addFormItem(container, isSale) { container.insertAdjacentHTML('beforeend', this.createFormItemHTML(isSale)) },
            handleFileUpload(event) { 
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        this.state.inventory = json.map(row => ({
                            particulars: String(row.particulars || "N/A"), quantity: parseInt(row.quantity, 10) || 0, rate: parseFloat(row.rate) || 0.0,
                        })).filter(item => item.particulars !== "N/A");
                        this.renderAll();
                        this.triggerAutoSave();
                        this.showToast('Inventory loaded successfully!', 'success');
                    } catch (error) { this.showToast('Error reading Excel file. Ensure columns are: particulars, quantity, rate.', 'error'); console.error(error); }
                };
                reader.readAsArrayBuffer(file);
            },
            deleteSale(transactionId) { 
                if (!confirm("Are you sure you want to delete this ENTIRE sale record? All items from this sale will be returned to inventory.")) {
                    return;
                }
                const transactionIndex = this.state.transactions.findIndex(t => t.id === transactionId);
                if (transactionIndex === -1) {
                    this.showToast("Sale not found.", "error");
                    return;
                }
                const transactionToDelete = this.state.transactions[transactionIndex];

                if (transactionToDelete.items && Array.isArray(transactionToDelete.items)) {
                    transactionToDelete.items.forEach(soldItem => {
                        if (soldItem.particulars.startsWith('(Cosmetic)')) return;
                        const inventoryItem = this.state.inventory.find(i => i.particulars === soldItem.particulars);
                        if (inventoryItem) {
                            inventoryItem.quantity += soldItem.quantity;
                        } else {
                            this.state.inventory.push({ particulars: soldItem.particulars, quantity: soldItem.quantity, rate: soldItem.costRate });
                        }
                    });
                }
                this.state.transactions.splice(transactionIndex, 1);
                this.showToast("Sale deleted and all stock restored.", "success");
                this.renderAll();
                this.triggerAutoSave();
            },
            handleSalesReturn(transactionId, itemParticulars) { 
                if (!confirm(`Are you sure you want to return "${itemParticulars}" from this sale? The item will be added back to inventory.`)) {
                    return;
                }
                
                const transaction = this.state.transactions.find(t => t.id === transactionId);
                if (!transaction) { this.showToast("Sale not found.", "error"); return; }

                const itemIndex = transaction.items.findIndex(i => i.particulars === itemParticulars);
                if (itemIndex === -1) { this.showToast("Item not found in this sale.", "error"); return; }

                const [returnedItem] = transaction.items.splice(itemIndex, 1);

                if (!returnedItem.particulars.startsWith('(Cosmetic)')) {
                    const inventoryItem = this.state.inventory.find(i => i.particulars === returnedItem.particulars);
                    if (inventoryItem) {
                        inventoryItem.quantity += returnedItem.quantity;
                    } else {
                        this.state.inventory.push({ particulars: returnedItem.particulars, quantity: returnedItem.quantity, rate: returnedItem.costRate });
                    }
                }

                const returnedValue = returnedItem.quantity * returnedItem.sellingRate;
                transaction.total -= returnedValue;

                if (transaction.paidAmount > transaction.total) {
                    transaction.paidAmount = transaction.total;
                }
                
                if (transaction.items.length === 0) {
                    const transactionIndexGlobal = this.state.transactions.findIndex(t => t.id === transactionId);
                    this.state.transactions.splice(transactionIndexGlobal, 1);
                    this.showToast('Item returned. The sale is now empty and has been removed.', 'success');
                } else {
                    this.showToast('Item returned and stock restored.', 'success');
                }

                this.renderAll();
                this.triggerAutoSave();
            },
            processSale(isInvoice, isCredit = false, creditForm) { 
                const container = isCredit ? creditForm.querySelector('#credit-inventory-items-container') : this.ui.salesItemsContainer;
                const partyName = isCredit ? creditForm.querySelector('#credit-inventory-party-name').value.trim() : null;
                const saleDate = isCredit ? new Date(creditForm.querySelector('#credit-inventory-date').value + 'T00:00:00') : new Date(); // Ensure local time

                if (isCredit && !partyName) { this.showToast("Party Name is required for credit sales.", "error"); return null; }
                if (isCredit && isNaN(saleDate.getTime())) { this.showToast("Please select a valid date for the credit sale.", "error"); return null; }

                const saleItems = [], errors = []; let isValid = true;
                container.querySelectorAll('.item-entry').forEach(entry => {
                    const rawParticulars = entry.querySelector('.particulars').value;
                    const p = this.parseItemNameFromDatalist(rawParticulars);
                    const q = parseInt(entry.querySelector('.quantity').value, 10);
                    const r = parseFloat(entry.querySelector('.rate').value);

                    if (!p || !q || isNaN(r)) return;
                    const item = this.state.inventory.find(i => i.particulars === p);
                    if (!item) { isValid = false; errors.push(`Item not found: ${p}`); }
                    else if (item.quantity < q) { isValid = false; errors.push(`Not enough stock for ${p}. Only ${item.quantity} left.`); }
                    else { saleItems.push({ particulars: p, quantity: q, sellingRate: r, costRate: item.rate }); }
                });

                if (saleItems.length === 0) { this.showToast("Please add at least one valid item.", "error"); return null; }
                if (!isValid) { this.showToast("Sale could not be completed:\n" + errors.join("\n"), "error"); return null; }

                saleItems.forEach(soldItem => {
                    const inventoryItem = this.state.inventory.find(i => i.particulars === soldItem.particulars);
                    inventoryItem.quantity -= soldItem.quantity;
                });
                
                const newTransaction = { id: Date.now(), type: 'Sale', saleType: isCredit ? 'Credit' : 'Cash', partyName: partyName, date: saleDate, items: saleItems, total: saleItems.reduce((acc, soldItem) => acc + (soldItem.sellingRate * soldItem.quantity), 0), paidAmount: 0 };
                this.state.transactions.push(newTransaction);
                this.renderAll(); this.triggerAutoSave();
                
                if (isCredit) { creditForm.reset(); this.ui.credit.inventoryDateInput.value = this.getTodayDateString(); container.innerHTML = ''; this.addFormItem(container, true); } 
                else { this.ui.salesItemsContainer.innerHTML = ''; this.addFormItem(this.ui.salesItemsContainer, true); }

                if (isInvoice) this.generateInvoice(newTransaction);
                this.showToast((isCredit ? 'Credit sale' : 'Sale') + ' recorded successfully!', "success");
            },
            recordPayment(creditorName, amount) { 
                let paymentToApply = amount;
                const creditorTransactions = this.state.transactions.filter(t => t.saleType === 'Credit' && t.partyName === creditorName && (t.total - (t.paidAmount || 0)) > 0.01).sort((a, b) => a.date - b.date);

                if (creditorTransactions.length === 0) { this.showToast("Could not find any outstanding balance for this creditor.", "error"); return; }
                const totalDue = creditorTransactions.reduce((sum, t) => sum + (t.total - (t.paidAmount || 0)), 0);
                if (amount > totalDue + 0.01) { this.showToast(`Payment amount (₹${amount.toFixed(2)}) exceeds the total due amount (₹${totalDue.toFixed(2)}).`, 'error'); return; }

                for (const transaction of creditorTransactions) {
                    if (paymentToApply <= 0) break;
                    const dueOnThisTx = transaction.total - (transaction.paidAmount || 0);
                    const paymentForThisTx = Math.min(paymentToApply, dueOnThisTx);
                    transaction.paidAmount = (transaction.paidAmount || 0) + paymentForThisTx;
                    paymentToApply -= paymentForThisTx;
                }
                
                this.showToast(`Payment of ₹${amount.toFixed(2)} recorded for ${creditorName}.`, 'success');
                this.renderAll();
                this.triggerAutoSave();
            },
            exportTransactionsToExcel() { 
                if (this.state.transactions.length === 0) { this.showToast("No transactions to export.", "error"); return; }
                const salesData = this.state.transactions.filter(t => t.type === 'Sale').flatMap(t => t.items.map(item => ({"Transaction ID": t.id, "Date (DD/MM/YYYY)": this.formatDateDDMMYYYY(t.date), "Sale Type": t.saleType, "Party Name": t.partyName || 'N/A', "Amount Paid": t.paidAmount, "Item Particulars": item.particulars, "Quantity": item.quantity, "Selling Rate (per item)": item.sellingRate, "Cost Rate (per item)": item.costRate, "Total Sale": (item.quantity * item.sellingRate), "Profit": (item.sellingRate - item.costRate) * item.quantity })));
                const purchaseData = this.state.transactions.filter(t => t.type === 'Purchase').flatMap(t => t.items.map(item => ({"Transaction ID": t.id, "Date (DD/MM/YYYY)": this.formatDateDDMMYYYY(t.date), "Item Particulars": item.particulars, "Quantity": item.quantity, "Cost Rate (per item)": item.rate, "Total Purchase": (item.quantity * item.rate) })));
                const profitData = salesData.map(item => ({ "Date (DD/MM/YYYY)": item["Date (DD/MM/YYYY)"], "Item Particulars": item["Item Particulars"], "Quantity": item.Quantity, "Selling Rate": item["Selling Rate (per item)"], "Cost Rate": item["Cost Rate (per item)"], "Total Profit": item.Profit }));
                const wsSales = XLSX.utils.json_to_sheet(salesData); const wsPurchases = XLSX.utils.json_to_sheet(purchaseData); const wsProfit = XLSX.utils.json_to_sheet(profitData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, wsSales, "Sales History"); XLSX.utils.book_append_sheet(wb, wsPurchases, "Purchase History"); XLSX.utils.book_append_sheet(wb, wsProfit, "Profit Details");
                XLSX.writeFile(wb, "Transaction_History.xlsx");
                this.showToast("Transaction history exported successfully!", "success");
            },
            generateInvoice(transaction) { 
                const doc = new jsPDF(); let y = 20;
                doc.setFontSize(22); doc.text("Tinny Fashion Store", 105, y, { align: "center" });
                y += 8; doc.setFontSize(12); doc.text("Run by Rekha ChandraShekhar Mishra", 105, y, { align: "center" });
                y += 15; doc.setFontSize(18); doc.text("Sale Invoice", 105, y, { align: "center" });
                y += 8; doc.setFontSize(10); 
                if (transaction.saleType === 'Credit') { doc.text(`Credit To: ${transaction.partyName}`, 20, y); }
                doc.text(`Date: ${this.formatDateDDMMYYYY(transaction.date)}`, 190, y, { align: "right" });
                y += 15; doc.setFontSize(12); doc.setFont("helvetica", "bold");
                doc.text("Item Description", 20, y); doc.text("Qty", 130, y); doc.text("Rate", 150, y); doc.text("Amount", 185, y, { align: "right" });
                y += 7; doc.setLineWidth(0.5); doc.line(20, y, 190, y); y += 8;
                doc.setFont("helvetica", "normal");
                transaction.items.forEach(item => {
                    const itemTotal = item.quantity * item.sellingRate;
                    doc.text(item.particulars, 20, y); doc.text(item.quantity.toString(), 130, y);
                    doc.text(item.sellingRate.toFixed(2), 150, y); doc.text(itemTotal.toFixed(2), 185, y, { align: "right" }); y += 7;
                });
                y += 5; doc.setLineWidth(0.5); doc.line(130, y, 190, y); y += 7;
                doc.setFont("helvetica", "bold"); doc.text("Grand Total", 130, y);
                doc.text(`Rs. ${transaction.total.toFixed(2)}`, 185, y, { align: "right" });
                doc.save(`Invoice_${transaction.id}.pdf`);
            },
            showToast(msg, type='success') { 
                const toast = document.getElementById('toast');
                toast.textContent = msg;
                toast.className = `show ${type}`;
                setTimeout(() => toast.className = toast.className.replace('show',''), 3000);
            },
            
            addEventListeners() { 
                this.ui.excelFile.addEventListener('change', (e) => this.handleFileUpload(e));
                this.ui.addSaleItemBtn.addEventListener('click', () => this.addFormItem(this.ui.salesItemsContainer, true));
                this.ui.addPurchaseItemBtn.addEventListener('click', () => this.addFormItem(this.ui.purchaseItemsContainer, false));
                this.ui.recordSaleBtn.addEventListener('click', () => this.processSale(false, false));
                this.ui.recordInvoiceBtn.addEventListener('click', () => this.processSale(true, false));
                this.ui.credit.addInventoryItemBtn.addEventListener('click', () => this.addFormItem(this.ui.credit.inventoryItemsContainer, true));
                this.ui.credit.inventorySaleForm.addEventListener('submit', (e) => { e.preventDefault(); this.processSale(false, true, e.target); });
                this.ui.manualSaveBtn.addEventListener('click', () => this.saveData());
                this.ui.analytics.filterBtn.addEventListener('click', () => this.renderFilteredSalesAndProfit());

                const downloadLowStockLogic = () => {
                    const lowStockItems = this.state.inventory.filter(item => item.quantity > 0 && item.quantity <= 5);
                    if (lowStockItems.length === 0) { this.showToast("There are no low stock items (qty <= 5) to download.", "info"); return; }
                    const dataForExcel = lowStockItems.map(item => ({ 'Particulars': item.particulars, 'Quantity Remaining': item.quantity, 'Last Cost Rate': item.rate.toFixed(2) }));
                    const ws = XLSX.utils.json_to_sheet(dataForExcel);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Low Stock Inventory");
                    XLSX.writeFile(wb, "Low_Stock_Inventory.xlsx");
                    this.showToast("Low stock list downloaded!", "success");
                };

                this.ui.analytics.downloadLowStockBtn.addEventListener('click', downloadLowStockLogic);
                if (this.ui.operations.dashboardDownloadLowStockBtn) { 
                    this.ui.operations.dashboardDownloadLowStockBtn.addEventListener('click', downloadLowStockLogic);
                }

                // For Analytics Tab Low Stock Accordion
                this.ui.analytics.lowStockItems.addEventListener('click', (e) => {
                    const categoryTitle = e.target.closest('.low-stock-category-title');
                    if (categoryTitle) {
                        const categoryIndex = categoryTitle.dataset.categoryIndex;
                        if (!categoryIndex) return;

                        const itemsListId = categoryIndex.replace('analytics-', 'analytics-items-');
                        const itemsList = document.getElementById(itemsListId);
                        
                        if (itemsList) {
                            const isExpanded = itemsList.style.display === 'block';
                            itemsList.style.display = isExpanded ? 'none' : 'block';
                            categoryTitle.classList.toggle('expanded', !isExpanded);
                        }
                    }
                });

                // For Operations Tab Dashboard Low Stock Accordion
                if (this.ui.operations.dashboardLowStockItemsUl) {
                    this.ui.operations.dashboardLowStockItemsUl.addEventListener('click', (e) => {
                        const categoryHeader = e.target.closest('.dashboard-category-header');
                        if (categoryHeader) {
                            const categoryIndex = categoryHeader.dataset.categoryIndex;
                            if(!categoryIndex) return;

                            const itemsListId = categoryIndex.replace('dashboard-', 'dashboard-items-');
                            const itemsList = document.getElementById(itemsListId);
                            
                            if (itemsList) { 
                                const isExpanded = itemsList.style.display === 'block';
                                itemsList.style.display = isExpanded ? 'none' : 'block';
                                categoryHeader.classList.toggle('expanded', !isExpanded);
                            }
                        }
                    });
                }
                
                // Sales Trend Controls
                this.ui.operations.salesTrendModeSelect.addEventListener('change', () => {
                    const mode = this.ui.operations.salesTrendModeSelect.value;
                    if (mode === 'customRange') {
                        this.ui.operations.salesTrendCustomRangeInputs.style.display = 'flex';
                    } else {
                        this.ui.operations.salesTrendCustomRangeInputs.style.display = 'none';
                    }
                    this.renderSalesTrendChart(); // Re-render on mode change
                });
                this.ui.operations.refreshSalesTrendBtn.addEventListener('click', () => this.renderSalesTrendChart());


                // Holiday Management Event Listeners
                this.ui.settings.addHolidayBtn.addEventListener('click', () => {
                    const holidayDateStr = this.ui.settings.holidayDateInput.value;
                    if (!holidayDateStr) {
                        this.showToast("Please select a date for the holiday.", "error");
                        return;
                    }
                    if (this.state.holidays.includes(holidayDateStr)) {
                        this.showToast("This date is already marked as a holiday.", "info");
                        return;
                    }
                    this.state.holidays.push(holidayDateStr);
                    this.renderHolidays();
                    this.triggerAutoSave();
                    this.showToast("Holiday added successfully!", "success");
                    this.ui.settings.holidayDateInput.value = ''; // Clear input
                });

                this.ui.settings.holidayList.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-holiday-btn')) {
                        const holidayDateToDelete = e.target.dataset.date;
                        this.state.holidays = this.state.holidays.filter(dateStr => dateStr !== holidayDateToDelete);
                        this.renderHolidays();
                        this.triggerAutoSave();
                        this.showToast("Holiday removed.", "success");
                    }
                });


                this.ui.credit.cosmeticSaleForm.addEventListener('submit', (e) => { 
                    e.preventDefault();
                    const form = e.target;
                    const partyName = form.querySelector('#credit-cosmetic-party-name').value.trim();
                    const saleDateStr = form.querySelector('#credit-cosmetic-date').value;
                    const itemName = form.querySelector('#credit-cosmetic-item-name').value.trim();
                    const quantity = parseInt(form.querySelector('#credit-cosmetic-qty').value, 10);
                    const costRate = parseFloat(form.querySelector('#credit-cosmetic-cost-rate').value);
                    const sellRate = parseFloat(form.querySelector('#credit-cosmetic-sell-rate').value);
                    
                    if (!saleDateStr) {
                        this.showToast("Please select a valid date for the cosmetic credit sale.", "error"); return;
                    }
                    const saleDate = new Date(saleDateStr + 'T00:00:00'); // Ensure local time

                    if (!partyName || !itemName || isNaN(quantity) || isNaN(costRate) || isNaN(sellRate) || quantity <= 0 || isNaN(saleDate.getTime())) {
                        this.showToast("Please fill all fields correctly for the cosmetic credit sale.", "error"); return;
                    }

                    const cosmeticItem = { particulars: `(Cosmetic) ${itemName}`, quantity, sellingRate: sellRate, costRate };
                    this.state.transactions.push({ id: Date.now(), type: 'Sale', saleType: 'Credit', partyName: partyName, date: saleDate, items: [cosmeticItem], total: sellRate * quantity, paidAmount: 0 });
                    this.renderAll(); this.triggerAutoSave();
                    form.reset(); this.ui.credit.cosmeticDateInput.value = this.getTodayDateString();
                    this.showToast(`Cosmetic credit sale to ${partyName} recorded!`, 'success');
                });
                this.ui.transactions.exportExcelBtn.addEventListener('click', () => this.exportTransactionsToExcel());
                this.ui.transactions.filterBtn.addEventListener('click', () => this.renderTransactions());
                this.ui.transactions.resetFilterBtn.addEventListener('click', () => { this.ui.transactions.startDateInput.value = ''; this.ui.transactions.endDateInput.value = ''; this.renderTransactions(); });
                this.ui.transactions.transactionSortOrder.addEventListener('change', () => this.renderTransactions());
                this.ui.credit.creditorListContainer.addEventListener('click', (e) => { 
                    const creditorHeader = e.target.closest('.creditor-header');
                    const recordButton = e.target.closest('.record-payment-btn');

                    if (creditorHeader) {
                        const details = creditorHeader.nextElementSibling;
                        const creditorItem = creditorHeader.closest('.creditor-item'); 
                        
                        details.classList.toggle('visible');
                        creditorHeader.classList.toggle('is-open'); 
                        if (creditorItem) { 
                            creditorItem.classList.toggle('is-expanded'); 
                        }
                    } else if (recordButton) {
                        const creditorName = recordButton.dataset.creditorName;
                        const paymentInput = recordButton.closest('.payment-form').querySelector('.payment-amount-input');
                        const amountToPay = parseFloat(paymentInput.value);

                        if (isNaN(amountToPay) || amountToPay <= 0) {
                            this.showToast('Please enter a valid payment amount.', 'error');
                            return;
                        }
                        this.recordPayment(creditorName, amountToPay);
                        paymentInput.value = '';
                    }
                });
                this.ui.cosmeticSaleForm.addEventListener('submit', (e) => { 
                    e.preventDefault();
                    const particulars = e.target.querySelector('#cosmetic-particulars').value.trim();
                    const quantity = parseInt(e.target.querySelector('#cosmetic-quantity').value, 10);
                    const costRate = parseFloat(e.target.querySelector('#cosmetic-cost-rate').value);
                    const sellRate = parseFloat(e.target.querySelector('#cosmetic-sell-rate').value);

                    if (!particulars || isNaN(quantity) || isNaN(costRate) || isNaN(sellRate) || quantity <= 0) {
                        this.showToast("Please fill all fields correctly. Quantity must be > 0.", "error");
                        return;
                    }
                    
                    const cosmeticItem = { particulars: `(Cosmetic) ${particulars}`, quantity, sellingRate: sellRate, costRate };
                    const totalSale = sellRate * quantity;

                    this.state.transactions.push({ id: Date.now(), type: 'Sale', saleType: 'Cash', partyName: null, date: new Date(), items: [cosmeticItem], total: totalSale });
                    this.renderAll();
                    this.triggerAutoSave();
                    this.ui.cosmeticSaleForm.reset();
                    this.showToast(`Profit recorded successfully!`, "success");
                });
                this.ui.purchaseForm.addEventListener('submit', (event) => { 
                    event.preventDefault();
                    const { newItems, total } = Array.from(this.ui.purchaseItemsContainer.querySelectorAll('.item-entry')).reduce((acc, entry) => {
                        const p = entry.querySelector('.particulars').value, q = parseInt(entry.querySelector('.quantity').value, 10), r = parseFloat(entry.querySelector('.rate').value);
                        if (p && q && !isNaN(r)) { acc.newItems.push({ particulars: p, quantity: q, rate: r }); acc.total += q * r; }
                        return acc;
                    }, { newItems: [], total: 0 });
                    if (newItems.length === 0) return this.showToast("Please fill out all fields for at least one item.", "error");
                    
                    newItems.forEach(newItem => {
                        const existing = this.state.inventory.find(i => i.particulars.toLowerCase() === newItem.particulars.toLowerCase());
                        if (existing) {
                            const totalExistingValue = existing.rate * existing.quantity; const totalNewValue = newItem.rate * newItem.quantity;
                            const totalQuantity = existing.quantity + newItem.quantity;
                            existing.rate = (totalExistingValue + totalNewValue) / totalQuantity; existing.quantity = totalQuantity;
                        } else { this.state.inventory.push(newItem); }
                    });
                    this.state.transactions.push({ id: Date.now(), type: 'Purchase', date: new Date(), items: newItems, total });
                    this.renderAll(); this.triggerAutoSave();
                    this.ui.purchaseItemsContainer.innerHTML = ''; this.addFormItem(this.ui.purchaseItemsContainer, false);
                    this.showToast('Stock updated!', "success");
                });
                this.ui.tabButtons.forEach(button => button.addEventListener('click', () => { 
                    this.ui.tabButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active');
                    this.ui.tabContents.forEach(content => content.classList.remove('active')); document.getElementById(button.dataset.tab).classList.add('active');
                    if (button.dataset.tab === 'operations' && typeof Chart !== 'undefined' && this.ui.operations.salesTrendChart) { 
                        this.renderSalesTrendChart();
                    }
                }));
                document.body.addEventListener('input', e => { 
                    if (e.target.classList.contains('particulars')) {
                        const particularsValue = this.parseItemNameFromDatalist(e.target.value);
                        const item = this.state.inventory.find(i => i.particulars === particularsValue);
                        const rateInput = e.target.closest('.item-entry').querySelector('.rate');
                        if (item && rateInput && e.target.closest('#sales-form, #credit-inventory-sale-form')) {
                            const sellingRate = item.sellingRate || item.rate; 
                            rateInput.value = sellingRate.toFixed(2);
                        }
                    }
                });
                this.ui.transactions.transactionsTab.addEventListener('click', e => { 
                    if (e.target.classList.contains('download-invoice-btn')) {
                        const tx = this.state.transactions.find(t => t.id === parseInt(e.target.dataset.id, 10));
                        if (tx) this.generateInvoice(tx);
                    } else if (e.target.classList.contains('delete-sale-btn')) {
                        const transactionId = parseInt(e.target.dataset.id, 10);
                        this.deleteSale(transactionId);
                    } else if (e.target.classList.contains('return-item-btn')) {
                        const transactionId = parseInt(e.target.dataset.transactionId, 10);
                        const itemParticulars = e.target.dataset.itemParticulars;
                        this.handleSalesReturn(transactionId, itemParticulars);
                    }
                });
                this.ui.inventoryTableBody.addEventListener('click', (e) => { 
                    const particulars = e.target.dataset.particulars; const targetRow = e.target.closest('tr');
                    if (!targetRow) return;
                    if (e.target.classList.contains('edit-btn')) {
                        const currentlyEditing = this.ui.inventoryTableBody.querySelector('tr.edit-mode');
                        if(currentlyEditing) currentlyEditing.classList.remove('edit-mode');
                        targetRow.classList.add('edit-mode');
                    } else if (e.target.classList.contains('cancel-btn')) {
                        targetRow.classList.remove('edit-mode');
                    } else if (e.target.classList.contains('delete-btn')) {
                        if (confirm(`Are you sure you want to delete "${particulars}"? This action cannot be undone.`)) {
                            this.state.inventory = this.state.inventory.filter(item => item.particulars !== particulars);
                            this.renderAll(); this.triggerAutoSave();
                            this.showToast('Item deleted.', 'success');
                        }
                    } else if (e.target.classList.contains('save-btn')) {
                        const newQty = parseInt(targetRow.querySelector('.edit-quantity').value, 10);
                        const newRate = parseFloat(targetRow.querySelector('.edit-rate').value);
                        if (isNaN(newQty) || isNaN(newRate) || newQty < 0 || newRate < 0) { this.showToast('Invalid input for quantity or rate.', 'error'); return; }
                        const itemToUpdate = this.state.inventory.find(item => item.particulars === particulars);
                        if (itemToUpdate) { itemToUpdate.quantity = newQty; itemToUpdate.rate = newRate; }
                        this.renderAll(); this.triggerAutoSave();
                        this.showToast('Inventory updated successfully!', 'success');
                    }
                });
            }
        };
        app.init();
    };
    </script>
</body>
</html>
