
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tinny Fashion Store - Complete Business Manager</title>
   <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3crect width='100' height='100' rx='15' fill='%2314B8A6'/%3e%3cpath fill='white' d='M20 30h60l-10 50H30zM50 20c-8 0-15 7-15 15v5h30v-5c0-8-7-15-15-15zM30 40c0 5 5 10 10 10h20c5 0 10-5 10-10'/%3e%3c/svg%3e">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <style>
        :root {
            --bg-primary: #111827;      /* Primary App Background */
            --bg-secondary: #1f2937;    /* Card, Header Background */
            --bg-tertiary: #374151;     /* Input, Hover Background */
            
            --text-primary: #f9fafb;      /* Brightest Text */
            --text-secondary: #d1d5db;    /* Subtitles, Body Text */
            --text-muted: #9ca3af;        /* Placeholders, Muted Info */

            --accent-primary: #14B8A6;    /* Teal-500 */
            --accent-primary-darker: #0D9488; /* Teal-600 */
            --accent-yellow: #F59E0B;     /* Amber-500 */
            --accent-pink: #EC4899;       /* Pink-500 */
            
            --status-success: #22c55e;    /* Green-500 */
            --status-danger: #ef4444;     /* Red-500 */
            --status-info: #3b82f6;       /* Blue-500 */

            --border-primary: #4b5563;    /* Gray-600 */
            --border-focus: var(--accent-primary);

            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-inner: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);
        }

        * { box-sizing: border-box; }
        html { height: 100%; scroll-behavior: smooth; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #login-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; width: 100%; text-align: center; padding: 2rem;
            background: var(--bg-secondary);
            background-image: radial-gradient(circle at top right, var(--accent-primary) -20%, transparent 50%),
                              radial-gradient(circle at bottom left, var(--accent-yellow) -20%, transparent 50%);
        }
        .login-box {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            padding: 3rem; border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            max-width: 450px; width: 100%;
            border: 1px solid var(--border-primary);
        }
        .login-box .store-logo { font-size: 2.25rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem; letter-spacing: -1px; }
        .login-box .store-logo span { background-color: var(--accent-primary); color: var(--bg-secondary); border-radius: var(--radius-sm); padding: 0.1em 0.3em; margin-right: 0.1em; }
        .login-box h1 { color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.75rem; font-weight: 700; }
        .login-box p { color: var(--text-muted); margin-bottom: 2rem; }
        #signin-btn { background-color: #4285F4; color: white; border: none; padding: 14px 28px; font-size: 1rem; font-weight: 500; border-radius: var(--radius-md); cursor: pointer; display: inline-flex; align-items: center; gap: 1rem; transition: background-color 0.3s, transform 0.2s; box-shadow: var(--shadow-md); }
        #signin-btn:hover:not([disabled]) { background-color: #357ae8; transform: translateY(-2px); }
        #signin-btn:active:not([disabled]) { transform: translateY(0); }
        #signin-btn[disabled] { background-color: var(--bg-tertiary); color: var(--text-muted); cursor: not-allowed; }
        #signin-btn svg { width: 24px; height: 24px; background: white; border-radius: 50%; padding: 2px; }
        #auth-status { margin-top: 1.5rem; font-size: 0.9rem; color: var(--text-muted); }
        
        #app-container { display: none; padding: 1.5rem; max-width: 1400px; margin-inline: auto; }
        #app-container.visible { display: block; animation: fadeInApp 0.5s ease-out; }
        @keyframes fadeInApp { from { opacity: 0; } to { opacity: 1; } }

        header {
            background-color: var(--bg-secondary);
            padding: 1rem 1.5rem; border-radius: var(--radius-lg);
            margin-bottom: 2rem; box-shadow: var(--shadow-md);
            display: flex; justify-content: space-between; align-items: center;
        }
        header .header-title-group h1 { margin: 0; font-weight: 700; font-size: 1.5rem; color: var(--text-primary); }
        .user-profile { display: flex; align-items: center; gap: 1rem; }
        .user-profile span { font-weight: 500; font-size: 0.9rem; color: var(--text-secondary); }
        #signout-btn { font-size: 0.85rem; color: var(--accent-yellow); cursor: pointer; background: transparent; border: 1px solid var(--accent-yellow); border-radius: var(--radius-md); padding: 8px 14px; font-weight: 600; transition: background-color 0.2s, color 0.2s; }
        #signout-btn:hover { background-color: var(--accent-yellow); color: var(--bg-primary); }
        .low-stock-alert { display: none; }

        .tab-nav {
            display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;
            margin-bottom: 2rem; padding: 0.5rem; border-radius: var(--radius-lg);
            background-color: var(--bg-secondary); box-shadow: var(--shadow-sm);
        }
        .tab-button {
            padding: 10px 20px; cursor: pointer; border: none; background-color: transparent;
            font-size: 0.95rem; font-weight: 500; color: var(--text-muted);
            border-radius: var(--radius-md); transition: color 0.3s, background-color 0.2s;
            position: relative;
        }
        .tab-button:hover { color: var(--text-primary); background-color: var(--bg-tertiary); }
        .tab-button.active { color: var(--bg-primary); background-color: var(--accent-primary); font-weight: 600; box-shadow: var(--shadow-md); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeInContent 0.5s ease; }
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background-color: var(--bg-secondary);
            border-radius: var(--radius-lg); padding: 1.5rem 2rem;
            box-shadow: var(--shadow-md); margin-bottom: 2rem;
            border: 1px solid var(--border-primary);
        }
        .card h2 {
            color: var(--accent-primary); font-weight: 600; font-size: 1.25rem; margin-top: 0;
            border-bottom: 1px solid var(--border-primary); padding-bottom: 1rem; margin-bottom: 1.5rem;
        }

        .form-grid, .cosmetic-form-grid, .cosmetic-credit-form-grid, .form-row {
            display: grid; gap: 1rem;
        }
        .form-grid { grid-template-columns: 2fr 1fr 1fr; margin-bottom: 1rem; }
        .cosmetic-form-grid { grid-template-columns: 2fr 1fr 1fr 1fr; margin-bottom: 1rem; }
        .cosmetic-credit-form-grid { grid-template-columns: 1.5fr 1fr 2fr 1fr 1fr 1fr; margin-bottom: 1rem; }
        .form-row { grid-template-columns: 1fr 1fr; }

        .card label {
            display: block; font-size: 0.9rem; color: var(--text-secondary);
            margin-bottom: 0.5rem; font-weight: 500;
        }

        .card input[type="text"], .card input[type="number"], .card input[type="file"], .card input[type="date"], .card input[type="month"], .card select {
            width: 100%; padding: 12px 15px; border: 1px solid var(--border-primary);
            border-radius: var(--radius-md); font-size: 0.95rem; 
            font-family: 'Inter', sans-serif; background-color: var(--bg-tertiary);
            color: var(--text-primary); transition: all 0.2s ease;
            box-shadow: var(--shadow-inner);
        }
        .card input:focus-visible, .card select:focus-visible {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.3);
        }
        .card input[type="file"] { border-color: transparent; background-color: var(--bg-tertiary); cursor: pointer; }
        .card input[type="file"]:hover { background-color: #4b5563; }
        .card input::placeholder { color: var(--text-muted); }
        
        #add-sale-item-btn, #add-purchase-item-btn, #add-credit-inventory-item-btn {
            background-color: transparent; color: var(--accent-primary); border: 2px dashed var(--border-primary);
            font-weight: 600; text-transform: none; padding: 10px 15px; margin-top: 10px; margin-bottom: 20px;
            width: 100%; border-radius: var(--radius-md); transition: all 0.2s;
        }
        #add-sale-item-btn:hover, #add-purchase-item-btn:hover, #add-credit-inventory-item-btn:hover { background-color: var(--bg-tertiary); border-color: var(--accent-primary); }

        .btn {
            padding: 12px 20px; border-radius: var(--radius-md); border: none; font-size: 0.9rem;
            font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer;
            transition: all 0.2s ease; box-shadow: var(--shadow-sm);
        }
        .btn:hover:not([disabled]) { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .btn:active:not([disabled]) { box-shadow: var(--shadow-sm); transform: translateY(0px); }
        .btn[disabled] { background-color: var(--text-muted); color: var(--bg-secondary); cursor: not-allowed; opacity: 0.7; box-shadow: none; }
        
        .btn-primary { background-color: var(--accent-primary); color: var(--bg-primary); }
        .btn-primary:hover:not([disabled]) { background-color: var(--accent-primary-darker); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover:not([disabled]) { background-color: #4b5563; }
        .btn-success { background-color: var(--status-success); color: white; }
        .btn-success:hover:not([disabled]) { background-color: #16a34a; }
        .btn-danger { background-color: var(--status-danger); color: white; }
        .btn-danger:hover:not([disabled]) { background-color: #dc2626; }
        .btn-info { background-color: var(--status-info); color: white; }
        .btn-info:hover:not([disabled]) { background-color: #2563eb; }
        .btn-small { padding: 8px 14px; font-size: 0.8rem; }
        .sales-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem; }

        .table-container { 
            max-height: 450px; overflow-y: auto; 
            border: 1px solid var(--border-primary); border-radius: var(--radius-lg); 
            background-color: var(--bg-primary);
        }
        .styled-table { width: 100%; border-collapse: collapse; border-spacing: 0; }
        .styled-table th, .styled-table td { padding: 14px 16px; text-align: left; font-size: 0.9rem; vertical-align: middle; color: var(--text-secondary); border-bottom: 1px solid var(--border-primary); }
        .styled-table th { background-color: var(--bg-tertiary); color: var(--accent-primary); font-weight: 600; position: sticky; top: 0; z-index: 1; }
        .styled-table tr:hover td { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .styled-table tr:last-child td { border-bottom: none; }
        .styled-table td ul { margin: 0; padding-left: 1rem; list-style-type: disc; }
        .profit-col { font-weight: 600; color: var(--status-success) !important; }
        .credit-label { font-size: 0.75rem; font-weight: 600; color: var(--bg-primary); background-color: var(--status-info); padding: 4px 8px; border-radius: var(--radius-sm); display: inline-block; margin-top: 8px; }
        tr.is-low-stock td { background-color: rgba(245, 158, 11, 0.1); border-left: 4px solid var(--accent-yellow); color: var(--accent-yellow) !important; }
        .low-stock-badge { background-color: var(--accent-yellow); color: var(--bg-primary); font-weight: 600; font-size: 0.7rem; padding: 3px 8px; border-radius: 12px; margin-left: 8px; }

        .analytics-grid, .dashboard-overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; }
        .metric-card, .overview-card { 
            background: var(--bg-secondary); padding: 1.5rem;
            border-radius: var(--radius-lg); box-shadow: var(--shadow-md); 
            border: 1px solid var(--border-primary);
            transition: transform 0.2s, box-shadow 0.2s; 
        }
        .metric-card:hover, .overview-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .metric-card h3, .overview-card h4 { margin: 0 0 10px; color: var(--text-muted); font-size: 0.9rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-card p, .overview-value { font-size: 2.25rem; margin: 0; color: var(--accent-primary); font-weight: 700; }
        .overview-card #overview-low-stock .overview-value, .overview-card #overview-inventory-value .overview-value { color: var(--accent-yellow); }

        #toast { position: fixed; bottom: -120px; left: 50%; transform: translateX(-50%); padding: 14px 25px; border-radius: var(--radius-md); color: var(--bg-primary); font-weight: 600; font-size: 0.95rem; box-shadow: var(--shadow-lg); transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 9999; opacity: 0; }
        #toast.show { bottom: 25px; opacity: 1; }
        #toast.success { background-color: var(--status-success); color: white; }
        #toast.error { background-color: var(--status-danger); color: white; }
        #toast.info { background-color: var(--status-info); color: white; }

        .creditor-item { background-color: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: var(--radius-lg); margin-bottom: 1rem; box-shadow: var(--shadow-sm); overflow: hidden; transition: box-shadow 0.2s; }
        .creditor-item.is-expanded { box-shadow: var(--shadow-lg); }
        .creditor-header { display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 1.1rem; cursor: pointer; padding: 1rem 1.5rem; transition: background-color 0.2s; }
        .creditor-header .creditor-balance { color: var(--accent-yellow); }
        .creditor-header:hover { background-color: var(--bg-tertiary); }
        .creditor-header::after { content: '▼'; color: var(--text-muted); transition: transform 0.3s ease; }
        .creditor-header.is-open::after { transform: rotate(180deg); color: var(--accent-primary); }
        .creditor-details { display: none; padding: 1.5rem; background-color: var(--bg-primary); border-top: 1px solid var(--border-primary); }
        .creditor-details.visible { display: block; }
        .creditor-details table { width: 100%; margin-bottom: 1rem; }
        .creditor-details th, .creditor-details td { padding: 10px; border-bottom: 1px solid var(--border-primary); color: var(--text-secondary); }
        .creditor-details th { color: var(--accent-primary); background-color: var(--bg-tertiary); }

        .dashboard-main-area { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-top: 2rem; margin-bottom: 2rem; }
        .action-forms-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; }
        .credit-layout, .operations-layout { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        .chart-canvas-wrapper { position: relative; min-height: 280px; flex-grow: 1; }

        .dashboard-low-stock-list.card { padding-bottom: 1rem; }
        .dashboard-low-stock-list .list-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid var(--border-primary); margin-bottom: 1rem; }
        .dashboard-low-stock-list .list-header h2 { border: none; padding: 0; margin: 0; font-size: 1.1rem; }
        #dashboard-low-stock-items-ul { list-style: none; padding: 0; margin: 0; max-height: 350px; overflow-y: auto; }
        .item-icon-placeholder { width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: var(--radius-sm); margin-right: 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        #dashboard-low-stock-items-ul .dashboard-items-in-category li { display: flex; align-items: center; padding: 0.75rem; border-radius: var(--radius-md); transition: background-color 0.2s; }
        #dashboard-low-stock-items-ul .dashboard-items-in-category li:hover { background-color: var(--bg-tertiary); }
        .item-details .item-name { display: block; font-weight: 500; color: var(--text-primary); font-size: 0.95rem; }
        .item-details .item-sub-detail { color: var(--text-muted); font-size: 0.85rem; }
        .item-stock-level { font-weight: 600; color: var(--accent-yellow); margin-left: auto; }
        
        .dashboard-category-header { padding: 10px; background-color: var(--bg-tertiary); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; border-radius: var(--radius-md); margin-bottom: 0.5rem; }
        .dashboard-category-header:hover { background-color: #4b5563; }
        .dashboard-category-header h5 { margin: 0; color: var(--accent-pink); font-size: 1rem; }
        .category-toggle-indicator { transition: transform 0.2s ease-out; }
        .dashboard-category-header.expanded .category-toggle-indicator { transform: rotate(90deg); }
        
        #low-stock-items.metric-card { padding: 0; background: transparent; border: none; box-shadow: none; }
        .categorized-low-stock-container .low-stock-category-group { margin-bottom: 1rem; }
        .low-stock-category-title { color: var(--text-primary); background-color: var(--bg-tertiary); padding: 12px; border-radius: var(--radius-md); cursor: pointer; display: flex; justify-content: space-between; }
        .low-stock-items-in-category { list-style-type: none; padding: 0.5rem; margin-top: 0.5rem; background-color: var(--bg-primary); border-radius: var(--radius-md); }
        .low-stock-items-in-category li { padding: 10px; border-bottom: 1px dashed var(--border-primary); font-size: 0.9rem; }
        
        @media (max-width: 1024px) {
            .dashboard-main-area { grid-template-columns: 1fr; }
            .action-forms-section, .credit-layout { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            #app-container { padding: 1rem; }
            header { flex-direction: column; gap: 1rem; }
            .form-grid, .cosmetic-form-grid, .cosmetic-credit-form-grid, .form-row, .sales-actions { grid-template-columns: 1fr; }
            .card { padding: 1.5rem; }
            #demand-forecasting-form, .analytics-chart-container .chart-controls { grid-template-columns: 1fr; }
        }
         @media (max-width: 480px) {
            body { font-size: 0.95rem; }
            #app-container { padding: 0.5rem; }
            .card { padding: 1rem; }
            .login-box { padding: 2rem 1.5rem; }
            .login-box h1 { font-size: 1.5rem; }
            .btn { padding: 10px 16px; font-size: 0.85rem; }
        }

        /* Keep existing non-layout selectors to prevent breaking functionality */
        #settings .card input[type="file"] { margin-top: 15px; }
        #holiday-management-section { margin-top: 20px; }
        .table-container { max-height: 450px; }
        tr.edit-mode .display-value, tr:not(.edit-mode) .edit-field { display: none; }
        tr:not(.edit-mode) .save-btn, tr:not(.edit-mode) .cancel-btn { display: none; }
        tr.edit-mode .edit-btn, tr.edit-mode .delete-btn { display: none; }
        .edit-input { max-width: 90px; }
    </style>
</head>
<!-- THE REST OF THE HTML BODY REMAINS UNCHANGED -->
<body>
    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-box">
            <div class="store-logo"><span>T</span>inny Fashion</div>
            <h1>Welcome Back!</h1>
            <p>Manage your fashion store with ease.</p>
            <p style="color: var(--text-muted); margin-bottom: 2rem; font-size: 0.9rem;">Sign in with Google to access your dashboard.</p>
            <button id="signin-btn" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 35.841 44 30.138 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                Sign in with Google
            </button>
            <p id="auth-status" style="margin-top: 1.5rem; font-size: 0.9rem;">Initializing...</p>
        </div>
    </div>
    <!-- MAIN APP CONTAINER -->
    <div id="app-container">
        <header>
            <div id="low-stock-alert-container" class="low-stock-alert">
                Low Stock: <span id="low-stock-counter">0</span>
            </div>
            <div class="header-title-group">
                <h1>Tinny Fashion Store</h1>
            </div>
            <div id="user-profile-container" class="user-profile" style="display: none;">
                <div>
                    <span id="user-name"></span>
                    <button id="signout-btn">Sign Out</button>
                </div>
            </div>
        </header>

        <nav class="tab-nav">
            <button class="tab-button active" data-tab="operations">Operations</button>
            <button class="tab-button" data-tab="credit">Credit</button>
            <button class="tab-button" data-tab="analytics">Analytics</button>
            <button class="tab-button" data-tab="profit">Profit</button>
            <button class="tab-button" data-tab="transactions">Transactions</button>
            <button class="tab-button" data-tab="settings">Settings</button>
        </nav>

        <main>
            <!-- Operations Tab -->
            <div id="operations" class="tab-content active">
                <section class="dashboard-overview-grid">
                    <div class="overview-card" id="overview-current-stock">
                        <h4>Current Stock</h4>
                        <p class="overview-value" id="dashboard-total-units">0</p>
                    </div>
                    <div class="overview-card" id="overview-low-stock">
                        <h4>Low in Stock</h4>
                        <p class="overview-value" id="dashboard-low-stock-count">0</p>
                    </div>
                    <div class="overview-card" id="overview-inventory-value">
                        <h4>Inventory Value</h4>
                        <p class="overview-value" id="dashboard-inventory-value">₹0.00</p>
                    </div>
                </section>
                <section class="dashboard-main-area">
                    <div class="card">
                        <h2>Sales Trend</h2>
                         <div id="sales-trend-controls" style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                            <label for="sales-trend-mode" style="margin-bottom: 0; color: var(--text-secondary);">View:</label>
                            <select id="sales-trend-mode" style="padding: 8px 10px; font-size: 0.9rem; max-width: 150px;">
                                <option value="last7days" selected>Last 7 Days</option>
                                <option value="currentMonth">Current Month</option>
                                <option value="customRange">Custom Range</option>
                            </select>
                            <div id="sales-trend-custom-range-inputs" style="display:none; gap: 10px; align-items: center;">
                                <input type="date" id="sales-trend-start-date" style="padding: 8px 10px; font-size: 0.9rem;">
                                <span style="color: var(--text-secondary);">-</span>
                                <input type="date" id="sales-trend-end-date" style="padding: 8px 10px; font-size: 0.9rem;">
                            </div>
                            <button id="refresh-sales-trend-btn" class="btn btn-secondary btn-small" style="margin-left:auto;">Refresh</button>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="salesTrendChart"></canvas>
                        </div>
                        <div class="quick-stats-grid" style="padding-top: 15px; border-top: 1px solid var(--border-primary); font-size: 0.9rem;">
                            <div><span>Total Revenue (All Time):</span> <strong id="dashboard-total-revenue" style="color: var(--text-primary);">₹0.00</strong></div>
                            <div><span>Total Profit (All Time):</span> <strong id="dashboard-total-profit" style="color: var(--accent-primary);">₹0.00</strong></div>
                        </div>
                    </div>
                    <div class="dashboard-low-stock-list card">
                        <div class="list-header">
                            <h2>Products Low in Stock</h2>
                            <button class="btn btn-primary btn-small" id="dashboard-download-low-stock-btn">Download</button>
                        </div>
                        <ul id="dashboard-low-stock-items-ul">
                            <li><p style="text-align:center; color: var(--text-muted);">No low stock items.</p></li>
                        </ul>
                    </div>
                </section>
                <div class="action-forms-section">
                    <section class="card">
                        <h2>Make a Sale (From Inventory)</h2>
                        <form id="sales-form">
                            <div id="sales-items-container"></div>
                            <datalist id="inventory-datalist"></datalist>
                            <button type="button" id="add-sale-item-btn" class="btn">+ Add Item</button>
                            <div class="sales-actions">
                                <button type="button" id="record-sale-btn" class="btn btn-secondary">Record Sale</button>
                                <button type="button" id="record-invoice-btn" class="btn btn-primary">Record & Print</button>
                            </div>
                        </form>
                    </section>
                    <section class="card">
                        <h2>Add New Stock (Purchase)</h2>
                        <form id="purchase-form">
                            <div id="purchase-items-container"></div>
                            <button type="button" id="add-purchase-item-btn" class="btn">+ Add Item</button>
                            <button type="submit" class="btn btn-primary">Add to Stock</button>
                        </form>
                    </section>
                </div>
                <div class="operations-layout">
                    <section class="card">
                        <h2>Cosmetic & Non-Inventory Sale</h2>
                        <form id="cosmetic-sale-form">
                            <div class="cosmetic-form-grid">
                                <input type="text" id="cosmetic-particulars" placeholder="Item Particulars" required>
                                <input type="number" id="cosmetic-quantity" placeholder="Quantity" min="1" required>
                                <input type="number" id="cosmetic-cost-rate" placeholder="Cost Rate (per item)" min="0" step="0.01" required>
                                <input type="number" id="cosmetic-sell-rate" placeholder="Selling Rate (per item)" min="0" step="0.01" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Record Profit</button>
                        </form>
                    </section>
                </div>
            </div>
            <!-- Credit Tab -->
            <div id="credit" class="tab-content">
                <div class="credit-layout">
                    <section class="card">
                        <h2>Credit Sale (From Inventory)</h2>
                        <form id="credit-inventory-sale-form">
                            <div class="form-row">
                                <div>
                                    <label for="credit-inventory-party-name">Party Name</label>
                                    <input type="text" id="credit-inventory-party-name" placeholder="Enter party's name" required>
                                </div>
                                <div>
                                    <label for="credit-inventory-date">Transaction Date</label>
                                    <input type="date" id="credit-inventory-date" required>
                                </div>
                            </div>
                            <div id="credit-inventory-items-container"></div>
                            <button type="button" id="add-credit-inventory-item-btn" class="btn">+ Add More Items</button>
                            <button type="submit" class="btn btn-primary" style="margin-top:1rem;">Record Credit Sale</button>
                        </form>
                    </section>

                    <section class="card">
                        <h2>Cosmetics Sales on Credit</h2>
                        <form id="credit-cosmetic-sale-form">
                            <div class="cosmetic-credit-form-grid">
                            <div><label>Party Name</label><input type="text" id="credit-cosmetic-party-name" placeholder="Party's Name" required></div>
                            <div><label>Date</label><input type="date" id="credit-cosmetic-date" required></div>
                            <div><label>Item Name</label><input type="text" id="credit-cosmetic-item-name" placeholder="e.g., Lipstick" required></div>
                            <div><label>Quantity</label><input type="number" id="credit-cosmetic-qty" placeholder="Qty" min="1" required></div>
                            <div><label>Cost Rate</label><input type="number" id="credit-cosmetic-cost-rate" placeholder="Cost per item" min="0" step="0.01" required></div>
                            <div><label>Sell Rate</label><input type="number" id="credit-cosmetic-sell-rate" placeholder="Sell per item" min="0" step="0.01" required></div>
                            </div>
                            <button type="submit" class="btn btn-primary">Record Cosmetic Credit Sale</button>
                        </form>
                    </section>
                    <section class="card" id="creditor-list-section">
                        <h2>Creditor List</h2>
                        <div id="creditor-list-container">
                             <p style="text-align:center; color: var(--text-muted);">No outstanding credit balances.</p>
                        </div>
                    </section>
                </div>
            </div>
            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                <section class="card">
                    <h2>Shop Performance At a Glance</h2>
                    <div class="analytics-grid">
                        <div class="metric-card"><h3>Total Profit</h3><p id="total-profit">₹0.00</p></div>
                        <div class="metric-card"><h3>Total Revenue</h3><p id="total-revenue" style="color: var(--text-primary);">₹0.00</p></div>
                        <div class="metric-card"><h3>Average Margin</h3><p id="avg-margin">0%</p></div>
                        <div class="metric-card"><h3>Inventory Value</h3><p id="total-inventory-cost" style="color: var(--accent-yellow);">₹0.00</p></div>
                        <div class="metric-card"><h3>Units in Stock</h3><p id="total-units" style="color: var(--text-primary);">0</p></div>
                    </div>
                </section>
                <section class="card">
                    <h2>Sales & Profit by Date Range</h2>
                    <div class="form-row" style="margin-bottom: 1rem;">
                        <div class="analytics-control-group">
                            <label for="analytics-start-date">Start Date</label>
                            <input type="date" id="analytics-start-date">
                        </div>
                        <div class="analytics-control-group">
                            <label for="analytics-end-date">End Date</label>
                            <input type="date" id="analytics-end-date">
                        </div>
                    </div>
                    <div style="display:flex; gap: 1rem;">
                        <button class="btn btn-info" id="analytics-today-btn">Today</button>
                        <button class="btn btn-primary" id="analytics-filter-btn">Filter</button>
                    </div>
                     <div class="analytics-grid" id="filtered-sales-profit-container" style="margin-top: 1.5rem; background-color:var(--bg-primary); padding:1rem; border-radius:var(--radius-md);">
                        <div class="metric-card" style="box-shadow:none; padding:0;">
                            <h3 id="filtered-sales-heading">Total Sales</h3>
                            <p id="filtered-sales-total" style="color: var(--text-primary);">₹0.00</p>
                        </div>
                        <div class="metric-card" style="box-shadow:none; padding:0;">
                            <h3 id="filtered-profit-heading">Total Profit</h3>
                            <p id="filtered-profit-total">₹0.00</p>
                        </div>
                    </div>
                </section>

                <section class="card" style="display: flex; flex-direction: column;">
                    <h2>Sales & Profit Trend with Projection</h2>
                     <div class="chart-canvas-wrapper">
                        <canvas id="trendProjectionChart"></canvas>
                    </div>
                </section>
                
                 <section class="card">
                    <h2>Product Performance Heat Map</h2>
                    <div class="form-row" style="margin-bottom:1rem;">
                        <div class="analytics-control-group">
                            <label for="heatmap-month-filter">Filter by Month</label>
                            <select id="heatmap-month-filter"><option value="all">All Time</option></select>
                        </div>
                        <div class="analytics-control-group">
                            <label for="heatmap-item-type-filter">Filter by Item Type</label>
                            <select id="heatmap-item-type-filter">
                                <option value="all">All Items</option><option value="inventory">Inventory Only</option><option value="cosmetic">Cosmetics Only</option>
                            </select>
                        </div>
                    </div>
                    <div id="product-heatmap-container" style="display:flex; flex-wrap:wrap; gap:10px; padding-top:10px;">
                         <div class="heatmap-item" style="padding:12px 18px; border-radius:10px; color:var(--bg-primary); font-weight:600;">Product Name</div>
                    </div>
                </section>
                
                <section class="card">
                    <h2>Low Stock Items
                        <button class="btn btn-success btn-small" id="download-low-stock-btn" style="float: right;">Download List</button>
                    </h2>
                    <div id="low-stock-items" class="metric-card">
                         <p style="text-align:center; color: var(--text-muted);">No low stock items.</p>
                    </div>
                </section>

                <section class="card">
                    <h2>Future Sales & Profit Prediction</h2>
                    <p style="color: var(--text-muted); font-size: 0.9rem; max-width: 80ch;">This tool analyzes your historical sales data to provide a simple, trend-based projection for the next three months. The projection is based on your average month-over-month growth.</p>
                    <button id="run-prediction-btn" class="btn btn-primary" style="margin-top: 15px;">Run Prediction</button>
                    <div id="prediction-results-container" style="margin-top: 20px;">
                        <p style="color: var(--text-muted);">Click the button to generate a forecast.</p>
                    </div>
                </section>
            </div>
            <!-- Profit Tab -->
            <div id="profit" class="tab-content"><section class="card"><h2>Item-wise Profit Details</h2><div class="table-container"><table class="styled-table" id="profit-details-table"><thead><tr><th>Date (DD/MM/YYYY)</th><th>Particulars</th><th>Qty</th><th>Total Sell Price</th><th>Cost Rate (per item)</th><th>Profit</th></tr></thead><tbody><tr><td colspan="6" style="text-align:center;">No sales recorded yet.</td></tr></tbody></table></div></section></div>
            <!-- Transactions Tab -->
            <div id="transactions" class="tab-content">
                <section class="card">
                    <h2>Controls</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: flex-end;">
                        <div><label for="start-date">Start Date</label><input type="date" id="start-date"></div>
                        <div><label for="end-date">End Date</label><input type="date" id="end-date"></div>
                        <div><label for="transaction-sort-order">Sort By</label><select id="transaction-sort-order"><option value="newest-first">Newest First</option><option value="oldest-first">Oldest First</option></select></div>
                        <button class="btn btn-primary" id="filter-btn">Filter</button>
                        <button class="btn btn-secondary" id="reset-filter-btn">Reset</button>
                        <button class="btn btn-success" id="export-excel-btn">Export to Excel</button>
                    </div>
                </section>
                <section class="card"><h2>Sales History</h2><div class="table-container"><table class="styled-table" id="sales-history-table"><thead><tr><th>Date (DD/MM/YYYY)</th><th>Items</th><th>Total</th><th>Action</th></tr></thead><tbody><tr><td colspan="4" style="text-align:center;">No sales recorded yet.</td></tr></tbody></table></div></section>
                <section class="card"><h2>Purchase History</h2><div class="table-container"><table class="styled-table" id="purchase-history-table"><thead><tr><th>Date (DD/MM/YYYY)</th><th>Items</th><th>Total</th></tr></thead><tbody><tr><td colspan="3" style="text-align:center;">No purchases recorded yet.</td></tr></tbody></table></div></section>
            </div>
            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <section class="card">
                    <h2>Data Management</h2>
                    <p>Load your existing inventory from an Excel file. The file must contain 'particulars', 'quantity', and 'rate' columns. This will overwrite your current inventory.</p>
                    <input type="file" id="excel-file" accept=".xlsx, .xls">
                    <div style="margin-top: 2rem; border-top: 1px solid var(--border-primary); padding-top: 1.5rem;">
                         <button class="btn btn-success" id="manual-save-btn">Sync to Google Drive</button>
                         <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 10px;">Manually save all current data. The app also saves automatically after you make changes.</p>
                    </div>
                </section>
                <section class="card" id="holiday-management-section">
                    <h2>Holiday Management</h2>
                    <p>Mark specific dates as holidays. Sales on these dates will be excluded from the Sales Trend graph.</p>
                    <div style="display:flex; align-items:flex-end; gap:10px; margin-bottom: 1.5rem;">
                        <div style="flex-grow:1;"><label for="holiday-date">Select Holiday Date:</label><input type="date" id="holiday-date"></div>
                        <button id="add-holiday-btn" class="btn btn-primary btn-small">Add Holiday</button>
                    </div>
                    <h3>Marked Holidays:</h3>
                    <ul id="holiday-list" style="list-style:none; padding:0; margin-top:1rem;">
                        <li style="text-align:center; color: var(--text-muted);">No holidays marked yet.</li>
                    </ul>
                </section>
                <section class="card"><h2>Current Inventory</h2><div class="table-container"><table class="styled-table" id="inventory-table"><thead><tr><th>Particulars</th><th>Quantity</th><th>Cost Rate</th><th>Action</th></tr></thead><tbody></tbody></table></div></section>
            </div>
        </main>
    </div>

    <div id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- THE SCRIPT LOGIC REMAINS UNCHANGED -->
    <script>
    window.onload = () => {
        const { jsPDF } = window.jspdf;

        const app = {
            CLIENT_ID: '460969544827-ip0gvjsjv79m5sibkmgbngmqpl8n5u16.apps.googleusercontent.com',
            API_KEY: 'AIzaSyDYfJX4cryYxGSgPe1319kHf_u6bb071lg', 
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            APP_FOLDER_NAME: 'TinnyFashionStore_Data',
            DATA_FILE_NAME: 'fashion_store_data.json',
            tokenClient: null, driveFileId: null, isSaving: false, saveTimeout: null,
            state: { inventory: [], transactions: [], holidays: [] },
            ui: {},
            // Chart instances
            salesChartInstance: null, 
            trendProjectionChartInstance: null,

            init() { 
                this.cacheDOMElements();
                gapi.load('client', this.initializeGapiClient.bind(this));
                this.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: this.CLIENT_ID,
                    scope: this.SCOPES,
                    callback: this.handleAuthResponse.bind(this),
                });
                this.ui.signinBtn.addEventListener('click', () => this.tokenClient.requestAccessToken({prompt: 'consent'}));
                this.ui.signoutBtn.addEventListener('click', this.signOut.bind(this));
            },
            async initializeGapiClient() { 
                await gapi.client.init({
                    apiKey: this.API_KEY,
                    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                });
                this.ui.signinBtn.disabled = false;
                this.ui.authStatus.textContent = 'Ready. Please sign in.';
            },
            async handleAuthResponse(response) { 
                if (response.error) {
                    this.showToast(`Error: ${response.error}`, 'error');
                    return;
                }
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').classList.add('visible');
                await this.updateUserProfile();
                await this.loadData();
                this.startAppLogic();
            },
            signOut() { 
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token, () => {
                        gapi.client.setToken('');
                        this.driveFileId = null;
                        document.getElementById('login-screen').style.display = 'flex';
                        document.getElementById('app-container').classList.remove('visible');
                        this.showToast('Signed out successfully.');
                    });
                }
            },
            async updateUserProfile() { 
                try {
                    const res = await gapi.client.request({ path: 'https://www.googleapis.com/oauth2/v3/userinfo' });
                    document.getElementById('user-name').textContent = res.result.name;
                    document.getElementById('user-profile-container').style.display = 'flex';
                } catch (e) { console.error("Could not fetch user profile", e); }
            },
            startAppLogic() { 
                this.addEventListeners();
                this.addFormItem(this.ui.salesItemsContainer, true);
                this.addFormItem(this.ui.purchaseItemsContainer, false);
                this.addFormItem(this.ui.credit.inventoryItemsContainer, true);
                
                this.ui.credit.inventoryDateInput.value = this.getTodayDateString();
                this.ui.credit.cosmeticDateInput.value = this.getTodayDateString();
                
                this.renderAll();
            },
            async _findOrCreateAppFolder() { 
                if (this.appFolderId) return this.appFolderId;
                try {
                    let res = await gapi.client.drive.files.list({ q: `name='${this.APP_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`, spaces: 'drive', fields: 'files(id)' });
                    if (res.result.files && res.result.files.length > 0) {
                        this.appFolderId = res.result.files[0].id;
                    } else {
                        let folder = { 'name': this.APP_FOLDER_NAME, 'mimeType': 'application/vnd.google-apps.folder' };
                        res = await gapi.client.drive.files.create({ resource: folder, fields: 'id' });
                        this.appFolderId = res.result.id;
                    }
                    return this.appFolderId;
                } catch (e) { console.error('Error finding/creating app folder:', e); this.showToast('Could not access Drive folder.', 'error'); }
            },
            async loadData() { 
                this.showToast("Loading data from Google Drive...", "info");
                try {
                    const response = await gapi.client.drive.files.list({ q: `name='${this.DATA_FILE_NAME}' and trashed=false`, spaces: 'drive', fields: 'files(id)' });
                    if (response.result.files && response.result.files.length > 0) {
                        this.driveFileId = response.result.files[0].id;
                        const fileContentResponse = await gapi.client.drive.files.get({ fileId: this.driveFileId, alt: 'media' });
                        const loadedState = JSON.parse(fileContentResponse.body);
                        
                        if (loadedState.transactions) {
                           loadedState.transactions.forEach(t => {
                               t.date = new Date(t.date);
                               if (t.saleType === 'Credit' && t.paidAmount === undefined) t.paidAmount = 0;
                               if(t.items && !Array.isArray(t.items)) t.items = [t.items]; 
                           });
                        }

                        const defaultState = { inventory: [], transactions: [], holidays: [] };
                        this.state = { ...defaultState, ...loadedState };
                        this.state.holidays = loadedState.holidays || []; 

                        this.showToast("Data loaded successfully.", "success");
                    } else {
                        this.showToast("No data file found. Starting fresh.", "info");
                        this.state = { inventory: [], transactions: [], holidays: [] };
                        await this._findOrCreateAppFolder(); 
                    }
                } catch (e) {
                    console.error("Error loading data:", e);
                    this.showToast("Failed to load data. Starting fresh.", "error");
                    this.state = { inventory: [], transactions: [], holidays: [] }; 
                }
            },
            triggerAutoSave() { 
                clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => this.saveData(), 2000);
            },
            async saveData() { 
                if (this.isSaving) return;
                this.isSaving = true;

                const originalBtnText = this.ui.manualSaveBtn.textContent;
                this.ui.manualSaveBtn.disabled = true;
                this.ui.manualSaveBtn.textContent = 'Saving...';
                
                this.showToast("Saving data...", "info");

                try {
                    if (!this.appFolderId) await this._findOrCreateAppFolder();
                    const dataToSave = JSON.stringify(this.state, null, 2);
                    const boundary = '-------314159265358979323846';
                    const delimiter = "
--" + boundary + "
";
                    const close_delim = "
--" + boundary + "--";
                    let request;
                    if (this.driveFileId) {
                        const multipartRequestBody = delimiter + 'Content-Type: application/json

' + JSON.stringify({}) + delimiter + 'Content-Type: application/json

' + dataToSave + close_delim;
                        request = gapi.client.request({'path': `https://www.googleapis.com/upload/drive/v3/files/${this.driveFileId}`,'method': 'PATCH','params': { 'uploadType': 'multipart' },'headers': {'Content-Type': 'multipart/related; boundary="' + boundary + '"'},'body': multipartRequestBody});
                    } else {
                        const metadata = {'name': this.DATA_FILE_NAME, 'parents': [this.appFolderId], 'mimeType': 'application/json'};
                        const multipartRequestBody = delimiter + 'Content-Type: application/json

' + JSON.stringify(metadata) + delimiter + 'Content-Type: application/json

' + dataToSave + close_delim;
                        request = gapi.client.request({'path': 'https://www.googleapis.com/upload/drive/v3/files', 'method': 'POST', 'params': {'uploadType': 'multipart'}, 'headers': {'Content-Type': 'multipart/related; boundary="' + boundary + '"'},'body': multipartRequestBody});
                    }
                    const response = await request;
                    if (!this.driveFileId) { this.driveFileId = response.result.id; }
                    this.showToast("Data saved successfully!", "success");
                } catch (e) { 
                    console.error("Error saving data:", e); 
                    this.showToast("Failed to save data.", "error");
                } finally {
                    this.isSaving = false;
                    this.ui.manualSaveBtn.disabled = false;
                    this.ui.manualSaveBtn.textContent = originalBtnText;
                }
            },

            hexToRgba(hex, alpha = 1) {
                if (!hex || typeof hex !== 'string' || hex.charAt(0) !== '#') return `rgba(20, 184, 166, ${alpha})`; 
                const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
                if (isNaN(r) || isNaN(g) || isNaN(b)) return `rgba(20, 184, 166, ${alpha})`; 
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            },
            
            interpolateColor(color1, color2, factor) {
                let result = color1.slice();
                for (let i = 0; i < 3; i++) {
                    result[i] = Math.round(result[i] + factor * (color2[i] - result[i]));
                }
                return `rgb(${result.join(',')})`;
            },

            cacheDOMElements() {
                this.ui = {
                    signinBtn: document.getElementById('signin-btn'),
                    signoutBtn: document.getElementById('signout-btn'),
                    authStatus: document.getElementById('auth-status'),
                    excelFile: document.getElementById('excel-file'),
                    inventoryTableBody: document.querySelector('#inventory-table tbody'),
                    inventoryDatalist: document.getElementById('inventory-datalist'),
                    salesForm: document.getElementById('sales-form'),
                    addSaleItemBtn: document.getElementById('add-sale-item-btn'),
                    salesItemsContainer: document.getElementById('sales-items-container'),
                    purchaseForm: document.getElementById('purchase-form'),
                    addPurchaseItemBtn: document.getElementById('add-purchase-item-btn'),
                    purchaseItemsContainer: document.getElementById('purchase-items-container'),
                    recordSaleBtn: document.getElementById('record-sale-btn'),
                    recordInvoiceBtn: document.getElementById('record-invoice-btn'),
                    cosmeticSaleForm: document.getElementById('cosmetic-sale-form'),
                    tabButtons: document.querySelectorAll('.tab-button'),
                    tabContents: document.querySelectorAll('.tab-content'),
                    manualSaveBtn: document.getElementById('manual-save-btn'),
                    analytics: { 
                        totalProfit: document.getElementById('total-profit'),
                        totalRevenue: document.getElementById('total-revenue'),
                        avgMargin: document.getElementById('avg-margin'),
                        inventoryCost: document.getElementById('total-inventory-cost'),
                        totalUnits: document.getElementById('total-units'),
                        lowStockItems: document.getElementById('low-stock-items'),
                        downloadLowStockBtn: document.getElementById('download-low-stock-btn'),
                        startDateInput: document.getElementById('analytics-start-date'),
                        endDateInput: document.getElementById('analytics-end-date'),
                        filterBtn: document.getElementById('analytics-filter-btn'),
                        todayBtn: document.getElementById('analytics-today-btn'),
                        filteredSalesTotal: document.getElementById('filtered-sales-total'),
                        filteredProfitTotal: document.getElementById('filtered-profit-total'),
                        filteredSalesHeading: document.getElementById('filtered-sales-heading'),
                        filteredProfitHeading: document.getElementById('filtered-profit-heading'),
                        productHeatmapContainer: document.getElementById('product-heatmap-container'),
                        heatmapMonthFilter: document.getElementById('heatmap-month-filter'),
                        heatmapItemTypeFilter: document.getElementById('heatmap-item-type-filter'),
                        trendProjectionChart: document.getElementById('trendProjectionChart'),
                        // NEW UI ELEMENTS FOR PREDICTOR
                        runPredictionBtn: document.getElementById('run-prediction-btn'),
                        predictionResultsContainer: document.getElementById('prediction-results-container'),
                    },
                    transactions: { 
                        salesHistoryBody: document.querySelector('#sales-history-table tbody'),
                        purchaseHistoryBody: document.querySelector('#purchase-history-table tbody'),
                        transactionsTab: document.getElementById('transactions'),
                        startDateInput: document.getElementById('start-date'),
                        endDateInput: document.getElementById('end-date'),
                        filterBtn: document.getElementById('filter-btn'),
                        resetFilterBtn: document.getElementById('reset-filter-btn'),
                        exportExcelBtn: document.getElementById('export-excel-btn'),
                        transactionSortOrder: document.getElementById('transaction-sort-order'),
                    },
                    profit: { 
                        profitDetailsBody: document.querySelector('#profit-details-table tbody'),
                    },
                    credit: { 
                        inventorySaleForm: document.getElementById('credit-inventory-sale-form'),
                        inventoryItemsContainer: document.getElementById('credit-inventory-items-container'),
                        addInventoryItemBtn: document.getElementById('add-credit-inventory-item-btn'),
                        inventoryDateInput: document.getElementById('credit-inventory-date'),
                        cosmeticSaleForm: document.getElementById('credit-cosmetic-sale-form'),
                        cosmeticDateInput: document.getElementById('credit-cosmetic-date'),
                        creditorListContainer: document.getElementById('creditor-list-container'),
                    },
                    operations: {
                        dashboardTotalUnits: document.getElementById('dashboard-total-units'),
                        dashboardLowStockCount: document.getElementById('dashboard-low-stock-count'),
                        dashboardInventoryValue: document.getElementById('dashboard-inventory-value'),
                        dashboardTotalRevenue: document.getElementById('dashboard-total-revenue'),
                        dashboardTotalProfit: document.getElementById('dashboard-total-profit'),
                        dashboardLowStockItemsUl: document.getElementById('dashboard-low-stock-items-ul'),
                        dashboardDownloadLowStockBtn: document.getElementById('dashboard-download-low-stock-btn'),
                        salesTrendChart: document.getElementById('salesTrendChart'), 
                        salesTrendModeSelect: document.getElementById('sales-trend-mode'),
                        salesTrendCustomRangeInputs: document.getElementById('sales-trend-custom-range-inputs'),
                        salesTrendStartDateInput: document.getElementById('sales-trend-start-date'),
                        salesTrendEndDateInput: document.getElementById('sales-trend-end-date'),
                        refreshSalesTrendBtn: document.getElementById('refresh-sales-trend-btn'),
                    },
                    settings: {
                        holidayDateInput: document.getElementById('holiday-date'),
                        addHolidayBtn: document.getElementById('add-holiday-btn'),
                        holidayList: document.getElementById('holiday-list'),
                    }
                };
            },
            
            getTodayDateString(date = new Date()) { return date.toISOString().slice(0, 10); },
            formatDateDDMMYYYY(date) { 
                if (!(date instanceof Date) || isNaN(date)) return 'N/A';
                return new Intl.DateTimeFormat('en-GB').format(date);
            },
            parseItemNameFromDatalist(value) { 
                if (typeof value !== 'string') return '';
                const match = value.match(/^(.*) \(\d+ left\)$/);
                return match ? match[1].trim() : value.trim();
            },
            getCategoryFromParticulars(particulars) {
                const pTrimmed = particulars.trim();
                if (!pTrimmed) return "Uncategorized";
                const words = pTrimmed.split(/\s+/);
                let categoryParts = [];
                for (const word of words) {
                    if (/\d/.test(word)) break;
                    categoryParts.push(word);
                }
                if (categoryParts.length > 0) return categoryParts.join(" ").trim();
                if (words.length > 0) {
                    const firstWord = words[0];
                    const textualPrefixMatch = firstWord.match(/^([a-zA-Z_]+)/); 
                    if (textualPrefixMatch && textualPrefixMatch[1]) return textualPrefixMatch[1];
                }
                return "Other Items"; 
            },
            
            _getFirstDayOfMonth(date) { return new Date(date.getFullYear(), date.getMonth(), 1); },
            _getLastDayOfMonth(date) { return new Date(date.getFullYear(), date.getMonth() + 1, 0); },
            _getDaysInMonth(year, month) { return new Date(year, month + 1, 0).getDate(); },

            renderAll() {
                this.renderInventory();
                this.renderAnalytics(); 
                this.renderTransactions();
                this.renderProfit();
                this.renderCreditorList(); 
                this.renderHolidays();
                this.populateHeatmapFilters();
                
                this.renderAllAnalyticsCharts();
            },

            renderAllAnalyticsCharts() {
                const activeTab = document.querySelector('.tab-content.active')?.id;
                if (!activeTab) return;
                
                if (activeTab === 'analytics') {
                    this.renderTrendProjectionChart();
                    this.renderProductHeatmap();
                }
                if (activeTab === 'operations') {
                     this.renderSalesTrendChart();
                }
            },
            
            renderInventory() { 
                this.state.inventory.sort((a, b) => a.particulars.localeCompare(b.particulars));
                this.ui.inventoryTableBody.innerHTML = this.state.inventory.length
                    ? this.state.inventory.map(item => {
                        const isLowStock = item.quantity > 0 && item.quantity <= 3; 
                        const rowClass = isLowStock ? 'is-low-stock' : '';
                        const badgeHTML = isLowStock ? ` <span class="low-stock-badge">Low</span>` : '';

                        return `<tr data-particulars="${item.particulars}" class="${rowClass}">
                            <td><span class="display-value">${item.particulars}</span><div class="edit-field"><input type="text" class="edit-input" value="${item.particulars}" readonly></div></td>
                            <td><span class="display-value">${item.quantity}${badgeHTML}</span><div class="edit-field"><input type="number" class="edit-input edit-quantity" value="${item.quantity}" min="0"></div></td>
                            <td><span class="display-value">${item.rate.toFixed(2)}</span><div class="edit-field"><input type="number" class="edit-input edit-rate" value="${item.rate.toFixed(2)}" min="0" step="0.01"></div></td>
                            <td><div class="inventory-actions" style="display:flex; gap:6px;">
                                    <button class="btn btn-small btn-secondary edit-btn" data-particulars="${item.particulars}">Edit</button>
                                    <button class="btn btn-small btn-success save-btn" data-particulars="${item.particulars}">Save</button>
                                    <button class="btn btn-small btn-secondary cancel-btn">Cancel</button>
                                    <button class="btn btn-small btn-danger delete-btn" data-particulars="${item.particulars}">Delete</button>
                                </div></td></tr>`;
                    }).join('')
                    : `<tr><td colspan="4" style="text-align:center;">No inventory data. Add stock or load an Excel file.</td></tr>`;
                
                this.ui.inventoryDatalist.innerHTML = this.state.inventory
                    .map(item => `<option value="${item.particulars} (${item.quantity} left)"></option>`)
                    .join('');
            },

            renderAnalytics() { 
                const { cost, units, lowStockItemsArr } = this.state.inventory.reduce((acc, item) => {
                    acc.cost += item.quantity * item.rate;
                    acc.units += item.quantity;
                    if (item.quantity > 0 && item.quantity <= 3) acc.lowStockItemsArr.push(item);
                    return acc;
                }, { cost: 0, units: 0, lowStockItemsArr: [] });

                lowStockItemsArr.sort((a, b) => a.particulars.localeCompare(b.particulars));

                const categorizedLowStock = {};
                if (lowStockItemsArr.length > 0) {
                    lowStockItemsArr.forEach(item => {
                        const category = this.getCategoryFromParticulars(item.particulars);
                        if (!categorizedLowStock[category]) categorizedLowStock[category] = [];
                        categorizedLowStock[category].push(item);
                    });
                }
                const sortedCategories = Object.keys(categorizedLowStock).sort((a, b) => a.localeCompare(b));
                
                let analyticsLowStockHtml = '';
                if (sortedCategories.length > 0) {
                    analyticsLowStockHtml = '<div class="categorized-low-stock-container">';
                    sortedCategories.forEach((category, index) => {
                        analyticsLowStockHtml += `<div class="low-stock-category-group"><h4 class="low-stock-category-title" data-category-index="analytics-${index}"><span class="category-name-text">${category.toUpperCase()}</span><span class="category-toggle-indicator">▼</span></h4><ul class="low-stock-items-in-category" id="analytics-items-${index}" style="display: none;">`;
                        categorizedLowStock[category].forEach(item => {
                            analyticsLowStockHtml += `<li>${item.particulars} - <span style="color:var(--accent-yellow); font-weight:600;">${item.quantity} left</span></li>`;
                        });
                        analyticsLowStockHtml += `</ul></div>`;
                    });
                    analyticsLowStockHtml += '</div>';
                } else {
                    analyticsLowStockHtml = '<p style="text-align:center; color: var(--text-muted); padding: 20px 0;">No low stock items.</p>';
                }
                this.ui.analytics.lowStockItems.innerHTML = analyticsLowStockHtml;
                
                let dashboardLowStockHtml = '';
                if (sortedCategories.length > 0) {
                    sortedCategories.forEach((category, index) => {
                        dashboardLowStockHtml += `<li class="dashboard-category-item"><div class="dashboard-category-header" data-category-index="dashboard-${index}"><h5>${category.toUpperCase()}</h5><span class="category-toggle-indicator">▼</span></div><div class="dashboard-items-in-category" id="dashboard-items-${index}" style="display: none;"><ul>`;
                        categorizedLowStock[category].forEach(item => {
                            dashboardLowStockHtml += `<li><div class="item-icon-placeholder">🛍️</div><div class="item-details"><span class="item-name">${item.particulars}</span><span class="item-sub-detail">Cost: ₹${item.rate.toFixed(2)} / Qty: <span style="color:var(--accent-yellow); font-weight:600;">${item.quantity}</span></span></div><span class="item-stock-level">${item.quantity}</span></li>`;
                        });
                        dashboardLowStockHtml += `</ul></div></li>`;
                    });
                } else {
                    dashboardLowStockHtml = '<li><p style="text-align:center; color: var(--text-muted);">No low stock items.</p></li>';
                }
                if (this.ui.operations.dashboardLowStockItemsUl) this.ui.operations.dashboardLowStockItemsUl.innerHTML = dashboardLowStockHtml;

                const sales = this.state.transactions.filter(t => t.type === 'Sale');
                const totalRevenue = sales.reduce((sum, t) => sum + t.total, 0);
                const totalProfit = sales.flatMap(t => t.items).reduce((sum, i) => sum + (i.sellingRate - i.costRate) * i.quantity, 0);
                const avgMargin = totalRevenue > 0 ? ((totalProfit / totalRevenue) * 100) : 0;
                
                this.ui.analytics.totalProfit.textContent = `₹${totalProfit.toFixed(2)}`;
                this.ui.analytics.totalRevenue.textContent = `₹${totalRevenue.toFixed(2)}`;
                this.ui.analytics.avgMargin.textContent = `${avgMargin.toFixed(1)}%`;
                this.ui.analytics.inventoryCost.textContent = `₹${cost.toFixed(2)}`;
                this.ui.analytics.totalUnits.textContent = units;
                
                const lowStockCount = lowStockItemsArr.length;
                this.ui.analytics.downloadLowStockBtn.disabled = lowStockCount === 0;
                
                if (this.ui.operations.dashboardTotalUnits) { 
                    this.ui.operations.dashboardTotalUnits.textContent = units;
                    this.ui.operations.dashboardLowStockCount.textContent = lowStockCount;
                    this.ui.operations.dashboardInventoryValue.textContent = `₹${cost.toFixed(2)}`;
                    this.ui.operations.dashboardTotalRevenue.textContent = `₹${totalRevenue.toFixed(2)}`;
                    this.ui.operations.dashboardTotalProfit.textContent = `₹${totalProfit.toFixed(2)}`;
                    if(this.ui.operations.dashboardDownloadLowStockBtn) this.ui.operations.dashboardDownloadLowStockBtn.disabled = lowStockCount === 0;
                }
                this.renderFilteredSalesAndProfit();
            },
            
            isDateHoliday(dateObj) { 
                if (!this.state.holidays || this.state.holidays.length === 0) return false;
                if (!(dateObj instanceof Date) || isNaN(dateObj.getTime())) return false; 
                const dateString = dateObj.toISOString().split('T')[0];
                return this.state.holidays.includes(dateString);
            },

            _prepareSalesDataForMode(mode, customStartDateStr, customEndDateStr) {
                let loopIterationStartDate, loopIterationEndDate, transactionFilterStartDate, transactionFilterEndDate;
                const salesDataAggregated = {}; let titleSuffix = "";
                const today = new Date(); today.setHours(0, 0, 0, 0);

                if (mode === 'last7days') {
                    titleSuffix = "Last 7 Days";
                    loopIterationEndDate = new Date(today);
                    loopIterationStartDate = new Date(today); loopIterationStartDate.setDate(today.getDate() - 6);
                } else if (mode === 'currentMonth') {
                    titleSuffix = "Current Month";
                    loopIterationStartDate = this._getFirstDayOfMonth(today); 
                    loopIterationEndDate = this._getLastDayOfMonth(today);   
                } else if (mode === 'customRange') {
                    if (!customStartDateStr || !customEndDateStr) return this._prepareSalesDataForMode('last7days'); 
                    loopIterationStartDate = new Date(customStartDateStr); loopIterationStartDate.setHours(0,0,0,0);
                    loopIterationEndDate = new Date(customEndDateStr); loopIterationEndDate.setHours(0,0,0,0);
                    if (loopIterationStartDate > loopIterationEndDate) return this._prepareSalesDataForMode('last7days'); 
                    titleSuffix = `Custom: ${this.formatDateDDMMYYYY(loopIterationStartDate)} - ${this.formatDateDDMMYYYY(loopIterationEndDate)}`;
                }
                
                transactionFilterStartDate = new Date(loopIterationStartDate); transactionFilterStartDate.setHours(0,0,0,0);
                transactionFilterEndDate = new Date(loopIterationEndDate); transactionFilterEndDate.setHours(23,59,59,999);

                let currentDateIter = new Date(loopIterationStartDate);
                while(currentDateIter <= loopIterationEndDate) {
                    if (!this.isDateHoliday(currentDateIter)) salesDataAggregated[currentDateIter.toISOString().split('T')[0]] = 0;
                    currentDateIter.setDate(currentDateIter.getDate() + 1);
                }
                
                this.state.transactions.forEach(t => {
                    if (t.type === 'Sale' && t.date >= transactionFilterStartDate && t.date <= transactionFilterEndDate) {
                        const dateString = t.date.toISOString().split('T')[0];
                        if (salesDataAggregated.hasOwnProperty(dateString)) salesDataAggregated[dateString] += t.total;
                    }
                });
                
                const finalLabels = [], finalDataPoints = [];
                Object.keys(salesDataAggregated).sort().forEach(dateString => {
                    finalLabels.push(this.formatDateDDMMYYYY(new Date(dateString+'T00:00:00')).substring(0, 5));
                    finalDataPoints.push(salesDataAggregated[dateString]);
                });
                return { labels: finalLabels, dataPoints: finalDataPoints, titleSuffix: titleSuffix + " (Excl. Holidays)" };
            },

            renderSalesTrendChart() {
                if (typeof Chart === 'undefined' || !this.ui.operations.salesTrendChart) return;
                const ctx = this.ui.operations.salesTrendChart.getContext('2d');
                if (!ctx) return;
                const style = getComputedStyle(document.documentElement);
                const accentPrimary = style.getPropertyValue('--accent-primary').trim();
                const textMuted = style.getPropertyValue('--text-muted').trim();
                const borderPrimary = style.getPropertyValue('--border-primary').trim();

                const { labels, dataPoints, titleSuffix } = this._prepareSalesDataForMode(this.ui.operations.salesTrendModeSelect.value, this.ui.operations.salesTrendStartDateInput.value, this.ui.operations.salesTrendEndDateInput.value);

                if (this.salesChartInstance) this.salesChartInstance.destroy();
                this.salesChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ label: 'Daily Sales', data: dataPoints, borderColor: accentPrimary, backgroundColor: this.hexToRgba(accentPrimary, 0.2), tension: 0.3, fill: true, pointBackgroundColor: accentPrimary, pointHoverRadius: 7 }] },
                    options: this.getCommonChartOptions(`Sales Trend: ${titleSuffix}`),
                });
            },
            
            renderFilteredSalesAndProfit() {
                const startDateStr = this.ui.analytics.startDateInput.value, endDateStr = this.ui.analytics.endDateInput.value;
                const startDate = startDateStr ? new Date(startDateStr) : null; if(startDate) startDate.setHours(0, 0, 0, 0);
                const endDate = endDateStr ? new Date(endDateStr) : null; if(endDate) endDate.setHours(23, 59, 59, 999);
                const sales = this.state.transactions.filter(t => t.type === 'Sale' && (!startDate || t.date >= startDate) && (!endDate || t.date <= endDate));
                const totalSales = sales.reduce((sum, t) => sum + t.total, 0), totalProfit = sales.flatMap(t => t.items).reduce((sum, i) => sum + (i.sellingRate - i.costRate) * i.quantity, 0);
                this.ui.analytics.filteredSalesTotal.textContent = `₹${totalSales.toFixed(2)}`;
                this.ui.analytics.filteredProfitTotal.textContent = `₹${totalProfit.toFixed(2)}`;
                const isFiltered = startDate || endDate;
                this.ui.analytics.filteredSalesHeading.textContent = isFiltered ? "Filtered Sales" : "All-Time Sales";
                this.ui.analytics.filteredProfitHeading.textContent = isFiltered ? "Filtered Profit" : "All-Time Profit";
            },

            renderTransactions() { 
                const startDateStr = this.ui.transactions.startDateInput.value, endDateStr = this.ui.transactions.endDateInput.value;
                const startDate = startDateStr ? new Date(startDateStr) : null; if(startDate) startDate.setHours(0,0,0,0);
                const endDate = endDateStr ? new Date(endDateStr) : null; if(endDate) endDate.setHours(23,59,59,999);
                const sortFunction = (a, b) => this.ui.transactions.transactionSortOrder.value === 'oldest-first' ? a.date - b.date : b.date - a.date;
                const filteredSales = this.state.transactions.filter(t => t.type === 'Sale' && (!startDate || t.date >= startDate) && (!endDate || t.date <= endDate)).sort(sortFunction);
                const filteredPurchases = this.state.transactions.filter(t => t.type === 'Purchase' && (!startDate || t.date >= startDate) && (!endDate || t.date <= endDate)).sort(sortFunction);
                this.ui.transactions.salesHistoryBody.innerHTML = filteredSales.length ? filteredSales.map(t => { const creditLabel = t.saleType === 'Credit' ? `<span class="credit-label">CREDIT TO: ${t.partyName} (Paid: ₹${(t.paidAmount || 0).toFixed(2)})</span>` : ''; const itemsHtml = t.items.map(i => `<li><span style="display:inline-block; max-width: 250px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${i.quantity} x ${i.particulars} @ ₹${i.sellingRate.toFixed(2)}</span> <button class="btn btn-danger btn-small return-item-btn" style="margin-left:8px;" data-transaction-id="${t.id}" data-item-particulars="${i.particulars}">Return</button></li>`).join(''); return `<tr><td>${this.formatDateDDMMYYYY(t.date)}</td><td><ul style="max-width:300px;">${itemsHtml}</ul>${creditLabel}</td><td>₹${t.total.toFixed(2)}</td><td><div class="sales-history-actions" style="display:flex; gap:8px;"><button class="btn btn-secondary btn-small download-invoice-btn" data-id="${t.id}">Invoice</button><button class="btn btn-danger btn-small delete-sale-btn" data-id="${t.id}">Delete</button></div></td></tr>`}).join('') : `<tr><td colspan="4" style="text-align:center;">No sales match the selected criteria.</td></tr>`;
                this.ui.transactions.purchaseHistoryBody.innerHTML = filteredPurchases.length ? filteredPurchases.map(t => `<tr><td>${this.formatDateDDMMYYYY(t.date)}</td><td><ul>${t.items.map(i => `<li>${i.quantity} x ${i.particulars} @ ₹${i.rate.toFixed(2)}</li>`).join('')}</ul></td><td>₹${t.total.toFixed(2)}</td></tr>`).join('') : `<tr><td colspan="3" style="text-align:center;">No purchases match the selected criteria.</td></tr>`;
            },
            renderProfit() { 
                const allItemsSold = this.state.transactions.filter(t => t.type === 'Sale').flatMap(t => t.items.map(item => ({ ...item, date: t.date })));
                if (!allItemsSold.length) { this.ui.profit.profitDetailsBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No sales recorded yet.</td></tr>`; return; }
                allItemsSold.sort((a,b) => b.date - a.date);
                this.ui.profit.profitDetailsBody.innerHTML = allItemsSold.map(item => `<tr><td>${this.formatDateDDMMYYYY(item.date)}</td><td>${item.particulars}</td><td>${item.quantity}</td><td>${(item.sellingRate * item.quantity).toFixed(2)}</td><td>${item.costRate.toFixed(2)}</td><td class="profit-col">₹${((item.sellingRate - item.costRate) * item.quantity).toFixed(2)}</td></tr>`).join('');
            },
            renderCreditorList() { 
                const creditors = this.state.transactions.filter(t => t.saleType === 'Credit').reduce((acc, t) => { if (!t.partyName) return acc; if (!acc[t.partyName]) acc[t.partyName] = { totalOwed: 0, totalPaid: 0, transactions: [] }; acc[t.partyName].totalOwed += t.total; acc[t.partyName].totalPaid += (t.paidAmount || 0); acc[t.partyName].transactions.push(t); return acc; }, {});
                this.ui.credit.creditorListContainer.innerHTML = '';
                const creditorsWithBalance = Object.entries(creditors).filter(([_, data]) => (data.totalOwed - data.totalPaid) > 0.01);
                if (creditorsWithBalance.length === 0) { this.ui.credit.creditorListContainer.innerHTML = '<p style="text-align:center; color: var(--text-muted);">No outstanding credit balances.</p>'; return; }
                creditorsWithBalance.sort((a,b) => a[0].localeCompare(b[0])).forEach(([name, data]) => { const remainingBalance = data.totalOwed - data.totalPaid; const transactionRows = data.transactions.map(tx => { const balanceOnTx = tx.total - (tx.paidAmount || 0); if (balanceOnTx <= 0.01) return ''; return `<tr><td>${this.formatDateDDMMYYYY(tx.date)}</td><td>${tx.items.map(i => `${i.quantity}x ${i.particulars.replace('(Cosmetic)', '')}`).join(', ')}</td><td>₹${tx.total.toFixed(2)}</td><td>₹${balanceOnTx.toFixed(2)}</td></tr>`; }).join(''); this.ui.credit.creditorListContainer.insertAdjacentHTML('beforeend', `<div class="creditor-item" data-creditor-name="${name}"><div class="creditor-header"><span class="creditor-name">${name}</span><span class="creditor-balance">Balance: ₹${remainingBalance.toFixed(2)}</span></div><div class="creditor-details"><table><thead><tr><th>Date</th><th>Items</th><th>Total Sale</th><th>Balance</th></tr></thead><tbody>${transactionRows}</tbody></table><div class="payment-form" style="display:flex; gap:10px; align-items:center;"><label for="payment-${name.replace(/\s+/g, '-')}" style="white-space:nowrap; margin-bottom:0;">Record Payment:</label><input type="number" id="payment-${name.replace(/\s+/g, '-')}" class="payment-amount-input" placeholder="Enter amount" min="0.01" max="${remainingBalance.toFixed(2)}" step="0.01" style="max-width:180px;"><button class="btn btn-success btn-small record-payment-btn" data-creditor-name="${name}">Pay</button></div></div></div>`); });
            },
            renderHolidays() {
                const holidayListEl = this.ui.settings.holidayList; holidayListEl.innerHTML = ''; 
                if (this.state.holidays.length === 0) { holidayListEl.innerHTML = '<li style="text-align:center; color: var(--text-muted);">No holidays marked yet.</li>'; return; }
                [...this.state.holidays].sort().forEach(holidayDateStr => { holidayListEl.insertAdjacentHTML('beforeend', `<li style="background-color:var(--bg-tertiary); padding:10px 15px; border-radius:var(--radius-sm); margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; font-size:0.95rem; color:var(--text-primary);">${this.formatDateDDMMYYYY(new Date(holidayDateStr + 'T00:00:00'))}<button class="btn btn-danger btn-small delete-holiday-btn" data-date="${holidayDateStr}">Remove</button></li>`); });
            },

            populateHeatmapFilters() {
                const monthFilter = this.ui.analytics.heatmapMonthFilter;
                const existingValue = monthFilter.value;
                monthFilter.innerHTML = '<option value="all">All Time</option>';
                const salesTransactions = this.state.transactions.filter(t => t.type === 'Sale');
                if(salesTransactions.length === 0) return;
                const months = new Set();
                salesTransactions.forEach(t => { months.add(t.date.toISOString().slice(0, 7)); });
                Array.from(months).sort().reverse().forEach(monthKey => {
                    const option = document.createElement('option');
                    option.value = monthKey;
                    option.textContent = new Date(monthKey + '-02').toLocaleString('default', { month: 'long', year: 'numeric' });
                    monthFilter.appendChild(option);
                });
                if ([...monthFilter.options].some(o => o.value === existingValue)) {
                    monthFilter.value = existingValue;
                }
            },
            
            renderProductHeatmap() {
                const container = this.ui.analytics.productHeatmapContainer;
                const selectedMonth = this.ui.analytics.heatmapMonthFilter.value;
                const itemType = this.ui.analytics.heatmapItemTypeFilter.value;
                let transactionsToConsider = this.state.transactions.filter(t => t.type === 'Sale' && (selectedMonth === 'all' || t.date.toISOString().startsWith(selectedMonth)));
                const itemFilter = i => (itemType === 'cosmetic' && i.particulars.includes('(Cosmetic)')) || (itemType === 'inventory' && !i.particulars.includes('(Cosmetic)')) || itemType === 'all';
                const productSales = transactionsToConsider.flatMap(t => t.items).filter(itemFilter).reduce((acc, item) => {
                    const cleanParticulars = item.particulars.replace('(Cosmetic) ', '');
                    acc[cleanParticulars] = (acc[cleanParticulars] || 0) + item.quantity;
                    return acc;
                }, {});
                const sortedProducts = Object.entries(productSales).sort(([,a], [,b]) => b - a);
                if (sortedProducts.length === 0) { container.innerHTML = '<p style="color: var(--text-muted);">No sales data for the selected filters.</p>'; return; }
                container.innerHTML = '';
                const maxSales = sortedProducts.length > 0 ? sortedProducts[0][1] : 0;
                const colorStart = [20, 184, 166]; const colorEnd = [239, 68, 68];
                sortedProducts.forEach(([product, sales]) => {
                    const factor = maxSales > 1 ? (sales - 1) / (maxSales - 1) : (maxSales > 0 ? 1 : 0);
                    const color = this.interpolateColor([31, 41, 55], colorEnd, factor); // From bg-secondary to red
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'heatmap-item';
                    itemDiv.style.backgroundColor = this.interpolateColor([245, 158, 11], [239, 68, 68], factor); // Yellow to red
                    itemDiv.innerHTML = `<span class="heatmap-product-name" title="${product}" style="display:block; max-width:150px; white-space:nowrap; overflow:hidden; text-overflow: ellipsis;">${product}</span><span class="heatmap-sales-count" style="display:block; font-size: 1.2rem; margin-top: 5px;">${sales}</span>`;
                    container.appendChild(itemDiv);
                });
            },

            renderTrendProjectionChart() {
                if(typeof Chart === 'undefined' || !this.ui.analytics.trendProjectionChart) return;
                const ctx = this.ui.analytics.trendProjectionChart.getContext('2d');
                if (this.trendProjectionChartInstance) this.trendProjectionChartInstance.destroy();

                const monthlyData = {};
                this.state.transactions.forEach(t => {
                    if (t.type === 'Sale') {
                        const monthKey = `${t.date.getFullYear()}-${String(t.date.getMonth() + 1).padStart(2, '0')}`;
                        if (!monthlyData[monthKey]) { monthlyData[monthKey] = { sales: 0, profit: 0 }; }
                        monthlyData[monthKey].sales += t.total;
                        monthlyData[monthKey].profit += t.items.reduce((sum, i) => sum + (i.sellingRate - i.costRate) * i.quantity, 0);
                    }
                });

                const sortedMonths = Object.keys(monthlyData).sort();
                if (sortedMonths.length < 2) {
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.font = "16px Inter, sans-serif"; ctx.fillStyle = "grey"; ctx.textAlign = "center";
                    ctx.fillText("At least two months of sales data needed for trend projection.", ctx.canvas.width/2, ctx.canvas.height/2);
                    return;
                }

                const historicalLabels = sortedMonths.map(m => new Date(m+'-02').toLocaleString('default', {month:'short', year:'2-digit'}));
                const historicalSalesData = sortedMonths.map(m => monthlyData[m].sales);
                const historicalProfitData = sortedMonths.map(m => monthlyData[m].profit);
                
                const projectionPoints = 6; const dataForRegression = historicalSalesData.slice(-projectionPoints); const n = dataForRegression.length; let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
                for(let i = 0; i < n; i++) { sumX += i; sumY += dataForRegression[i]; sumXY += i * dataForRegression[i]; sumX2 += i * i; }
                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX); const intercept = (sumY - slope * sumX) / n;
                const projectionLabels = []; const projectionData = []; const lastMonthDate = new Date(sortedMonths[sortedMonths.length - 1] + '-02');
                for (let i = 1; i <= projectionPoints; i++) { const nextMonth = new Date(lastMonthDate.getFullYear(), lastMonthDate.getMonth() + i, 1); projectionLabels.push(nextMonth.toLocaleString('default', {month:'short', year:'2-digit'})); const projectedValue = (slope * (n - 1 + i)) + intercept; projectionData.push(projectedValue > 0 ? projectedValue : 0); }

                const style = getComputedStyle(document.documentElement);
                const accentPink = style.getPropertyValue('--accent-pink').trim(), accentYellow = style.getPropertyValue('--accent-yellow').trim(), infoBlue = style.getPropertyValue('--status-info').trim();
                
                this.trendProjectionChartInstance = new Chart(ctx, {
                    type: 'line', data: { labels: [...historicalLabels, ...projectionLabels],
                        datasets: [
                            { label: 'Historical Sales', data: historicalSalesData, borderColor: accentPink, tension: 0.2, fill: false },
                            { label: 'Historical Profit', data: historicalProfitData, borderColor: accentYellow, tension: 0.2, fill: false },
                            { label: 'Projected Sales', data: [...Array(historicalSalesData.length).fill(null), ...projectionData], borderColor: infoBlue, borderDash: [5, 5], tension: 0.2, fill: false }
                        ]
                    },
                    options: this.getCommonChartOptions('Monthly Sales & Profit + 6-Month Sales Projection')
                });
            },

            getCommonChartOptions(titleText) {
                const style = getComputedStyle(document.documentElement);
                const textMuted = style.getPropertyValue('--text-muted').trim();
                const textPrimary = style.getPropertyValue('--text-primary').trim();
                const borderPrimary = style.getPropertyValue('--border-primary').trim();
                return { responsive: true, maintainAspectRatio: false,
                    scales: { 
                        x: { grid: { color: borderPrimary }, ticks: { color: textMuted } }, 
                        y: { beginAtZero: true, grid: { color: borderPrimary }, ticks: { color: textMuted, callback: value => '₹' + new Intl.NumberFormat('en-IN').format(value) } } 
                    },
                    plugins: { 
                        legend: { labels: { color: textMuted } }, 
                        title: { display: true, text: titleText, color: textPrimary, font: { size: 16 } },
                        tooltip: { 
                           backgroundColor: '#111827', titleFont: {size: 14}, bodyFont: {size: 12}, padding: 12, borderColor: borderPrimary, borderWidth: 1,
                           callbacks: { label: context => `${context.dataset.label || ''}: ${new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(context.parsed.y)}` }
                        }
                    }
                };
            },
            
            runSalesPrediction() {
                const monthlyData = {};
                this.state.transactions.forEach(t => { if (t.type === 'Sale') { const monthKey = t.date.toISOString().slice(0, 7); if (!monthlyData[monthKey]) { monthlyData[monthKey] = { sales: 0, profit: 0 }; } const saleProfit = t.items.reduce((sum, i) => sum + (i.sellingRate - i.costRate) * i.quantity, 0); monthlyData[monthKey].sales += t.total; monthlyData[monthKey].profit += saleProfit; } });
                const sortedMonths = Object.keys(monthlyData).sort();
                if (sortedMonths.length < 2) { this.ui.analytics.predictionResultsContainer.innerHTML = `<p style="color: var(--accent-yellow);">Not enough historical data. At least two months of sales are needed.</p>`; return; }
                let totalGrowthRate = 0, growthPeriods = 0;
                for (let i = 1; i < sortedMonths.length; i++) { const prevSales = monthlyData[sortedMonths[i-1]].sales, currentSales = monthlyData[sortedMonths[i]].sales; if (prevSales > 0) { totalGrowthRate += (currentSales - prevSales) / prevSales; growthPeriods++; } }
                const averageGrowth = growthPeriods > 0 ? totalGrowthRate / growthPeriods : 0.05;
                const lastMonthKey = sortedMonths[sortedMonths.length - 1], lastMonthData = monthlyData[lastMonthKey], predictions = [], lastDate = new Date(lastMonthKey + "-02"); 
                for (let i = 1; i <= 3; i++) { predictions.push({ month: new Date(lastDate.getFullYear(), lastDate.getMonth() + i, 1).toLocaleString('default', { month: 'long', year: 'numeric' }), sales: lastMonthData.sales * Math.pow(1 + averageGrowth, i), profit: lastMonthData.profit * Math.pow(1 + averageGrowth, i) }); }
                this.renderPredictionResults(predictions);
            },

            renderPredictionResults(predictions) {
                let tableHTML = `<div class="table-container"><table class="styled-table"><thead><tr><th>Future Month</th><th>Projected Sales</th><th class="profit-col">Projected Profit</th></tr></thead><tbody>`;
                predictions.forEach(p => { tableHTML += `<tr><td>${p.month}</td><td>₹${p.sales.toFixed(2)}</td><td class="profit-col">₹${p.profit.toFixed(2)}</td></tr>`; });
                tableHTML += `</tbody></table></div>`; this.ui.analytics.predictionResultsContainer.innerHTML = tableHTML;
            },

            createFormItemHTML(isSale) { return isSale ? `<div class="form-grid item-entry"><input type="text" class="particulars" placeholder="Item Particulars" list="inventory-datalist" required><input type="number" class="quantity" placeholder="Quantity" min="1" required><input type="number" class="rate" placeholder="Selling Rate" min="0" step="0.01" required></div>` : `<div class="form-grid item-entry"><input type="text" class="particulars" placeholder="Item Particulars" required><input type="number" class="quantity" placeholder="Quantity" min="1" required><input type="number" class="rate" placeholder="Cost Rate" min="0" step="0.01" required></div>`; },
            addFormItem(container, isSale) { container.insertAdjacentHTML('beforeend', this.createFormItemHTML(isSale)) },
            handleFileUpload(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' }); const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]); this.state.inventory = json.map(row => ({ particulars: String(row.particulars || "N/A"), quantity: parseInt(row.quantity, 10) || 0, rate: parseFloat(row.rate) || 0.0 })).filter(item => item.particulars !== "N/A"); this.renderAll(); this.triggerAutoSave(); this.showToast('Inventory loaded successfully!', 'success'); } catch (error) { this.showToast('Error reading Excel file. Ensure columns are: particulars, quantity, rate.', 'error'); console.error(error); } }; reader.readAsArrayBuffer(file); },
            deleteSale(transactionId) { if (!confirm("Are you sure you want to delete this ENTIRE sale record?")) return; const transactionIndex = this.state.transactions.findIndex(t => t.id === transactionId); if (transactionIndex === -1) { this.showToast("Sale not found.", "error"); return; } const transactionToDelete = this.state.transactions[transactionIndex]; if (transactionToDelete.items) { transactionToDelete.items.forEach(soldItem => { if (soldItem.particulars.startsWith('(Cosmetic)')) return; const inventoryItem = this.state.inventory.find(i => i.particulars === soldItem.particulars); if (inventoryItem) inventoryItem.quantity += soldItem.quantity; else this.state.inventory.push({ particulars: soldItem.particulars, quantity: soldItem.quantity, rate: soldItem.costRate }); }); } this.state.transactions.splice(transactionIndex, 1); this.showToast("Sale deleted and stock restored.", "success"); this.renderAll(); this.triggerAutoSave(); },
            handleSalesReturn(transactionId, itemParticulars) { if (!confirm(`Are you sure you want to return "${itemParticulars}" from this sale?`)) return; const transaction = this.state.transactions.find(t => t.id === transactionId); if (!transaction) { this.showToast("Sale not found.", "error"); return; } const itemIndex = transaction.items.findIndex(i => i.particulars === itemParticulars); if (itemIndex === -1) { this.showToast("Item not found.", "error"); return; } const [returnedItem] = transaction.items.splice(itemIndex, 1); if (!returnedItem.particulars.startsWith('(Cosmetic)')) { const inventoryItem = this.state.inventory.find(i => i.particulars === returnedItem.particulars); if (inventoryItem) inventoryItem.quantity += returnedItem.quantity; else this.state.inventory.push({ particulars: returnedItem.particulars, quantity: returnedItem.quantity, rate: returnedItem.costRate }); } const returnedValue = returnedItem.quantity * returnedItem.sellingRate; transaction.total -= returnedValue; if (transaction.paidAmount > transaction.total) transaction.paidAmount = transaction.total; if (transaction.items.length === 0) { const transactionIndexGlobal = this.state.transactions.findIndex(t => t.id === transactionId); this.state.transactions.splice(transactionIndexGlobal, 1); this.showToast('Item returned. Sale removed.', 'success'); } else { this.showToast('Item returned.', 'success'); } this.renderAll(); this.triggerAutoSave(); },
            processSale(isInvoice, isCredit = false, creditForm) { const container = isCredit ? creditForm.querySelector('#credit-inventory-items-container') : this.ui.salesItemsContainer; const partyName = isCredit ? creditForm.querySelector('#credit-inventory-party-name').value.trim() : null; const saleDate = isCredit ? new Date(creditForm.querySelector('#credit-inventory-date').value + 'T00:00:00') : new Date(); if (isCredit && !partyName) { this.showToast("Party Name is required.", "error"); return null; } if (isCredit && isNaN(saleDate.getTime())) { this.showToast("Invalid date.", "error"); return null; } const saleItems = [], errors = []; let isValid = true; container.querySelectorAll('.item-entry').forEach(entry => { const p = this.parseItemNameFromDatalist(entry.querySelector('.particulars').value); const q = parseInt(entry.querySelector('.quantity').value, 10); const r = parseFloat(entry.querySelector('.rate').value); if (!p || !q || isNaN(r)) return; const item = this.state.inventory.find(i => i.particulars === p); if (!item) { isValid = false; errors.push(`Item not found: ${p}`); } else if (item.quantity < q) { isValid = false; errors.push(`Not enough stock for ${p}.`); } else saleItems.push({ particulars: p, quantity: q, sellingRate: r, costRate: item.rate }); }); if (saleItems.length === 0) { this.showToast("Add at least one item.", "error"); return null; } if (!isValid) { this.showToast("Sale error:
" + errors.join("
"), "error"); return null; } saleItems.forEach(soldItem => { this.state.inventory.find(i => i.particulars === soldItem.particulars).quantity -= soldItem.quantity; }); const newTransaction = { id: Date.now(), type: 'Sale', saleType: isCredit ? 'Credit' : 'Cash', partyName, date: saleDate, items: saleItems, total: saleItems.reduce((acc, si) => acc + (si.sellingRate * si.quantity), 0), paidAmount: 0 }; this.state.transactions.push(newTransaction); this.renderAll(); this.triggerAutoSave(); if (isCredit) { creditForm.reset(); this.ui.credit.inventoryDateInput.value = this.getTodayDateString(); container.innerHTML = ''; this.addFormItem(container, true); } else { this.ui.salesForm.reset(); this.ui.salesItemsContainer.innerHTML = ''; this.addFormItem(this.ui.salesItemsContainer, true); } if (isInvoice) this.generateInvoice(newTransaction); this.showToast((isCredit ? 'Credit sale' : 'Sale') + ' recorded!', "success"); },
            recordPayment(creditorName, amount) { let paymentToApply = amount; const creditorTransactions = this.state.transactions.filter(t => t.saleType === 'Credit' && t.partyName === creditorName && (t.total - (t.paidAmount || 0)) > 0.01).sort((a, b) => a.date - b.date); if (creditorTransactions.length === 0) { this.showToast("No outstanding balance.", "error"); return; } const totalDue = creditorTransactions.reduce((sum, t) => sum + (t.total - (t.paidAmount || 0)), 0); if (amount > totalDue + 0.01) { this.showToast(`Payment (₹${amount.toFixed(2)}) exceeds total due (₹${totalDue.toFixed(2)}).`, 'error'); return; } for (const transaction of creditorTransactions) { if (paymentToApply <= 0) break; const dueOnThisTx = transaction.total - (transaction.paidAmount || 0); const paymentForThisTx = Math.min(paymentToApply, dueOnThisTx); transaction.paidAmount = (transaction.paidAmount || 0) + paymentForThisTx; paymentToApply -= paymentForThisTx; } this.showToast(`Payment of ₹${amount.toFixed(2)} recorded for ${creditorName}.`, 'success'); this.renderAll(); this.triggerAutoSave(); },
            exportTransactionsToExcel() { if (this.state.transactions.length === 0) { this.showToast("No transactions to export.", "error"); return; } const salesData = this.state.transactions.filter(t => t.type === 'Sale').flatMap(t => t.items.map(i => ({"Tx ID": t.id, Date: this.formatDateDDMMYYYY(t.date), Type: t.saleType, Party: t.partyName || 'N/A', Paid: t.paidAmount, Item: i.particulars, Qty: i.quantity, "Sell Rate": i.sellingRate, "Cost Rate": i.costRate, Total: i.quantity * i.sellingRate, Profit: (i.sellingRate - i.costRate) * i.quantity }))); const purchaseData = this.state.transactions.filter(t => t.type === 'Purchase').flatMap(t => t.items.map(i => ({"Tx ID": t.id, Date: this.formatDateDDMMYYYY(t.date), Item: i.particulars, Qty: i.quantity, "Cost Rate": i.rate, Total: i.quantity * i.rate }))); const wsSales = XLSX.utils.json_to_sheet(salesData), wsPurchases = XLSX.utils.json_to_sheet(purchaseData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, wsSales, "Sales"); XLSX.utils.book_append_sheet(wb, wsPurchases, "Purchases"); XLSX.writeFile(wb, "Transaction_History.xlsx"); this.showToast("Exported successfully!", "success"); },
            generateInvoice(transaction) { const doc = new jsPDF(); let y = 20; doc.setFontSize(22); doc.text("Tinny Fashion Store", 105, y, { align: "center" }); y += 8; doc.setFontSize(12); doc.text("Run by Rekha ChandraShekhar Mishra", 105, y, { align: "center" }); y += 15; doc.setFontSize(18); doc.text("Sale Invoice", 105, y, { align: "center" }); y += 8; doc.setFontSize(10); if (transaction.saleType === 'Credit') doc.text(`Credit To: ${transaction.partyName}`, 20, y); doc.text(`Date: ${this.formatDateDDMMYYYY(transaction.date)}`, 190, y, { align: "right" }); y += 15; doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.text("Item Description", 20, y); doc.text("Qty", 130, y); doc.text("Rate", 150, y); doc.text("Amount", 185, y, { align: "right" }); y += 7; doc.setLineWidth(0.5); doc.line(20, y, 190, y); y += 8; doc.setFont("helvetica", "normal"); transaction.items.forEach(item => { doc.text(item.particulars, 20, y); doc.text(item.quantity.toString(), 130, y); doc.text(item.sellingRate.toFixed(2), 150, y); doc.text((item.quantity * item.sellingRate).toFixed(2), 185, y, { align: "right" }); y += 7; }); y += 5; doc.setLineWidth(0.5); doc.line(130, y, 190, y); y += 7; doc.setFont("helvetica", "bold"); doc.text("Grand Total", 130, y); doc.text(`Rs. ${transaction.total.toFixed(2)}`, 185, y, { align: "right" }); doc.save(`Invoice_${transaction.id}.pdf`); },
            showToast(msg, type='success') { const toast = document.getElementById('toast'); toast.textContent = msg; toast.className = `show ${type}`; setTimeout(() => toast.className = toast.className.replace('show',''), 3000); },
            
            addEventListeners() { 
                this.ui.excelFile.addEventListener('change', (e) => this.handleFileUpload(e));
                this.ui.addSaleItemBtn.addEventListener('click', () => this.addFormItem(this.ui.salesItemsContainer, true));
                this.ui.addPurchaseItemBtn.addEventListener('click', () => this.addFormItem(this.ui.purchaseItemsContainer, false));
                this.ui.recordSaleBtn.addEventListener('click', () => this.processSale(false, false));
                this.ui.recordInvoiceBtn.addEventListener('click', () => this.processSale(true, false));
                this.ui.credit.addInventoryItemBtn.addEventListener('click', () => this.addFormItem(this.ui.credit.inventoryItemsContainer, true));
                this.ui.credit.inventorySaleForm.addEventListener('submit', (e) => { e.preventDefault(); this.processSale(false, true, e.target); });
                this.ui.manualSaveBtn.addEventListener('click', () => this.saveData());
                this.ui.analytics.filterBtn.addEventListener('click', () => this.renderFilteredSalesAndProfit());
                this.ui.analytics.todayBtn.addEventListener('click', () => { const todayStr = this.getTodayDateString(); this.ui.analytics.startDateInput.value = todayStr; this.ui.analytics.endDateInput.value = todayStr; this.renderFilteredSalesAndProfit(); });
                this.ui.analytics.heatmapMonthFilter.addEventListener('change', () => this.renderProductHeatmap());
                this.ui.analytics.heatmapItemTypeFilter.addEventListener('change', () => this.renderProductHeatmap());
                
                // NEW EVENT LISTENER FOR PREDICTION BUTTON
                this.ui.analytics.runPredictionBtn.addEventListener('click', () => this.runSalesPrediction());

                const downloadLowStockLogic = () => {
                    const lowStockItems = this.state.inventory.filter(item => item.quantity > 0 && item.quantity <= 5);
                    if (lowStockItems.length === 0) { this.showToast("No low stock items.", "info"); return; }
                    const ws = XLSX.utils.json_to_sheet(lowStockItems.map(item => ({ 'Particulars': item.particulars, 'Qty': item.quantity, 'Rate': item.rate.toFixed(2) })));
                    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Low Stock"); XLSX.writeFile(wb, "Low_Stock_Inventory.xlsx");
                    this.showToast("Low stock list downloaded!", "success");
                };
                this.ui.analytics.downloadLowStockBtn.addEventListener('click', downloadLowStockLogic);
                if (this.ui.operations.dashboardDownloadLowStockBtn) this.ui.operations.dashboardDownloadLowStockBtn.addEventListener('click', downloadLowStockLogic);
                
                this.ui.analytics.lowStockItems.addEventListener('click', (e) => {
                    const categoryTitle = e.target.closest('.low-stock-category-title');
                    if (categoryTitle) { const itemsList = document.getElementById(categoryTitle.dataset.categoryIndex.replace('analytics-', 'analytics-items-')); if (itemsList) { const isExpanded = itemsList.style.display === 'block'; itemsList.style.display = isExpanded ? 'none' : 'block'; categoryTitle.classList.toggle('expanded', !isExpanded); } }
                });
                if (this.ui.operations.dashboardLowStockItemsUl) {
                    this.ui.operations.dashboardLowStockItemsUl.addEventListener('click', (e) => {
                        const categoryHeader = e.target.closest('.dashboard-category-header');
                        if (categoryHeader) { const itemsList = document.getElementById(categoryHeader.dataset.categoryIndex.replace('dashboard-', 'dashboard-items-')); if (itemsList) { const isExpanded = itemsList.style.display === 'block'; itemsList.style.display = isExpanded ? 'none' : 'block'; categoryHeader.classList.toggle('expanded', !isExpanded); } }
                    });
                }
                
                this.ui.operations.salesTrendModeSelect.addEventListener('change', () => {
                    this.ui.operations.salesTrendCustomRangeInputs.style.display = this.ui.operations.salesTrendModeSelect.value === 'customRange' ? 'flex' : 'none';
                    if (this.ui.operations.salesTrendModeSelect.value === 'customRange') {
                        if (!this.ui.operations.salesTrendStartDateInput.value) this.ui.operations.salesTrendStartDateInput.value = this.getTodayDateString(new Date(new Date().setDate(new Date().getDate() - 6)));
                        if (!this.ui.operations.salesTrendEndDateInput.value) this.ui.operations.salesTrendEndDateInput.value = this.getTodayDateString();
                    }
                    this.renderSalesTrendChart(); 
                });
                this.ui.operations.refreshSalesTrendBtn.addEventListener('click', () => this.renderSalesTrendChart());
                this.ui.settings.addHolidayBtn.addEventListener('click', () => { const holidayDateStr = this.ui.settings.holidayDateInput.value; if (!holidayDateStr) { this.showToast("Select a date.", "error"); return; } if (this.state.holidays.includes(holidayDateStr)) { this.showToast("Date is already a holiday.", "info"); return; } this.state.holidays.push(holidayDateStr); this.renderHolidays(); this.triggerAutoSave(); this.showToast("Holiday added!", "success"); this.ui.settings.holidayDateInput.value = ''; this.renderSalesTrendChart(); });
                this.ui.settings.holidayList.addEventListener('click', (e) => { if (e.target.classList.contains('delete-holiday-btn')) { this.state.holidays = this.state.holidays.filter(d => d !== e.target.dataset.date); this.renderHolidays(); this.triggerAutoSave(); this.showToast("Holiday removed.", "success"); this.renderSalesTrendChart(); } });
                this.ui.credit.cosmeticSaleForm.addEventListener('submit', (e) => { e.preventDefault(); const pName = e.target.querySelector('#credit-cosmetic-party-name').value.trim(), dateStr = e.target.querySelector('#credit-cosmetic-date').value, iName = e.target.querySelector('#credit-cosmetic-item-name').value.trim(), qty = parseInt(e.target.querySelector('#credit-cosmetic-qty').value, 10), cRate = parseFloat(e.target.querySelector('#credit-cosmetic-cost-rate').value), sRate = parseFloat(e.target.querySelector('#credit-cosmetic-sell-rate').value); if (!dateStr) { this.showToast("Select a date.", "error"); return; } const sDate = new Date(dateStr + 'T00:00:00'); if (!pName || !iName || isNaN(qty) || isNaN(cRate) || isNaN(sRate) || qty <= 0 || isNaN(sDate.getTime())) { this.showToast("Fill all fields correctly.", "error"); return; } this.state.transactions.push({ id: Date.now(), type: 'Sale', saleType: 'Credit', partyName: pName, date: sDate, items: [{ particulars: `(Cosmetic) ${iName}`, quantity: qty, sellingRate: sRate, costRate: cRate }], total: sRate * qty, paidAmount: 0 }); this.renderAll(); this.triggerAutoSave(); e.target.reset(); this.ui.credit.cosmeticDateInput.value = this.getTodayDateString(); this.showToast(`Credit sale to ${pName} recorded!`, 'success'); });
                this.ui.transactions.exportExcelBtn.addEventListener('click', () => this.exportTransactionsToExcel());
                this.ui.transactions.filterBtn.addEventListener('click', () => this.renderTransactions());
                this.ui.transactions.resetFilterBtn.addEventListener('click', () => { this.ui.transactions.startDateInput.value = ''; this.ui.transactions.endDateInput.value = ''; this.renderTransactions(); });
                this.ui.transactions.transactionSortOrder.addEventListener('change', () => this.renderTransactions());
                this.ui.credit.creditorListContainer.addEventListener('click', (e) => { const creditorHeader = e.target.closest('.creditor-header'), recordButton = e.target.closest('.record-payment-btn'); if (creditorHeader) { const details = creditorHeader.nextElementSibling, item = creditorHeader.closest('.creditor-item'); details.classList.toggle('visible'); creditorHeader.classList.toggle('is-open'); if (item) item.classList.toggle('is-expanded'); } else if (recordButton) { const name = recordButton.dataset.creditorName, input = recordButton.closest('.payment-form').querySelector('.payment-amount-input'), amount = parseFloat(input.value); if (isNaN(amount) || amount <= 0) { this.showToast('Enter a valid amount.', 'error'); return; } this.recordPayment(name, amount); input.value = ''; } });
                this.ui.cosmeticSaleForm.addEventListener('submit', (e) => { e.preventDefault(); const p = e.target.querySelector('#cosmetic-particulars').value.trim(), q = parseInt(e.target.querySelector('#cosmetic-quantity').value, 10), c = parseFloat(e.target.querySelector('#cosmetic-cost-rate').value), s = parseFloat(e.target.querySelector('#cosmetic-sell-rate').value); if (!p || isNaN(q) || isNaN(c) || isNaN(s) || q <= 0) { this.showToast("Fill all fields correctly.", "error"); return; } this.state.transactions.push({ id: Date.now(), type: 'Sale', saleType: 'Cash', partyName: null, date: new Date(), items: [{ particulars: `(Cosmetic) ${p}`, quantity: q, sellingRate: s, costRate: c }], total: s * q }); this.renderAll(); this.triggerAutoSave(); e.target.reset(); this.showToast(`Profit recorded!`, "success"); });
                this.ui.purchaseForm.addEventListener('submit', (event) => { event.preventDefault(); const { newItems, total } = Array.from(this.ui.purchaseItemsContainer.querySelectorAll('.item-entry')).reduce((acc, entry) => { const p = entry.querySelector('.particulars').value, q = parseInt(entry.querySelector('.quantity').value, 10), r = parseFloat(entry.querySelector('.rate').value); if (p && q && !isNaN(r)) { acc.newItems.push({ particulars: p, quantity: q, rate: r }); acc.total += q * r; } return acc; }, { newItems: [], total: 0 }); if (newItems.length === 0) return this.showToast("Add at least one item.", "error"); newItems.forEach(newItem => { const existing = this.state.inventory.find(i => i.particulars.toLowerCase() === newItem.particulars.toLowerCase()); if (existing) { const totalVal = existing.rate * existing.quantity + newItem.rate * newItem.quantity, totalQty = existing.quantity + newItem.quantity; existing.rate = totalVal / totalQty; existing.quantity = totalQty; } else this.state.inventory.push(newItem); }); this.state.transactions.push({ id: Date.now(), type: 'Purchase', date: new Date(), items: newItems, total }); this.renderAll(); this.triggerAutoSave(); this.ui.purchaseItemsContainer.innerHTML = ''; this.addFormItem(this.ui.purchaseItemsContainer, false); this.showToast('Stock updated!', "success"); });
                this.ui.tabButtons.forEach(button => button.addEventListener('click', () => { this.ui.tabButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); this.ui.tabContents.forEach(content => content.classList.remove('active')); document.getElementById(button.dataset.tab).classList.add('active'); this.renderAllAnalyticsCharts(); }));
                document.body.addEventListener('input', e => { if (e.target.classList.contains('particulars')) { const item = this.state.inventory.find(i => i.particulars === this.parseItemNameFromDatalist(e.target.value)); const rateInput = e.target.closest('.item-entry').querySelector('.rate'); if (item && rateInput && (e.target.closest('#sales-form') || e.target.closest('#credit-inventory-sale-form'))) rateInput.value = (item.rate * 1.25).toFixed(2); } });
                this.ui.transactions.transactionsTab.addEventListener('click', e => { if (e.target.classList.contains('download-invoice-btn')) { const tx = this.state.transactions.find(t => t.id === parseInt(e.target.dataset.id, 10)); if (tx) this.generateInvoice(tx); } else if (e.target.classList.contains('delete-sale-btn')) this.deleteSale(parseInt(e.target.dataset.id, 10)); else if (e.target.classList.contains('return-item-btn')) this.handleSalesReturn(parseInt(e.target.dataset.transactionId, 10), e.target.dataset.itemParticulars); });
                this.ui.inventoryTableBody.addEventListener('click', (e) => { const particulars = e.target.dataset.particulars, row = e.target.closest('tr'); if (!row) return; if (e.target.classList.contains('edit-btn')) { const editing = this.ui.inventoryTableBody.querySelector('tr.edit-mode'); if(editing) editing.classList.remove('edit-mode'); row.classList.add('edit-mode'); } else if (e.target.classList.contains('cancel-btn')) row.classList.remove('edit-mode'); else if (e.target.classList.contains('delete-btn')) { if (confirm(`Delete "${particulars}"?`)) { this.state.inventory = this.state.inventory.filter(item => item.particulars !== particulars); this.renderAll(); this.triggerAutoSave(); this.showToast('Item deleted.', 'success'); } } else if (e.target.classList.contains('save-btn')) { const newQty = parseInt(row.querySelector('.edit-quantity').value, 10), newRate = parseFloat(row.querySelector('.edit-rate').value); if (isNaN(newQty) || isNaN(newRate) || newQty < 0 || newRate < 0) { this.showToast('Invalid input.', 'error'); return; } const itemToUpdate = this.state.inventory.find(item => item.particulars === particulars); if (itemToUpdate) { itemToUpdate.quantity = newQty; itemToUpdate.rate = newRate; } this.renderAll(); this.triggerAutoSave(); this.showToast('Inventory updated!', 'success'); } });
            }
        };
        app.init();
    };
    </script>
</body>
</html>

