<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tinny Fashion - Business Manager</title>
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3crect width='100' height='100' rx='15' fill='%23DD6B20'/%3e%3cpath fill='white' d='M20 30h60l-10 50H30zM50 20c-8 0-15 7-15 15v5h30v-5c0-8-7-15-15-15zM30 40c0 5 5 10 10 10h20c5 0 10-5 10-10'/%3e%3c/svg%3e">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <style>
        :root {
            --background-body: #F7FAFC;
            --surface-card: #FFFFFF;
            --text-primary: #1A202C;
            --text-secondary: #718096;
            --border-color: #E2E8F0;
            
            --accent-primary: #DD6B20; /* Orange */
            --accent-primary-hover: #C05621;
            --accent-secondary: #4A5568;
            
            --success-green: #38A169;
            --danger-red: #C53030;
            --info-blue: #3182CE;
            
            --border-radius-md: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html { height: 100%; }
        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--background-body);
            color: var(--text-primary);
            line-height: 1.5;
        }

        #login-screen {
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; width: 100%; text-align: center; padding: 1rem;
        }
        .login-box {
            background: var(--surface-card); padding: 2.5rem; border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md); max-width: 450px; width: 100%;
        }
        .login-box h1 { margin-bottom: 0.5rem; font-size: 2rem; font-weight: 700; color: var(--accent-primary); }
        .login-box p { color: var(--text-secondary); margin-bottom: 2rem; }
        #signin-btn { 
            background-color: #4285F4; color: white; border: none; padding: 12px 24px; font-size: 1rem; 
            font-weight: 500; border-radius: 8px; cursor: pointer; display: inline-flex; 
            align-items: center; gap: 1rem; transition: background-color 0.3s; box-shadow: var(--shadow-sm); 
        }
        #signin-btn:hover:not([disabled]) { background-color: #357ae8; box-shadow: var(--shadow-md); }
        #signin-btn[disabled] { background-color: #A0AEC0; cursor: not-allowed; }
        #signin-btn svg { width: 22px; height: 22px; background: white; border-radius: 50%; padding: 2px; }

        #app-wrapper { display: none; }
        #app-wrapper.visible { display: block; }

        #app-header {
            background: var(--surface-card);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--accent-primary); }
        #top-nav { display: flex; gap: 0.5rem; }
        .nav-link {
            padding: 0.5rem 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: color 0.2s, background-color 0.2s;
        }
        .nav-link:hover { color: var(--text-primary); background-color: var(--background-body); }
        .nav-link.active { color: var(--accent-primary); font-weight: 600; }
        
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        #signout-btn {
            background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary);
            padding: 0.5rem 1rem; border-radius: 8px; font-weight: 500; cursor: pointer;
            transition: all 0.2s;
        }
        #signout-btn:hover { background-color: var(--background-body); color: var(--text-primary); }
        
        .mobile-menu-btn { display: none; }

        #main-content { padding: 2rem; max-width: 1200px; margin: 0 auto; }
        .page { display: none; }
        .page.active { display: block; animation: fadeInContent 0.5s ease-out; }
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .page-header { margin-bottom: 2rem; }
        .page-header h1 { font-size: 2rem; font-weight: 700; }
        .page-header p { color: var(--text-secondary); font-size: 1rem; }

        .card {
            background: var(--surface-card); border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
            padding: 1.5rem; margin-bottom: 1.5rem;
        }
         .card h2 {
            font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem;
        }

        /* Dashboard & Analytics Grids */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }
        .kpi-card { padding: 1.5rem; }
        .kpi-card h3 {
            font-size: 0.9rem; font-weight: 500; color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        .kpi-card p { font-size: 2.25rem; font-weight: 700; line-height: 1; color: var(--text-primary); }
        .main-chart-card { grid-column: 1 / -1; }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
        }
        label { font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem; display: block; }
        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 1rem; font-family: 'Poppins', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus {
            outline: none; border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(221, 107, 32, 0.2);
        }
        .btn {
            padding: 0.75rem 1.5rem; border: none; border-radius: 8px;
            font-size: 0.95rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background-color: var(--accent-primary); color: #fff; }
        .btn-primary:hover { background-color: var(--accent-primary-hover); transform: translateY(-2px); box-shadow: var(--shadow-md);}
        .btn-secondary { background-color: var(--accent-secondary); color: #fff; }
        .btn-danger { background-color: var(--danger-red); color: #fff; }

        /* Tables */
        .table-container { width: 100%; overflow-x: auto; }
        .styled-table { width: 100%; border-collapse: collapse; }
        .styled-table th, .styled-table td {
            padding: 1rem; text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .styled-table th {
            font-weight: 600; font-size: 0.85rem; text-transform: uppercase;
            color: var(--text-secondary);
        }
        .styled-table td { font-weight: 500; }
        .action-icon {
            display: inline-flex; cursor: pointer; color: var(--text-secondary);
            padding: 0.25rem; border-radius: 50%;
            transition: color 0.2s, background-color 0.2s;
        }
        .action-icon:hover { color: var(--danger-red); background-color: #FEE2E2; }
        .action-icon svg { width: 20px; height: 20px; }

        /* Multi-item Form */
        .multi-item-form-container .item-row {
            display: grid; grid-template-columns: 3fr 1fr 1fr auto;
            gap: 1rem; align-items: flex-end; padding: 1rem 0;
            border-bottom: 1px dashed var(--border-color);
        }
        .multi-item-form-container .item-row:first-child { padding-top: 0; }
        
        #toast { 
            position: fixed; bottom: -120px; right: 2rem;
            padding: 1rem 1.5rem; border-radius: var(--border-radius-md); color: #fff; 
            font-weight: 600; font-size: 1rem; box-shadow: var(--shadow-md); 
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); 
            z-index: 9999; opacity: 0;
        }
        #toast.show { bottom: 2rem; opacity: 1; }
        #toast.success { background-color: var(--success-green); }
        #toast.error { background-color: var(--danger-red); }
        #toast.info { background-color: var(--info-blue); }
        
        /* Responsive */
        @media (max-width: 1024px) {
            #app-header { padding: 1rem; }
            #main-content { padding: 1.5rem; }
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
            .main-chart-card { grid-column: 1 / -1; }
        }

        @media (max-width: 768px) {
            #top-nav {
                display: none;
                position: absolute;
                top: 100%; left: 0;
                width: 100%;
                background-color: var(--surface-card);
                border-bottom: 1px solid var(--border-color);
                flex-direction: column;
                padding: 1rem;
            }
            #top-nav.active { display: flex; }
            .mobile-menu-btn {
                display: block; background: transparent; border: none; cursor: pointer;
            }
            .mobile-menu-btn svg { width: 28px; height: 28px; }

            .dashboard-grid { grid-template-columns: 1fr; }
            .multi-item-form-container .item-row { grid-template-columns: 1fr; }
            .multi-item-form-container .item-row .actions { justify-self: stretch; }
            .multi-item-form-container .item-row .actions button { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h1>Tinny Fashion</h1>
            <p>Your business manager. Sign in to get started.</p>
            <button id="signin-btn" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 35.841 44 30.138 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <div id="app-wrapper">
        <header id="app-header">
            <div class="logo">Tinny Fashion</div>
            <nav id="top-nav">
                <a href="#" class="nav-link active" data-page="dashboard">Dashboard</a>
                <a href="#" class="nav-link" data-page="sales">Sales</a>
                <a href="#" class="nav-link" data-page="purchase">Purchase</a>
                <a href="#" class="nav-link" data-page="stocks">Stocks</a>
                <a href="#" class="nav-link" data-page="analytics">Analytics</a>
                <a href="#" class="nav-link" data-page="credit">Credit</a>
                <a href="#" class="nav-link" data-page="settings">Settings</a>
            </nav>
            <div class="header-actions">
                <button id="signout-btn">Sign Out</button>
                <button class="mobile-menu-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                </button>
            </div>
        </header>
        <main id="main-content">
            <div id="dashboard" class="page active">
                <div class="page-header">
                    <h1>Dashboard</h1>
                    <p>A quick overview of your store's performance.</p>
                </div>
                <div class="dashboard-grid">
                    <div class="card kpi-card">
                        <h3>Revenue (30 Days)</h3>
                        <p id="dashboard-revenue">₹0</p>
                    </div>
                    <div class="card kpi-card">
                        <h3>Profit (30 Days)</h3>
                        <p id="dashboard-profit">₹0</p>
                    </div>
                    <div class="card kpi-card">
                        <h3>Low Stock Items</h3>
                        <p id="dashboard-low-stock">0</p>
                    </div>
                    <div class="card kpi-card">
                        <h3>Inventory Value</h3>
                        <p id="dashboard-inv-value">₹0</p>
                    </div>
                    <div class="card main-chart-card">
                        <h2>Sales Trend (Last 7 Days)</h2>
                        <canvas id="salesTrendChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>

            <div id="sales" class="page">
                <div class="page-header"><h1>Record a Sale</h1><p>Add items from your inventory to record a transaction.</p></div>
                <div class="card">
                    <h2>Inventory Sale</h2>
                    <form id="sales-form">
                        <div id="sales-items-container" class="multi-item-form-container"></div>
                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
                            <button type="button" id="add-sale-item-btn" class="btn btn-secondary" style="background-color: #E2E8F0; color: var(--text-primary);">+ Add Item</button>
                            <button type="submit" class="btn btn-primary" style="margin-left: auto;">Record Sale</button>
                        </div>
                    </form>
                </div>
                <datalist id="inventory-datalist"></datalist>
            </div>
            
            <div id="purchase" class="page">
                 <div class="page-header"><h1>Record a Purchase</h1><p>Add new items to update your stock levels.</p></div>
                 <div class="card">
                    <h2>Add New Stock</h2>
                    <form id="purchase-form">
                        <div id="purchase-items-container" class="multi-item-form-container"></div>
                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
                            <button type="button" id="add-purchase-item-btn" class="btn btn-secondary" style="background-color: #E2E8F0; color: var(--text-primary);">+ Add Item</button>
                            <button type="submit" class="btn btn-primary" style="margin-left: auto;">Add to Stock</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="stocks" class="page">
                <div class="page-header"><h1>Inventory Stocks</h1><p>View and manage all items in your inventory.</p></div>
                <div class="card">
                    <div class="table-container">
                        <table class="styled-table" id="inventory-table">
                            <thead><tr><th>ITEM</th><th>QTY</th><th>COST</th><th>ACTION</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="analytics" class="page">
                 <div class="page-header"><h1>Analytics</h1><p>Explore your sales data and store performance.</p></div>
                 <div class="card dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                    <div class="kpi-card">
                        <h3>Total Revenue (All Time)</h3>
                        <p id="analytics-total-revenue">₹0</p>
                    </div>
                    <div class="kpi-card">
                        <h3>Total Profit (All Time)</h3>
                        <p id="analytics-total-profit">₹0</p>
                    </div>
                    <div class="kpi-card">
                        <h3>Avg. Margin (All Time)</h3>
                        <p id="analytics-avg-margin">0%</p>
                    </div>
                </div>
                <div class="card">
                    <h2>Filter by Date</h2>
                    <div class="form-grid" style="align-items: flex-end;">
                        <div><label>Start Date</label><input type="date" id="analytics-start-date"></div>
                        <div><label>End Date</label><input type="date" id="analytics-end-date"></div>
                        <button class="btn btn-primary" id="analytics-filter-btn">Filter</button>
                    </div>
                    <div id="filtered-results-container" class="dashboard-grid" style="display:none; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <div class="kpi-card"><h3>Filtered Sales</h3><p id="filtered-sales-total">₹0</p></div>
                        <div class="kpi-card"><h3>Filtered Profit</h3><p id="filtered-profit-total">₹0</p></div>
                    </div>
                </div>
            </div>
            
            <div id="credit" class="page">
                <div class="page-header"><h1>Credit Management</h1><p>Track outstanding payments from customers.</p></div>
                <div class="card">
                    <h2>Record Credit Sale</h2>
                     <form id="credit-inventory-sale-form" class="form-grid">
                        <div style="grid-column: 1 / -1;"><label for="credit-inventory-party-name">Creditor's Name</label><input type="text" id="credit-inventory-party-name" required></div>
                        <div style="grid-column: 1 / -1;"><label>Item Name</label><input type="text" class="particulars" list="inventory-datalist" required></div>
                        <div><label>Quantity</label><input type="number" class="quantity" min="1" required></div>
                        <div><label>Sale Rate</label><input type="number" class="rate" min="0" step="0.01" required></div>
                        <button type="submit" class="btn btn-primary" style="grid-column: 1 / -1;">Record Credit Sale</button>
                    </form>
                </div>
                <div class="card">
                    <h2>Outstanding Credit</h2>
                    <div id="creditor-list-container" class="table-container"></div>
                </div>
            </div>

            <div id="settings" class="page">
                <div class="page-header"><h1>Settings</h1><p>Manage your application data and preferences.</p></div>
                 <div class="card">
                    <h2>Data Management</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Load inventory from an Excel file (columns: 'particulars', 'quantity', 'rate'). This will overwrite your current inventory.</p>
                    <button class="btn btn-primary" id="import-data-btn">Import from Excel</button>
                    <input type="file" id="excel-file" accept=".xlsx, .xls" style="display: none;">
                </div>
            </div>
        </main>
    </div>
    
    <div id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
    window.onload = () => {
        const { jsPDF } = window.jspdf;

        const app = {
            CLIENT_ID: '460969544827-ip0gvjsjv79m5sibkmgbngmqpl8n5u16.apps.googleusercontent.com',
            API_KEY: 'AIzaSyDYfJX4cryYxGSgPe1319kHf_u6bb071lg', 
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            APP_FOLDER_NAME: 'TinnyFashionStore_Data',
            DATA_FILE_NAME: 'fashion_store_data.json',
            tokenClient: null, driveFileId: null, isSaving: false, saveTimeout: null,
            state: { inventory: [], transactions: [], holidays: [] },
            ui: {},
            salesChartInstance: null,

            init() {
                this.cacheDOMElements();
                gapi.load('client', this.initializeGapiClient.bind(this));
                this.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: this.CLIENT_ID, scope: this.SCOPES,
                    callback: this.handleAuthResponse.bind(this),
                });
                this.ui.signinBtn.addEventListener('click', () => this.tokenClient.requestAccessToken({prompt: 'consent'}));
                this.ui.signoutBtn.addEventListener('click', this.signOut.bind(this));
            },
            async initializeGapiClient() {
                await gapi.client.init({ apiKey: this.API_KEY, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"] });
                this.ui.signinBtn.disabled = false;
            },
            async handleAuthResponse(response) {
                if (response.error) { this.showToast(`Error: ${response.error}`, 'error'); return; }
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-wrapper').classList.add('visible');
                await this.loadData();
                this.startAppLogic();
            },
            signOut() {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token, () => {
                        gapi.client.setToken(''); this.driveFileId = null;
                        document.getElementById('login-screen').style.display = 'flex';
                        document.getElementById('app-wrapper').classList.remove('visible');
                    });
                }
            },
            startAppLogic() {
                this.addEventListeners();
                this.renderPage('dashboard');
            },
            async loadData() {
                this.showToast("Loading data...", "info");
                try {
                    const response = await gapi.client.drive.files.list({ q: `name='${this.DATA_FILE_NAME}' and trashed=false`, spaces: 'drive', fields: 'files(id)' });
                    if (response.result.files && response.result.files.length > 0) {
                        this.driveFileId = response.result.files[0].id;
                        const fileContentResponse = await gapi.client.drive.files.get({ fileId: this.driveFileId, alt: 'media' });
                        const loadedState = JSON.parse(fileContentResponse.body);
                        
                        if (loadedState.transactions) {
                           loadedState.transactions.forEach(t => { t.date = new Date(t.date); });
                        }
                        const defaultState = { inventory: [], transactions: [], holidays: [] };
                        this.state = { ...defaultState, ...loadedState };
                    } else {
                        this.state = { inventory: [], transactions: [], holidays: [] };
                    }
                } catch (e) {
                    this.state = { inventory: [], transactions: [], holidays: [] }; 
                }
            },
            triggerAutoSave() {
                clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => this.saveData(), 2000);
            },
            async saveData() {
                if (this.isSaving) return;
                this.isSaving = true; this.showToast("Saving...", "info");
                try {
                    const dataToSave = JSON.stringify(this.state, null, 2);
                    const boundary = '-------314159265358979323846';
                    const delimiter = "\r\n--" + boundary + "\r\n";
                    const close_delim = "\r\n--" + boundary + "--";
                    let request;
                    if (this.driveFileId) {
                        const multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify({}) + delimiter + 'Content-Type: application/json\r\n\r\n' + dataToSave + close_delim;
                        request = gapi.client.request({'path': `https://www.googleapis.com/upload/drive/v3/files/${this.driveFileId}`,'method': 'PATCH','params': { 'uploadType': 'multipart' },'headers': {'Content-Type': 'multipart/related; boundary="' + boundary + '"'},'body': multipartRequestBody});
                    } else {
                        let res = await gapi.client.drive.files.list({ q: `name='${this.APP_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`, spaces: 'drive', fields: 'files(id)' });
                        let folderId = res.result.files?.[0]?.id;
                        if (!folderId) {
                            res = await gapi.client.drive.files.create({ resource: { 'name': this.APP_FOLDER_NAME, 'mimeType': 'application/vnd.google-apps.folder' }, fields: 'id' });
                            folderId = res.result.id;
                        }
                        const metadata = {'name': this.DATA_FILE_NAME, 'parents': [folderId], 'mimeType': 'application/json'};
                        const multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) + delimiter + 'Content-Type: application/json\r\n\r\n' + dataToSave + close_delim;
                        request = gapi.client.request({'path': 'https://www.googleapis.com/upload/drive/v3/files', 'method': 'POST', 'params': {'uploadType': 'multipart'}, 'headers': {'Content-Type': 'multipart/related; boundary="' + boundary + '"'},'body': multipartRequestBody});
                    }
                    const response = await request;
                    if (!this.driveFileId) { this.driveFileId = response.result.id; }
                    this.showToast("Data saved!", "success");
                } catch (e) { 
                    this.showToast("Failed to save.", "error");
                } finally {
                    this.isSaving = false;
                }
            },
            cacheDOMElements() {
                this.ui = {
                    signinBtn: document.getElementById('signin-btn'),
                    signoutBtn: document.getElementById('signout-btn'),
                    navLinks: document.querySelectorAll('.nav-link'),
                    pages: document.querySelectorAll('.page'),
                    mobileMenuBtn: document.querySelector('.mobile-menu-btn'),
                    topNav: document.getElementById('top-nav'),

                    dashboard: {
                        revenue: document.getElementById('dashboard-revenue'),
                        profit: document.getElementById('dashboard-profit'),
                        lowStock: document.getElementById('dashboard-low-stock'),
                        invValue: document.getElementById('dashboard-inv-value'),
                        salesChart: document.getElementById('salesTrendChart'),
                    },

                    salesForm: document.getElementById('sales-form'),
                    salesItemsContainer: document.getElementById('sales-items-container'),
                    addSaleItemBtn: document.getElementById('add-sale-item-btn'),
                    inventoryDatalist: document.getElementById('inventory-datalist'),

                    purchaseForm: document.getElementById('purchase-form'),
                    purchaseItemsContainer: document.getElementById('purchase-items-container'),
                    addPurchaseItemBtn: document.getElementById('add-purchase-item-btn'),
                    
                    inventoryTableBody: document.querySelector('#inventory-table tbody'),

                    analytics: {
                        totalRevenue: document.getElementById('analytics-total-revenue'),
                        totalProfit: document.getElementById('analytics-total-profit'),
                        avgMargin: document.getElementById('analytics-avg-margin'),
                        startDate: document.getElementById('analytics-start-date'),
                        endDate: document.getElementById('analytics-end-date'),
                        filterBtn: document.getElementById('analytics-filter-btn'),
                        filteredResultsContainer: document.getElementById('filtered-results-container'),
                        filteredSales: document.getElementById('filtered-sales-total'),
                        filteredProfit: document.getElementById('filtered-profit-total'),
                    },
                    
                    creditSaleForm: document.getElementById('credit-inventory-sale-form'),
                    creditorListContainer: document.querySelector('#creditor-list-container'),

                    settings: {
                        importDataBtn: document.getElementById('import-data-btn'),
                        excelFile: document.getElementById('excel-file'),
                    }
                };
            },
            renderPage(pageId) {
                this.ui.pages.forEach(p => p.classList.remove('active'));
                document.getElementById(pageId)?.classList.add('active');

                this.ui.navLinks.forEach(l => l.classList.remove('active'));
                document.querySelector(`.nav-link[data-page="${pageId}"]`)?.classList.add('active');
                
                this.renderInventoryDatalist();

                if (pageId === 'dashboard') this.renderDashboard();
                if (pageId === 'stocks') this.renderInventory();
                if (pageId === 'analytics') this.renderAnalytics();
                if (pageId === 'credit') this.renderCreditorList();
                if (pageId === 'sales') {
                    this.ui.salesItemsContainer.innerHTML = '';
                    this.addSaleItemRow();
                }
                if (pageId === 'purchase') {
                     this.ui.purchaseItemsContainer.innerHTML = '';
                    this.addPurchaseItemRow();
                }
            },
            
            renderDashboard() {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const recentSales = this.state.transactions.filter(t => t.type === 'Sale' && t.date >= thirtyDaysAgo);
                const recentRevenue = recentSales.reduce((sum, t) => sum + t.total, 0);
                const recentProfit = recentSales.flatMap(t => t.items).reduce((sum, i) => sum + (i.sellingRate - i.costRate) * i.quantity, 0);
                const { cost, lowStockCount } = this.state.inventory.reduce((acc, item) => {
                    acc.cost += item.quantity * item.rate;
                    if (item.quantity > 0 && item.quantity <= 5) acc.lowStockCount++;
                    return acc;
                }, { cost: 0, lowStockCount: 0 });
                this.ui.dashboard.revenue.textContent = `₹${recentRevenue.toFixed(0)}`;
                this.ui.dashboard.profit.textContent = `₹${recentProfit.toFixed(0)}`;
                this.ui.dashboard.lowStock.textContent = lowStockCount;
                this.ui.dashboard.invValue.textContent = `₹${cost.toFixed(0)}`;
                this.renderSalesChart();
            },

            renderSalesChart() {
                const ctx = this.ui.dashboard.salesChart.getContext('2d');
                const labels = [];
                const dataPoints = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    labels.push(d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    dataPoints.push(0);
                }
                const sevenDaysAgo = new Date(); sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                this.state.transactions.forEach(t => {
                    if (t.type === 'Sale' && t.date >= sevenDaysAgo) {
                        const dayIndex = 6 - Math.floor((new Date() - t.date) / (1000 * 60 * 60 * 24));
                        if(dayIndex >= 0 && dayIndex < 7) dataPoints[dayIndex] += t.total;
                    }
                });
                if (this.salesChartInstance) this.salesChartInstance.destroy();
                this.salesChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ label: 'Daily Sales', data: dataPoints, 
                        backgroundColor: 'rgba(221, 107, 32, 0.1)',
                        borderColor: 'rgba(221, 107, 32, 1)', 
                        borderWidth: 2, tension: 0.4, fill: true
                    }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                });
            },

            renderInventory() { 
                this.state.inventory.sort((a, b) => a.particulars.localeCompare(b.particulars));
                this.ui.inventoryTableBody.innerHTML = this.state.inventory.length
                    ? this.state.inventory.map(item => `
                        <tr>
                            <td>${item.particulars}</td>
                            <td>${item.quantity}</td>
                            <td>₹${item.rate.toFixed(2)}</td>
                            <td><span class="action-icon delete" data-particulars="${item.particulars}" title="Delete">
                               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.046a12.705 12.705 0 011.724 6.364A3.003 3.003 0 004.5 15.5v.75A.75.75 0 005.25 17h9.5a.75.75 0 00.75-.75v-.75a3.003 3.003 0 00-1.74-2.732 12.705 12.705 0 011.724-6.364l.149.046a.75.75 0 10.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25V4.075C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg>
                            </span></td>
                        </tr>`).join('')
                    : `<tr><td colspan="4" style="text-align:center;">No inventory data.</td></tr>`;
            },
            
            renderInventoryDatalist() {
                 this.ui.inventoryDatalist.innerHTML = this.state.inventory
                    .map(item => `<option value="${item.particulars}"></option>`).join('');
            },

            renderAnalytics() {
                const sales = this.state.transactions.filter(t => t.type === 'Sale');
                const totalRevenue = sales.reduce((sum, t) => sum + t.total, 0);
                const allSoldItems = sales.flatMap(t => t.items);
                const totalProfit = allSoldItems.reduce((sum, i) => sum + (i.sellingRate - i.costRate) * i.quantity, 0);
                const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;

                this.ui.analytics.totalRevenue.textContent = `₹${totalRevenue.toFixed(0)}`;
                this.ui.analytics.totalProfit.textContent = `₹${totalProfit.toFixed(0)}`;
                this.ui.analytics.avgMargin.textContent = `${avgMargin.toFixed(1)}%`;

                this.ui.analytics.filteredResultsContainer.style.display = 'none';
                this.ui.analytics.startDate.value = '';
                this.ui.analytics.endDate.value = '';
            },

            renderFilteredAnalytics() {
                const startDateStr = this.ui.analytics.startDate.value;
                const endDateStr = this.ui.analytics.endDate.value;
                if (!startDateStr || !endDateStr) {
                    this.showToast("Please select both start and end dates.", "error"); return;
                }
                const startDate = new Date(startDateStr); startDate.setHours(0,0,0,0);
                const endDate = new Date(endDateStr); endDate.setHours(23,59,59,999);
                const sales = this.state.transactions.filter(t => t.type === 'Sale' && t.date >= startDate && t.date <= endDate);
                const filteredRevenue = sales.reduce((sum, t) => sum + t.total, 0);
                const filteredProfit = sales.flatMap(t => t.items).reduce((sum, i) => sum + (i.sellingRate - i.costRate) * i.quantity, 0);
                this.ui.analytics.filteredSales.textContent = `₹${filteredRevenue.toFixed(0)}`;
                this.ui.analytics.filteredProfit.textContent = `₹${filteredProfit.toFixed(0)}`;
                this.ui.analytics.filteredResultsContainer.style.display = 'grid';
            },

             renderCreditorList() { 
                const creditors = this.state.transactions.filter(t => t.saleType === 'Credit').reduce((acc, t) => { if (!t.partyName) return acc; if (!acc[t.partyName]) acc[t.partyName] = 0; acc[t.partyName] += t.total - (t.paidAmount || 0); return acc; }, {});
                const creditorsWithBalance = Object.entries(creditors).filter(([_, balance]) => balance > 0.01);
                if (creditorsWithBalance.length === 0) {
                     this.ui.creditorListContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">No outstanding credit.</p>'; return;
                }
                this.ui.creditorListContainer.innerHTML = `
                    <table class="styled-table">
                        <thead><tr><th>CREDITOR</th><th>BALANCE</th><th>ACTION</th></tr></thead>
                        <tbody>
                        ${creditorsWithBalance.map(([name, balance]) => `
                            <tr>
                                <td>${name}</td>
                                <td>₹${balance.toFixed(2)}</td>
                                <td><button class="btn btn-primary pay-btn" style="padding: 0.5rem 1rem;" data-creditor-name="${name}">PAY</button></td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`;
            },
            
            handleFileUpload(event) {
                 const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); 
                 reader.onload = (e) => { 
                     try { 
                         const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' }); 
                         const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]); 
                         this.state.inventory = json.map(row => ({ particulars: String(row.particulars || "N/A"), quantity: parseInt(row.quantity, 10) || 0, rate: parseFloat(row.rate) || 0.0 })).filter(item => item.particulars !== "N/A"); 
                         this.renderPage('stocks'); this.triggerAutoSave(); this.showToast('Inventory loaded!', 'success'); 
                     } catch (error) { this.showToast('Error reading file. Check columns.', 'error'); } 
                 }; 
                 reader.readAsArrayBuffer(file); event.target.value = ''; 
            },
            
            addSaleItemRow() {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <div><label>Item Name</label><input type="text" class="particulars" list="inventory-datalist" required></div>
                    <div><label>Quantity</label><input type="number" class="quantity" min="1" required></div>
                    <div><label>Sale Rate</label><input type="number" class="rate" min="0" step="0.01" required></div>
                    <div class="actions"><button type="button" class="btn btn-danger remove-item-btn">Remove</button></div>
                `;
                this.ui.salesItemsContainer.appendChild(div);
            },
            addPurchaseItemRow() {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <div><label>Item Name</label><input type="text" class="particulars" required></div>
                    <div><label>Quantity</label><input type="number" class="quantity" min="1" required></div>
                    <div><label>Cost Rate</label><input type="number" class="rate" min="0" step="0.01" required></div>
                    <div class="actions"><button type="button" class="btn btn-danger remove-item-btn">Remove</button></div>
                `;
                this.ui.purchaseItemsContainer.appendChild(div);
            },
            
            processMultiItemSale(form) {
                const saleItems = [], errors = [];
                for(const row of form.querySelectorAll('.item-row')) {
                    const p = row.querySelector('.particulars').value.trim();
                    const q = parseInt(row.querySelector('.quantity').value, 10);
                    const r = parseFloat(row.querySelector('.rate').value);
                    if(!p || !q || isNaN(r)) continue;
                    const itemInStock = this.state.inventory.find(i => i.particulars === p);
                    if (!itemInStock || itemInStock.quantity < q) { errors.push(`Not enough stock for ${p}.`); continue; }
                    saleItems.push({ particulars: p, quantity: q, sellingRate: r, costRate: itemInStock.rate, itemInStock });
                }
                if (errors.length > 0) { this.showToast(errors.join('\n'), "error"); return; }
                if (saleItems.length === 0) { this.showToast("No valid items to record.", "error"); return; }
                saleItems.forEach(item => { item.itemInStock.quantity -= item.quantity; });
                const total = saleItems.reduce((sum, i) => sum + (i.sellingRate * i.quantity), 0);
                this.state.transactions.push({ id: Date.now(), type: 'Sale', saleType: 'Cash', date: new Date(), items: saleItems.map(({itemInStock, ...rest}) => rest), total, paidAmount: total });
                this.ui.salesItemsContainer.innerHTML = ''; this.addSaleItemRow();
                this.triggerAutoSave(); this.showToast(`Sale recorded! Total: ₹${total.toFixed(2)}`, "success");
            },

            addEventListeners() { 
                this.ui.navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.renderPage(e.currentTarget.dataset.page);
                        this.ui.topNav.classList.remove('active');
                    });
                });
                this.ui.mobileMenuBtn.addEventListener('click', () => this.ui.topNav.classList.toggle('active'));

                this.ui.settings.importDataBtn.addEventListener('click', () => this.ui.settings.excelFile.click());
                this.ui.settings.excelFile.addEventListener('change', (e) => this.handleFileUpload(e));
                
                this.ui.addSaleItemBtn.addEventListener('click', () => this.addSaleItemRow());
                this.ui.salesForm.addEventListener('submit', (e) => { e.preventDefault(); this.processMultiItemSale(e.target); });
                this.ui.salesItemsContainer.addEventListener('click', e => { if(e.target.classList.contains('remove-item-btn')) e.target.closest('.item-row').remove(); });

                this.ui.addPurchaseItemBtn.addEventListener('click', () => this.addPurchaseItemRow());
                this.ui.purchaseForm.addEventListener('submit', e => {
                    e.preventDefault();
                    const purchasedItems = [];
                    for(const row of e.target.querySelectorAll('.item-row')) {
                        const p = row.querySelector('.particulars').value.trim();
                        const q = parseInt(row.querySelector('.quantity').value, 10);
                        const r = parseFloat(row.querySelector('.rate').value);
                        if(p && q && !isNaN(r)) purchasedItems.push({particulars:p, quantity:q, rate:r});
                    }
                    if(purchasedItems.length === 0) { this.showToast("No valid items.", "error"); return; }
                    purchasedItems.forEach(newItem => {
                         const existing = this.state.inventory.find(i => i.particulars.toLowerCase() === newItem.particulars.toLowerCase());
                        if (existing) {
                            const totalVal = existing.rate * existing.quantity + newItem.rate * newItem.quantity;
                            const totalQty = existing.quantity + newItem.quantity;
                            existing.rate = totalVal / totalQty; existing.quantity = totalQty;
                        } else this.state.inventory.push(newItem);
                    });
                    this.state.transactions.push({ id: Date.now(), type: 'Purchase', date: new Date(), items: purchasedItems, total: purchasedItems.reduce((s, i) => s + (i.rate * i.quantity), 0) });
                    this.ui.purchaseItemsContainer.innerHTML = ''; this.addPurchaseItemRow();
                    this.triggerAutoSave(); this.showToast('Stock updated!', "success");
                });
                this.ui.purchaseItemsContainer.addEventListener('click', e => { if(e.target.classList.contains('remove-item-btn')) e.target.closest('.item-row').remove(); });

                this.ui.inventoryTableBody.addEventListener('click', (e) => {
                    const icon = e.target.closest('.action-icon');
                    if (!icon || !icon.classList.contains('delete')) return;
                    const particulars = icon.dataset.particulars;
                    if (confirm(`Delete "${particulars}"?`)) {
                        this.state.inventory = this.state.inventory.filter(item => item.particulars !== particulars);
                        this.renderInventory(); this.triggerAutoSave(); this.showToast('Item deleted.', 'success');
                    }
                });

                this.ui.analytics.filterBtn.addEventListener('click', () => this.renderFilteredAnalytics());
                
                this.ui.creditSaleForm.addEventListener('submit', (e) => { 
                    e.preventDefault(); 
                    const partyName = e.target.querySelector('#credit-inventory-party-name').value.trim();
                    const p = e.target.querySelector('.particulars').value.trim();
                    const q = parseInt(e.target.querySelector('.quantity').value, 10);
                    const r = parseFloat(e.target.querySelector('.rate').value);
                    if (!partyName || !p || !q || isNaN(r)) { this.showToast("All fields are required.", "error"); return; }
                    const itemInStock = this.state.inventory.find(i => i.particulars === p);
                    if (!itemInStock || itemInStock.quantity < q) { this.showToast("Item not found or not enough stock.", "error"); return;}
                    itemInStock.quantity -= q;
                    const newTx = { id: Date.now(), type: 'Sale', saleType: 'Credit', partyName, date: new Date(), items: [{ particulars: p, quantity: q, sellingRate: r, costRate: itemInStock.rate }], total: r * q, paidAmount: 0 };
                    this.state.transactions.push(newTx);
                    this.renderCreditorList(); this.triggerAutoSave(); e.target.reset();
                    this.showToast(`Credit sale to ${partyName} recorded!`, "success");
                });

                this.ui.creditorListContainer.addEventListener('click', e => {
                    if (e.target.classList.contains('pay-btn')) {
                        const name = e.target.dataset.creditorName;
                        const payment = parseFloat(prompt(`Enter payment amount for ${name}:`));
                        if (!isNaN(payment) && payment > 0) {
                            let rem = payment;
                            const txs = this.state.transactions.filter(t => t.partyName === name && t.saleType === 'Credit' && (t.total - (t.paidAmount || 0)) > 0.01).sort((a,b) => a.date - b.date);
                            for (const tx of txs) {
                                if (rem <= 0) break;
                                const due = tx.total - (tx.paidAmount || 0);
                                const payForThis = Math.min(rem, due);
                                tx.paidAmount = (tx.paidAmount || 0) + payForThis;
                                rem -= payForThis;
                            }
                            this.showToast(`Payment of ₹${payment.toFixed(2)} recorded.`, "success");
                            this.renderCreditorList(); this.triggerAutoSave();
                        }
                    }
                });
            },
            showToast(msg, type='success') {
                const toast = document.getElementById('toast');
                toast.textContent = msg;
                toast.className = `show ${type}`;
                setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
            },
        };
        app.init();
    };
    </script>
</body>
</html>
