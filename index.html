<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenant & Rent Management System</title>
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3crect width='100' height='100' rx='15' fill='%236366f1'/%3e%3ctext x='50' y='68' font-size='50' font-weight='bold' fill='white' text-anchor='middle'%3eTR%3c/text%3e%3c/svg%3e">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- --- Google API & Identity Scripts --- -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
        :root {
            --primary-color: #6366f1; --primary-hover: #4f46e5; --secondary-color: #10b981;
            --danger-color: #ef4444; --warning-color: #f59e0b; --bg-color: #f3f4f6;
            --text-color: #1f2937; --text-light: #6b7280; --card-bg: #ffffff;
            --border-color: #e5e7eb; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --whatsapp-color: #25D366;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; height: 100%; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--text-color); height: 100%; }

        #login-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; width: 100%; text-align: center;
        }
        .login-box { background: var(--card-bg); padding: 3rem; border-radius: 12px; box-shadow: var(--shadow); }
        #signin-btn {
            background-color: #4285F4; color: white; border: none; padding: 12px 24px;
            font-size: 1rem; font-weight: 600; border-radius: 8px; cursor: pointer;
            display: inline-flex; align-items: center; gap: 1rem; transition: background-color 0.3s;
        }
        #signin-btn:hover { background-color: #357ae8; }
        #signin-btn[disabled] { background-color: #ccc; cursor: not-allowed; }
        #signin-btn svg { width: 24px; height: 24px; background: white; border-radius: 50%; padding: 2px; }

        #app-container { display: none; height: 100vh; overflow: hidden; }
        #app-container.visible { display: flex; }

        .sidebar { width: 260px; background-color: var(--card-bg); padding: 1.5rem; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); flex-shrink: 0; }
        .sidebar-top { flex-grow: 1; }
        .main-content { flex-grow: 1; overflow-y: auto; padding: 2rem; }
        .logo { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); margin-bottom: 2.5rem; text-align: center; }
        .nav-menu { list-style: none; }
        .nav-menu a { display: flex; align-items: center; gap: 1rem; padding: 0.9rem 1.5rem; margin-bottom: 0.5rem; border-radius: 8px; color: var(--text-light); text-decoration: none; font-weight: 500; transition: background-color 0.2s, color 0.2s; cursor: pointer; }
        .nav-menu a:hover { background-color: #f3f4f6; color: var(--primary-color); }
        .nav-menu a.active { background-color: var(--primary-color); color: white; box-shadow: var(--shadow); }
        .nav-menu a svg { width: 22px; height: 22px; fill: currentColor; flex-shrink: 0; }

        .user-profile { display: flex; align-items: center; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        .user-profile img { width: 40px; height: 40px; border-radius: 50%; }
        .user-profile div { line-height: 1.2; }
        .user-profile span { font-weight: 600; font-size: 0.9rem; }
        #signout-btn { font-size: 0.8rem; color: var(--danger-color); cursor: pointer; background: none; border: none; padding: 0; }
        .view { display: none; } .view.active { display: block; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .section-header .header-actions { display: flex; gap: 1rem; align-items: center; }
        .section-title { font-size: 1.8rem; font-weight: 600; }
        .action-btn { padding: 0.7rem 1.2rem; font-size: 0.9rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s, opacity 0.2s; color: white; display: inline-flex; align-items: center; gap: 0.5rem; }
        .action-btn:hover:not([disabled]) { transform: translateY(-2px); }
        .action-btn[disabled] { cursor: not-allowed; opacity: 0.7; }
        .btn-primary { background-color: var(--primary-color); } .btn-primary:hover:not([disabled]) { box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .btn-secondary { background-color: var(--secondary-color); } .btn-secondary:hover:not([disabled]) { box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        .btn-danger { background-color: var(--danger-color); } .btn-warning { background-color: var(--warning-color); }
        .btn-cancel { background-color: #e5e7eb; color: #374151; }
        .btn-whatsapp { background-color: var(--whatsapp-color); }
        .btn-whatsapp:hover { box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4); }
        .transaction-actions { display: flex; gap: 0.5rem; align-items: center; }
        .btn-icon { padding: 0.4rem; line-height: 0; }
        .btn-icon svg { width: 1.2em; height: 1.2em; fill: white; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .data-card { background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .data-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .card-photo { width: 100%; height: 180px; background-color: var(--border-color); background-size: cover; background-position: center; position: relative; }
        .card-status { position: absolute; top: 1rem; right: 1rem; padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.8rem; font-weight: 600; text-transform: capitalize; backdrop-filter: blur(5px); background-color: rgba(255,255,255,0.7); }
        .status-available { color: #065f46; } .status-occupied { color: #991b1b; }
        .card-content { padding: 1.5rem; flex-grow: 1; } .card-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; } .card-info { color: var(--text-light); font-size: 0.9rem; }
        .metric-boxes { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin-bottom: 2rem; }
        .metric-box { padding: 1.5rem; background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); }
        .metric-box h3 { color: var(--text-light); margin-bottom: 1rem; font-size: 1rem; font-weight: 500; } .metric-value { font-size: 2.5rem; font-weight: 700; }
        .dashboard-section { background: var(--card-bg); padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow); }
        .dashboard-section h3 { font-size: 1.2rem; margin-bottom: 1rem; }
        .alert-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; }
        .alert-item.danger { background-color: #fee2e2; color: #b91c1c; } .alert-item.warning { background-color: #fef3c7; color: #92400e; } .alert-item:hover { opacity: 0.8; }
        .detail-view-header { display: flex; gap: 2rem; margin-bottom: 2rem; align-items: flex-start; }
        .detail-photo { width: 150px; height: 150px; flex-shrink: 0; border-radius: 12px; background-size: cover; background-position: center; background-color: var(--border-color); box-shadow: var(--shadow); }
        .detail-info h2 { font-size: 2rem; margin-bottom: 0.5rem; } .detail-info p { color: var(--text-light); margin-bottom: 0.2rem; }
        .detail-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
        .detail-main, .detail-sidebar { display: flex; flex-direction: column; gap: 1.5rem; }
        .detail-card { background-color: var(--card-bg); padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow); }
        .detail-card h4 { font-size: 1.1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        .detail-card ul { list-style: none; padding-left: 0; } .detail-card li { display: flex; justify-content: space-between; padding: 0.5rem 0; }
        .transaction-item { display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid var(--border-color); padding: 0.8rem 0;}
        .transaction-item:last-child { border-bottom: none; }
        .transaction-item.due { color: var(--danger-color); } .transaction-item.payment { color: var(--secondary-color); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: flex-start; justify-content: center; padding-top: 5vh; overflow-y: auto; }
        .modal.active { display: flex; }
        .modal-content { background-color: white; padding: 2rem; width: 90%; max-width: 600px; border-radius: 12px; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; }
        .close-btn { font-size: 2rem; cursor: pointer; background: none; border: none; color: var(--text-light); }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
        .form-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; }
        #photo-preview { max-width: 100px; max-height: 100px; margin-top: 1rem; border-radius: 8px; object-fit: cover; }
        #toast { position: fixed; bottom: -100px; right: 20px; padding: 1rem 2rem; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); transition: bottom 0.5s ease-in-out; z-index: 9999; }
        #toast.show { bottom: 20px; } #toast.success { background-color: var(--secondary-color); } #toast.error { background-color: var(--danger-color); }
        
        @media (max-width: 1024px) {
             .detail-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            #app-container.visible { flex-direction: column; height: 100%; overflow: hidden; }
            .sidebar { width: 100%; height: auto; flex-direction: row; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; z-index: 100; box-shadow: var(--shadow); }
            .main-content { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
            .sidebar-top { flex-grow: 1; display: flex; align-items: center; justify-content: space-between; }
            .logo { margin-bottom: 0; font-size: 1.5rem; }
            .nav-menu { display: flex; gap: 0.25rem; }
            .nav-menu a { padding: 0.8rem; gap: 0; }
            .nav-menu a span { display: none; }
            .user-profile { display: none; }
            .detail-view-header { flex-direction: column; align-items: center; text-align: center; }
            .section-header, .section-header .header-actions { justify-content: center; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 class="logo" style="margin-bottom: 1rem;">Mishra Ji üö©</h1>
            <p style="color: var(--text-light); margin-bottom: 2rem;">‡§∂‡•ç‡§∞‡•Ä ‡§ö‡§Ç‡§¶‡•ç‡§∞‡§∂‡•á‡§ñ‡§∞ ‡§Æ‡§ø‡§∂‡•ç‡§∞‡§æ ‡§´‡•à‡§Æ‡§ø‡§≤‡•Ä ‡§®‡§ø‡§µ‡§æ‡§∏ üôÇ</p>
            
            <p style="color: var(--text-light); margin-bottom: 2rem;">‡§∞‡•Ç‡§Æ ‡§î‡§∞ ‡§ï‡§ø‡§∞‡§æ‡§Ø‡•á‡§¶‡§æ‡§∞ ‡§ï‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°</p>
            <button id="signin-btn" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 35.841 44 30.138 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                Sign in with Google
            </button>
            <p id="auth-status" style="margin-top: 1rem; color: var(--text-light);">Initializing...</p>
        </div>
    </div>

    <div id="app-container">
        <aside class="sidebar">
            <div class="sidebar-top">
                <h1 class="logo">Mishra Ji</h1>
                <nav class="nav-menu">
                    <a data-action="navigate" data-view="dashboard" class="nav-link">
                        <svg viewBox="0 0 24 24"><path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/></svg>
                        <span>Dashboard</span>
                    </a>
                    <a data-action="navigate" data-view="rooms" class="nav-link">
                        <svg viewBox="0 0 24 24"><path d="M21.99 8.24c0-2.3-1.48-4.27-3.53-5.02C17.06 2.44 15.65 2 14 2h-4c-3.31 0-6 2.69-6 6v12h2V8c0-2.21 1.79-4 4-4h4c1.11 0 2.1.48 2.82 1.25.73.78 1.18 1.83 1.18 2.94v.81h-6v2h6v2h-6v2h6v2h-6v2h6v2h2V8.24z"/></svg>
                        <span>Rooms</span>
                    </a>
                    <a data-action="navigate" data-view="tenants" class="nav-link">
                        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        <span>Tenants</span>
                    </a>
                    <a data-action="navigate" data-view="leftTenants" class="nav-link">
                        <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                        <span>Left Tenants</span>
                    </a>
                    <a data-action="navigate" data-view="settings" class="nav-link">
                        <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                        <span>Settings</span>
                    </a>
                </nav>
            </div>
            <div id="user-profile-container" class="user-profile" style="display: none;">
                <img id="user-img" src="" alt="User">
                <div>
                    <span id="user-name"></span>
                    <span id="sync-status" style="font-size: 0.8rem; color: var(--text-light);"></span>
                    <button id="signout-btn">Sign Out</button>
                </div>
            </div>
        </aside>
        <main class="main-content" id="main-content-area"></main>
    </div>

    <div id="modal-container"></div>
    <div id="toast"></div>

<script>
window.onload = () => {
    const app = {
        // --- Configuration ---
        CLIENT_ID: '460969544827-21ethacfepnho56k8j89dtaq58rj0oem.apps.googleusercontent.com',
        API_KEY: 'AIzaSyDJ3soSuJgHcbD8beauFPWd06wJWqws3ps',
        SCOPES: 'https://www.googleapis.com/auth/drive.file', // Scope for app-specific files
        APP_FOLDER_NAME: 'TenantManagementApp',
        DATA_FILE_NAME: 'tenant_data.json', // The MASTER file for app operation
        MONTHLY_FILENAME_TEMPLATE: (month, year) => `${month.toLowerCase()}_${year}tanent_reord.json`,
        
        tokenClient: null,
        appFolderId: null,
        driveFileId: null, // ID for the MASTER file
        isSaving: false,
        saveTimeout: null,
        userRole: 'owner', // 'owner' or 'viewer' - defaults to owner for first time use

        state: {
            rooms: [], tenants: [], leftTenants: [], dues: [], payments: [], utilityReadings: [],
            settings: { electricityRate: 8.00, currencySymbol: '‚Çπ' },
            currentView: 'dashboard', detailViewId: null,
            dashboardFilter: 'this_month'
        },

        // --- CORE: Initialization and Authentication ---
        init() {
            gapi.load('client', this.initializeGapiClient.bind(this));
            this.tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: this.CLIENT_ID,
                scope: this.SCOPES,
                callback: this.handleAuthResponse.bind(this),
            });
            document.getElementById('signin-btn').addEventListener('click', () => this.tokenClient.requestAccessToken({prompt: 'consent'}));
            document.getElementById('signout-btn').addEventListener('click', this.signOut.bind(this));
        },

        async initializeGapiClient() {
            await gapi.client.init({
                apiKey: this.API_KEY,
                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
            });
            document.getElementById('signin-btn').disabled = false;
            document.getElementById('auth-status').textContent = 'Ready. Please sign in.';
        },

        async handleAuthResponse(response) {
            if (response.error) { this.showToast(`Error: ${response.error}`, 'error'); return; }
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').classList.add('visible');
            await this.updateUserProfile();
            await this.loadData();
            this.startAppLogic();
        },
        
        signOut() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken('');
                    this.driveFileId = null; this.appFolderId = null; this.userRole = 'owner'; // Reset role on sign out
                    document.getElementById('login-screen').style.display = 'flex';
                    document.getElementById('app-container').classList.remove('visible');
                    this.showToast('Signed out successfully.');
                });
            }
        },

        async updateUserProfile() {
            try {
                const res = await gapi.client.request({ path: 'https://www.googleapis.com/oauth2/v3/userinfo' });
                document.getElementById('user-name').textContent = res.result.name;
                document.getElementById('user-img').src = res.result.picture;
                document.getElementById('user-profile-container').style.display = 'flex';
            } catch (e) { console.error("Could not fetch user profile", e); }
        },
        
        startAppLogic() {
            if (this.isOwner()) {
                const duesGenerated = this.generateMissingRentDues();
                if (duesGenerated > 0) { this.triggerAutoSave(); this.showToast(`${duesGenerated} new rent due(s) generated.`); }
            } else {
                this.showToast('Logged in as Viewer. Actions are restricted.');
            }
            this.addEventListeners();
            this.navigateTo('dashboard');
        },

        // --- CORE: Google Drive Data Management & Roles ---
        async _findOrCreateAppFolder() {
            if (this.appFolderId) return this.appFolderId;
            try {
                // Search for the folder by name
                let res = await gapi.client.drive.files.list({ 
                    q: `name='${this.APP_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`, 
                    spaces: 'drive', 
                    fields: 'files(id)' 
                });

                if (res.result.files && res.result.files.length > 0) {
                    this.appFolderId = res.result.files[0].id;
                } else {
                    // Create the folder if it doesn't exist
                    let folder = { 'name': this.APP_FOLDER_NAME, 'mimeType': 'application/vnd.google-apps.folder' };
                    res = await gapi.client.drive.files.create({ 
                        resource: folder, 
                        fields: 'id' 
                    });
                    this.appFolderId = res.result.id;
                }
                return this.appFolderId;
            } catch (e) { 
                console.error('Error finding/creating app folder:', e); 
                this.showToast('Could not access Drive folder.', 'error'); 
                throw e; // Propagate error
            }
        },

        async loadData() {
            this.showToast("Loading data from Google Drive...", "info");
            try {
                // Try to find the MASTER data file
                const response = await gapi.client.drive.files.list({ 
                    q: `name='${this.DATA_FILE_NAME}' and trashed=false`, 
                    spaces: 'drive', 
                    fields: 'files(id, name, capabilities)' // Request capabilities to determine user role
                });

                if (response.result.files && response.result.files.length > 0) {
                    const file = response.result.files[0];
                    this.driveFileId = file.id;
                    // Determine user role based on file edit capabilities
                    this.userRole = file.capabilities.canEdit ? 'owner' : 'viewer'; 
                    
                    // Fetch file content
                    const fileContentResponse = await gapi.client.drive.files.get({ 
                        fileId: this.driveFileId, 
                        alt: 'media' 
                    });
                    const loadedState = JSON.parse(fileContentResponse.body);
                    
                    // Merge loaded state with default to ensure all properties exist
                    const defaultState = { rooms: [], tenants: [], leftTenants: [], dues: [], payments: [], utilityReadings: [] };
                    this.state = { ...defaultState, ...loadedState };
                    this.state.settings = { ...this.state.settings, ...(loadedState.settings || {}) }; // Ensure settings are merged
                    
                    this.showToast(`Data loaded. (${this.userRole} mode)`, "success");
                } else {
                    // No data file found, assume user is owner and will create it
                    this.userRole = 'owner';
                    this.showToast("No data file found. Starting fresh. (Owner mode)", "info");
                    await this._findOrCreateAppFolder(); // Ensure folder exists for new data file
                }
            } catch (e) { 
                console.error("Error loading data:", e); 
                this.showToast("Failed to load data. You may not have permission, or file is corrupted.", "error"); 
                if (!this.userRole) this.userRole = 'viewer';
            }
        },

        isOwner() { return this.userRole === 'owner'; },

        // Auto-save mechanism: debounces saves by 2 seconds
        triggerAutoSave() {
            if (!this.isOwner()) return;
            clearTimeout(this.saveTimeout);
            const syncStatusSpan = document.getElementById('sync-status');
            if (syncStatusSpan) syncStatusSpan.textContent = 'Changes detected...';
            this.saveTimeout = setTimeout(() => this.saveData(), 2000);
        },
        
        // --- Saving technique inspired by Tinny Fashion Store ---
        async _performFileUpload(fileName, content, fileId = null, parentFolderId = null) {
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";
            
            let request;
            const metadata = { 'name': fileName, 'mimeType': 'application/json' };

            if (fileId) {
                // UPDATE an existing file using multipart
                const multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify({}) + delimiter + 'Content-Type: application/json\r\n\r\n' + content + close_delim;
                request = gapi.client.request({
                    'path': `https://www.googleapis.com/upload/drive/v3/files/${fileId}`,
                    'method': 'PATCH',
                    'params': { 'uploadType': 'multipart' },
                    'headers': { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
                    'body': multipartRequestBody
                });
            } else {
                // CREATE a new file using multipart
                if (parentFolderId) metadata.parents = [parentFolderId];
                const multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) + delimiter + 'Content-Type: application/json\r\n\r\n' + content + close_delim;
                request = gapi.client.request({
                    'path': 'https://www.googleapis.com/upload/drive/v3/files',
                    'method': 'POST',
                    'params': { 'uploadType': 'multipart' },
                    'headers': { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
                    'body': multipartRequestBody
                });
            }
            const response = await request;
            return response.result.id;
        },

        async _findFileByNameInFolder(fileName, folderId) {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and '${folderId}' in parents and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id)'
                });
                if (response.result.files && response.result.files.length > 0) {
                    return response.result.files[0].id; // Return the ID if found
                }
                return null; // Return null if not found
            } catch (e) {
                console.error(`Error finding file by name: ${fileName} in folder ${folderId}`, e);
                this.showToast(`Error accessing Drive to find ${fileName}.`, 'error');
                throw e;
            }
        },

        async saveData() {
            if (!this.isOwner() || this.isSaving) return;
            this.isSaving = true;
            
            const manualSaveBtn = document.getElementById('manual-save-btn');
            const syncStatusSpan = document.getElementById('sync-status');
            
            let originalBtnText = '';
            if (manualSaveBtn) {
                originalBtnText = manualSaveBtn.textContent;
                manualSaveBtn.disabled = true;
                manualSaveBtn.textContent = 'Syncing...';
            }
            if (syncStatusSpan) syncStatusSpan.textContent = 'Syncing...';
            
            this.showToast("Saving data to Google Drive...", "info");

            try {
                if (!this.appFolderId) await this._findOrCreateAppFolder();

                const dataToSave = JSON.stringify(this.state, null, 2);

                // --- 1. Save the main data file ---
                const mainSavePromise = this._performFileUpload(this.DATA_FILE_NAME, dataToSave, this.driveFileId, this.appFolderId)
                    .then(fileId => {
                        if (!this.driveFileId) { 
                            this.driveFileId = fileId; 
                            this.userRole = 'owner';
                        }
                    });

                // --- 2. Save the monthly record file ---
                const now = new Date();
                const monthName = now.toLocaleString('default', { month: 'long' });
                const year = now.getFullYear();
                const monthlyFileName = this.MONTHLY_FILENAME_TEMPLATE(monthName, year);
                
                const monthlyFileId = await this._findFileByNameInFolder(monthlyFileName, this.appFolderId);
                const monthlySavePromise = this._performFileUpload(monthlyFileName, dataToSave, monthlyFileId, this.appFolderId);
                
                // --- Execute both save operations in parallel ---
                await Promise.all([mainSavePromise, monthlySavePromise]);

                this.showToast('Data & monthly record saved successfully!', 'success');
                if (syncStatusSpan) syncStatusSpan.textContent = 'Synced!';
                setTimeout(() => { if (syncStatusSpan.textContent === 'Synced!') syncStatusSpan.textContent = ''; }, 3000); // Clear after a few seconds

            } catch (e) {
                console.error("Error saving data:", e);
                this.showToast("An error occurred during save. See console.", "error");
                if (syncStatusSpan) syncStatusSpan.textContent = 'Sync failed!';
            } finally {
                this.isSaving = false;
                if (manualSaveBtn) {
                    manualSaveBtn.disabled = false;
                    manualSaveBtn.textContent = originalBtnText;
                }
            }
        },

        async uploadPhotoToDrive(file) {
            if (!file || file.size === 0) return ''; // No file selected

            if (!this.appFolderId) {
                await this._findOrCreateAppFolder(); // Ensure app folder exists
            }

            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";

            const metadata = {
                'name': `app_photo_${Date.now()}_${file.name}`,
                'mimeType': file.type,
                'parents': [this.appFolderId],
            };

            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onload = async (e) => {
                    const base64Data = e.target.result.split(',')[1];
                    const multipartRequestBody =
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify(metadata) +
                        delimiter +
                        'Content-Type: ' + file.type + '\r\n' +
                        'Content-Transfer-Encoding: base64\r\n' +
                        '\r\n' +
                        base64Data +
                        close_delim;

                    try {
                        const response = await gapi.client.request({
                            'path': 'https://www.googleapis.com/upload/drive/v3/files',
                            'method': 'POST',
                            'params': { 'uploadType': 'multipart' },
                            'headers': { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
                            'body': multipartRequestBody
                        });
                        // webContentLink provides a direct link to the content
                        resolve(response.result.webContentLink); 
                    } catch (error) {
                        console.error("Error uploading photo to Drive:", error);
                        this.showToast("Failed to upload photo.", "error");
                        reject(error);
                    }
                };
                reader.onerror = (error) => {
                    reject(error);
                };
                reader.readAsDataURL(file); // Read as Base64 for multipart upload
            });
        },

        // --- UI & Event Handling ---
        navigateTo(v, id=null) { this.state.currentView=v;this.state.detailViewId=id;this.render(); },
        render() { const{currentView:v,detailViewId:id}=this.state;const m=document.getElementById('main-content-area');const k=v.includes('-')?v.split('-').map((p,i)=>i>0?p.charAt(0).toUpperCase()+p.slice(1):p).join(''):v;const f=this.templates[k];if(f)m.innerHTML=f.call(this,id);else m.innerHTML=`<p>Error: View '${v}' not found.</p>`;document.querySelectorAll('.nav-link').forEach(l=>l.classList.toggle('active',l.dataset.view===v.split('-')[0]));},
        addEventListeners() { 
            document.body.addEventListener('click',e=>{
                const t=e.target.closest('[data-action]');
                if(!t)return;
                e.preventDefault();
                const{action:a,view:v,id:i,modalType:m,itemType:it}=t.dataset;

                // Restrict actions for viewers
                const ownerActions = ['show-modal', 'delete-item', 'mark-tenant-left', 'report-meter-broken', 'install-new-meter', 'manual-save', 'settle-security-deposit'];
                if (ownerActions.includes(a) && !this.isOwner()) {
                    this.showToast('Access Denied: You are in viewer mode.', 'error');
                    return;
                }

                const A={
                    'navigate':()=>this.navigateTo(v),
                    'navigate-detail':()=>this.navigateTo(v,i),
                    'show-modal':()=>this.showModal(m,i),
                    'close-modal':()=>this.closeModal(),
                    'delete-item':()=>{if(confirm(`Delete this ${it.replace('-',' ')}? This cannot be undone.`))this.deleteItem(it,i);},
                    'mark-tenant-left':()=>{if(confirm('Are you sure this tenant has left? This will move them to the "Left Tenants" record.'))this.markTenantAsLeft(i);},
                    'generate-receipt':()=>this.generateReceipt(i),
                    'report-meter-broken':()=>{if(confirm('Report meter as broken?'))this.reportMeterBroken(i);},
                    'install-new-meter':()=>this.installNewMeter(i),
                    'share-receipt-whatsapp':()=>this.shareReceiptWhatsApp(i),
                    'share-dues-whatsapp':()=>this.shareDuesWhatsApp(i),
                    'manual-save':()=>this.saveData(),
                    'settle-security-deposit': () => this.showModal('settleSecurityDeposit', i)
                };
                if(A[a])A[a]();
            });

            document.body.addEventListener('submit',e=>{
                e.preventDefault();
                if(!this.isOwner()){ // Prevent form submissions for viewers
                    this.showToast('Access Denied: You are in viewer mode.', 'error');
                    return;
                }
                const h={
                    'room-form':f=>this.handleRoomSubmit(f),
                    'tenant-form':f=>this.handleTenantSubmit(f),
                    'settings-form':f=>this.handleSettingsSubmit(f),
                    'utility-form':f=>this.handleUtilitySubmit(f),
                    'payment-form':f=>this.handlePaymentSubmit(f),
                    'service-charge-form':f=>this.handleServiceChargeSubmit(f),
                    'edit-room-form':f=>this.handleEditRoomSubmit(f),
                    'edit-tenant-form':f=>this.handleEditTenantSubmit(f),
                    'settle-security-deposit-form': f => this.handleSettleSecurityDeposit(f)
                };
                if(h[e.target.id])h[e.target.id](e.target);
            });

            document.body.addEventListener('change',e=>{
                if(e.target.matches('input[type="file"]')&&e.target.id!=='import-file-input')this.previewPhoto(e); 
                if(e.target.id === 'dashboard-filter'){ this.state.dashboardFilter = e.target.value; this.render(); }
            });
        },
        
        // --- TEMPLATES (with Role-Based UI & New Features) ---
        templates: {
            dashboard() {
                const { dues, payments, tenants, rooms, settings, dashboardFilter } = this.state;
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();

                let filteredPayments = [];
                let filterLabel = "This Month's";
                if (dashboardFilter === 'this_month') {
                    filteredPayments = (payments || []).filter(p => { const pDate = new Date(p.date); return pDate.getFullYear() === currentYear && pDate.getMonth() === currentMonth; });
                } else if (dashboardFilter === 'last_month') {
                    const lastMonthDate = new Date(now); lastMonthDate.setMonth(currentMonth - 1);
                    const lastMonthYear = lastMonthDate.getFullYear(); const lastMonth = lastMonthDate.getMonth();
                    filteredPayments = (payments || []).filter(p => { const pDate = new Date(p.date); return pDate.getFullYear() === lastMonthYear && pDate.getMonth() === lastMonth; });
                    filterLabel = "Last Month's";
                } else { // all_time
                    filteredPayments = payments || [];
                    filterLabel = "Total";
                }
                const filteredIncome = filteredPayments.reduce((s, p) => s + p.amount, 0);
                const totalElecBill = (payments || []).filter(p => p.category === 'Electricity').reduce((acc, p) => acc + p.amount, 0);

                const o = (rooms || []).length > 0 ? (((tenants || []).length / (rooms || []).length) * 100).toFixed(0) : 0;
                const tD = (tenants || []).reduce((total, t) => {
                    const tdues = (dues || []).filter(d => d.tenantId === t.id).reduce((s, d) => s + d.amount, 0);
                    const tpmts = (payments || []).filter(p => p.tenantId === t.id && p.category !== 'Security Deposit (Paid)' && p.category !== 'Security Deposit (Refunded)' && p.category !== 'Security Deposit (Adjusted)').reduce((s, p) => s + p.amount, 0);
                    return total + Math.max(0, tdues - tpmts)
                }, 0);
                const u = (tenants || []).filter(t => !t.isVerified);
                let aH = u.map(t => `<div class="alert-item warning" data-action="navigate-detail" data-view="tenant-detail" data-id="${t.id}">${t.name}'s verification is pending. <span>View ‚Üí</span></div>`).join('');
                
                const tenantsWithDues = (tenants || [])
                    .map(tenant => ({ ...tenant, balance: (dues || []).filter(d => d.tenantId === tenant.id).reduce((s, d) => s + d.amount, 0) - (payments || []).filter(p => p.tenantId === tenant.id && p.category !== 'Security Deposit (Paid)' && p.category !== 'Security Deposit (Refunded)' && p.category !== 'Security Deposit (Adjusted)').reduce((s, p) => s + p.amount, 0) }))
                    .filter(tenant => tenant.balance > 0).sort((a, b) => b.balance - a.balance);

                const tenantDuesSection = tenantsWithDues.length > 0 ? `<div class="dashboard-section" style="margin-top: 1.5rem;"><h3>Pending Dues by Tenant</h3><div id="tenant-dues-list">${tenantsWithDues.map(t => `<div class="alert-item danger" data-action="navigate-detail" data-view="tenant-detail" data-id="${t.id}"><span>${t.name}</span><strong>${settings.currencySymbol}${t.balance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></div>`).join('')}</div></div>` : '';
                const quickActions = this.isOwner() ? `<button class="action-btn btn-primary" style="width:100%;margin-bottom:1rem;" data-action="show-modal" data-modal-type="addRoom">Add New Room</button><button class="action-btn btn-secondary" style="width:100%;" data-action="show-modal" data-modal-type="addTenant">Add New Tenant</button>` : `<p style="text-align:center;color:var(--text-light)"><i>View-only mode.</i></p>`;
                
                return `<div id="dashboard" class="view active">
                    <div class="section-header">
                        <h2 class="section-title">Dashboard</h2>
                        <div class="header-actions">
                            <select id="dashboard-filter" style="padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                                <option value="this_month" ${dashboardFilter === 'this_month' ? 'selected' : ''}>This Month</option>
                                <option value="last_month" ${dashboardFilter === 'last_month' ? 'selected' : ''}>Last Month</option>
                                <option value="all_time" ${dashboardFilter === 'all_time' ? 'selected' : ''}>All Time</option>
                            </select>
                        </div>
                    </div>
                    <div class="metric-boxes grid-container">
                        <div class="metric-box"><h3>${filterLabel} Income</h3><div class="metric-value">${settings.currencySymbol}${filteredIncome.toLocaleString('en-IN')}</div></div>
                        <div class="metric-box"><h3>Total Pending Dues</h3><div class="metric-value">${settings.currencySymbol}${tD.toLocaleString('en-IN')}</div></div>
                        <div class="metric-box"><h3>Occupancy</h3><div class="metric-value">${o}%</div></div>
                        <div class="metric-box"><h3>Unverified Tenants</h3><div class="metric-value">${u.length}</div></div>
                        <div class="metric-box"><h3>Total Electricity Income</h3><div class="metric-value">${settings.currencySymbol}${totalElecBill.toLocaleString('en-IN')}</div></div>
                    </div>
                    <div class="detail-grid" style="margin-top:2rem;">
                        <div class="dashboard-section">
                            <h3>System Alerts</h3><div id="alert-list">${aH || '<p>No system alerts.</p>'}</div>
                        </div>
                        <div class="dashboard-section"><h3>Quick Actions</h3>${quickActions}</div>
                    </div>
                    ${tenantDuesSection}
                </div>`;
            },
            rooms() { const addRoomBtn=this.isOwner()?`<button class="action-btn btn-primary" data-action="show-modal" data-modal-type="addRoom">Add Room</button>`:``;return `<div class="view active"><div class="section-header"><h2 class="section-title">Rooms</h2>${addRoomBtn}</div><div class="grid-container">${(this.state.rooms||[]).map(r=>`<div class="data-card" data-action="navigate-detail" data-view="room-detail" data-id="${r.id}"><div class="card-photo" style="background-image:url(${r.photo||''})"><span class="card-status status-${r.status}">${r.status}</span></div><div class="card-content"><h3 class="card-title">Room ${r.number}</h3><p class="card-info">Rent: ${this.state.settings.currencySymbol}${r.rent}/month</p><p class="card-info">Tenant: ${(this.state.tenants||[]).find(t=>t.id===r.tenantId)?.name||'<i>Vacant</i>'}</p></div></div>`).join('')||'<p>No rooms found.</p>'}</div></div>`;},
            tenants() { const addTenantBtn=this.isOwner()?`<button class="action-btn btn-secondary" data-action="show-modal" data-modal-type="addTenant">Add Tenant</button>`:``;return `<div class="view active"><div class="section-header"><h2 class="section-title">Current Tenants</h2>${addTenantBtn}</div><div class="grid-container">${(this.state.tenants||[]).map(t=>`<div class="data-card" data-action="navigate-detail" data-view="tenant-detail" data-id="${t.id}"><div class="card-photo" style="background-image:url(${t.photo||''})"><span class="card-status" style="color:${t.isVerified?'green':'red'}">${t.isVerified?'Verified':'Not Verified'}</span></div><div class="card-content"><h3 class="card-title">${t.name}</h3><p class="card-info">Room: ${(this.state.rooms||[]).find(r=>r.id===t.roomId)?.number||'N/A'}</p><p class="card-info">Phone: ${t.phone}</p></div></div>`).join('')||'<p>No current tenants found.</p>'}</div></div>`;},
            leftTenants() { return `<div class="view active"><div class="section-header"><h2 class="section-title">Left Tenant Records</h2></div><div class="grid-container">${(this.state.leftTenants||[]).sort((a,b) => new Date(b.leaveDate) - new Date(a.leaveDate)).map(t=>`<div class="data-card" style="opacity: 0.8;"><div class="card-photo" style="background-image:url(${t.photo||''})"></div><div class="card-content"><h3 class="card-title">${t.name}</h3><p class="card-info">Room Occupied: ${(this.state.rooms||[]).find(r=>r.id===t.roomId)?.number||'N/A'}</p><p class="card-info">Left On: ${new Date(t.leaveDate).toLocaleDateString()}</p></div></div>`).join('')||'<p>No records of left tenants.</p>'}</div></div>`; },
            settings() { 
                const o = this.isOwner();
                const saveSection = o ? `<div class="detail-card" style="max-width:500px;margin-top:2rem;">
                                            <h4>Data Synchronization</h4>
                                            <p style="margin-bottom:1rem;color:var(--text-light)">Manually save all current data to your Google Drive. The app also saves automatically. This will update both the main data file and the record file for the current month.</p>
                                            <button id="manual-save-btn" class="action-btn btn-secondary" data-action="manual-save">Sync Data to Drive</button>
                                         </div>` : '';
                return `<div class="view active">
                            <div class="section-header"><h2 class="section-title">Settings</h2></div>
                            <div class="detail-card" style="max-width:500px;">
                                <form id="settings-form">
                                    <h4>General Settings</h4>
                                    <div class="form-group">
                                        <label>Electricity Rate (per unit)</label>
                                        <input type="number" step="0.01" id="electricity-rate" value="${this.state.settings.electricityRate}" ${!o?'readonly':''}>
                                    </div>
                                    <div class="form-group">
                                        <label>Currency Symbol</label>
                                        <input type="text" id="currency-symbol" value="${this.state.settings.currencySymbol}" ${!o?'readonly':''}>
                                    </div>
                                    <div class="form-actions">${o?'<button type="submit" class="action-btn btn-primary">Save Settings</button>':''}</div>
                                </form>
                            </div>
                            ${saveSection}
                        </div>`;
            },
            roomDetail(id) { 
                const r=(this.state.rooms||[]).find(rm=>rm.id===id);
                if(!r)return`<p>Room not found.</p>`;
                const t=(this.state.tenants||[]).find(tn=>tn.id===r.tenantId);
                const rd=(this.state.utilityReadings||[]).filter(ur=>ur.roomId===id&&ur.meterInstallationId===r.meterInstallationId).sort((a,b)=>new Date(b.date)-new Date(a.date));
                const o=this.isOwner();
                
                const headerActions = o ? `<button class="action-btn btn-warning" data-action="show-modal" data-modal-type="editRoom" data-id="${id}">Edit</button>` : ``;
                const deleteButton = o ? `<button class="action-btn btn-danger" data-action="delete-item" data-item-type="room" data-id="${id}">Delete</button>` : ``;
                
                let meterManagement = o ? 
                    (r.meterStatus === 'broken' ? 
                        `<button class="action-btn btn-warning" data-action="install-new-meter" data-id="${id}">Install New</button>` : 
                        `<button class="action-btn btn-danger" data-action="report-meter-broken" data-id="${id}">Report Broken</button>`) : 
                    `<p>Status: <strong>${r.meterStatus}</strong></p>`;
                
                const utilityForm = o ? `<div class="detail-card"><h4>Add Utility Reading</h4><form id="utility-form" data-room-id="${id}"><div class="form-group"><label>New Meter Reading</label><input type="number" id="meter-reading" required ${r.meterStatus==='broken'?'disabled':''}></div><button type="submit" class="action-btn btn-secondary" style="width:100%" ${r.meterStatus==='broken'?'disabled':''}>Generate Bill</button></form></div>` : '';

                return `<div class="view active">
                    <div class="section-header">
                        <div class="header-actions">
                            <button class="action-btn btn-cancel" data-action="navigate" data-view="rooms">‚Üê Back</button>
                            ${headerActions}
                        </div>
                        ${deleteButton}
                    </div>
                    <div class="detail-view-header">
                        <div class="detail-photo" style="background-image: url(${r.photo||''})"></div>
                        <div class="detail-info">
                            <h2>Room ${r.number}</h2>
                            <p>Status: ${r.status}</p>
                            <p>Tenant: ${t?t.name:'Vacant'}</p>
                        </div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-main">
                            <div class="detail-card">
                                <h4>Room Information</h4>
                                <ul>
                                    <li><span>Monthly Rent</span><strong>${this.state.settings.currencySymbol}${r.rent}</strong></li>
                                    <li><span>Meter Status</span><strong>${r.meterStatus}</strong></li>
                                </ul>
                            </div>
                            <div class="detail-card">
                                <h4>Utility Readings</h4>
                                <div>${rd.map(r=>`<p><strong>${new Date(r.date).toLocaleDateString()}</strong> - ${r.reading} units</p>`).join('')||'<p>No readings for this meter.</p>'}</div>
                            </div>
                        </div>
                        <div class="detail-sidebar">
                            <div class="detail-card">
                                <h4>Meter Management</h4>
                                ${meterManagement}
                            </div>
                            ${utilityForm}
                        </div>
                    </div>
                </div>`;
            },
            tenantDetail(id) { 
                const t=(this.state.tenants||[]).find(tn=>tn.id===id);
                if(!t)return`<p>Tenant not found.</p>`;
                const r=(this.state.rooms||[]).find(rm=>rm.id===t.roomId);
                const d=(this.state.dues||[]).filter(du=>du.tenantId===id);
                const p=(this.state.payments||[]).filter(pm=>pm.tenantId===id);
                
                // Calculate current due balance (excluding security deposit movements)
                const currentDuesTotal = d.reduce((s,du)=>s+du.amount,0);
                const currentPaymentsTotal = p.filter(pm => 
                    pm.category !== 'Security Deposit (Paid)' && 
                    pm.category !== 'Security Deposit (Refunded)' &&
                    pm.category !== 'Security Deposit (Adjusted)'
                ).reduce((s,pm)=>s+pm.amount,0);
                const balance = currentDuesTotal - currentPaymentsTotal;

                // Calculate current security deposit balance
                const sdPaid = p.filter(pm => pm.category === 'Security Deposit (Paid)').reduce((s, pm) => s + pm.amount, 0);
                const sdRefunded = p.filter(pm => pm.category === 'Security Deposit (Refunded)').reduce((s, pm) => s + pm.amount, 0);
                const sdAdjusted = p.filter(pm => pm.category === 'Security Deposit (Adjusted)').reduce((s, pm) => s + pm.amount, 0);
                const currentSDBalance = sdPaid - sdRefunded - sdAdjusted;

                const trs=[...d.map(du=>({...du,isDue:true})),...p.map(pm=>({...pm,isPayment:true}))].sort((a,b)=>new Date(b.date)-new Date(a.date));
                
                const wS=`<svg viewBox="0 0 24 24"><path d="M16.75 13.96c.25.13.42.2.46.28.05.08.05.38-.02.75-.07.37-.52.68-.97.75-.45.07-1.03.22-1.57-.12-.54-.33-1.12-.78-1.8-1.38-.95-.83-1.63-1.85-1.7-2.03-.07-.18-.54-1.08.2-1.33.6-.2.95-.12 1.18.06.23.18.35.45.4.53.05.08.08.13.03.28-.05.15-.12.28-.23.4-.1.13-.18.18-.3.28-.13.1-.2.15-.28.25s-.12.18-.03.3.4.65.78 1.03c.53.5 1.12.83 1.33.9.2.08.33.05.43-.03.1-.08.43-.5.53-.65.1-.15.18-.13.28-.08zM12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/></svg>`;
                const o=this.isOwner();
                
                const headerActions = o ? `<button class="action-btn btn-warning" data-action="show-modal" data-modal-type="editTenant" data-id="${id}">Edit</button>` : ``;
                const deleteAndArchiveBtn = o ? `<button class="action-btn btn-danger" data-action="mark-tenant-left" data-id="${id}">Mark as Left</button>` : ``;
                
                const paymentForm = o ? `<div class="detail-card"><h4>Add Payment</h4><form id="payment-form" data-tenant-id="${id}"><div class="form-group"><label>Amount Paid</label><input type="number" id="payment-amount" required></div><div class="form-group"><label>For</label><select id="payment-category" required><option value="Rent">Rent</option><option value="Electricity">Electricity</option><option value="Other">Other</option></select></div><button type="submit" class="action-btn btn-secondary" style="width:100%">Record Payment</button></form></div>` : ``;
                const serviceChargeForm = o ? `<div class="detail-card"><h4>Add Service Charge</h4><form id="service-charge-form" data-tenant-id="${id}"><div class="form-group"><label>Description</label><input type="text" id="charge-desc" required></div><div class="form-group"><label>Amount</label><input type="number" id="charge-amount" required></div><button type="submit" class="action-btn btn-warning" style="width:100%">Add Charge</button></form></div>` : ``;
                
                const settleSDButton = o && currentSDBalance > 0 ? `<button class="action-btn btn-primary" data-action="settle-security-deposit" data-id="${id}">Settle Security Deposit</button>` : '';

                return`<div class="view active">
                    <div class="section-header">
                        <div class="header-actions">
                            <button class="action-btn btn-cancel" data-action="navigate" data-view="tenants">‚Üê Back</button>
                            ${headerActions}
                        </div>
                        <div class="header-actions">${deleteAndArchiveBtn}</div>
                    </div>
                    <div class="detail-view-header">
                        <div class="detail-photo" style="background-image:url(${t.photo||''})"></div>
                        <div class="detail-info">
                            <h2>${t.name}</h2>
                            <p>Room ${r?.number||'N/A'}</p>
                            <p>${t.isVerified?'‚úî Verified':'‚úñ Not Verified'}</p>
                        </div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-main">
                            <div class="detail-card">
                                <h4>Security Deposit</h4>
                                <ul>
                                    <li><span>Initial Deposit</span><strong>${this.state.settings.currencySymbol}${(t.initialSecurityDeposit || 0).toLocaleString('en-IN')}</strong></li>
                                    <li><span>Current Balance</span><strong>${this.state.settings.currencySymbol}${currentSDBalance.toLocaleString('en-IN')}</strong></li>
                                </ul>
                                <div style="margin-top:1rem;">${settleSDButton}</div>
                            </div>
                            <div class="detail-card">
                                <h4>Transactions</h4>
                                ${balance>0?`<div class="alert-item danger">Balance: <strong>${this.state.settings.currencySymbol}${balance.toLocaleString('en-IN')}</strong></div>`:`<div class="alert-item" style="background-color:#d1fae5;color:#065f46">All dues cleared.</div>`}
                                <div id="transaction-list">
                                    ${trs.map(tr=>`<div class="transaction-item ${tr.isDue?'due':'payment'}">
                                        <div>
                                            <p><strong>${tr.isDue?'-':'+'}${this.state.settings.currencySymbol}${tr.amount.toLocaleString('en-IN')}</strong> - ${tr.description||tr.category}</p>
                                            <p style="font-size:0.9rem;color:var(--text-light)">${new Date(tr.date).toLocaleDateString()}</p>
                                        </div>
                                        ${tr.isPayment?`<div class="transaction-actions"><button class="action-btn btn-cancel" data-action="generate-receipt" data-id="${tr.id}">Receipt</button><button class="action-btn btn-whatsapp btn-icon" data-action="share-receipt-whatsapp" data-id="${tr.id}">${wS}</button></div>`:''}
                                    </div>`).join('')||'<p>No transactions.</p>'}
                                </div>
                            </div>
                        </div>
                        <div class="detail-sidebar">
                            <div class="detail-card">
                                <h4>Contact & Info</h4>
                                <ul>
                                    <li><span>Phone</span><strong>${t.phone}</strong></li>
                                    <li><span>Move-in Date</span><strong>${new Date(t.moveInDate).toLocaleDateString()}</strong></li>
                                </ul>
                            </div>
                            <div class="detail-card">
                                <h4>Communication</h4>
                                <button class="action-btn btn-whatsapp" style="width:100%" data-action="share-dues-whatsapp" data-id="${id}">Send Dues Reminder</button>
                            </div>
                            ${paymentForm}
                            ${serviceChargeForm}
                        </div>
                    </div>
                </div>`; 
            },
        },
        
        // --- Core Application Logic (with Role Checks & New Features) ---
        showModal(type, id = null) { 
            if (!this.isOwner()) {
                this.showToast('Access Denied: You are in viewer mode.', 'error');
                return;
            }
            const mC=document.getElementById('modal-container');let mH='';
            if(type==='addRoom'){mH=`<div class="modal active"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Add New Room</h2><button class="close-btn" data-action="close-modal">√ó</button></div><form id="room-form"><div class="form-group"><label>Room Number*</label><input type="text" name="number" required></div><div class="form-group"><label>Monthly Rent (${this.state.settings.currencySymbol})*</label><input type="number" name="rent" required></div><div class="form-group"><label>Room Photo</label><input type="file" name="photo" accept="image/*"><img id="photo-preview" src="" style="display:none;"></div><div class="form-actions"><button type="button" class="action-btn btn-cancel" data-action="close-modal">Cancel</button><button type="submit" class="action-btn btn-primary">Save Room</button></div></form></div></div>`;
            }else if(type==='editRoom'){const r=(this.state.rooms || []).find(rm=>rm.id===id);if(!r)return;mH=`<div class="modal active"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Edit Room ${r.number}</h2><button class="close-btn" data-action="close-modal">√ó</button></div><form id="edit-room-form" data-id="${id}"><div class="form-group"><label>Room Number*</label><input type="text" name="number" required value="${r.number}"></div><div class="form-group"><label>Monthly Rent (${this.state.settings.currencySymbol})*</label><input type="number" name="rent" required value="${r.rent}"></div><div class="form-group"><label>Room Photo (leave blank)</label><input type="file" name="photo" accept="image/*"><img id="photo-preview" src="${r.photo||''}" style="display:${r.photo?'block':'none'};"></div><div class="form-actions"><button type="button" class="action-btn btn-cancel" data-action="close-modal">Cancel</button><button type="submit" class="action-btn btn-primary">Save Changes</button></div></form></div></div>`;
            }else if(type==='addTenant'){const aR=(this.state.rooms || []).filter(r=>r.status==='available');mH=`<div class="modal active"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Add New Tenant</h2><button class="close-btn" data-action="close-modal">√ó</button></div><form id="tenant-form"><div class="form-group"><label>Full Name*</label><input type="text" name="name" required></div><div class="form-group"><label>Phone Number*</label><input type="tel" name="phone" required></div><div class="form-group"><label>Move-in Date*</label><input type="date" name="moveInDate" required value="${new Date().toISOString().split('T')[0]}"></div><div class="form-group"><label>Initial Security Deposit (${this.state.settings.currencySymbol})</label><input type="number" name="initialSecurityDeposit" value="0"></div><div class="form-group"><label>Assign to Room*</label><select name="roomId" required ${aR.length===0?'disabled':''}><option value="">Select a room</option>${aR.map(r=>`<option value="${r.id}">Room ${r.number}</option>`).join('')}</select>${aR.length===0?'<p style="color:red;font-size:0.9rem;">No available rooms.</p>':''}</div><div class="form-group"><label>Tenant Photo</label><input type="file" name="photo" accept="image/*"><img id="photo-preview" src="" style="display:none;"></div><div class="form-group" style="display:flex;align-items:center;"><input type="checkbox" name="isVerified" id="isVerified" style="width:auto;margin-right:0.5rem;"><label for="isVerified" style="margin:0;">Identity Verified</label></div><div class="form-actions"><button type="button" class="action-btn btn-cancel" data-action="close-modal">Cancel</button><button type="submit" class="action-btn btn-primary">Save Tenant</button></div></form></div></div>`;
            }else if(type==='editTenant'){const t=(this.state.tenants || []).find(tn=>tn.id===id);if(!t)return;const cR=(this.state.rooms || []).find(r=>r.id===t.roomId),aR=(this.state.rooms || []).filter(r=>r.status==='available'),rO=[cR,...aR].filter(Boolean),uRO=[...new Map(rO.map(i=>[i['id'],i])).values()];mH=`<div class="modal active"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Edit Tenant ${t.name}</h2><button class="close-btn" data-action="close-modal">√ó</button></div><form id="edit-tenant-form" data-id="${id}"><div class="form-group"><label>Full Name*</label><input type="text" name="name" required value="${t.name}"></div><div class="form-group"><label>Phone Number*</label><input type="tel" name="phone" required value="${t.phone}"></div><div class="form-group"><label>Move-in Date*</label><input type="date" name="moveInDate" required value="${t.moveInDate}"></div><div class="form-group"><label>Initial Security Deposit (${this.state.settings.currencySymbol})</label><input type="number" name="initialSecurityDeposit" value="${t.initialSecurityDeposit || 0}"></div><div class="form-group"><label>Assign to Room*</label><select name="roomId" required>${uRO.map(r=>`<option value="${r.id}" ${r.id===t.roomId?'selected':''}>Room ${r.number}</option>`).join('')}</select></div><div class="form-group"><label>Tenant Photo (leave blank)</label><input type="file" name="photo" accept="image/*"><img id="photo-preview" src="${t.photo||''}" style="display:${t.photo?'block':'none'};"></div><div class="form-group" style="display:flex;align-items:center;"><input type="checkbox" name="isVerified" id="isVerified" style="width:auto;margin-right:0.5rem;" ${t.isVerified?'checked':''}}><label for="isVerified" style="margin:0;">Identity Verified</label></div><div class="form-actions"><button type="button" class="action-btn btn-cancel" data-action="close-modal">Cancel</button><button type="submit" class="action-btn btn-primary">Save Changes</button></div></form></div></div>`;
            } else if (type === 'settleSecurityDeposit') {
                const tenantPayments = (this.state.payments || []).filter(p => p.tenantId === id);
                const sdPaid = tenantPayments.filter(pm => pm.category === 'Security Deposit (Paid)').reduce((s, pm) => s + pm.amount, 0);
                const sdRefunded = tenantPayments.filter(pm => pm.category === 'Security Deposit (Refunded)').reduce((s, pm) => s + pm.amount, 0);
                const sdAdjusted = tenantPayments.filter(pm => pm.category === 'Security Deposit (Adjusted)').reduce((s, pm) => s + pm.amount, 0);
                const currentSDBalance = sdPaid - sdRefunded - sdAdjusted;

                const tenantDues = (this.state.dues || []).filter(d => d.tenantId === id);
                const tenantPaymentsExclSD = tenantPayments.filter(pm => 
                    pm.category !== 'Security Deposit (Paid)' && 
                    pm.category !== 'Security Deposit (Refunded)' &&
                    pm.category !== 'Security Deposit (Adjusted)'
                );
                const currentDuesBalance = tenantDues.reduce((s, d) => s + d.amount, 0) - tenantPaymentsExclSD.reduce((s, p) => s + p.amount, 0);

                mH = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Settle Security Deposit</h2><button class="close-btn" data-action="close-modal">√ó</button></div>
                    <form id="settle-security-deposit-form" data-tenant-id="${id}">
                        <p style="margin-bottom: 1rem;">Current Security Deposit Balance: <strong>${this.state.settings.currencySymbol}${currentSDBalance.toLocaleString('en-IN')}</strong></p>
                        <p style="margin-bottom: 1rem;">Current Pending Dues: <strong>${this.state.settings.currencySymbol}${Math.max(0, currentDuesBalance).toLocaleString('en-IN')}</strong></p>
                        
                        <div class="form-group">
                            <label>Amount to Refund</label>
                            <input type="number" step="0.01" id="refund-amount" max="${currentSDBalance}" value="0">
                        </div>
                        <p style="text-align: center; margin-bottom: 1rem; color: var(--text-light);">OR</p>
                        <button type="button" class="action-btn btn-secondary" style="width:100%;" data-action="adjust-deposit-against-dues" data-id="${id}">Adjust Against Pending Dues</button>
                        <div class="form-actions">
                            <button type="button" class="action-btn btn-cancel" data-action="close-modal">Cancel</button>
                            <button type="submit" class="action-btn btn-primary" id="confirm-refund-btn">Confirm Refund</button>
                        </div>
                    </form></div></div>`;
            }
            mC.innerHTML=mH; 

            if (type === 'settleSecurityDeposit') {
                const refundInput = mC.querySelector('#refund-amount');
                const confirmRefundBtn = mC.querySelector('#confirm-refund-btn');
                const adjustBtn = mC.querySelector('[data-action="adjust-deposit-against-dues"]');
                const sdTenantId = id;

                // Add event listener for the "Adjust Against Pending Dues" button
                if (adjustBtn) {
                    adjustBtn.addEventListener('click', async () => {
                        if (!this.isOwner()) {
                            this.showToast('Access Denied: You are in viewer mode.', 'error');
                            return;
                        }
                        if (confirm(`Are you sure you want to adjust the security deposit against outstanding dues?`)) {
                            await this.handleSettleSecurityDeposit(null, sdTenantId, 'adjust', currentSDBalance, currentDuesBalance);
                        }
                    });
                }
                
                // Event listener for the "Confirm Refund" button (which is also the form submit)
                if (confirmRefundBtn) {
                    confirmRefundBtn.addEventListener('click', async (event) => {
                         if (!this.isOwner()) {
                            this.showToast('Access Denied: You are in viewer mode.', 'error');
                            return;
                        }
                        event.preventDefault(); // Prevent default form submission initially
                        const refundAmount = parseFloat(refundInput.value);
                        if (isNaN(refundAmount) || refundAmount <= 0) {
                            this.showToast('Please enter a valid amount to refund.', 'error');
                            return;
                        }
                        if (refundAmount > currentSDBalance) {
                            this.showToast('Refund amount cannot exceed current security deposit balance.', 'error');
                            return;
                        }
                        if (confirm(`Are you sure you want to refund ${this.state.settings.currencySymbol}${refundAmount.toLocaleString('en-IN')}?`)) {
                            await this.handleSettleSecurityDeposit(null, sdTenantId, 'refund', refundAmount);
                        }
                    });
                }
            }
        },
        closeModal() { document.getElementById('modal-container').innerHTML = ''; },
        
        async handleRoomSubmit(f) { 
            const d=new FormData(f);
            const photoFile = d.get('photo');
            const photoUrl = await this.uploadPhotoToDrive(photoFile);

            this.state.rooms.push({
                id:`room_${Date.now()}`,
                number:d.get('number'),
                rent:parseFloat(d.get('rent')),
                status:'available',
                tenantId:null,
                photo: photoUrl, // Store URL
                meterStatus:'ok',
                meterInstallationId:`m_${Date.now()}`
            });
            this.triggerAutoSave();this.closeModal();this.render();this.showToast('Room added!');
        },
        async handleTenantSubmit(f) { 
            const d=new FormData(f);
            const rId=d.get('roomId');
            if(!rId){this.showToast('Please select a room.','error');return;}
            
            const photoFile = d.get('photo');
            const photoUrl = await this.uploadPhotoToDrive(photoFile);
            const initialSD = parseFloat(d.get('initialSecurityDeposit') || '0');

            const nT={
                id:`tenant_${Date.now()}`,
                name:d.get('name'),
                phone:d.get('phone'),
                moveInDate:d.get('moveInDate'),
                isVerified:d.get('isVerified')==='on',
                photo: photoUrl, // Store URL
                roomId:rId,
                initialSecurityDeposit: initialSD // Store initial SD
            };
            this.state.tenants.push(nT);

            // Record initial security deposit as a payment
            if (initialSD > 0) {
                this.state.payments.push({
                    id: `pay_sd_${Date.now()}`,
                    tenantId: nT.id,
                    amount: initialSD,
                    date: new Date().toISOString(),
                    category: 'Security Deposit (Paid)',
                    description: 'Initial Security Deposit'
                });
            }

            const r=this.state.rooms.find(rm=>rm.id===rId);
            if(r){r.status='occupied';r.tenantId=nT.id;}
            this.triggerAutoSave();this.closeModal();this.navigateTo('tenants');this.showToast('Tenant added!');
        },
        handleSettingsSubmit(f) {
            this.state.settings.electricityRate=parseFloat(f.querySelector('#electricity-rate').value);
            this.state.settings.currencySymbol=f.querySelector('#currency-symbol').value;
            this.triggerAutoSave();this.render();this.showToast('Settings saved!');
        },
        handleUtilitySubmit(f) { 
            const rId=f.dataset.roomId,r=this.state.rooms.find(rm=>rm.id===rId);
            const nR=parseInt(f.querySelector('#meter-reading').value);
            const lR=(this.state.utilityReadings||[]).filter(ur=>ur.meterInstallationId===r.meterInstallationId).sort((a,b)=>b.reading-a.reading)[0]?.reading||0;
            if(nR<=lR){this.showToast('New reading must be > last.','error');return;}
            const c=nR-lR,b=c*this.state.settings.electricityRate;
            this.state.utilityReadings.push({id:`ur_${Date.now()}`,roomId:rId,date:new Date().toISOString(),reading:nR,meterInstallationId:r.meterInstallationId});
            if(r?.tenantId)this.state.dues.push({id:`due_${Date.now()}`,tenantId:r.tenantId,amount:parseFloat(b.toFixed(2)),date:new Date().toISOString(),type:'utility',description:`Utility Bill (${c} units)`});
            this.triggerAutoSave();this.render();this.showToast(`Bill of ${this.state.settings.currencySymbol}${b.toFixed(2)} generated.`);
        },
        handlePaymentSubmit(f) { 
            this.state.payments.push({id:`pay_${Date.now()}`,tenantId:f.dataset.tenantId,amount:parseFloat(f.querySelector('#payment-amount').value),date:new Date().toISOString(),category:f.querySelector('#payment-category').value,description:f.querySelector('#payment-category').value+" Payment"});
            this.triggerAutoSave();this.render();this.showToast('Payment recorded!');
        },
        handleServiceChargeSubmit(f) { 
            this.state.dues.push({id:`due_${Date.now()}`,tenantId:f.dataset.tenantId,amount:parseFloat(f.querySelector('#charge-amount').value),date:new Date().toISOString(),type:'service',description:f.querySelector('#charge-desc').value});
            this.triggerAutoSave();this.render();this.showToast('Service charge added!');
        },
        async handleEditRoomSubmit(f) { 
            const id=f.dataset.id,r=this.state.rooms.find(rm=>rm.id===id);
            if(!r)return;
            const d=new FormData(f);
            r.number=d.get('number');
            r.rent=parseFloat(d.get('rent'));
            const p=d.get('photo');
            if(p&&p.size>0)r.photo=await this.uploadPhotoToDrive(p); // Update photo if new one selected
            this.triggerAutoSave();this.closeModal();this.render();this.showToast('Room details updated!');
        },
        async handleEditTenantSubmit(f) { 
            const id=f.dataset.id,t=this.state.tenants.find(tn=>tn.id===id);
            if(!t)return;
            const d=new FormData(f),oRId=t.roomId,nRId=d.get('roomId');
            t.name=d.get('name');t.phone=d.get('phone');t.moveInDate=d.get('moveInDate');t.isVerified=d.get('isVerified')==='on';t.roomId=nRId;
            t.initialSecurityDeposit = parseFloat(d.get('initialSecurityDeposit') || '0'); // Update initial SD, but actual balance is from payments
            const p=d.get('photo');
            if(p&&p.size>0)t.photo=await this.uploadPhotoToDrive(p); // Update photo if new one selected
            if(oRId!==nRId){
                const oR=this.state.rooms.find(r=>r.id===oRId);if(oR){oR.status='available';oR.tenantId=null;}
                const nR=this.state.rooms.find(r=>r.id===nRId);if(nR){nR.status='occupied';nR.tenantId=id;}
            }
            this.triggerAutoSave();this.closeModal();this.render();this.showToast('Tenant details updated!');
        },
        async handleSettleSecurityDeposit(form, tenantId, type, amount, currentDuesBalance = 0) {
            if (!this.isOwner()) {
                this.showToast('Access Denied: You are in viewer mode.', 'error');
                return;
            }
            const tenantPayments = (this.state.payments || []).filter(p => p.tenantId === tenantId);
            const sdPaid = tenantPayments.filter(pm => pm.category === 'Security Deposit (Paid)').reduce((s, pm) => s + pm.amount, 0);
            const sdRefunded = tenantPayments.filter(pm => pm.category === 'Security Deposit (Refunded)').reduce((s, pm) => s + pm.amount, 0);
            const sdAdjusted = tenantPayments.filter(pm => pm.category === 'Security Deposit (Adjusted)').reduce((s, pm) => s + pm.amount, 0);
            const currentSDBalance = sdPaid - sdRefunded - sdAdjusted;

            if (type === 'refund') {
                const refundAmount = amount; // amount is directly the refund value here
                if (refundAmount <= 0 || refundAmount > currentSDBalance) {
                    this.showToast('Invalid refund amount.', 'error');
                    return;
                }
                this.state.payments.push({
                    id: `pay_sd_refund_${Date.now()}`,
                    tenantId: tenantId,
                    amount: refundAmount,
                    date: new Date().toISOString(),
                    category: 'Security Deposit (Refunded)',
                    description: 'Security Deposit Refund'
                });
                this.showToast(`Refunded ${this.state.settings.currencySymbol}${refundAmount.toLocaleString('en-IN')}.`, 'success');

            } else if (type === 'adjust') {
                const amountToAdjust = Math.min(currentSDBalance, Math.max(0, currentDuesBalance));
                if (amountToAdjust <= 0) {
                    this.showToast('No outstanding dues or insufficient security deposit to adjust.', 'warning');
                    this.closeModal(); // Close if no adjustment needed
                    return;
                }
                this.state.payments.push({
                    id: `pay_sd_adjust_${Date.now()}`,
                    tenantId: tenantId,
                    amount: amountToAdjust,
                    date: new Date().toISOString(),
                    category: 'Security Deposit (Adjusted)',
                    description: 'Security Deposit Adjusted Against Dues'
                });
                this.showToast(`Adjusted ${this.state.settings.currencySymbol}${amountToAdjust.toLocaleString('en-IN')} from security deposit against dues.`, 'success');
            }

            this.triggerAutoSave();
            this.closeModal();
            this.render(); // Re-render tenant detail to show updated balance
        },
        deleteItem(t, id) { 
            if (!this.isOwner()) {
                this.showToast('Access Denied: You are in viewer mode.', 'error');
                return;
            }
            if(t==='room'){
                if((this.state.rooms||[]).find(r=>r.id===id)?.status==='occupied'){
                    this.showToast('Cannot delete occupied room.','error');return;
                }
                this.state.rooms=(this.state.rooms||[]).filter(r=>r.id!==id);
                this.navigateTo('rooms');
            }
            this.triggerAutoSave();this.showToast(`${t.replace('-',' ')} deleted.`,'success');
        },
        markTenantAsLeft(tenantId) { 
            if (!this.isOwner()) {
                this.showToast('Access Denied: You are in viewer mode.', 'error');
                return;
            }
            const tenantIndex = this.state.tenants.findIndex(t => t.id === tenantId); 
            if (tenantIndex === -1) return; 
            const tenant = this.state.tenants[tenantIndex]; 
            tenant.leaveDate = new Date().toISOString(); 
            const room = this.state.rooms.find(r => r.id === tenant.roomId); 
            if (room) { room.status = 'available'; room.tenantId = null; } 
            if (!this.state.leftTenants) this.state.leftTenants = []; 
            this.state.leftTenants.push(tenant); 
            this.state.tenants.splice(tenantIndex, 1); 
            this.triggerAutoSave(); 
            this.navigateTo('leftTenants'); 
            this.showToast(`${tenant.name}'s record moved to Left Tenants.`, 'success');
        },
        reportMeterBroken(rId) { 
            if (!this.isOwner()) {
                this.showToast('Access Denied: You are in viewer mode.', 'error');
                return;
            }
            const r=this.state.rooms.find(rm=>rm.id===rId);if(r)r.meterStatus='broken';this.triggerAutoSave();this.render();
        },
        installNewMeter(rId) {
            if (!this.isOwner()) {
                this.showToast('Access Denied: You are in viewer mode.', 'error');
                return;
            }
            const i=parseInt(prompt("Initial reading of new meter:","0"));if(isNaN(i)||i<0)return;
            const r=this.state.rooms.find(rm=>rm.id===rId);
            if(r){r.meterStatus='ok';r.meterInstallationId=`m_${Date.now()}`;}
            this.state.utilityReadings.push({id:`ur_${Date.now()}`,roomId:rId,date:new Date().toISOString(),reading:i,meterInstallationId:r.meterInstallationId});
            this.triggerAutoSave();this.render();this.showToast('New meter installed!');
        },
        generateMissingRentDues() { 
            let c=0;const t=new Date();t.setHours(0,0,0,0);
            (this.state.tenants||[]).forEach(tn=>{
                const r=(this.state.rooms||[]).find(rm=>rm.id===tn.roomId);
                if(!r||!tn.moveInDate)return;
                let dD=new Date(tn.moveInDate);dD.setHours(0,0,0,0);
                dD.setMonth(dD.getMonth()+1); // Start checking from the month after move-in
                
                while(dD <= t){
                    const dY=dD.getFullYear(),dM=dD.getMonth();
                    const alreadyExists = (this.state.dues || []).some(due => 
                        due.tenantId === tn.id && 
                        due.type === 'rent' && 
                        new Date(due.date).getFullYear() === dY && 
                        new Date(due.date).getMonth() === dM
                    );
                    if(!alreadyExists){
                        this.state.dues.push({
                            id:`due_${dD.getTime()}_${tn.id}`,
                            tenantId:tn.id,
                            amount:r.rent,
                            date:dD.toISOString(),
                            type:'rent',
                            description:`Monthly Rent`
                        });
                        c++;
                    }
                    dD.setMonth(dD.getMonth()+1); // Move to next month
                }
            });
            return c;
        },
        generateReceipt(pId){const p=this.state.payments.find(pm=>pm.id===pId),t=this.state.tenants.find(tn=>tn.id===p.tenantId)||this.state.leftTenants.find(tn=>tn.id===p.tenantId),w=window.open('','‡§∞‡§∏‡•Ä‡§¶');w.document.write(`<html><head><title>‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∞‡§∏‡•Ä‡§¶</title></head><body style="font-family:sans-serif;padding:2rem;"><h1>‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∞‡§∏‡•Ä‡§¶</h1><hr><p><strong>‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ:</strong> ${t.name}</p><p><strong>‡§∞‡§æ‡§∂‡§ø:</strong> ${this.state.settings.currencySymbol}${p.amount.toLocaleString('en-IN')}</p><p><strong>‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï:</strong> ${new Date(p.date).toLocaleString('hi-IN')}</p><p><strong>‡§ï‡•á ‡§≤‡§ø‡§è:</strong> ${p.description||p.category}</p><hr><p>‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶!</p></body></html>`);w.document.close();w.print();},
        shareReceiptWhatsApp(pId) { const p=this.state.payments.find(pm=>pm.id===pId);if(!p)return;const t=this.state.tenants.find(tn=>tn.id===p.tenantId)||this.state.leftTenants.find(tn=>tn.id===p.tenantId);if(!t||!t.phone){this.showToast('Tenant phone not found.','error');return;}const{currencySymbol:cS}=this.state.settings;const m=`*Payment Confirmation*\n\nHi ${t.name},\n\nWe have received your payment.\n\n*Details:*\nAmount: ${cS}${p.amount.toLocaleString('en-IN')}\nDate: ${new Date(p.date).toLocaleDateString()}\nFor: ${p.description||p.category}\n\nThank you.`;this.openWhatsApp(t.phone,m);},
        shareDuesWhatsApp(tenantId){const t=this.state.tenants.find(tn=>tn.id===tenantId);if(!t||!t.phone){this.showToast('‡§ï‡§ø‡§∞‡§æ‡§Ø‡•á‡§¶‡§æ‡§∞ ‡§ï‡§æ ‡§´‡§º‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç‡•§','error');return;}const{currencySymbol:cS,electricityRate:eR}=this.state.settings;
            // Exclude security deposit movements from standard dues calculation
            const allDues=(this.state.dues||[]).filter(d=>d.tenantId===tenantId);
            const allPayments=(this.state.payments||[]).filter(p=>p.tenantId===tenantId && !['Security Deposit (Paid)', 'Security Deposit (Refunded)', 'Security Deposit (Adjusted)'].includes(p.category));
            
            const totalDueAmount=allDues.reduce((s,d)=>s+d.amount,0);
            const totalPaidAmount=allPayments.reduce((s,p)=>s+p.amount,0);
            const balance=totalDueAmount-totalPaidAmount;
            
            if(balance<=0){this.showToast('‡§ï‡•ã‡§à ‡§≤‡§Ç‡§¨‡§ø‡§§ ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§','success');return;}
            const hindiDueItems=[];
            allDues.forEach(d=>{let itemString='';const amountFormatted=`${cS}${d.amount.toLocaleString('hi-IN')}`;
            
            // For rent and utility, we need to check if the specific month's due is paid
            let isPaid = false;
            if (d.type === 'rent') {
                const paidForThisMonth = allPayments.filter(p => p.category === 'Rent' && new Date(p.date).getFullYear() === new Date(d.date).getFullYear() && new Date(p.date).getMonth() === new Date(d.date).getMonth()).reduce((s, p) => s + p.amount, 0);
                if (paidForThisMonth >= d.amount) isPaid = true;
            } else if (d.type === 'utility') {
                const paidForThisUtility = allPayments.filter(p => p.category === 'Electricity' && p.description === d.description && new Date(p.date).getFullYear() === new Date(d.date).getFullYear() && new Date(p.date).getMonth() === new Date(d.date).getMonth()).reduce((s, p) => s + p.amount, 0);
                if (paidForThisUtility >= d.amount) isPaid = true;
            } else if (d.type === 'service') {
                 // For service charges, a simple check if any payment covers it by description or if it's explicitly paid
                 const paidForThisService = allPayments.filter(p => p.category === 'Other' && p.description === d.description).reduce((s, p) => s + p.amount, 0);
                 if (paidForThisService >= d.amount) isPaid = true;
            }

            if (!isPaid) {
                if(d.type==='rent'){itemString=`* ‡§ï‡§ø‡§∞‡§æ‡§Ø‡§æ: ${amountFormatted}`;}
                else if(d.type==='utility'){const unitsMatch=d.description.match(/(\d+(\.\d+)?)\s*units/),units=unitsMatch?unitsMatch[1]:'N/A';itemString=`* ‡§¨‡§ø‡§ú‡§≤‡•Ä: ${units} ‡§Ø‡•Ç‡§®‡§ø‡§ü @ ${cS}${eR}/‡§Ø‡•Ç‡§®‡§ø‡§ü = ${amountFormatted}`;}
                else if(d.type==='service'){itemString=`* ${d.description}: ${amountFormatted}`;}
                hindiDueItems.push(itemString);
            }
            });
            
            const duesListString=hindiDueItems.join('\n');
            const paymentPhoneNumber='7078098123';
            const finalWhatsAppMessage=`‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${t.name},\n\n‡§Ø‡§π ‡§Ü‡§™‡§ï‡•á ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∂‡•Å‡§≤‡•ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§π‡•à:\n\n${duesListString}\n\n*‡§ï‡•Å‡§≤ ‡§¶‡•á‡§Ø ‡§∞‡§æ‡§∂‡§ø: ${cS}${balance.toLocaleString('hi-IN')}*\n\n‡§ï‡•É‡§™‡§Ø‡§æ ‡§ú‡§≤‡•ç‡§¶ ‡§∏‡•á ‡§ú‡§≤‡•ç‡§¶ ‡§∂‡•á‡§∑ ‡§∞‡§æ‡§∂‡§ø ‡§ï‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Ü‡§™ ‡§á‡§∏ ‡§®‡§Ç‡§¨‡§∞ ‡§™‡§∞ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç: *${paymentPhoneNumber}*\n\n‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡•á ‡§¨‡§æ‡§¶, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§π‡§Æ‡•á‡§Ç *‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§®‡§∂‡•â‡§ü* ‡§≠‡•á‡§ú‡§®‡§æ ‡§® ‡§≠‡•Ç‡§≤‡•á‡§Ç‡•§\n\n‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶‡•§`;
            this.openWhatsApp(t.phone,finalWhatsAppMessage);
        },
        openWhatsApp(phone, message) { const cP=phone.replace(/\D/g,''),fP=cP.startsWith('91')?cP:'91'+cP;const u=`https://wa.me/${fP}?text=${encodeURIComponent(message)}`;window.open(u,'_blank');},
        showToast(msg, type='success') {const t=document.getElementById('toast');t.textContent=msg;t.className=`show ${type}`;setTimeout(()=>t.className=t.className.replace('show',''),3000);},
        previewPhoto(e) {const p=document.getElementById('photo-preview');if(!p)return;const f=e.target.files[0];if(f){const r=new FileReader();r.onload=ev=>{p.src=ev.target.result;p.style.display='block';};r.readAsDataURL(f);}},
    };

    app.init();
};
</script>

</body>
</html>
