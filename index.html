<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tinny Fashion - Business Manager</title>
   <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3crect width='100' height='100' rx='15' fill='%236B46C1'/%3e%3cpath fill='white' d='M20 30h60l-10 50H30zM50 20c-8 0-15 7-15 15v5h30v-5c0-8-7-15-15-15zM30 40c0 5 5 10 10 10h20c5 0 10-5 10-10'/%3e%3c/svg%3e">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <style>
        :root {
            --background-body: #E0E0E0;
            --surface-light: #FFFFFF;
            --text-dark: #333333;
            --text-light: #FFFFFF;
            --border-color: #BDBDBD;
            
            --input-bg: #E3F2FD;
            --input-border: #90CAF9;

            --btn-orange: #EF6C00;
            --btn-green: #2E7D32;
            --btn-red: #C62828;
            --btn-blue: #1565C0;
            
            --border-radius-md: 8px;
            --shadow-strong: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html { height: 100%; }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-body);
            color: var(--text-dark);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        #login-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; text-align: center;
        }
        .login-box {
            background: var(--surface-light);
            padding: 2.5rem 3rem; border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-strong); max-width: 480px; width: 100%;
        }
        .login-box h1 { margin-bottom: 0.5rem; font-size: 1.8rem; font-weight: 700; }
        .login-box p { color: #555; margin-bottom: 1.5rem; font-size: 0.95rem; }
        #signin-btn { background-color: #4285F4; color: white; border: none; padding: 14px 28px; font-size: 1rem; font-weight: 500; border-radius: var(--border-radius-md); cursor: pointer; display: inline-flex; align-items: center; gap: 1rem; transition: background-color 0.3s; }
        #signin-btn:hover:not([disabled]) { background-color: #357ae8; }
        #signin-btn[disabled] { background-color: #9E9E9E; cursor: not-allowed; }
        #signin-btn svg { width: 24px; height: 24px; background: white; border-radius: 50%; padding: 2px; }
        #auth-status { margin-top: 1.5rem; font-size: 0.9rem; }

        #app-container { display: none; }
        #app-container.visible { display: block; }
        
        .tab-nav { display: none; } /* Hide original tab navigation */
        
        .mobile-screen {
            background-color: var(--surface-light);
            border: 8px solid #424242;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            box-shadow: var(--shadow-strong);
            position: relative;
        }

        .screen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .screen-header h2 {
            font-size: 1.2rem;
            font-weight: 700;
            flex-grow: 1;
            text-align: center;
        }
        .nav-arrow {
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: #555;
            padding: 0 5px;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeInContent 0.4s ease-out; }
        @keyframes fadeInContent { from { opacity: 0; } to { opacity: 1; } }

        /* Home Screen */
        .home-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .home-button {
            background-color: var(--surface-light);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: 20px 10px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .home-button:hover { background-color: #f5f5f5; }
        .home-button .icon { font-size: 2rem; margin-bottom: 8px; }
        .home-button .title { font-weight: 500; }

        /* Forms */
        .form-section { margin-bottom: 20px; }
        .form-section h3 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 15px;
        }
        .form-section h3::before { content: '‚ùØ '; }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .form-grid input[placeholder="Item Name"] { grid-column: 1 / -1; }

        input[type="text"], input[type="number"], input[type="date"], input[type="file"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 0.95rem;
            background-color: var(--input-bg);
            color: var(--text-dark);
        }
        input::placeholder { color: #616161; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            margin-top: 10px;
        }
        .btn-orange { background-color: var(--btn-orange); }
        .btn-green { background-color: var(--btn-green); }
        .btn-blue { background-color: var(--btn-blue); }
        .btn-small { padding: 6px 10px; font-size: 0.8rem; width: auto; margin-top: 0;}
        .btn-danger { background-color: var(--btn-red); }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .filter-controls input[type="date"] {
            flex-grow: 1;
            padding: 8px;
        }
        .filter-controls .btn {
            margin-top: 0;
            padding: 8px 12px;
        }
        
        /* Tables */
        .table-container { 
            width: 100%; 
            overflow-x: auto; 
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        .styled-table {
            width: 100%;
            border-collapse: collapse;
        }
        .styled-table th, .styled-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
            font-size: 0.9rem;
            vertical-align: middle;
        }
        .styled-table th { background-color: #f5f5f5; font-weight: 700; }

        /* Specific Screen Styles */
        /* Stocks */
        .inventory-actions { display: flex; gap: 8px; align-items: center; justify-content: center;}
        .action-icon { cursor: pointer; font-size: 1.2rem; }
        .action-icon.delete { color: var(--btn-red); }
        .action-icon.edit { color: var(--btn-blue); }

        /* Analytics */
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .metric-card {
            background-color: #fafafa;
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .metric-card p {
            font-size: 1.1rem;
            font-weight: 700;
        }
        #stock-value-card {
            grid-column: 1 / -1;
            text-align: center;
        }
        .top-products h3 {
             font-size: 1rem;
            font-weight: 700;
            margin-top: 20px;
        }

        /* Settings */
        .setting-section { margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .setting-section h3 { font-size: 1rem; font-weight: 700; margin-bottom: 10px; }
        .setting-section p { font-size: 0.9rem; color: #555; margin-bottom: 10px;}
        #holiday-list { list-style: none; padding: 0; }
        #holiday-list li { display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid #eee; }
        .delete-holiday-icon { cursor: pointer; color: var(--btn-red); font-weight: bold; font-size: 1.2rem; }

        #toast { position: fixed; bottom: -120px; left: 50%; transform: translateX(-50%); padding: 14px 25px; border-radius: var(--border-radius-md); color: var(--text-light); font-weight: 600; font-size: 0.95rem; box-shadow: var(--shadow-strong); transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 9999; opacity: 0; }
        #toast.show { bottom: 25px; opacity: 1; }
        #toast.success { background-color: var(--btn-green); }
        #toast.error { background-color: var(--btn-red); }
        #toast.info { background-color: var(--btn-blue); }

    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-box">
            <h1>Tinny Fashion</h1>
            <p>Sign in with Google to manage your store.</p>
            <button id="signin-btn" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 35.841 44 30.138 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                Sign in with Google
            </button>
            <p id="auth-status" style="margin-top: 1.5rem; font-size: 0.9rem;">Initializing...</p>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container">
        <!-- HIDDEN TAB NAVIGATION FOR JS CONTROL -->
         <nav class="tab-nav">
            <button class="tab-button active" data-tab="home">Home</button>
            <button class="tab-button" data-tab="sales">Sales</button>
            <button class="tab-button" data-tab="purchase">Purchase</button>
            <button class="tab-button" data-tab="stocks">Stocks</button>
            <button class="tab-button" data-tab="records">Records</button>
            <button class="tab-button" data-tab="analytics">Analytics</button>
            <button class="tab-button" data-tab="profit">Profit</button>
            <button class="tab-button" data-tab="credit">Credit</button>
            <button class="tab-button" data-tab="settings">Settings</button>
        </nav>

        <main>
            <!-- Home Tab -->
            <div id="home" class="tab-content active">
                <div class="mobile-screen">
                    <header class="screen-header">
                        <span class="nav-arrow" style="visibility: hidden;">‚óÄ</span>
                        <h2>TINNY FASHION</h2>
                         <span class="nav-arrow" id="signout-btn" title="Sign Out">‚èè</span>
                    </header>
                    <div class="home-grid">
                        <div class="home-button" data-target-tab="sales">
                            <div class="icon">üòä</div>
                            <div class="title">SALE</div>
                        </div>
                        <div class="home-button" data-target-tab="purchase">
                            <div class="icon">üòä</div>
                            <div class="title">PURCHASE</div>
                        </div>
                        <div class="home-button" data-target-tab="stocks">
                            <div class="icon">üòä</div>
                            <div class="title">STOCKS</div>
                        </div>
                         <div class="home-button" data-target-tab="records">
                            <div class="icon">üòä</div>
                            <div class="title">RECORDS</div>
                        </div>
                        <div class="home-button" data-target-tab="analytics">
                            <div class="icon">üòä</div>
                            <div class="title">ANALYTICS</div>
                        </div>
                        <div class="home-button" data-target-tab="profit">
                            <div class="icon">üòä</div>
                            <div class="title">PROFIT</div>
                        </div>
                        <div class="home-button" data-target-tab="credit">
                            <div class="icon">üòä</div>
                            <div class="title">CREDIT</div>
                        </div>
                        <div class="home-button" data-target-tab="settings">
                            <div class="icon">üòä</div>
                            <div class="title">SETTING</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Tab -->
            <div id="sales" class="tab-content">
                <div class="mobile-screen">
                     <header class="screen-header">
                        <span class="nav-arrow back-to-home">‚óÄ</span>
                        <h2>TINNY FASHION</h2>
                        <span class="nav-arrow" style="visibility: hidden;">‚ñ∂</span>
                    </header>
                    <div class="form-section">
                        <h3>SALES ENTRY - INVENTORY</h3>
                        <form id="sales-form">
                            <div class="form-grid">
                                <input type="text" class="particulars" placeholder="ITEM NAME" list="inventory-datalist" required>
                                <input type="number" class="quantity" placeholder="QTY" min="1" required>
                                <input type="number" class="rate" placeholder="SALE RATE" min="0" step="0.01" required>
                            </div>
                            <button type="button" class="btn btn-orange" id="add-sale-item-btn">ADD ITEMS</button>
                            <button type="button" class="btn btn-green" id="record-sale-btn">RECORD SALES</button>
                        </form>
                    </div>
                    <div class="form-section">
                        <h3>SALES ENTRY - COSMETICS</h3>
                        <form id="cosmetic-sale-form">
                           <div class="form-grid">
                                <input type="text" id="cosmetic-particulars" placeholder="ITEM NAME" required>
                                <input type="number" id="cosmetic-quantity" placeholder="QTY" min="1" required>
                                <input type="number" id="cosmetic-sell-rate" placeholder="SALE RATE" min="0" step="0.01" required>
                                <input type="number" id="cosmetic-cost-rate" placeholder="COST RATE" min="0" step="0.01" style="display:none;" value="0">
                            </div>
                            <button type="submit" class="btn btn-orange">ADD ITEMS</button>
                            <button type="submit" class="btn btn-green">RECORD SALES</button>
                        </form>
                    </div>
                     <datalist id="inventory-datalist"></datalist>
                </div>
            </div>

            <!-- Purchase Tab -->
            <div id="purchase" class="tab-content">
                <div class="mobile-screen">
                     <header class="screen-header">
                        <span class="nav-arrow back-to-home">‚óÄ</span>
                        <h2>TINNY FASHION</h2>
                        <span class="nav-arrow" style="visibility: hidden;">‚ñ∂</span>
                    </header>
                     <div class="form-section">
                        <h3>PURCHASE ENTRY</h3>
                        <form id="purchase-form">
                            <div class="form-grid">
                                <input type="text" class="particulars" placeholder="ITEM NAME" required>
                                <input type="number" class="quantity" placeholder="QTY" min="1" required>
                                <input type="number" class="rate" placeholder="COST RATE" min="0" step="0.01" required>
                            </div>
                            <button type="button" id="add-purchase-item-btn" class="btn btn-orange">ADD ITEMS</button>
                            <button type="submit" class="btn btn-green">RECORD PURCHASE</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Stocks Tab -->
             <div id="stocks" class="tab-content">
                 <div class="mobile-screen">
                     <header class="screen-header">
                        <span class="nav-arrow back-to-home">‚óÄ</span>
                        <h2>TINNY FASHION</h2>
                        <span class="nav-arrow" style="visibility: hidden;">‚ñ∂</span>
                    </header>
                     <h3>STOCKS DATA (INVENTORY)</h3>
                     <div class="table-container">
                        <table class="styled-table" id="inventory-table">
                            <thead><tr><th>ITEM</th><th>QTY</th><th>COST</th><th>EDIT</th><th>DELETE</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Records Tab -->
            <div id="records" class="tab-content">
                 <div class="mobile-screen">
                     <header class="screen-header">
                        <span class="nav-arrow back-to-home">‚óÄ</span>
                        <h2>TINNY FASHION</h2>
                        <span class="nav-arrow" style="visibility: hidden;">‚ñ∂</span>
                    </header>
                     <h3>RECORD (TRANSACTION)</h3>
                     <div class="filter-controls">
                        <input type="date" id="start-date">
                        <input type="date" id="end-date">
                        <button class="btn btn-blue btn-small" id="filter-btn">FILTER</button>
                     </div>
                     <button class="btn btn-green" id="export-excel-btn">EXPORT TO EXCEL</button>
                     <div class="table-container" style="margin-top: 15px;">
                        <table class="styled-table" id="sales-history-table">
                             <thead><tr><th>DATE</th><th>ITEM</th><th>QTY</th><th>SALE</th><th>RETURN</th></tr></thead>
                             <tbody><tr><td colspan="5" style="text-align:center;">No records found.</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                 <div class="mobile-screen">
                     <header class="screen-header">
                        <span class="nav-arrow back-to-home">‚óÄ</span>
                        <h2>TINNY FASHION</h2>
                        <span class="nav-arrow" style="visibility: hidden;">‚ñ∂</span>
                    </header>
                     <h3>ANALYTICS</h3>
                     <div class="analytics-grid">
                        <div class="metric-card"><p id="filtered-sales-total">SALES: 0</p></div>
                        <div class="metric-card"><p id="total-units">UNITS: 0</p></div>
                        <div class="metric-card"><p id="filtered-profit-total">PROFIT: 0</p></div>
                        <div class="metric-card"><p id="avg-margin">MARGIN: 0</p></div>
                        <div class="metric-card" id="stock-value-card"><p id="total-inventory-cost">STOCK VALUE: 0</p></div>
                     </div>
                     <div class="sales-profit-filter">
                        <h4>Sales & Profit by Date Range</h4>
                        <div class="filter-controls">
                            <input type="date" id="analytics-start-date">
                            <input type="date" id="analytics-end-date">
                            <button class="btn btn-blue btn-small" id="analytics-filter-btn">FILTER</button>
                        </div>
                         <button class="btn btn-green" id="analytics-today-btn">TODAY</button>
                     </div>
                     <div class="top-products">
                         <h3>TOP PRODUCTS LIST</h3>
                         <div class="table-container">
                            <table class="styled-table" id="top-products-table">
                                <thead><tr><th>ITEM</th><th>SOLD QTY</th></tr></thead>
                                <tbody><tr><td colspan="2" style="text-align: center">No sales data.</td></tr></tbody>
                            </table>
                         </div>
                     </div>
                </div>
            </div>

            <!-- Profit Tab -->
            <div id="profit" class="tab-content">
                <div class="mobile-screen">
                     <header class="screen-header">
                        <span class="nav-arrow back-to-home">‚óÄ</span>
                        <h2>TINNY FASHION</h2>
                        <span class="nav-arrow" style="visibility: hidden;">‚ñ∂</span>
                    </header>
                    <h3>PROFIT DATA</h3>
                    <div class="filter-controls">
                        <input type="date" id="profit-start-date">
                        <input type="date" id="profit-end-date">
                        <button id="profit-filter-btn" class="btn btn-blue btn-small">FILTER</button>
                    </div>
                    <button class="btn btn-green" id="profit-export-btn">EXPORT TO EXCEL</button>
                    <div class="table-container" style="margin-top: 15px;">
                        <table class="styled-table" id="profit-details-table">
                            <thead><tr><th>DATE</th><th>ITEM</th><th>QTY</th><th>SALE</th><th>PROFIT</th></tr></thead>
                            <tbody><tr><td colspan="5" style="text-align:center;">No profit data.</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Credit Tab -->
            <div id="credit" class="tab-content">
                <div class="mobile-screen">
                    <header class="screen-header">
                        <span class="nav-arrow back-to-home">‚óÄ</span>
                        <h2>TINNY FASHION</h2>
                        <span class="nav-arrow" style="visibility: hidden;">‚ñ∂</span>
                    </header>
                    <div class="form-section">
                        <h3>CREDIT SALES ENTRY</h3>
                        <form id="credit-inventory-sale-form">
                            <div style="margin-bottom: 10px;">
                                <input type="text" id="credit-inventory-party-name" placeholder="ABC PERSON" required>
                            </div>
                            <div class="form-grid">
                                <input type="text" class="particulars" placeholder="ITEM NAME" list="inventory-datalist" required>
                                <input type="number" class="quantity" placeholder="QTY" min="1" required>
                                <input type="number" class="rate" placeholder="SALE RATE" min="0" step="0.01" required>
                            </div>
                            <button type="button" class="btn btn-orange" id="add-credit-inventory-item-btn">ADD ITEMS</button>
                            <button type="submit" class="btn btn-green">RECORD CREDIT SALES</button>
                        </form>
                    </div>
                     <div class="form-section">
                         <h3>CREDITORS LIST</h3>
                         <div id="creditor-list-container">
                             <!-- Creditors will be dynamically inserted here -->
                         </div>
                     </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="mobile-screen">
                     <header class="screen-header">
                        <span class="nav-arrow back-to-home">‚óÄ</span>
                        <h2>TINNY FASHION</h2>
                        <span class="nav-arrow" style="visibility: hidden;">‚ñ∂</span>
                    </header>
                    <h3>SETTING</h3>
                    <div class="setting-section">
                        <button class="btn btn-blue" id="load-data-btn-proxy">LOAD DATA (EXCEL)</button>
                        <button class="btn btn-green" id="import-data-btn" style="margin-top: 5px;">IMPORT DATA</button>
                        <input type="file" id="excel-file" accept=".xlsx, .xls" style="display: none;">
                        <p>Load your existing inventory from an Excel file. The file must contain 'particulars', 'quantity', and 'rate' columns. This will overwrite your current inventory.</p>
                    </div>
                    <div class="setting-section">
                        <h3>HOLIDAY ENTRY</h3>
                        <div class="filter-controls">
                             <input type="date" id="holiday-date">
                             <button id="add-holiday-btn" class="btn btn-blue btn-small">Add</button>
                        </div>
                        <ul id="holiday-list">
                            <!-- Holidays will be dynamically inserted here -->
                        </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
    // NOTE: This is a significantly modified script to adapt to the new UI structure.
    // The core data logic from the original script is preserved.
    window.onload = () => {
        const { jsPDF } = window.jspdf;

        const app = {
            CLIENT_ID: '460969544827-ip0gvjsjv79m5sibkmgbngmqpl8n5u16.apps.googleusercontent.com',
            API_KEY: 'AIzaSyDYfJX4cryYxGSgPe1319kHf_u6bb071lg', 
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            APP_FOLDER_NAME: 'TinnyFashionStore_Data',
            DATA_FILE_NAME: 'fashion_store_data.json',
            tokenClient: null, driveFileId: null, isSaving: false, saveTimeout: null,
            state: { inventory: [], transactions: [], holidays: [] },
            ui: {},
            
            init() { 
                this.cacheDOMElements();
                gapi.load('client', this.initializeGapiClient.bind(this));
                this.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: this.CLIENT_ID,
                    scope: this.SCOPES,
                    callback: this.handleAuthResponse.bind(this),
                });
                this.ui.signinBtn.addEventListener('click', () => this.tokenClient.requestAccessToken({prompt: 'consent'}));
                this.ui.signoutBtn.addEventListener('click', this.signOut.bind(this));
            },
            async initializeGapiClient() { 
                await gapi.client.init({
                    apiKey: this.API_KEY,
                    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                });
                this.ui.signinBtn.disabled = false;
                this.ui.authStatus.textContent = 'Ready. Please sign in.';
            },
            async handleAuthResponse(response) { 
                if (response.error) {
                    this.showToast(`Error: ${response.error}`, 'error');
                    return;
                }
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').classList.add('visible');
                await this.loadData();
                this.startAppLogic();
            },
            signOut() { 
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token, () => {
                        gapi.client.setToken('');
                        this.driveFileId = null;
                        document.getElementById('login-screen').style.display = 'flex';
                        document.getElementById('app-container').classList.remove('visible');
                        this.showToast('Signed out successfully.');
                    });
                }
            },
            
            startAppLogic() { 
                this.addEventListeners();
                this.renderAll();
            },
            
            async loadData() { 
                this.showToast("Loading data...", "info");
                try {
                    const response = await gapi.client.drive.files.list({ q: `name='${this.DATA_FILE_NAME}' and trashed=false`, spaces: 'drive', fields: 'files(id)' });
                    if (response.result.files && response.result.files.length > 0) {
                        this.driveFileId = response.result.files[0].id;
                        const fileContentResponse = await gapi.client.drive.files.get({ fileId: this.driveFileId, alt: 'media' });
                        const loadedState = JSON.parse(fileContentResponse.body);
                        
                        if (loadedState.transactions) {
                           loadedState.transactions.forEach(t => {
                               t.date = new Date(t.date);
                               if(t.items && !Array.isArray(t.items)) t.items = [t.items]; 
                           });
                        }
                        const defaultState = { inventory: [], transactions: [], holidays: [] };
                        this.state = { ...defaultState, ...loadedState };
                        this.state.holidays = loadedState.holidays || []; 

                        this.showToast("Data loaded.", "success");
                    } else {
                        this.showToast("No data file found. Starting fresh.", "info");
                        this.state = { inventory: [], transactions: [], holidays: [] };
                    }
                } catch (e) {
                    this.showToast("Failed to load data.", "error");
                    this.state = { inventory: [], transactions: [], holidays: [] }; 
                }
            },
            triggerAutoSave() { 
                clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => this.saveData(), 2000);
            },
            async saveData() { 
                if (this.isSaving) return;
                this.isSaving = true;
                this.showToast("Saving...", "info");

                try {
                    const dataToSave = JSON.stringify(this.state, null, 2);
                    const boundary = '-------314159265358979323846';
                    const delimiter = "\r\n--" + boundary + "\r\n";
                    const close_delim = "\r\n--" + boundary + "--";
                    let request;
                    if (this.driveFileId) {
                        const multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify({}) + delimiter + 'Content-Type: application/json\r\n\r\n' + dataToSave + close_delim;
                        request = gapi.client.request({'path': `https://www.googleapis.com/upload/drive/v3/files/${this.driveFileId}`,'method': 'PATCH','params': { 'uploadType': 'multipart' },'headers': {'Content-Type': 'multipart/related; boundary="' + boundary + '"'},'body': multipartRequestBody});
                    } else {
                        // Find or create folder first
                        let res = await gapi.client.drive.files.list({ q: `name='${this.APP_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`, spaces: 'drive', fields: 'files(id)' });
                        let folderId;
                        if (res.result.files && res.result.files.length > 0) {
                            folderId = res.result.files[0].id;
                        } else {
                            let folder = { 'name': this.APP_FOLDER_NAME, 'mimeType': 'application/vnd.google-apps.folder' };
                            res = await gapi.client.drive.files.create({ resource: folder, fields: 'id' });
                            folderId = res.result.id;
                        }
                        
                        const metadata = {'name': this.DATA_FILE_NAME, 'parents': [folderId], 'mimeType': 'application/json'};
                        const multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) + delimiter + 'Content-Type: application/json\r\n\r\n' + dataToSave + close_delim;
                        request = gapi.client.request({'path': 'https://www.googleapis.com/upload/drive/v3/files', 'method': 'POST', 'params': {'uploadType': 'multipart'}, 'headers': {'Content-Type': 'multipart/related; boundary="' + boundary + '"'},'body': multipartRequestBody});
                    }
                    const response = await request;
                    if (!this.driveFileId) { this.driveFileId = response.result.id; }
                    this.showToast("Data saved!", "success");
                } catch (e) { 
                    this.showToast("Failed to save.", "error");
                } finally {
                    this.isSaving = false;
                }
            },
            
            cacheDOMElements() {
                 this.ui = {
                    signinBtn: document.getElementById('signin-btn'),
                    signoutBtn: document.getElementById('signout-btn'),
                    authStatus: document.getElementById('auth-status'),
                    excelFile: document.getElementById('excel-file'),
                    tabButtons: document.querySelectorAll('.tab-button'),
                    tabContents: document.querySelectorAll('.tab-content'),
                    homeButtons: document.querySelectorAll('.home-button'),
                    backToHomeButtons: document.querySelectorAll('.back-to-home'),
                    
                    // Sales
                    salesForm: document.getElementById('sales-form'),
                    addSaleItemBtn: document.getElementById('add-sale-item-btn'),
                    recordSaleBtn: document.getElementById('record-sale-btn'),
                    cosmeticSaleForm: document.getElementById('cosmetic-sale-form'),
                    inventoryDatalist: document.getElementById('inventory-datalist'),

                    // Purchase
                    purchaseForm: document.getElementById('purchase-form'),
                    addPurchaseItemBtn: document.getElementById('add-purchase-item-btn'),
                    
                    // Stocks
                    inventoryTableBody: document.querySelector('#inventory-table tbody'),

                    // Records
                    records: {
                        startDate: document.getElementById('start-date'),
                        endDate: document.getElementById('end-date'),
                        filterBtn: document.getElementById('filter-btn'),
                        exportBtn: document.getElementById('export-excel-btn'),
                        historyTableBody: document.querySelector('#sales-history-table tbody'),
                    },
                    
                    // Analytics
                    analytics: {
                        filteredSales: document.getElementById('filtered-sales-total'),
                        totalUnits: document.getElementById('total-units'),
                        filteredProfit: document.getElementById('filtered-profit-total'),
                        avgMargin: document.getElementById('avg-margin'),
                        inventoryCost: document.getElementById('total-inventory-cost'),
                        startDate: document.getElementById('analytics-start-date'),
                        endDate: document.getElementById('analytics-end-date'),
                        filterBtn: document.getElementById('analytics-filter-btn'),
                        todayBtn: document.getElementById('analytics-today-btn'),
                        topProductsTableBody: document.querySelector('#top-products-table tbody'),
                    },

                    // Profit
                    profit: {
                        startDate: document.getElementById('profit-start-date'),
                        endDate: document.getElementById('profit-end-date'),
                        filterBtn: document.getElementById('profit-filter-btn'),
                        exportBtn: document.getElementById('profit-export-btn'),
                        detailsTableBody: document.querySelector('#profit-details-table tbody'),
                    },

                    // Credit
                    credit: {
                        saleForm: document.getElementById('credit-inventory-sale-form'),
                        addCreditItemBtn: document.getElementById('add-credit-inventory-item-btn'),
                        creditorListContainer: document.getElementById('creditor-list-container'),
                    },

                    // Settings
                    settings: {
                        loadDataBtnProxy: document.getElementById('load-data-btn-proxy'),
                        importDataBtn: document.getElementById('import-data-btn'),
                        holidayDateInput: document.getElementById('holiday-date'),
                        addHolidayBtn: document.getElementById('add-holiday-btn'),
                        holidayList: document.getElementById('holiday-list'),
                    }
                };
            },

            formatDateDDMMYYYY(date) { 
                if (!(date instanceof Date) || isNaN(date)) return 'N/A';
                return new Intl.DateTimeFormat('en-GB', { day: 'numeric', month: 'numeric', year: '2-digit' }).format(date);
            },
            
            renderAll() {
                const activeTabId = document.querySelector('.tab-content.active')?.id;

                this.renderInventoryDatalist();

                if (activeTabId === 'stocks') this.renderInventory();
                if (activeTabId === 'analytics') this.renderAnalytics(); 
                if (activeTabId === 'records') this.renderRecords();
                if (activeTabId === 'profit') this.renderProfit();
                if (activeTabId === 'credit') this.renderCreditorList(); 
                if (activeTabId === 'settings') this.renderHolidays();
            },
            
            renderInventory() { 
                this.state.inventory.sort((a, b) => a.particulars.localeCompare(b.particulars));
                this.ui.inventoryTableBody.innerHTML = this.state.inventory.length
                    ? this.state.inventory.map(item => `
                        <tr data-particulars="${item.particulars}">
                            <td>${item.particulars}</td>
                            <td>${item.quantity}</td>
                            <td>${item.rate.toFixed(2)}</td>
                            <td><span class="action-icon edit" data-particulars="${item.particulars}">‚úì</span></td>
                            <td><span class="action-icon delete" data-particulars="${item.particulars}">‚äó</span></td>
                        </tr>`).join('')
                    : `<tr><td colspan="5" style="text-align:center;">No inventory data.</td></tr>`;
            },
            
            renderInventoryDatalist() {
                 this.ui.inventoryDatalist.innerHTML = this.state.inventory
                    .map(item => `<option value="${item.particulars}"></option>`)
                    .join('');
            },

            renderAnalytics() { 
                const { cost, units } = this.state.inventory.reduce((acc, item) => {
                    acc.cost += item.quantity * item.rate;
                    acc.units += item.quantity;
                    return acc;
                }, { cost: 0, units: 0 });

                this.ui.analytics.inventoryCost.textContent = `STOCK VALUE: ${cost.toFixed(0)}`;
                this.ui.analytics.totalUnits.textContent = `UNITS: ${units}`;
                
                const startDateStr = this.ui.analytics.startDate.value, endDateStr = this.ui.analytics.endDate.value;
                const startDate = startDateStr ? new Date(startDateStr) : null; if(startDate) startDate.setHours(0, 0, 0, 0);
                const endDate = endDateStr ? new Date(endDateStr) : null; if(endDate) endDate.setHours(23, 59, 59, 999);
                
                const sales = this.state.transactions.filter(t => t.type === 'Sale' && (!startDate || t.date >= startDate) && (!endDate || t.date <= endDate));
                
                const totalSales = sales.reduce((sum, t) => sum + t.total, 0);
                const totalProfit = sales.flatMap(t => t.items).reduce((sum, i) => sum + (i.sellingRate - i.costRate) * i.quantity, 0);
                const avgMargin = totalSales > 0 ? ((totalProfit / totalSales) * 100) : 0;
                
                this.ui.analytics.filteredSales.textContent = `SALES: ${totalSales.toFixed(0)}`;
                this.ui.analytics.filteredProfit.textContent = `PROFIT: ${totalProfit.toFixed(0)}`;
                this.ui.analytics.avgMargin.textContent = `MARGIN: ${avgMargin.toFixed(0)}`;

                // Top Products
                const productSales = sales.flatMap(t => t.items).reduce((acc, item) => {
                    const cleanName = item.particulars.replace('(Cosmetic) ', '');
                    acc[cleanName] = (acc[cleanName] || 0) + item.quantity;
                    return acc;
                }, {});

                const topProducts = Object.entries(productSales).sort(([,a],[,b]) => b - a).slice(0, 5);

                this.ui.analytics.topProductsTableBody.innerHTML = topProducts.length > 0 
                    ? topProducts.map(([name, qty]) => `<tr><td>${name}</td><td>${qty}</td></tr>`).join('')
                    : `<tr><td colspan="2" style="text-align:center;">No sales data.</td></tr>`;
            },
            
            renderRecords() {
                const startDateStr = this.ui.records.startDate.value, endDateStr = this.ui.records.endDate.value;
                const startDate = startDateStr ? new Date(startDateStr) : null; if(startDate) startDate.setHours(0,0,0,0);
                const endDate = endDateStr ? new Date(endDateStr) : null; if(endDate) endDate.setHours(23,59,59,999);
                
                const sales = this.state.transactions
                    .filter(t => t.type === 'Sale' && (!startDate || t.date >= startDate) && (!endDate || t.date <= endDate))
                    .sort((a,b) => b.date - a.date)
                    .flatMap(t => t.items.map(item => ({...item, date: t.date, transactionId: t.id})));
                    
                this.ui.records.historyTableBody.innerHTML = sales.length 
                    ? sales.map(s => `<tr>
                        <td>${this.formatDateDDMMYYYY(s.date)}</td>
                        <td>${s.particulars.replace('(Cosmetic) ', '')}</td>
                        <td>${s.quantity}</td>
                        <td>${(s.sellingRate * s.quantity).toFixed(0)}</td>
                        <td><span class="action-icon edit return-item-btn" data-transaction-id="${s.transactionId}" data-item-particulars="${s.particulars}">‚§µ</span></td>
                    </tr>`).join('') 
                    : `<tr><td colspan="5" style="text-align:center;">No sales match criteria.</td></tr>`;
            },
            
            renderProfit() { 
                const startDateStr = this.ui.profit.startDate.value, endDateStr = this.ui.profit.endDate.value;
                const startDate = startDateStr ? new Date(startDateStr) : null; if(startDate) startDate.setHours(0,0,0,0);
                const endDate = endDateStr ? new Date(endDateStr) : null; if(endDate) endDate.setHours(23,59,59,999);

                const allItemsSold = this.state.transactions
                    .filter(t => t.type === 'Sale' && (!startDate || t.date >= startDate) && (!endDate || t.date <= endDate))
                    .flatMap(t => t.items.map(item => ({ ...item, date: t.date })));
                
                if (!allItemsSold.length) { this.ui.profit.detailsTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No sales data.</td></tr>`; return; }
                
                allItemsSold.sort((a,b) => b.date - a.date);

                this.ui.profit.detailsTableBody.innerHTML = allItemsSold.map(item => `
                    <tr>
                        <td>${this.formatDateDDMMYYYY(item.date)}</td>
                        <td>${item.particulars.replace('(Cosmetic) ', '')}</td>
                        <td>${item.quantity}</td>
                        <td>${(item.sellingRate * item.quantity).toFixed(0)}</td>
                        <td>${((item.sellingRate - item.costRate) * item.quantity).toFixed(0)}</td>
                    </tr>`).join('');
            },

             renderCreditorList() { 
                const creditors = this.state.transactions.filter(t => t.saleType === 'Credit').reduce((acc, t) => { if (!t.partyName) return acc; if (!acc[t.partyName]) acc[t.partyName] = { balance: 0, transactions: [] }; acc[t.partyName].balance += t.total - (t.paidAmount || 0); acc[t.partyName].transactions.push(t); return acc; }, {});
                
                const creditorsWithBalance = Object.entries(creditors).filter(([_, data]) => data.balance > 0.01);
                
                if (creditorsWithBalance.length === 0) {
                     this.ui.credit.creditorListContainer.innerHTML = '<p style="text-align:center;">No outstanding credit.</p>'; return;
                }
                
                this.ui.credit.creditorListContainer.innerHTML = `
                    <div class="table-container">
                    <table class="styled-table">
                        <thead><tr><th>DATE</th><th>ITEM</th><th>QTY</th><th>SALE</th><th>BALANCE</th><th></th></tr></thead>
                        <tbody>
                        ${creditorsWithBalance.map(([name, data]) => {
                            const firstTx = data.transactions.find(tx => tx.total - (tx.paidAmount || 0) > 0.01);
                            if(!firstTx) return '';
                            return `<tr>
                                <td>${this.formatDateDDMMYYYY(firstTx.date)}</td>
                                <td>${firstTx.items[0].particulars.replace('(Cosmetic) ','')}</td>
                                <td>${firstTx.items[0].quantity}</td>
                                <td>${firstTx.items[0].sellingRate.toFixed(0)}</td>
                                <td>${data.balance.toFixed(0)}</td>
                                <td><button class="btn btn-blue btn-small pay-btn" data-creditor-name="${name}">PAY</button></td>
                            </tr>`;
                        }).join('')}
                        </tbody>
                    </table></div>`;
            },
            
            renderHolidays() {
                const holidayListEl = this.ui.settings.holidayList; holidayListEl.innerHTML = ''; 
                if (this.state.holidays.length === 0) { holidayListEl.innerHTML = '<li>No holidays marked.</li>'; return; }
                
                [...this.state.holidays].sort().forEach(holidayDateStr => { 
                    const formattedDate = new Date(holidayDateStr + 'T00:00:00').toLocaleDateString('en-GB');
                    holidayListEl.insertAdjacentHTML('beforeend', 
                        `<li><span>‚Ä¢${formattedDate}</span><span class="delete-holiday-icon" data-date="${holidayDateStr}">‚äó</span></li>`); 
                });
            },

            // CORE LOGIC METHODS
            handleFileUpload(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' }); const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]); this.state.inventory = json.map(row => ({ particulars: String(row.particulars || "N/A"), quantity: parseInt(row.quantity, 10) || 0, rate: parseFloat(row.rate) || 0.0 })).filter(item => item.particulars !== "N/A"); this.renderAll(); this.triggerAutoSave(); this.showToast('Inventory loaded!', 'success'); } catch (error) { this.showToast('Error reading file. Check columns.', 'error'); } }; reader.readAsArrayBuffer(file); event.target.value = ''; },
            
            handleSalesReturn(transactionId, itemParticulars) {
                 if (!confirm(`Return "${itemParticulars}" from this sale?`)) return;
                 const transaction = this.state.transactions.find(t => t.id === transactionId);
                 if (!transaction) return;
                 const itemIndex = transaction.items.findIndex(i => i.particulars === itemParticulars);
                 if (itemIndex === -1) return;
                 
                 const [returnedItem] = transaction.items.splice(itemIndex, 1);
                 if (!returnedItem.particulars.startsWith('(Cosmetic)')) {
                     const inventoryItem = this.state.inventory.find(i => i.particulars === returnedItem.particulars);
                     if (inventoryItem) inventoryItem.quantity += returnedItem.quantity;
                     else this.state.inventory.push({ particulars: returnedItem.particulars, quantity: returnedItem.quantity, rate: returnedItem.costRate });
                 }

                 transaction.total -= returnedItem.quantity * returnedItem.sellingRate;
                 if (transaction.items.length === 0) {
                     this.state.transactions = this.state.transactions.filter(t => t.id !== transactionId);
                 }
                 this.showToast('Item returned.', 'success');
                 this.renderAll();
                 this.triggerAutoSave();
            },
            
            processSale(form, isCredit) {
                const partyName = isCredit ? form.querySelector('#credit-inventory-party-name').value.trim() : null;
                if (isCredit && !partyName) { this.showToast("Party Name is required.", "error"); return; }
                
                const saleItems = [], errors = [];
                let total = 0;
                
                const p = form.querySelector('.particulars').value.trim();
                const q = parseInt(form.querySelector('.quantity').value, 10);
                const r = parseFloat(form.querySelector('.rate').value);
                
                if(!p || !q || isNaN(r)) { this.showToast("All fields are required.", "error"); return; }

                const itemInStock = this.state.inventory.find(i => i.particulars === p);
                if (!itemInStock) { this.showToast(`Item not found: ${p}`, "error"); return; }
                if (itemInStock.quantity < q) { this.showToast(`Not enough stock for ${p}.`, "error"); return; }

                saleItems.push({ particulars: p, quantity: q, sellingRate: r, costRate: itemInStock.rate });
                total += r * q;
                itemInStock.quantity -= q;

                const newTransaction = { id: Date.now(), type: 'Sale', saleType: isCredit ? 'Credit' : 'Cash', partyName, date: new Date(), items: saleItems, total, paidAmount: 0 };
                this.state.transactions.push(newTransaction);
                
                this.renderAll();
                this.triggerAutoSave();
                form.reset();
                this.showToast((isCredit ? 'Credit sale' : 'Sale') + ' recorded!', "success");
            },

            addEventListeners() { 
                this.ui.excelFile.addEventListener('change', (e) => this.handleFileUpload(e));

                // Navigation
                this.ui.homeButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const targetTabId = button.dataset.targetTab;
                        this.ui.tabButtons.forEach(btn => btn.classList.remove('active'));
                        document.querySelector(`.tab-button[data-tab="${targetTabId}"]`).classList.add('active');
                        this.ui.tabContents.forEach(content => content.classList.remove('active'));
                        document.getElementById(targetTabId).classList.add('active');
                        this.renderAll();
                    });
                });
                this.ui.backToHomeButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        document.querySelector('.home-button[data-target-tab="home"]').click();
                    });
                });

                // Forms
                this.ui.recordSaleBtn.addEventListener('click', () => this.processSale(this.ui.salesForm, false));
                this.ui.purchaseForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const p = e.target.querySelector('.particulars').value.trim();
                    const q = parseInt(e.target.querySelector('.quantity').value, 10);
                    const r = parseFloat(e.target.querySelector('.rate').value);
                    if(!p || !q || isNaN(r)) { this.showToast("All fields required.", "error"); return; }

                    const existing = this.state.inventory.find(i => i.particulars.toLowerCase() === p.toLowerCase());
                    if (existing) {
                        const totalVal = existing.rate * existing.quantity + r * q;
                        const totalQty = existing.quantity + q;
                        existing.rate = totalVal / totalQty;
                        existing.quantity = totalQty;
                    } else this.state.inventory.push({ particulars: p, quantity: q, rate: r });

                    this.state.transactions.push({ id: Date.now(), type: 'Purchase', date: new Date(), items: [{particulars:p, quantity:q, rate:r}], total: q*r });
                    this.renderAll();
                    this.triggerAutoSave();
                    e.target.reset();
                    this.showToast('Stock updated!', "success");
                });
                this.ui.credit.saleForm.addEventListener('submit', (e) => { e.preventDefault(); this.processSale(e.target, true); });

                // Stocks Table Actions
                this.ui.inventoryTableBody.addEventListener('click', (e) => {
                    const particulars = e.target.dataset.particulars;
                    if (e.target.classList.contains('delete')) {
                        if (confirm(`Delete "${particulars}"?`)) {
                            this.state.inventory = this.state.inventory.filter(item => item.particulars !== particulars);
                            this.renderAll(); this.triggerAutoSave(); this.showToast('Item deleted.', 'success');
                        }
                    } else if (e.target.classList.contains('edit')) {
                        const item = this.state.inventory.find(i => i.particulars === particulars);
                        if(!item) return;
                        const newQty = prompt("Enter new quantity:", item.quantity);
                        const newCost = prompt("Enter new cost rate:", item.rate);
                        if (newQty !== null && newCost !== null) {
                            item.quantity = parseInt(newQty, 10) || item.quantity;
                            item.rate = parseFloat(newCost) || item.rate;
                            this.renderAll(); this.triggerAutoSave(); this.showToast('Item updated.', 'success');
                        }
                    }
                });

                // Records Actions
                this.ui.records.filterBtn.addEventListener('click', () => this.renderRecords());
                this.ui.records.historyTableBody.addEventListener('click', e => {
                    if (e.target.classList.contains('return-item-btn')) {
                        this.handleSalesReturn(parseInt(e.target.dataset.transactionId, 10), e.target.dataset.itemParticulars);
                    }
                });

                // Analytics Actions
                this.ui.analytics.filterBtn.addEventListener('click', () => this.renderAnalytics());
                this.ui.analytics.todayBtn.addEventListener('click', () => {
                    const today = new Date().toISOString().slice(0, 10);
                    this.ui.analytics.startDate.value = today;
                    this.ui.analytics.endDate.value = today;
                    this.renderAnalytics();
                });
                
                // Profit Actions
                this.ui.profit.filterBtn.addEventListener('click', () => this.renderProfit());

                // Settings
                this.ui.settings.loadDataBtnProxy.addEventListener('click', () => this.ui.excelFile.click());
                this.ui.settings.importDataBtn.addEventListener('click', () => this.ui.excelFile.click());
                this.ui.settings.addHolidayBtn.addEventListener('click', () => { 
                    const holidayDateStr = this.ui.settings.holidayDateInput.value; 
                    if (!holidayDateStr) { this.showToast("Select a date.", "error"); return; } 
                    if (this.state.holidays.includes(holidayDateStr)) { this.showToast("Date is already a holiday.", "info"); return; } 
                    this.state.holidays.push(holidayDateStr); 
                    this.renderHolidays(); this.triggerAutoSave(); this.showToast("Holiday added!", "success"); this.ui.settings.holidayDateInput.value = ''; 
                });
                this.ui.settings.holidayList.addEventListener('click', (e) => { 
                    if (e.target.classList.contains('delete-holiday-icon')) { 
                        this.state.holidays = this.state.holidays.filter(d => d !== e.target.dataset.date); 
                        this.renderHolidays(); this.triggerAutoSave(); this.showToast("Holiday removed.", "success"); 
                    } 
                });

                 // Credit pay button
                this.ui.credit.creditorListContainer.addEventListener('click', e => {
                    if (e.target.classList.contains('pay-btn')) {
                        const name = e.target.dataset.creditorName;
                        const payment = parseFloat(prompt(`Enter payment amount for ${name}:`));
                        if (!isNaN(payment) && payment > 0) {
                            let remainingPayment = payment;
                            const creditorTransactions = this.state.transactions.filter(t => t.partyName === name && t.saleType === 'Credit' && (t.total - (t.paidAmount || 0)) > 0.01).sort((a,b) => a.date - b.date);
                            for (const tx of creditorTransactions) {
                                if (remainingPayment <= 0) break;
                                const due = tx.total - (tx.paidAmount || 0);
                                const payForThis = Math.min(remainingPayment, due);
                                tx.paidAmount = (tx.paidAmount || 0) + payForThis;
                                remainingPayment -= payForThis;
                            }
                            this.showToast(`Payment of ${payment.toFixed(2)} recorded.`, "success");
                            this.renderCreditorList();
                            this.triggerAutoSave();
                        }
                    }
                });
            },
            showToast(msg, type='success') { const toast = document.getElementById('toast'); toast.textContent = msg; toast.className = `show ${type}`; setTimeout(() => toast.className = toast.className.replace('show',''), 3000); },
        };
        app.init();
    };
    </script>
</body>
</html>
