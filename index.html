<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tinny Fashion Store - AI Business Manager</title>
   <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3crect width='100' height='100' rx='15' fill='%236B46C1'/%3e%3cpath fill='white' d='M20 30h60l-10 50H30zM50 20c-8 0-15 7-15 15v5h30v-5c0-8-7-15-15-15zM30 40c0 5 5 10 10 10h20c5 0 10-5 10-10'/%3e%3c/svg%3e">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>


    <style>
        :root {
            --background-body: #F0F2F5;
            --surface-dark: #1A202C;
            --surface-dark-alt: #2D3748;
            
            --text-on-dark-primary: #E2E8F0;
            --text-on-dark-secondary: #A0AEC0;
            --text-on-dark-placeholder: #718096;

            --text-primary-on-light: #2D3748;
            --text-secondary-on-light: #4A5568;

            --accent-teal: #00A99D;
            --accent-teal-darker: #007A70;
            --accent-yellow: #F59E0B; /* Used for warnings, highlights */
            --accent-pink: #EC4899; /* For some dashboard trends or highlights */
            --accent-prediction: #3B82F6; /* Blue for predictions */
            
            --success-green: #38A169;
            --danger-red: #E53E3E;
            --info-blue: #3182CE;

            --border-dark-primary: #4A5568;
            --border-dark-focus: var(--accent-teal);

            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 14px;

            --shadow-subtle: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03);
            --shadow-medium: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
            --shadow-strong: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
        }

        * { box-sizing: border-box; }
        html { height: 100%; scroll-behavior: smooth; }
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background-color: var(--background-body);
            color: var(--text-primary-on-light);
            margin: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; width: 100%; text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--accent-teal) 0%, var(--accent-yellow) 100%); }
        .login-box { background: var(--surface-dark-alt); color: var(--text-on-dark-primary); padding: 2.5rem 3rem; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-strong); max-width: 480px; width: 100%; }
        .login-box .store-logo { font-size: 2.5rem; font-weight: 700; color: var(--accent-yellow); margin-bottom: 0.5rem; }
        .login-box .store-logo span { display: inline-block; padding: 0.1em 0.4em; background-color: var(--accent-yellow); color: var(--surface-dark); border-radius: var(--border-radius-sm); margin-right: 0.1em; }
        .login-box h1 { color: var(--text-on-dark-primary); margin-bottom: 0.5rem; font-size: 1.8rem; font-weight: 700; }
        .login-box p { color: var(--text-on-dark-secondary); margin-bottom: 1.5rem; font-size: 0.95rem; }
        #signin-btn { background-color: #4285F4; color: white; border: none; padding: 14px 28px; font-size: 1rem; font-weight: 500; border-radius: var(--border-radius-md); cursor: pointer; display: inline-flex; align-items: center; gap: 1rem; transition: background-color 0.3s, box-shadow 0.3s; box-shadow: var(--shadow-subtle); }
        #signin-btn:hover:not([disabled]) { background-color: #357ae8; box-shadow: var(--shadow-medium); }
        #signin-btn[disabled] { background-color: #718096; color: var(--text-on-dark-secondary); cursor: not-allowed; }
        #signin-btn svg { width: 24px; height: 24px; background: white; border-radius: 50%; padding: 2px; }
        #auth-status { margin-top: 1.5rem; font-size: 0.9rem; }

        #app-container { display: none; padding: 25px; }
        #app-container.visible { display: block; }

        header { background-color: var(--surface-dark); color: var(--text-on-dark-primary); padding: 15px 25px; border-radius: var(--border-radius-lg); margin-bottom: 35px; box-shadow: var(--shadow-medium); display: flex; justify-content: space-between; align-items: center; }
        header .header-title-group h1 { margin: 0; font-weight: 700; font-size: 1.6rem; color: var(--accent-yellow); }
        .user-profile { display: flex; align-items: center; gap: 12px; }
        .user-profile span { font-weight: 500; font-size: 0.9rem; color: var(--text-on-dark-primary); }
        #signout-btn { font-size: 0.85rem; color: var(--accent-yellow); cursor: pointer; background: transparent; border: 1px solid var(--accent-yellow); border-radius: var(--border-radius-md); padding: 7px 12px; font-weight: 500; transition: background-color 0.2s, color 0.2s; }
        #signout-btn:hover { background-color: var(--accent-yellow); color: var(--surface-dark); }
        .low-stock-alert { display: none; }

        .tab-nav { display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 30px; background-color: var(--surface-dark-alt); padding: 5px; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-subtle); }
        .tab-button { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 0.95rem; font-weight: 500; color: var(--text-on-dark-secondary); border-radius: var(--border-radius-md); transition: color 0.3s ease, background-color 0.2s ease; margin: 0 3px; }
        .tab-button:hover { color: var(--text-on-dark-primary); background-color: rgba(255,255,255,0.05); }
        .tab-button.active { color: var(--surface-dark); background-color: var(--accent-teal); font-weight: 600; box-shadow: var(--shadow-medium); }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeInContent 0.4s ease-out; }
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        main { max-width: 1200px; margin: 0 auto; }
        .main-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .operations-layout, .credit-layout { display: grid; grid-template-columns: 1fr; gap: 30px; }
        .action-forms-section { margin-top: 30px; } 

        .card { background-color: var(--surface-dark); color: var(--text-on-dark-primary); border-radius: var(--border-radius-lg); padding: 25px 30px; box-shadow: var(--shadow-medium); margin-bottom: 30px; }
        .card h2 { color: var(--accent-teal); font-weight: 600; font-size: 1.25rem; margin-top: 0; border-bottom: 1px solid var(--border-dark-primary); padding-bottom: 15px; margin-bottom: 25px; }
        .card .form-grid, .card form .item-entry { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .card .cosmetic-form-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .card .cosmetic-credit-form-grid { display: grid; grid-template-columns: 1.5fr 1fr 2fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .card .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        .card input[type="text"], .card input[type="number"], .card input[type="file"], .card input[type="date"], .card select { width: 100%; padding: 12px 15px; border: 1px solid var(--border-dark-primary); border-radius: var(--border-radius-md); font-size: 0.95rem; font-family: 'Roboto', sans-serif; background-color: var(--surface-dark-alt); color: var(--text-on-dark-primary); transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .card input[type="text"]:focus, .card input[type="number"]:focus, .card input[type="date"]:focus, .card select:focus { border-color: var(--border-dark-focus); box-shadow: 0 0 0 3px rgba(0, 169, 157, 0.25); outline: none; }
        .card input[type="file"] { background-color: var(--surface-dark-alt); border-color: var(--accent-teal); color: var(--accent-teal); cursor: pointer; }
        .card input::placeholder { color: var(--text-on-dark-placeholder); opacity: 1; }
        #settings .card input[type="file"] { margin-top: 15px; }
        .card .controls-grid label, .card .form-row label, #holiday-management-section label { display: block; font-size: 0.9rem; color: var(--text-on-dark-secondary); margin-bottom: 6px; font-weight: 500; }
        
        #add-sale-item-btn, #add-purchase-item-btn, #add-credit-inventory-item-btn { background-color: transparent; color: var(--accent-teal); border: 2px dashed var(--accent-teal); font-weight: 500; text-transform: none; padding: 10px 15px; margin-top: 10px; margin-bottom: 20px; width: 100%; border-radius: var(--border-radius-md); transition: background-color 0.2s, color 0.2s; }
        #add-sale-item-btn:hover, #add-purchase-item-btn:hover, #add-credit-inventory-item-btn:hover { background-color: rgba(0, 169, 157, 0.1); }

        .btn { width: 100%; padding: 12px 20px; border-radius: var(--border-radius-md); border: none; font-size: 0.95rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease; box-shadow: var(--shadow-subtle); }
        .btn:hover:not([disabled]) { box-shadow: var(--shadow-medium); transform: translateY(-1px); }
        .btn:active:not([disabled]) { box-shadow: var(--shadow-subtle); transform: translateY(0px); }
        .btn[disabled] { background-color: var(--text-on-dark-placeholder); color: var(--surface-dark-alt); cursor: not-allowed; opacity: 0.8; box-shadow: none; }
        .btn-primary { background-color: var(--accent-teal); color: var(--surface-dark); }
        .btn-primary:hover:not([disabled]) { background-color: var(--accent-teal-darker); }
        .btn-secondary { background-color: var(--surface-dark-alt); color: var(--text-on-dark-primary); border: 1px solid var(--border-dark-primary); }
        .btn-secondary:hover:not([disabled]) { background-color: #4A5568; }
        .btn-success { background-color: var(--success-green); color: white; }
        .btn-success:hover:not([disabled]) { background-color: #2F855A; }
        .btn-danger { background-color: var(--danger-red); color: white; }
        .btn-danger:hover:not([disabled]) { background-color: #C53030; }
        .btn-small { padding: 8px 14px; font-size: 0.8rem; letter-spacing: 0.2px; width: auto;}
        .sales-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }

        .table-container { max-height: 450px; overflow-y: auto; border: 1px solid var(--border-dark-primary); border-radius: var(--border-radius-md); margin-top: 20px; background-color: var(--surface-dark); }
        .styled-table { width: 100%; border-collapse: collapse; }
        .styled-table th, .styled-table td { border-bottom: 1px solid var(--border-dark-primary); padding: 14px 16px; text-align: left; font-size: 0.9rem; vertical-align: middle; color: var(--text-on-dark-secondary); }
        .styled-table th { background-color: var(--surface-dark-alt); color: var(--accent-teal); font-weight: 600; position: sticky; top: 0; text-transform: capitalize; z-index: 1; }
        .styled-table tr:hover td { background-color: var(--surface-dark-alt); color: var(--text-on-dark-primary); }
        .styled-table td ul { margin: 0; padding-left: 18px; list-style-type: disc; }
        .styled-table td li { padding: 3px 0; }
        .profit-col { font-weight: 600; color: var(--success-green); }
        .credit-label { font-size: 0.75rem; font-weight: 600; color: var(--surface-dark); background-color: var(--info-blue); padding: 3px 8px; border-radius: var(--border-radius-sm); display: inline-block; margin-top: 6px; }
        .sales-history-actions { display: flex; gap: 8px; }
        tr.is-low-stock td { background-color: rgba(245, 158, 11, 0.1) !important; border-left: 3px solid var(--accent-yellow); color: var(--accent-yellow) !important; }
        .low-stock-badge { display: inline-block; margin-left: 8px; padding: 3px 7px; font-size: 0.7rem; font-weight: 600; color: var(--surface-dark); background-color: var(--accent-yellow); border-radius: 10px; text-transform: uppercase; vertical-align: middle; }
        .inventory-actions { display: flex; gap: 6px; }
        .edit-input { padding: 6px 8px; font-size: 0.9rem; max-width: 90px; }
        tr.edit-mode .display-value { display: none; }
        tr:not(.edit-mode) .edit-field { display: none; }
        tr.edit-mode .edit-btn, tr.edit-mode .delete-btn { display: none; }
        tr:not(.edit-mode) .save-btn, tr:not(.edit-mode) .cancel-btn { display: none; }

        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .metric-card { text-align: left; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .metric-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-strong); }
        .metric-card h3 { margin: 0 0 12px; color: var(--text-on-dark-secondary); font-size: 0.85rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-card p { font-size: 2rem; margin: 0; color: var(--accent-yellow); font-weight: 700; }
        .metric-card #total-profit, .metric-card #total-revenue { color: var(--accent-teal);}
        
        #low-stock-items { background-color: var(--surface-dark-alt); padding-bottom: 15px; }
        #low-stock-items.metric-card h3 { color: var(--accent-yellow); } 
        .categorized-low-stock-container .low-stock-category-group { margin-bottom: 15px; }
        .categorized-low-stock-container .low-stock-category-group:last-child { margin-bottom: 0; }
        .low-stock-category-title { color: var(--accent-teal); font-size: 1rem; font-weight: 600; margin-top: 15px; margin-bottom: 8px; padding: 8px 5px; border-bottom: 1px solid var(--border-dark-primary); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
        .low-stock-category-title:hover { background-color: rgba(0, 169, 157, 0.1); }
        .low-stock-category-title.expanded .category-toggle-indicator { transform: rotate(90deg); }
        .categorized-low-stock-container .low-stock-category-group:first-child .low-stock-category-title { margin-top: 0; }
        .low-stock-items-in-category { list-style-type: none; padding-left: 15px; margin-top: 5px; background-color: var(--surface-dark); border-radius: 0 0 var(--border-radius-sm) var(--border-radius-sm); }
        .low-stock-items-in-category li { padding: 10px 5px; border-bottom: 1px dashed var(--border-dark-primary); font-size: 0.9rem; color: var(--text-on-dark-secondary); }
        .low-stock-items-in-category li:last-child { border-bottom: none; }
        .low-stock-items-in-category li .low-stock-qty { color: var(--accent-yellow); font-weight: 600; }
        #low-stock-items p[style*="text-align:center"] { font-size: 0.95rem; color: var(--text-on-dark-secondary); text-align: center; padding: 20px 0; }

        #toast { position: fixed; bottom: -120px; right: 25px; padding: 14px 25px; border-radius: var(--border-radius-md); color: var(--surface-dark); font-weight: 600; font-size: 0.95rem; box-shadow: var(--shadow-strong); transition: bottom 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.4s ease; z-index: 9999; opacity: 0; }
        #toast.show { bottom: 25px; opacity: 1; }
        #toast.success { background-color: var(--success-green); color: white; }
        #toast.error { background-color: var(--danger-red); color: white; }
        #toast.info { background-color: var(--info-blue); color: white; }

        /* ANALYTICS CHART & AI PREDICTION STYLES */
        .performance-chart-container.card { min-height: 450px; display: flex; flex-direction: column; }
        .performance-chart-container.card h2 { font-size: 1.1rem; border: none; padding: 0; margin: 0 0 20px 0;}
        .chart-controls-wrapper { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-dark-primary); }
        
        .period-selector { display: flex; gap: 5px; background-color: var(--surface-dark-alt); border-radius: var(--border-radius-md); padding: 5px; }
        .period-selector .period-btn { background-color: transparent; border: none; color: var(--text-on-dark-secondary); padding: 8px 16px; border-radius: var(--border-radius-sm); font-weight: 500; cursor: pointer; transition: all 0.2s ease-in-out; }
        .period-selector .period-btn.active { background-color: var(--accent-teal); color: var(--surface-dark); box-shadow: var(--shadow-medium); }
        
        .prediction-controls { display: flex; align-items: center; gap: 15px; }
        .prediction-controls label { font-size: 0.9rem; color: var(--text-on-dark-secondary); font-weight: 500; }
        
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--surface-dark-alt); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-prediction); }
        input:checked + .slider:before { transform: translateX(20px); }

        .prediction-horizon-selector { padding: 6px 10px; font-size: 0.9rem; background-color: var(--surface-dark-alt); color: var(--text-on-dark-primary); border: 1px solid var(--border-dark-primary); border-radius: var(--border-radius-sm); }
        .prediction-status { display: flex; align-items: center; gap: 12px; }
        .confidence-display { font-size: 0.9rem; font-weight: 500; color: var(--text-on-dark-secondary); }
        .confidence-display span { font-weight: 700; color: var(--accent-prediction); font-size: 1rem; }
        .trend-indicator { font-size: 1.2rem; font-weight: bold; }
        .trend-indicator.up { color: var(--success-green); }
        .trend-indicator.down { color: var(--danger-red); }

        .chart-main-area { flex-grow: 1; position: relative; min-height: 300px; padding-bottom: 15px; }
        .quick-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-top: 15px; border-top: 1px solid var(--border-dark-primary); font-size: 0.9rem; }
        .quick-stats-grid span { color: var(--text-on-dark-secondary); }
        .quick-stats-grid strong { color: var(--accent-teal); }
        .quick-stats-grid #predicted-total { color: var(--accent-prediction); }


        @media (max-width: 900px) {
             .chart-controls-wrapper { flex-direction: column; align-items: stretch; }
        }
        @media (max-width: 800px) {
            .main-columns, .card .cosmetic-form-grid, .card .cosmetic-credit-form-grid { grid-template-columns: 1fr; }
            header { flex-direction: column; align-items: center; text-align: center; gap: 10px; }
            .analytics-grid, .sales-actions, .card .form-row { grid-template-columns: 1fr; }
            .tab-nav { padding: 5px 0; }
            .tab-button { padding: 10px 12px; font-size: 0.9rem; margin: 2px; }
            .card .form-grid, .card .cosmetic-credit-form-grid { grid-template-columns: 1fr; }
            .card .controls-grid { grid-template-columns: 1fr; }
            .controls-grid .btn { margin-top: 10px; }
            header .header-title-group h1 { font-size: 1.4rem; }
            .card h2 { font-size: 1.15rem; }
            .prediction-controls { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-box">
            <div class="store-logo"><span>T</span>inny Fashion</div>
            <h1>Welcome Back!</h1>
            <p>Manage your fashion store with ease and AI-powered insights.</p>
            <p style="color: var(--text-on-dark-secondary); margin-bottom: 2rem; font-size: 0.9rem;">Sign in with Google to access your dashboard.</p>
            <button id="signin-btn" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 35.841 44 30.138 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                Sign in with Google
            </button>
            <p id="auth-status" style="margin-top: 1.5rem; font-size: 0.9rem;">Initializing...</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container">
        <header>
            <div class="header-title-group">
                <h1>Tinny Fashion Store</h1>
            </div>
            <div id="user-profile-container" class="user-profile" style="display: none;">
                <div>
                    <span id="user-name"></span>
                    <button id="signout-btn">Sign Out</button>
                </div>
            </div>
        </header>

        <nav class="tab-nav">
            <button class="tab-button" data-tab="operations">Operations</button>
            <button class="tab-button" data-tab="credit">Credit</button>
            <button class="tab-button active" data-tab="analytics">Analytics</button>
            <button class="tab-button" data-tab="profit">Profit</button>
            <button class="tab-button" data-tab="transactions">Transactions</button>
            <button class="tab-button" data-tab="settings">Settings</button>
        </nav>

        <main>
            <!-- Operations Tab -->
            <div id="operations" class="tab-content">
                <div class="main-columns action-forms-section">
                    <section class="card">
                        <h2>Make a Sale (From Inventory)</h2>
                        <form id="sales-form">
                            <div id="sales-items-container"></div>
                            <datalist id="inventory-datalist"></datalist>
                            <button type="button" id="add-sale-item-btn" class="btn">+ Add Item</button>
                            <div class="sales-actions">
                                <button type="button" id="record-sale-btn" class="btn btn-secondary">Record Sale</button>
                                <button type="button" id="record-invoice-btn" class="btn btn-primary">Record & Print</button>
                            </div>
                        </form>
                    </section>
                    <section class="card">
                        <h2>Add New Stock (Purchase)</h2>
                        <form id="purchase-form">
                            <div id="purchase-items-container"></div>
                            <button type="button" id="add-purchase-item-btn" class="btn">+ Add Item</button>
                            <button type="submit" class="btn btn-primary">Add to Stock</button>
                        </form>
                    </section>
                </div>
            </div>

            <!-- Credit Tab -->
            <div id="credit" class="tab-content">
                <!-- Credit content remains the same, omitted for brevity -->
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content active">
                <section class="performance-chart-container card">
                    <div class="chart-controls-wrapper">
                        <div class="period-selector" id="chart-period-selector">
                            <button class="period-btn active" data-period="7d">7D</button>
                            <button class="period-btn" data-period="1m">1M</button>
                            <!-- <button class="period-btn" data-period="custom">Custom</button> -->
                        </div>
                        <div class="prediction-controls">
                            <label for="prediction-toggle">AI Prediction</label>
                            <label class="switch">
                                <input type="checkbox" id="prediction-toggle">
                                <span class="slider"></span>
                            </label>
                            <select id="prediction-horizon-selector" class="prediction-horizon-selector" disabled>
                                <option value="3">3 Day Forecast</option>
                                <option value="7" selected>7 Day Forecast</option>
                                <option value="14">14 Day Forecast</option>
                            </select>
                            <div id="prediction-status-display" class="prediction-status" style="display: none;">
                                <div class="confidence-display">Conf: <span id="confidence-score">-%</span></div>
                                <div id="trend-indicator" class="trend-indicator"></div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-main-area">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                    <div class="quick-stats-grid">
                        <div><span>Actual Total:</span> <strong id="actual-total">₹0.00</strong></div>
                        <div><span>Predicted Total:</span> <strong id="predicted-total">₹0.00</strong></div>
                    </div>
                </section>
                <section class="card">
                    <h2>Shop Performance At a Glance</h2>
                    <div class="analytics-grid">
                        <div class="metric-card"><h3>Total Profit</h3><p id="total-profit">₹0.00</p></div>
                        <div class="metric-card"><h3>Total Revenue</h3><p id="total-revenue">₹0.00</p></div>
                        <div class="metric-card"><h3>Average Margin</h3><p id="avg-margin">0%</p></div>
                        <div class="metric-card"><h3>Inventory Value</h3><p id="total-inventory-cost">₹0.00</p></div>
                        <div class="metric-card"><h3>Units in Stock</h3><p id="total-units">0</p></div>
                    </div>
                </section>
                <section class="card">
                    <h2>Low Stock Items
                        <button class="btn btn-success btn-small" id="download-low-stock-btn" style="float: right; margin-top: -5px;">Download List</button>
                    </h2>
                    <div id="low-stock-items" class="metric-card">
                         <p style="text-align:center; color: var(--text-on-dark-secondary);">No low stock items.</p>
                    </div>
                </section>
            </div>

            <!-- Other Tabs (Profit, Transactions, Settings) -->
            <div id="profit" class="tab-content">
                <!-- Profit content remains the same, omitted for brevity -->
            </div>
            <div id="transactions" class="tab-content">
                <!-- Transactions content remains the same, omitted for brevity -->
            </div>
            <div id="settings" class="tab-content">
                <!-- Settings content remains the same, omitted for brevity -->
            </div>

            <!-- Current Inventory Section (Common to all tabs) -->
            <section class="card"><h2>Current Inventory</h2><div class="table-container">
                <table class="styled-table" id="inventory-table">
                    <thead><tr><th>Particulars</th><th>Quantity</th><th>Cost Rate</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div></section>
        </main>
    </div>

    <div id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
    window.onload = () => {
        const { jsPDF } = window.jspdf;

        const app = {
            // --- GAPI & AUTH CONFIG ---
            CLIENT_ID: '460969544827-ip0gvjsjv79m5sibkmgbngmqpl8n5u16.apps.googleusercontent.com',
            API_KEY: 'AIzaSyDYfJX4cryYxGSgPe1319kHf_u6bb071lg', 
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            DATA_FILE_NAME: 'fashion_store_data.json',
            tokenClient: null, driveFileId: null, isSaving: false, saveTimeout: null,
            
            // --- APP STATE ---
            state: { inventory: [], transactions: [], holidays: [], historicalSales: [] },
            ui: {},
            salesChartInstance: null, 

            // --- AI PREDICTION MODULE ---
            ai: {
                enabled: false,
                horizon: 7, // Default forecast horizon in days
                currentPrediction: null, // To store latest prediction results

                /**
                 * Generates a sales forecast using a heuristic model.
                 * This model simulates analysis of day-of-week patterns, recent trends, and seasonality.
                 * @param {Array} salesHistory - Combined array of recent and historical sales {date, total}.
                 * @returns {object} { predictions, confidence, trendDirection }
                 */
                generatePrediction(salesHistory) {
                    if (salesHistory.length < 14) {
                        return { predictions: [], confidence: 0, trendDirection: 'neutral' };
                    }
                    salesHistory.sort((a, b) => a.date - b.date);

                    // --- 1. Day-of-Week Pattern Analysis ---
                    const dayOfWeekAverages = Array(7).fill(0).map(() => ({ total: 0, count: 0 }));
                    salesHistory.forEach(sale => {
                        const day = sale.date.getDay(); // 0=Sun, 1=Mon...
                        dayOfWeekAverages[day].total += sale.total;
                        dayOfWeekAverages[day].count++;
                    });

                    const overallAverage = salesHistory.reduce((sum, s) => sum + s.total, 0) / salesHistory.length;
                    const dayOfWeekFactors = dayOfWeekAverages.map(day => {
                        if (day.count === 0) return 1; // Neutral factor if no data for this day
                        const avg = day.total / day.count;
                        return avg / overallAverage; // Factor > 1 means above average, < 1 means below
                    });

                    // --- 2. Weighted Trend Combination ---
                    const lastDate = salesHistory[salesHistory.length - 1].date;
                    const getDateSince = (days) => new Date(lastDate).setDate(lastDate.getDate() - days);
                    
                    const getAvgForPeriod = (days) => {
                        const sinceDate = getDateSince(days);
                        const periodSales = salesHistory.filter(s => s.date >= sinceDate);
                        if (periodSales.length === 0) return overallAverage;
                        return periodSales.reduce((sum, s) => sum + s.total, 0) / periodSales.length;
                    };
                    
                    const avg3day = getAvgForPeriod(3);
                    const avg7day = getAvgForPeriod(7);
                    const avg14day = getAvgForPeriod(14);
                    // Weights: More recent data is more important
                    const weightedTrendBaseline = (avg3day * 0.5) + (avg7day * 0.3) + (avg14day * 0.2);

                    // --- 3. Seasonal Adjustments (Simplified: Month-over-Month) ---
                    const lastMonthDate = new Date(lastDate);
                    lastMonthDate.setMonth(lastMonthDate.getMonth() - 1);
                    const salesAroundLastMonth = salesHistory.filter(s => 
                        s.date >= new Date(lastMonthDate).setDate(lastMonthDate.getDate() - 7) &&
                        s.date <= new Date(lastMonthDate).setDate(lastMonthDate.getDate() + 7)
                    );
                    let seasonalFactor = 1.0;
                    if(salesAroundLastMonth.length > 0) {
                        const lastMonthAvg = salesAroundLastMonth.reduce((sum, s) => sum + s.total, 0) / salesAroundLastMonth.length;
                        seasonalFactor = weightedTrendBaseline / lastMonthAvg;
                        seasonalFactor = Math.max(0.5, Math.min(1.5, seasonalFactor)); // Clamp factor to avoid extremes
                    }

                    // --- 4. Generate Forecast ---
                    const predictions = [];
                    let currentDate = new Date(lastDate);
                    for (let i = 1; i <= this.horizon; i++) {
                        currentDate.setDate(currentDate.getDate() + 1);
                        const futureDayOfWeek = currentDate.getDay();
                        
                        let predictedValue = weightedTrendBaseline * dayOfWeekFactors[futureDayOfWeek] * seasonalFactor;
                        predictedValue = Math.max(0, predictedValue); // Sales can't be negative

                        predictions.push({
                            date: new Date(currentDate),
                            value: predictedValue,
                        });
                    }

                    // --- 5. Confidence Scoring ---
                    let confidence = 90; // Base score
                    if (salesHistory.length < 30) confidence -= 20; // Less data, less confidence
                    if (this.horizon === 14) confidence -= 10; // Longer forecasts are harder
                    if (this.horizon === 3) confidence += 5;   // Shorter are easier
                    const volatility = (avg3day - avg14day) / avg14day;
                    if(Math.abs(volatility) > 0.5) confidence -= 10; // High volatility reduces confidence

                    // --- 6. Trend Direction Indicator ---
                    const predictedAverage = predictions.reduce((sum, p) => sum + p.value, 0) / predictions.length;
                    let trendDirection = 'neutral';
                    if (predictedAverage > weightedTrendBaseline * 1.05) trendDirection = 'up';
                    if (predictedAverage < weightedTrendBaseline * 0.95) trendDirection = 'down';

                    return { predictions, confidence: Math.max(50, Math.min(99, Math.round(confidence))), trendDirection };
                }
            },
            
            // --- INITIALIZATION & AUTH ---
            init() { 
                this.cacheDOMElements();
                gapi.load('client', this.initializeGapiClient.bind(this));
                this.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: this.CLIENT_ID,
                    scope: this.SCOPES,
                    callback: this.handleAuthResponse.bind(this),
                });
                this.ui.signinBtn.addEventListener('click', () => this.tokenClient.requestAccessToken({prompt: 'consent'}));
                this.ui.signoutBtn.addEventListener('click', this.signOut.bind(this));
            },
            async initializeGapiClient() { 
                await gapi.client.init({ apiKey: this.API_KEY, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"] });
                this.ui.signinBtn.disabled = false;
                this.ui.authStatus.textContent = 'Ready. Please sign in.';
            },
            async handleAuthResponse(response) { 
                if (response.error) { this.showToast(`Error: ${response.error}`, 'error'); return; }
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').classList.add('visible');
                await this.updateUserProfile();
                await this.loadData();
                await this.loadHistoricalData();
                this.startAppLogic();
            },
            signOut() { /* ... unchanged ... */ },
            async updateUserProfile() { /* ... unchanged ... */ },
            
            // --- DATA HANDLING (DRIVE & HISTORICAL) ---
            async loadData() { /* ... unchanged ... */ },
            triggerAutoSave() { /* ... unchanged ... */ },
            async saveData() { /* ... unchanged ... */ },
            async loadHistoricalData() {
                // IMPORTANT: Replace this URL with the "Raw" link to your own JSON file on GitHub.
                const url = 'https://raw.githubusercontent.com/USER/REPO/main/previous_months_sales.json';
                this.showToast('Loading historical data...', 'info');
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Network response not ok. Status: ${response.status}`);
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        this.state.historicalSales = data.map(sale => ({
                            date: new Date(sale.date + 'T12:00:00Z'), // Use ISO format with Z for UTC noon
                            total: parseFloat(sale.total) || 0
                        })).filter(sale => !isNaN(sale.date.getTime()) && sale.total > 0);
                        this.showToast(`Loaded ${this.state.historicalSales.length} historical sales records.`, 'success');
                    }
                } catch (error) {
                    console.warn('Could not load historical sales data. Predictions will be based on recent data only.', error);
                    this.showToast('Historical data not found. Predictions may be less accurate.', 'error');
                }
            },
            
            // --- CORE APP LOGIC ---
            startAppLogic() { 
                this.addEventListeners();
                this.addFormItem(this.ui.salesItemsContainer, true);
                this.addFormItem(this.ui.purchaseItemsContainer, false);
                this.renderAll();
                this.renderSalesTrendChart(); // Initial render for the active analytics tab
            },

            // --- UI ELEMENT CACHING ---
            cacheDOMElements() {
                this.ui = {
                    signinBtn: document.getElementById('signin-btn'),
                    signoutBtn: document.getElementById('signout-btn'),
                    authStatus: document.getElementById('auth-status'),
                    excelFile: document.getElementById('excel-file'),
                    inventoryTableBody: document.querySelector('#inventory-table tbody'),
                    inventoryDatalist: document.getElementById('inventory-datalist'),
                    salesForm: document.getElementById('sales-form'),
                    addSaleItemBtn: document.getElementById('add-sale-item-btn'),
                    salesItemsContainer: document.getElementById('sales-items-container'),
                    purchaseForm: document.getElementById('purchase-form'),
                    addPurchaseItemBtn: document.getElementById('add-purchase-item-btn'),
                    purchaseItemsContainer: document.getElementById('purchase-items-container'),
                    tabButtons: document.querySelectorAll('.tab-button'),
                    tabContents: document.querySelectorAll('.tab-content'),
                    manualSaveBtn: document.getElementById('manual-save-btn'),
                    analytics: { 
                        totalProfit: document.getElementById('total-profit'),
                        totalRevenue: document.getElementById('total-revenue'),
                        avgMargin: document.getElementById('avg-margin'),
                        inventoryCost: document.getElementById('total-inventory-cost'),
                        totalUnits: document.getElementById('total-units'),
                        lowStockItems: document.getElementById('low-stock-items'),
                        downloadLowStockBtn: document.getElementById('download-low-stock-btn'),
                        // Chart & AI controls
                        salesTrendChart: document.getElementById('salesTrendChart'),
                        chartPeriodSelector: document.getElementById('chart-period-selector'),
                        predictionToggle: document.getElementById('prediction-toggle'),
                        predictionHorizonSelector: document.getElementById('prediction-horizon-selector'),
                        predictionStatusDisplay: document.getElementById('prediction-status-display'),
                        confidenceScore: document.getElementById('confidence-score'),
                        trendIndicator: document.getElementById('trend-indicator'),
                        actualTotalDisplay: document.getElementById('actual-total'),
                        predictedTotalDisplay: document.getElementById('predicted-total'),
                    },
                    // other ui sections...
                };
            },
            
            // --- UTILS & FORMATTERS ---
            getTodayDateString(date = new Date()) { return date.toISOString().slice(0, 10); },
            formatDateDDMMYYYY(date) { /* ... unchanged ... */ },
            hexToRgba(hex, alpha = 1) { /* ... unchanged ... */ },
            
            // --- RENDER FUNCTIONS ---
            renderAll() {
                this.renderInventory();
                this.renderAnalyticsSummary();
                this.renderTransactions();
                this.renderProfit();
                // ... other render calls
                if (document.getElementById('analytics').classList.contains('active')) {
                     this.renderSalesTrendChart(); 
                }
            },
            renderInventory() { /* ... unchanged ... */ },
            renderAnalyticsSummary() { /* Renders the metric cards, not the chart */
                // ... existing logic from old renderAnalytics()
            },

            /**
             * Prepares sales data for the chart based on the selected period.
             * FIX: This now correctly includes the current day for the "7d" view.
             */
            _prepareSalesDataForMode(mode) {
                const salesByDate = new Map();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let startDate = new Date(today);
                let endDate = new Date(today);
                
                if (mode === '7d') {
                    startDate.setDate(today.getDate() - 6);
                } else if (mode === '1m') {
                    startDate.setDate(1); // First day of the current month
                }
                
                // Initialize map with all dates in the range to ensure gaps are shown
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    if (!this.isDateHoliday(d)) {
                       salesByDate.set(d.toISOString().split('T')[0], 0);
                    }
                }
                
                // Aggregate sales data from transactions
                const filterStartDate = new Date(startDate);
                const filterEndDate = new Date(endDate);
                filterEndDate.setHours(23, 59, 59, 999);
                
                this.state.transactions.forEach(transaction => {
                    if (transaction.type === 'Sale') {
                        const tDate = new Date(transaction.date);
                        if (tDate >= filterStartDate && tDate <= filterEndDate) {
                            const dateString = tDate.toISOString().split('T')[0];
                            if (salesByDate.has(dateString)) {
                                salesByDate.set(dateString, salesByDate.get(dateString) + transaction.total);
                            }
                        }
                    }
                });

                // Convert map to arrays for Chart.js, sorting by date
                const sortedEntries = [...salesByDate.entries()].sort();
                const labels = sortedEntries.map(entry => new Date(entry[0] + 'T12:00:00Z'));
                const dataPoints = sortedEntries.map(entry => entry[1]);

                return { labels, dataPoints };
            },

            /**
             * Renders the main sales trend chart with optional AI predictions.
             */
            renderSalesTrendChart() {
                if (typeof Chart === 'undefined' || !this.ui.analytics.salesTrendChart) return;

                const ctx = this.ui.analytics.salesTrendChart.getContext('2d');
                const style = getComputedStyle(document.documentElement);
                const accentTeal = style.getPropertyValue('--accent-teal').trim();
                const accentPrediction = style.getPropertyValue('--accent-prediction').trim();
                
                const activePeriodBtn = this.ui.analytics.chartPeriodSelector.querySelector('.period-btn.active');
                const period = activePeriodBtn ? activePeriodBtn.dataset.period : '7d';

                // --- 1. Get Actual Sales Data ---
                const { labels: actualLabels, dataPoints: actualData } = this._prepareSalesDataForMode(period);
                this.ui.analytics.actualTotalDisplay.textContent = `₹${actualData.reduce((a, b) => a + b, 0).toFixed(2)}`;
                this.ui.analytics.predictedTotalDisplay.textContent = 'N/A';

                const datasets = [{
                    label: 'Actual Sales',
                    data: actualData,
                    borderColor: accentTeal,
                    backgroundColor: this.hexToRgba(accentTeal, 0.2),
                    tension: 0.3,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: accentTeal,
                }];
                
                let chartLabels = actualLabels;

                // --- 2. Handle AI Prediction ---
                if (this.ai.enabled) {
                    const allSales = [
                        ...this.state.transactions.filter(t => t.type === 'Sale').map(t => ({ date: new Date(t.date), total: t.total })),
                        ...this.state.historicalSales
                    ];
                    
                    const { predictions, confidence, trendDirection } = this.ai.generatePrediction(allSales);
                    this.ai.currentPrediction = predictions;

                    if (predictions.length > 0) {
                        const predictionLabels = predictions.map(p => p.date);
                        const predictionValues = predictions.map(p => p.value);
                        
                        // Combine labels and align data
                        chartLabels = [...actualLabels, ...predictionLabels];
                        const alignedActualData = [...actualData, ...Array(predictionValues.length).fill(null)];

                        datasets[0].data = alignedActualData; // Update actuals to have nulls for future
                        datasets.push({
                            label: 'Predicted Sales',
                            data: [...Array(actualData.length).fill(null), ...predictionValues],
                            borderColor: accentPrediction,
                            borderDash: [5, 5], // Dashed line for prediction
                            backgroundColor: 'transparent',
                            tension: 0.3,
                            fill: false,
                            pointRadius: 4,
                            pointBackgroundColor: accentPrediction,
                        });
                        
                        // Update UI
                        this.ui.analytics.predictionStatusDisplay.style.display = 'flex';
                        this.ui.analytics.confidenceScore.textContent = `${confidence}%`;
                        this.ui.analytics.trendIndicator.className = `trend-indicator ${trendDirection}`;
                        this.ui.analytics.trendIndicator.innerHTML = trendDirection === 'up' ? '▲' : (trendDirection === 'down' ? '▼' : '');
                        this.ui.analytics.predictedTotalDisplay.textContent = `₹${predictionValues.reduce((a, b) => a + b, 0).toFixed(2)}`;
                    }
                } else {
                    this.ui.analytics.predictionStatusDisplay.style.display = 'none';
                }

                // --- 3. Render Chart ---
                if (this.salesChartInstance) this.salesChartInstance.destroy();

                this.salesChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'day', tooltipFormat: 'MMM d, yyyy', displayFormats: { day: 'MMM d' } },
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { color: style.getPropertyValue('--text-on-dark-secondary').trim() }
                            },
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: {
                                    color: style.getPropertyValue('--text-on-dark-secondary').trim(),
                                    callback: (value) => '₹' + value.toLocaleString('en-IN')
                                }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: style.getPropertyValue('--text-on-dark-primary').trim() } },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: (context) => {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        if (context.parsed.y !== null) {
                                            label += new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            },
            
            // --- EVENT LISTENERS ---
            addEventListeners() {
                // ... other event listeners like file upload, form submissions ...

                // New Chart and AI Control Listeners
                this.ui.analytics.chartPeriodSelector.addEventListener('click', (e) => {
                    if (e.target.classList.contains('period-btn')) {
                        this.ui.analytics.chartPeriodSelector.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        this.renderSalesTrendChart();
                    }
                });

                this.ui.analytics.predictionToggle.addEventListener('change', (e) => {
                    this.ai.enabled = e.target.checked;
                    this.ui.analytics.predictionHorizonSelector.disabled = !this.ai.enabled;
                    this.renderSalesTrendChart();
                });
                
                this.ui.analytics.predictionHorizonSelector.addEventListener('change', (e) => {
                    this.ai.horizon = parseInt(e.target.value, 10);
                    if (this.ai.enabled) {
                        this.renderSalesTrendChart();
                    }
                });
                
                // Update tab switching to render chart only when analytics is active
                this.ui.tabButtons.forEach(button => button.addEventListener('click', () => { 
                    this.ui.tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    this.ui.tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(button.dataset.tab).classList.add('active');
                    if (button.dataset.tab === 'analytics') { 
                        this.renderSalesTrendChart();
                    }
                }));

                // ... other event listeners
            },

            isDateHoliday(dateObj) { /* ... unchanged ... */ },
            
            // ... all other helper and logic functions (processSale, deleteSale, etc.) remain largely the same
            // Omitted for brevity, they should be copied from the original provided code.
        };

        app.init();
    };
    </script>
</body>
</html>
