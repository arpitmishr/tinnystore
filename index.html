<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tinny Fashion - Business Manager</title>
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3crect width='100' height='100' rx='15' fill='%234A5568'/%3e%3cpath fill='white' d='M20 30h60l-10 50H30zM50 20c-8 0-15 7-15 15v5h30v-5c0-8-7-15-15-15zM30 40c0 5 5 10 10 10h20c5 0 10-5 10-10'/%3e%3c/svg%3e">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <style>
        :root {
            --background-body: #F1F5F9;
            --surface-card: #FFFFFF;
            --sidebar-bg: #1A202C;
            --sidebar-text: #E2E8F0;
            --sidebar-text-hover: #FFFFFF;
            --sidebar-active-bg: #4A5568;

            --text-primary: #1A202C;
            --text-secondary: #4A5568;
            --border-color: #CBD5E1;
            
            --accent-primary: #3182CE;
            --accent-primary-hover: #2B6CB0;
            
            --success-green: #38A169;
            --danger-red: #E53E3E;
            --warning-yellow: #D69E2E;
            
            --border-radius-md: 8px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html { height: 100%; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--background-body);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #login-screen {
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; width: 100%; text-align: center; padding: 1rem;
        }
        .login-box {
            background: var(--surface-card); padding: 2.5rem; border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md); max-width: 450px; width: 100%;
        }
        .login-box h1 { margin-bottom: 0.5rem; font-size: 2rem; font-weight: 700; }
        .login-box p { color: var(--text-secondary); margin-bottom: 2rem; }
        #signin-btn { 
            background-color: #4285F4; color: white; border: none; padding: 12px 24px; font-size: 1rem; 
            font-weight: 500; border-radius: var(--border-radius-md); cursor: pointer; display: inline-flex; 
            align-items: center; gap: 1rem; transition: background-color 0.3s; box-shadow: var(--shadow-sm); 
        }
        #signin-btn:hover:not([disabled]) { background-color: #357ae8; box-shadow: var(--shadow-md); }
        #signin-btn[disabled] { background-color: #A0AEC0; cursor: not-allowed; }
        #signin-btn svg { width: 22px; height: 22px; background: white; border-radius: 50%; padding: 2px; }

        #app-wrapper {
            display: none;
            height: 100vh;
            width: 100vw;
        }
        #app-wrapper.visible { display: flex; }

        #sidebar {
            width: 240px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: margin-left 0.3s ease;
        }
        #sidebar .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 2rem;
            color: #fff;
        }
        #sidebar .sidebar-nav {
            list-style: none;
            flex-grow: 1;
        }
        .nav-item a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius-md);
            text-decoration: none;
            color: var(--sidebar-text);
            font-weight: 500;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s, color 0.2s;
        }
        .nav-item a:hover {
            background-color: var(--sidebar-active-bg);
            color: var(--sidebar-text-hover);
        }
        .nav-item a.active {
            background-color: var(--accent-primary);
            color: #fff;
        }
        .nav-item a svg { width: 20px; height: 20px; }
        .sidebar-footer { text-align: center; }
        .sidebar-footer button {
            background: var(--sidebar-active-bg); color: var(--sidebar-text);
            border: none; padding: 0.6rem 1rem; width: 100%; border-radius: var(--border-radius-md);
            cursor: pointer; font-weight: 500; transition: background-color 0.2s;
        }
        .sidebar-footer button:hover { background-color: #5A6578; }

        #main-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .page { display: none; }
        .page.active { display: block; animation: fadeInContent 0.4s ease-out; }
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .page-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .page-header h1 { font-size: 1.8rem; font-weight: 700; }
        
        .card {
            background: var(--surface-card);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .card h2 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        /* Dashboard & Analytics */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
        }
        .kpi-card {
            border-left: 4px solid var(--accent-primary);
        }
        .kpi-card h3 {
            font-size: 0.9rem; font-weight: 500; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;
        }
        .kpi-card p { font-size: 2rem; font-weight: 700; line-height: 1; }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            align-items: flex-end;
        }
        .form-group { display: flex; flex-direction: column; }
        label { font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.25rem; }
        input[type="text"], input[type="number"], input[type="date"], input[type="file"], select {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md); font-size: 1rem; background-color: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus {
            outline: none; border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.2);
        }
        
        .btn {
            padding: 0.75rem 1.25rem; border: none; border-radius: var(--border-radius-md);
            font-size: 0.95rem; font-weight: 600; cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background-color: var(--accent-primary); color: #fff; }
        .btn-primary:hover { background-color: var(--accent-primary-hover); }
        .btn-secondary { background-color: var(--text-secondary); color: #fff; }
        .btn-danger { background-color: var(--danger-red); color: #fff; }

        .filter-controls {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .filter-controls .form-group { flex-grow: 1; }

        /* Table Styles */
        .table-container { 
            width: 100%; overflow-x: auto; 
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
        }
        .styled-table { width: 100%; border-collapse: collapse; }
        .styled-table th, .styled-table td {
            padding: 0.8rem 1rem; text-align: left;
            font-size: 0.9rem; vertical-align: middle;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .styled-table tr:last-child td { border-bottom: none; }
        .styled-table th { 
            background-color: var(--background-body); 
            font-weight: 600; position: sticky; top: 0; z-index: 1;
        }
        .action-icon {
            display: inline-block; cursor: pointer; color: var(--text-secondary);
            transition: color 0.2s;
        }
        .action-icon:hover { color: var(--danger-red); }
        .action-icon svg { width: 18px; height: 18px; }

        /* Multi-item Form */
        .multi-item-form-container .item-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px dashed var(--border-color);
        }
        .multi-item-form-container .item-row:first-child { padding-top: 0; }
         .multi-item-form-container .item-row .actions {
            justify-self: end;
            align-self: end;
        }

        #toast { 
            position: fixed; bottom: -120px; left: 50%; transform: translateX(-50%); 
            padding: 1rem 1.5rem; border-radius: var(--border-radius-md); color: #fff; 
            font-weight: 600; font-size: 1rem; box-shadow: var(--shadow-md); 
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); 
            z-index: 9999; opacity: 0; text-align: center;
        }
        #toast.show { bottom: 25px; opacity: 1; }
        #toast.success { background-color: var(--success-green); }
        #toast.error { background-color: var(--danger-red); }
        #toast.info { background-color: var(--accent-primary); }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: -250px; /* Hidden by default */
                height: 100%;
                z-index: 1000;
                margin-left: 0;
            }
            #sidebar.active { left: 0; }
            #main-content { padding: 1rem; }
            .page-header { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .mobile-menu-btn {
                display: block;
                background: var(--surface-card);
                border: 1px solid var(--border-color);
                padding: 0.5rem;
                border-radius: var(--border-radius-md);
            }
            .filter-controls { flex-direction: column; align-items: stretch; }
        }
        @media (min-width: 769px) {
             .mobile-menu-btn { display: none; }
        }
         @media (min-width: 640px) {
             .multi-item-form-container .item-row {
                grid-template-columns: 3fr 1fr 1fr auto;
                align-items: flex-end;
            }
        }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h1>Tinny Fashion</h1>
            <p>Your complete business manager. Sign in to continue.</p>
            <button id="signin-btn" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 35.841 44 30.138 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <div id="app-wrapper">
        <nav id="sidebar">
            <div class="sidebar-header">Tinny Fashion</div>
            <ul class="sidebar-nav">
                <li class="nav-item"><a href="#" class="nav-link active" data-page="dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
                    Dashboard
                </a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-page="sales">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" /></svg>
                    Sales
                </a></li>
                 <li class="nav-item"><a href="#" class="nav-link" data-page="purchase">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c.51 0 .962-.343 1.087-.835l1.823-6.831a1.5 1.5 0 00-1.423-2.182H5.518M5.121 17.25c.387.02.75.029 1.121.029h11.218m-11.218 0l-1.022-.165m-1.022-.165L2.11 4.111" /></svg>
                    Purchase
                </a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-page="stocks">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg>
                    Stocks
                </a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-page="analytics">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>
                    Analytics
                </a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-page="credit">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" /></svg>
                    Credit
                </a></li>
                 <li class="nav-item"><a href="#" class="nav-link" data-page="settings">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.48.398.668 1.03.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.075.124a6.57 6.57 0 01-.22.127c-.331.183-.581.495-.645.87l-.213 1.281c-.09.543-.56.941-1.11.941h-2.593c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.003-.827c.293-.24.438-.613-.438-.995s-.145-.755-.438-.995l-1.003-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37-.49l1.217.456c.355.133.75.072 1.075-.124.072-.044.146-.087.22-.127.331-.183.581-.495.645-.87l.213-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Settings
                </a></li>
            </ul>
            <div class="sidebar-footer">
                <button id="signout-btn">Sign Out</button>
            </div>
        </nav>

        <main id="main-content">
            <div id="dashboard" class="page active">
                <div class="page-header">
                    <h1>Dashboard</h1>
                    <button class="mobile-menu-btn">Menu</button>
                </div>
                <div class="kpi-grid card">
                    <div class="kpi-card">
                        <h3>Revenue (Last 30 Days)</h3>
                        <p id="dashboard-revenue">₹0</p>
                    </div>
                    <div class="kpi-card">
                        <h3>Profit (Last 30 Days)</h3>
                        <p id="dashboard-profit">₹0</p>
                    </div>
                    <div class="kpi-card" style="border-color: var(--warning-yellow);">
                        <h3>Low Stock Items</h3>
                        <p id="dashboard-low-stock">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3>Inventory Value</h3>
                        <p id="dashboard-inv-value">₹0</p>
                    </div>
                </div>
                <div class="card">
                    <h2>Sales Trend (Last 7 Days)</h2>
                    <canvas id="salesTrendChart"></canvas>
                </div>
            </div>

            <div id="sales" class="page">
                <div class="page-header"><h1>Record a Sale</h1><button class="mobile-menu-btn">Menu</button></div>
                <div class="card">
                    <h2>Inventory Sale</h2>
                    <form id="sales-form">
                        <div id="sales-items-container" class="multi-item-form-container"></div>
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button type="button" id="add-sale-item-btn" class="btn btn-secondary" style="width: auto;">+ Add Item</button>
                            <button type="submit" class="btn btn-primary" style="width: auto; margin-left: auto;">Record Sale</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h2>Cosmetic / Non-Inventory Sale</h2>
                     <form id="cosmetic-sale-form" class="form-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="cosmetic-particulars">Item Name</label>
                            <input type="text" id="cosmetic-particulars" required>
                        </div>
                        <div class="form-group">
                            <label for="cosmetic-quantity">Quantity</label>
                            <input type="number" id="cosmetic-quantity" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="cosmetic-sell-rate">Sale Rate</label>
                            <input type="number" id="cosmetic-sell-rate" min="0" step="0.01" required>
                        </div>
                         <div class="form-group">
                            <label for="cosmetic-cost-rate">Cost Rate</label>
                            <input type="number" id="cosmetic-cost-rate" min="0" step="0.01" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="grid-column: 1 / -1;">Record Cosmetic Sale</button>
                    </form>
                </div>
                 <datalist id="inventory-datalist"></datalist>
            </div>
            
            <div id="purchase" class="page">
                <div class="page-header"><h1>Record a Purchase</h1><button class="mobile-menu-btn">Menu</button></div>
                 <div class="card">
                    <h2>Add New Stock</h2>
                    <form id="purchase-form">
                        <div id="purchase-items-container" class="multi-item-form-container"></div>
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button type="button" id="add-purchase-item-btn" class="btn btn-secondary" style="width: auto;">+ Add Item</button>
                            <button type="submit" class="btn btn-primary" style="width: auto; margin-left: auto;">Add to Stock</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="stocks" class="page">
                <div class="page-header"><h1>Inventory Stocks</h1><button class="mobile-menu-btn">Menu</button></div>
                <div class="card">
                    <div class="table-container">
                        <table class="styled-table" id="inventory-table">
                            <thead><tr><th>ITEM</th><th>QTY</th><th>COST</th><th>ACTION</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="analytics" class="page">
                 <div class="page-header"><h1>Analytics</h1><button class="mobile-menu-btn">Menu</button></div>
                 <div class="card kpi-grid">
                    <div class="kpi-card">
                        <h3>Total Revenue</h3>
                        <p id="analytics-total-revenue">₹0</p>
                    </div>
                    <div class="kpi-card">
                        <h3>Total Profit</h3>
                        <p id="analytics-total-profit">₹0</p>
                    </div>
                    <div class="kpi-card">
                        <h3>Avg. Margin</h3>
                        <p id="analytics-avg-margin">0%</p>
                    </div>
                     <div class="kpi-card">
                        <h3>Total Units Sold</h3>
                        <p id="analytics-units-sold">0</p>
                    </div>
                </div>
                <div class="card">
                    <h2>Filter by Date</h2>
                    <div class="filter-controls">
                        <div class="form-group"><label>Start Date</label><input type="date" id="analytics-start-date"></div>
                        <div class="form-group"><label>End Date</label><input type="date" id="analytics-end-date"></div>
                        <button class="btn btn-primary" id="analytics-filter-btn">Filter</button>
                    </div>
                    <div id="filtered-results-container" class="kpi-grid" style="display:none; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <div class="kpi-card"><h3>Filtered Sales</h3><p id="filtered-sales-total">₹0</p></div>
                        <div class="kpi-card"><h3>Filtered Profit</h3><p id="filtered-profit-total">₹0</p></div>
                    </div>
                </div>
                 <div class="card">
                    <h2>Top Selling Products (All Time)</h2>
                    <div class="table-container">
                        <table class="styled-table" id="top-products-table">
                            <thead><tr><th>ITEM</th><th>SOLD QTY</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="credit" class="page">
                <div class="page-header"><h1>Credit Management</h1><button class="mobile-menu-btn">Menu</button></div>
                <div class="card">
                    <h2>Record Credit Sale</h2>
                     <form id="credit-inventory-sale-form" class="form-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="credit-inventory-party-name">Creditor's Name</label>
                            <input type="text" id="credit-inventory-party-name" required>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Item Name</label>
                            <input type="text" class="particulars" list="inventory-datalist" required>
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" class="quantity" min="1" required>
                        </div>
                        <div class="form-group">
                            <label>Sale Rate</label>
                            <input type="number" class="rate" min="0" step="0.01" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="grid-column: 1 / -1;">Record Credit Sale</button>
                    </form>
                </div>
                <div class="card">
                    <h2>Outstanding Credit</h2>
                    <div id="creditor-list-container" class="table-container">
                    </div>
                </div>
            </div>

            <div id="settings" class="page">
                <div class="page-header"><h1>Settings</h1><button class="mobile-menu-btn">Menu</button></div>
                 <div class="card">
                    <h2>Data Management</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Load inventory from an Excel file (columns: 'particulars', 'quantity', 'rate'). This will overwrite your current inventory.</p>
                    <button class="btn btn-primary" id="import-data-btn">Import from Excel</button>
                    <input type="file" id="excel-file" accept=".xlsx, .xls" style="display: none;">
                </div>
                 <div class="card">
                    <h2>Holiday Management</h2>
                    <div class="filter-controls">
                        <div class="form-group"><label>Holiday Date</label><input type="date" id="holiday-date"></div>
                         <button id="add-holiday-btn" class="btn btn-primary">Add Holiday</button>
                    </div>
                    <h3>Marked Holidays</h3>
                    <ul id="holiday-list" style="list-style: none; padding-top: 0.5rem;">
                        <li>No holidays marked.</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>
    
    <div id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
    window.onload = () => {
        const { jsPDF } = window.jspdf;

        const app = {
            CLIENT_ID: '460969544827-ip0gvjsjv79m5sibkmgbngmqpl8n5u16.apps.googleusercontent.com',
            API_KEY: 'AIzaSyDYfJX4cryYxGSgPe1319kHf_u6bb071lg', 
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            APP_FOLDER_NAME: 'TinnyFashionStore_Data',
            DATA_FILE_NAME: 'fashion_store_data.json',
            tokenClient: null, driveFileId: null, isSaving: false, saveTimeout: null,
            state: { inventory: [], transactions: [], holidays: [] },
            ui: {},
            salesChartInstance: null,

            init() {
                this.cacheDOMElements();
                gapi.load('client', this.initializeGapiClient.bind(this));
                this.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: this.CLIENT_ID, scope: this.SCOPES,
                    callback: this.handleAuthResponse.bind(this),
                });
                this.ui.signinBtn.addEventListener('click', () => this.tokenClient.requestAccessToken({prompt: 'consent'}));
                this.ui.signoutBtn.addEventListener('click', this.signOut.bind(this));
            },
            async initializeGapiClient() {
                await gapi.client.init({ apiKey: this.API_KEY, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"] });
                this.ui.signinBtn.disabled = false;
            },
            async handleAuthResponse(response) {
                if (response.error) { this.showToast(`Error: ${response.error}`, 'error'); return; }
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-wrapper').classList.add('visible');
                await this.loadData();
                this.startAppLogic();
            },
            signOut() {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token, () => {
                        gapi.client.setToken(''); this.driveFileId = null;
                        document.getElementById('login-screen').style.display = 'flex';
                        document.getElementById('app-wrapper').classList.remove('visible');
                    });
                }
            },
            startAppLogic() {
                this.addEventListeners();
                this.renderPage('dashboard'); // Start on the dashboard
            },
            async loadData() {
                this.showToast("Loading data...", "info");
                try {
                    const response = await gapi.client.drive.files.list({ q: `name='${this.DATA_FILE_NAME}' and trashed=false`, spaces: 'drive', fields: 'files(id)' });
                    if (response.result.files && response.result.files.length > 0) {
                        this.driveFileId = response.result.files[0].id;
                        const fileContentResponse = await gapi.client.drive.files.get({ fileId: this.driveFileId, alt: 'media' });
                        const loadedState = JSON.parse(fileContentResponse.body);
                        
                        if (loadedState.transactions) {
                           loadedState.transactions.forEach(t => { t.date = new Date(t.date); });
                        }
                        const defaultState = { inventory: [], transactions: [], holidays: [] };
                        this.state = { ...defaultState, ...loadedState };
                        this.state.holidays = this.state.holidays || []; 
                        this.showToast("Data loaded.", "success");
                    } else {
                        this.showToast("No data file found. Starting fresh.", "info");
                        this.state = { inventory: [], transactions: [], holidays: [] };
                    }
                } catch (e) {
                    this.showToast("Failed to load data.", "error");
                    this.state = { inventory: [], transactions: [], holidays: [] }; 
                }
            },
            triggerAutoSave() {
                clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => this.saveData(), 2000);
            },
            async saveData() {
                if (this.isSaving) return;
                this.isSaving = true; this.showToast("Saving...", "info");
                try {
                    const dataToSave = JSON.stringify(this.state, null, 2);
                    const boundary = '-------314159265358979323846';
                    const delimiter = "\r\n--" + boundary + "\r\n";
                    const close_delim = "\r\n--" + boundary + "--";
                    let request;
                    if (this.driveFileId) {
                        const multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify({}) + delimiter + 'Content-Type: application/json\r\n\r\n' + dataToSave + close_delim;
                        request = gapi.client.request({'path': `https://www.googleapis.com/upload/drive/v3/files/${this.driveFileId}`,'method': 'PATCH','params': { 'uploadType': 'multipart' },'headers': {'Content-Type': 'multipart/related; boundary="' + boundary + '"'},'body': multipartRequestBody});
                    } else {
                        let res = await gapi.client.drive.files.list({ q: `name='${this.APP_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`, spaces: 'drive', fields: 'files(id)' });
                        let folderId;
                        if (res.result.files && res.result.files.length > 0) {
                            folderId = res.result.files[0].id;
                        } else {
                            res = await gapi.client.drive.files.create({ resource: { 'name': this.APP_FOLDER_NAME, 'mimeType': 'application/vnd.google-apps.folder' }, fields: 'id' });
                            folderId = res.result.id;
                        }
                        const metadata = {'name': this.DATA_FILE_NAME, 'parents': [folderId], 'mimeType': 'application/json'};
                        const multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) + delimiter + 'Content-Type: application/json\r\n\r\n' + dataToSave + close_delim;
                        request = gapi.client.request({'path': 'https://www.googleapis.com/upload/drive/v3/files', 'method': 'POST', 'params': {'uploadType': 'multipart'}, 'headers': {'Content-Type': 'multipart/related; boundary="' + boundary + '"'},'body': multipartRequestBody});
                    }
                    const response = await request;
                    if (!this.driveFileId) { this.driveFileId = response.result.id; }
                    this.showToast("Data saved!", "success");
                } catch (e) { 
                    this.showToast("Failed to save.", "error");
                } finally {
                    this.isSaving = false;
                }
            },
            cacheDOMElements() {
                this.ui = {
                    signinBtn: document.getElementById('signin-btn'),
                    signoutBtn: document.getElementById('signout-btn'),
                    navLinks: document.querySelectorAll('.nav-link'),
                    pages: document.querySelectorAll('.page'),
                    mobileMenuBtn: document.querySelectorAll('.mobile-menu-btn'),
                    sidebar: document.getElementById('sidebar'),

                    dashboard: {
                        revenue: document.getElementById('dashboard-revenue'),
                        profit: document.getElementById('dashboard-profit'),
                        lowStock: document.getElementById('dashboard-low-stock'),
                        invValue: document.getElementById('dashboard-inv-value'),
                        salesChart: document.getElementById('salesTrendChart'),
                    },

                    salesForm: document.getElementById('sales-form'),
                    salesItemsContainer: document.getElementById('sales-items-container'),
                    addSaleItemBtn: document.getElementById('add-sale-item-btn'),
                    cosmeticSaleForm: document.getElementById('cosmetic-sale-form'),
                    inventoryDatalist: document.getElementById('inventory-datalist'),

                    purchaseForm: document.getElementById('purchase-form'),
                    purchaseItemsContainer: document.getElementById('purchase-items-container'),
                    addPurchaseItemBtn: document.getElementById('add-purchase-item-btn'),
                    
                    inventoryTableBody: document.querySelector('#inventory-table tbody'),

                    analytics: {
                        totalRevenue: document.getElementById('analytics-total-revenue'),
                        totalProfit: document.getElementById('analytics-total-profit'),
                        avgMargin: document.getElementById('analytics-avg-margin'),
                        unitsSold: document.getElementById('analytics-units-sold'),
                        startDate: document.getElementById('analytics-start-date'),
                        endDate: document.getElementById('analytics-end-date'),
                        filterBtn: document.getElementById('analytics-filter-btn'),
                        filteredResultsContainer: document.getElementById('filtered-results-container'),
                        filteredSales: document.getElementById('filtered-sales-total'),
                        filteredProfit: document.getElementById('filtered-profit-total'),
                        topProductsTableBody: document.querySelector('#top-products-table tbody'),
                    },
                    
                    creditSaleForm: document.getElementById('credit-inventory-sale-form'),
                    creditorListContainer: document.querySelector('#creditor-list-container'),

                    settings: {
                        importDataBtn: document.getElementById('import-data-btn'),
                        excelFile: document.getElementById('excel-file'),
                        holidayDateInput: document.getElementById('holiday-date'),
                        addHolidayBtn: document.getElementById('add-holiday-btn'),
                        holidayList: document.getElementById('holiday-list'),
                    }
                };
            },
            renderPage(pageId) {
                this.ui.pages.forEach(p => p.classList.remove('active'));
                document.getElementById(pageId)?.classList.add('active');

                this.ui.navLinks.forEach(l => l.classList.remove('active'));
                document.querySelector(`.nav-link[data-page="${pageId}"]`)?.classList.add('active');
                
                this.renderInventoryDatalist();

                // Call specific render functions for the activated page
                if (pageId === 'dashboard') this.renderDashboard();
                if (pageId === 'stocks') this.renderInventory();
                if (pageId === 'analytics') this.renderAnalytics();
                if (pageId === 'credit') this.renderCreditorList();
                if (pageId === 'settings') this.renderHolidays();
                if (pageId === 'sales') {
                    this.ui.salesItemsContainer.innerHTML = '';
                    this.addSaleItemRow();
                }
                if (pageId === 'purchase') {
                     this.ui.purchaseItemsContainer.innerHTML = '';
                    this.addPurchaseItemRow();
                }
            },
            
            renderDashboard() {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                const recentSales = this.state.transactions.filter(t => t.type === 'Sale' && t.date >= thirtyDaysAgo);
                const recentRevenue = recentSales.reduce((sum, t) => sum + t.total, 0);
                const recentProfit = recentSales.flatMap(t => t.items).reduce((sum, i) => sum + (i.sellingRate - i.costRate) * i.quantity, 0);
                
                const { cost, lowStockCount } = this.state.inventory.reduce((acc, item) => {
                    acc.cost += item.quantity * item.rate;
                    if (item.quantity > 0 && item.quantity <= 5) acc.lowStockCount++;
                    return acc;
                }, { cost: 0, lowStockCount: 0 });

                this.ui.dashboard.revenue.textContent = `₹${recentRevenue.toFixed(0)}`;
                this.ui.dashboard.profit.textContent = `₹${recentProfit.toFixed(0)}`;
                this.ui.dashboard.lowStock.textContent = lowStockCount;
                this.ui.dashboard.invValue.textContent = `₹${cost.toFixed(0)}`;
                
                this.renderSalesChart();
            },

            renderSalesChart() {
                const ctx = this.ui.dashboard.salesChart.getContext('2d');
                const labels = [];
                const dataPoints = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    labels.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
                    dataPoints.push(0);
                }

                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                this.state.transactions.forEach(t => {
                    if (t.type === 'Sale' && t.date >= sevenDaysAgo) {
                        const dayIndex = 6 - Math.floor((new Date() - t.date) / (1000 * 60 * 60 * 24));
                        if(dayIndex >= 0 && dayIndex < 7) {
                            dataPoints[dayIndex] += t.total;
                        }
                    }
                });
                
                if (this.salesChartInstance) this.salesChartInstance.destroy();
                this.salesChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Daily Sales', data: dataPoints, backgroundColor: 'rgba(49, 130, 206, 0.6)', borderColor: 'rgba(49, 130, 206, 1)', borderWidth: 1 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });
            },

            renderInventory() { 
                this.state.inventory.sort((a, b) => a.particulars.localeCompare(b.particulars));
                this.ui.inventoryTableBody.innerHTML = this.state.inventory.length
                    ? this.state.inventory.map(item => `
                        <tr data-particulars="${item.particulars}">
                            <td>${item.particulars}</td>
                            <td>${item.quantity}</td>
                            <td>₹${item.rate.toFixed(2)}</td>
                            <td><span class="action-icon delete" data-particulars="${item.particulars}" title="Delete">
                               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path></svg>
                            </span></td>
                        </tr>`).join('')
                    : `<tr><td colspan="4" style="text-align:center;">No inventory data.</td></tr>`;
            },
            
            renderInventoryDatalist() {
                 this.ui.inventoryDatalist.innerHTML = this.state.inventory
                    .map(item => `<option value="${item.particulars}"></option>`).join('');
            },

            renderAnalytics() {
                const sales = this.state.transactions.filter(t => t.type === 'Sale');
                const totalRevenue = sales.reduce((sum, t) => sum + t.total, 0);
                const allSoldItems = sales.flatMap(t => t.items);
                const totalProfit = allSoldItems.reduce((sum, i) => sum + (i.sellingRate - i.costRate) * i.quantity, 0);
                const totalUnitsSold = allSoldItems.reduce((sum, i) => sum + i.quantity, 0);
                const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;

                this.ui.analytics.totalRevenue.textContent = `₹${totalRevenue.toFixed(0)}`;
                this.ui.analytics.totalProfit.textContent = `₹${totalProfit.toFixed(0)}`;
                this.ui.analytics.avgMargin.textContent = `${avgMargin.toFixed(1)}%`;
                this.ui.analytics.unitsSold.textContent = totalUnitsSold;

                const productSales = allSoldItems.reduce((acc, item) => {
                    const cleanName = item.particulars.replace('(Cosmetic) ', '');
                    acc[cleanName] = (acc[cleanName] || 0) + item.quantity;
                    return acc;
                }, {});
                const topProducts = Object.entries(productSales).sort(([,a],[,b]) => b - a).slice(0, 10);
                this.ui.analytics.topProductsTableBody.innerHTML = topProducts.length > 0 
                    ? topProducts.map(([name, qty]) => `<tr><td>${name}</td><td>${qty}</td></tr>`).join('')
                    : `<tr><td colspan="2" style="text-align:center;">No sales data.</td></tr>`;
                
                this.ui.analytics.filteredResultsContainer.style.display = 'none';
            },

            renderFilteredAnalytics() {
                const startDateStr = this.ui.analytics.startDate.value;
                const endDateStr = this.ui.analytics.endDate.value;
                if (!startDateStr || !endDateStr) {
                    this.showToast("Please select both start and end dates.", "error"); return;
                }
                const startDate = new Date(startDateStr); startDate.setHours(0,0,0,0);
                const endDate = new Date(endDateStr); endDate.setHours(23,59,59,999);

                const sales = this.state.transactions.filter(t => t.type === 'Sale' && t.date >= startDate && t.date <= endDate);
                const filteredRevenue = sales.reduce((sum, t) => sum + t.total, 0);
                const filteredProfit = sales.flatMap(t => t.items).reduce((sum, i) => sum + (i.sellingRate - i.costRate) * i.quantity, 0);

                this.ui.analytics.filteredSales.textContent = `₹${filteredRevenue.toFixed(0)}`;
                this.ui.analytics.filteredProfit.textContent = `₹${filteredProfit.toFixed(0)}`;
                this.ui.analytics.filteredResultsContainer.style.display = 'grid';
            },

             renderCreditorList() { 
                const creditors = this.state.transactions.filter(t => t.saleType === 'Credit').reduce((acc, t) => { if (!t.partyName) return acc; if (!acc[t.partyName]) acc[t.partyName] = 0; acc[t.partyName] += t.total - (t.paidAmount || 0); return acc; }, {});
                
                const creditorsWithBalance = Object.entries(creditors).filter(([_, balance]) => balance > 0.01);
                
                if (creditorsWithBalance.length === 0) {
                     this.ui.creditorListContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">No outstanding credit.</p>'; return;
                }
                
                this.ui.creditorListContainer.innerHTML = `
                    <table class="styled-table">
                        <thead><tr><th>CREDITOR</th><th>BALANCE</th><th>ACTION</th></tr></thead>
                        <tbody>
                        ${creditorsWithBalance.map(([name, balance]) => `
                            <tr>
                                <td>${name}</td>
                                <td>₹${balance.toFixed(2)}</td>
                                <td><button class="btn btn-primary pay-btn" style="width: auto; padding: 0.5rem 1rem; margin: 0;" data-creditor-name="${name}">PAY</button></td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`;
            },
            
            renderHolidays() {
                const holidayListEl = this.ui.settings.holidayList; holidayListEl.innerHTML = ''; 
                if (this.state.holidays.length === 0) { holidayListEl.innerHTML = '<li>No holidays marked.</li>'; return; }
                [...this.state.holidays].sort().forEach(holidayDateStr => { 
                    const formattedDate = new Date(holidayDateStr + 'T00:00:00').toLocaleDateString('en-GB');
                    holidayListEl.insertAdjacentHTML('beforeend', 
                        `<li style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;"><span>${formattedDate}</span><span class="action-icon" data-date="${holidayDateStr}" title="Remove Holiday">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                        </span></li>`); 
                });
            },

            handleFileUpload(event) {
                 const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); 
                 reader.onload = (e) => { 
                     try { 
                         const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' }); 
                         const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]); 
                         this.state.inventory = json.map(row => ({ particulars: String(row.particulars || "N/A"), quantity: parseInt(row.quantity, 10) || 0, rate: parseFloat(row.rate) || 0.0 })).filter(item => item.particulars !== "N/A"); 
                         this.renderPage('stocks'); this.triggerAutoSave(); this.showToast('Inventory loaded!', 'success'); 
                     } catch (error) { 
                         this.showToast('Error reading file. Check columns.', 'error'); 
                     } 
                 }; 
                 reader.readAsArrayBuffer(file); event.target.value = ''; 
            },
            
            addSaleItemRow() {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <div class="form-group"><input type="text" class="particulars" placeholder="Item Name" list="inventory-datalist" required></div>
                    <div class="form-group"><input type="number" class="quantity" placeholder="Qty" min="1" required></div>
                    <div class="form-group"><input type="number" class="rate" placeholder="Sale Rate" min="0" step="0.01" required></div>
                    <div class="actions"><button type="button" class="btn btn-danger remove-item-btn" style="padding: 0.5rem;">Remove</button></div>
                `;
                this.ui.salesItemsContainer.appendChild(div);
            },
            addPurchaseItemRow() {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <div class="form-group"><input type="text" class="particulars" placeholder="Item Name" required></div>
                    <div class="form-group"><input type="number" class="quantity" placeholder="Qty" min="1" required></div>
                    <div class="form-group"><input type="number" class="rate" placeholder="Cost Rate" min="0" step="0.01" required></div>
                    <div class="actions"><button type="button" class="btn btn-danger remove-item-btn" style="padding: 0.5rem;">Remove</button></div>
                `;
                this.ui.purchaseItemsContainer.appendChild(div);
            },
            
            processMultiItemSale(form) {
                const saleItems = [], errors = [];
                const itemRows = form.querySelectorAll('.item-row');
                
                if (itemRows.length === 0) { this.showToast("Add at least one item.", "error"); return; }

                for(const row of itemRows) {
                    const p = row.querySelector('.particulars').value.trim();
                    const q = parseInt(row.querySelector('.quantity').value, 10);
                    const r = parseFloat(row.querySelector('.rate').value);

                    if(!p || !q || isNaN(r)) continue;

                    const itemInStock = this.state.inventory.find(i => i.particulars === p);
                    if (!itemInStock) { errors.push(`Item not found: ${p}`); continue; }
                    if (itemInStock.quantity < q) { errors.push(`Not enough stock for ${p}.`); continue; }
                    
                    saleItems.push({ particulars: p, quantity: q, sellingRate: r, costRate: itemInStock.rate, itemInStock });
                }

                if (errors.length > 0) { this.showToast(errors.join('\n'), "error"); return; }
                if (saleItems.length === 0) { this.showToast("No valid items to record.", "error"); return; }

                saleItems.forEach(item => { item.itemInStock.quantity -= item.quantity; });
                const total = saleItems.reduce((sum, i) => sum + (i.sellingRate * i.quantity), 0);

                const newTransaction = { id: Date.now(), type: 'Sale', saleType: 'Cash', date: new Date(), items: saleItems.map(({itemInStock, ...rest}) => rest), total, paidAmount: total };
                this.state.transactions.push(newTransaction);
                
                this.ui.salesItemsContainer.innerHTML = '';
                this.addSaleItemRow();
                this.triggerAutoSave();
                this.showToast(`Sale recorded! Total: ₹${total.toFixed(2)}`, "success");
            },

            addEventListeners() { 
                this.ui.navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.renderPage(e.currentTarget.dataset.page);
                         if (window.innerWidth <= 768) {
                            this.ui.sidebar.classList.remove('active');
                        }
                    });
                });
                this.ui.mobileMenuBtn.forEach(btn => btn.addEventListener('click', () => {
                     this.ui.sidebar.classList.toggle('active');
                }));


                this.ui.settings.importDataBtn.addEventListener('click', () => this.ui.settings.excelFile.click());
                this.ui.settings.excelFile.addEventListener('change', (e) => this.handleFileUpload(e));
                
                // Sales
                this.ui.addSaleItemBtn.addEventListener('click', () => this.addSaleItemRow());
                this.ui.salesForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.processMultiItemSale(e.target);
                });
                this.ui.salesItemsContainer.addEventListener('click', e => {
                    if(e.target.classList.contains('remove-item-btn')) {
                        e.target.closest('.item-row').remove();
                    }
                });

                // Purchase
                this.ui.addPurchaseItemBtn.addEventListener('click', () => this.addPurchaseItemRow());
                this.ui.purchaseForm.addEventListener('submit', e => {
                    e.preventDefault();
                    const itemRows = e.target.querySelectorAll('.item-row');
                    const purchasedItems = [];
                    for(const row of itemRows) {
                        const p = row.querySelector('.particulars').value.trim();
                        const q = parseInt(row.querySelector('.quantity').value, 10);
                        const r = parseFloat(row.querySelector('.rate').value);
                        if(p && q && !isNaN(r)) purchasedItems.push({particulars:p, quantity:q, rate:r});
                    }
                    if(purchasedItems.length === 0) {this.showToast("No valid items to add.", "error"); return;}
                    
                    purchasedItems.forEach(newItem => {
                         const existing = this.state.inventory.find(i => i.particulars.toLowerCase() === newItem.particulars.toLowerCase());
                        if (existing) {
                            const totalVal = existing.rate * existing.quantity + newItem.rate * newItem.quantity;
                            const totalQty = existing.quantity + newItem.quantity;
                            existing.rate = totalVal / totalQty; existing.quantity = totalQty;
                        } else this.state.inventory.push(newItem);
                    });
                    this.state.transactions.push({ id: Date.now(), type: 'Purchase', date: new Date(), items: purchasedItems, total: purchasedItems.reduce((s, i) => s + (i.rate * i.quantity), 0) });
                    this.ui.purchaseItemsContainer.innerHTML = '';
                    this.addPurchaseItemRow();
                    this.triggerAutoSave();
                    this.showToast('Stock updated!', "success");
                });
                 this.ui.purchaseItemsContainer.addEventListener('click', e => {
                    if(e.target.classList.contains('remove-item-btn')) {
                        e.target.closest('.item-row').remove();
                    }
                });


                // Stocks
                this.ui.inventoryTableBody.addEventListener('click', (e) => {
                    const icon = e.target.closest('.action-icon');
                    if (!icon) return;
                    const particulars = icon.dataset.particulars;
                    if (icon.classList.contains('delete')) {
                        if (confirm(`Delete "${particulars}"?`)) {
                            this.state.inventory = this.state.inventory.filter(item => item.particulars !== particulars);
                            this.renderInventory(); this.triggerAutoSave(); this.showToast('Item deleted.', 'success');
                        }
                    }
                });

                // Analytics
                this.ui.analytics.filterBtn.addEventListener('click', () => this.renderFilteredAnalytics());
                
                // Settings
                this.ui.settings.addHolidayBtn.addEventListener('click', () => { 
                    const holidayDateStr = this.ui.settings.holidayDateInput.value; 
                    if (!holidayDateStr) { this.showToast("Select a date.", "error"); return; } 
                    this.state.holidays.push(holidayDateStr); 
                    this.renderHolidays(); this.triggerAutoSave(); this.showToast("Holiday added!", "success"); this.ui.settings.holidayDateInput.value = ''; 
                });
                this.ui.settings.holidayList.addEventListener('click', (e) => { 
                    const icon = e.target.closest('.action-icon');
                    if(icon) {
                        this.state.holidays = this.state.holidays.filter(d => d !== icon.dataset.date); 
                        this.renderHolidays(); this.triggerAutoSave(); this.showToast("Holiday removed.", "success"); 
                    }
                });

                 // Credit
                this.ui.creditSaleForm.addEventListener('submit', (e) => { 
                    e.preventDefault(); 
                    const partyName = e.target.querySelector('#credit-inventory-party-name').value.trim();
                    if (!partyName) { this.showToast("Party Name is required.", "error"); return; }
                    const p = e.target.querySelector('.particulars').value.trim();
                    const q = parseInt(e.target.querySelector('.quantity').value, 10);
                    const r = parseFloat(e.target.querySelector('.rate').value);
                    if(!p || !q || isNaN(r)) { this.showToast("All item fields are required.", "error"); return; }
                    const itemInStock = this.state.inventory.find(i => i.particulars === p);
                    if (!itemInStock || itemInStock.quantity < q) { this.showToast("Item not found or not enough stock.", "error"); return;}
                    
                    itemInStock.quantity -= q;
                    const newTransaction = { id: Date.now(), type: 'Sale', saleType: 'Credit', partyName, date: new Date(), items: [{ particulars: p, quantity: q, sellingRate: r, costRate: itemInStock.rate }], total: r * q, paidAmount: 0 };
                    this.state.transactions.push(newTransaction);
                    this.renderCreditorList(); this.triggerAutoSave(); e.target.reset();
                    this.showToast(`Credit sale to ${partyName} recorded!`, "success");
                });

                this.ui.creditorListContainer.addEventListener('click', e => {
                    if (e.target.classList.contains('pay-btn')) {
                        const name = e.target.dataset.creditorName;
                        const payment = parseFloat(prompt(`Enter payment amount for ${name}:`));
                        if (!isNaN(payment) && payment > 0) {
                            let remainingPayment = payment;
                            const creditorTransactions = this.state.transactions.filter(t => t.partyName === name && t.saleType === 'Credit' && (t.total - (t.paidAmount || 0)) > 0.01).sort((a,b) => a.date - b.date);
                            for (const tx of creditorTransactions) {
                                if (remainingPayment <= 0) break;
                                const due = tx.total - (tx.paidAmount || 0);
                                const payForThis = Math.min(remainingPayment, due);
                                tx.paidAmount = (tx.paidAmount || 0) + payForThis;
                                remainingPayment -= payForThis;
                            }
                            this.showToast(`Payment of ${payment.toFixed(2)} recorded.`, "success");
                            this.renderCreditorList();
                            this.triggerAutoSave();
                        }
                    }
                });
            },
            showToast(msg, type='success') {
                const toast = document.getElementById('toast');
                toast.textContent = msg;
                toast.className = `show ${type}`;
                setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
            },
        };
        app.init();
    };
    </script>
</body>
</html>
